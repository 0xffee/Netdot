<%doc>
-- IP Worksheet --
Interface for IP blocks (both addresses and subnets)

</%doc>
%
%
<%flags>
inherit => 'section_management.html' 
</%flags>
%
%
<%attr>
title   => 'IP' 
section => 'Management'
</%attr>
%
%
<%args>
$id                => undef
$search            => undef
$_action           => 'SHOW_ROOTS'
$delete            => undef
$recursivedel      => undef
$allocate          => undef
$newblock          => undef
$parent            => undef
$length            => undef
$strategy          => undef
$edit              => undef
$submit            => undef
$rootversion       => 4 
$view_availability => 0
$rowsize           => 22
$dividefreespace   => 'max'
</%args>
%
%
<%init>
use integer;

my $DEBUG = 0;
my $o;
my $ci = 0;
my $title;
my @list;
my $covering_block;
my %S_LBL = ( 'SEARCH_ADDR'  => 'IP[/prefix]',
	          'SEARCH_REGEX' => 'IP regex',
              'SEARCH_OTHER' => 'Entity/Site/Descr'
	      );
if ( $id ){
    unless ( $o = Ipblock->retrieve($id) ){
	$m->comp('error.mhtml', error => "Could not retrieve Ipblock id: $id");
    }else{
	$title = $o->address . "/" . $o->prefix;
    }
}else{
    $title = "Search";
}

my $edit_ip    = 0;
my $edit_block = 0;
my $add_ip = 0;
my $add_block = 0;
$edit_ip       = 1 if ($edit eq "ipinfo");
$edit_block    = 1 if ($edit eq "blockinfo");

# By default, view object after any operation
# ( some exceptions will override )
my $view       = 1;

</%init>
%
<div id="sectiondetail">

<script language="javascript">
<!--

function edit_recursive(id, field, rec){
    var url = "ip-rec.html?id="+id+"&field="+field+"&recursive="+rec;
    var wind = window.open(url, 'Edit recursively', "width=600,height=200");
}

-->
</script>

<%perl>

print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

#######################################################################################
# Search
#
#######################################################################################

if ( defined($search) ){
    if ($search eq "" ){
</%perl>
       <div class="container">
         <div class="containerhead">
           <strong>Error!</strong>   
         </div>
         <div class="containerbody">
            <p><strong>No search criteria</strong>   
         </div>
       </div>
<%perl>
    }else{
        # Make sure we start with a clean error buffer
        $ipm->error("");
	$search =~ s/^\s*(.*)\s*$/$1/g;
	if ( $_action eq "SEARCH_ADDR" ){
	    if ($search =~ /\//){
		my ($addr, $prefix) = split /\//, $search;
		if ( !(@list = $ipm->searchblocks_addr($addr, $prefix)) && !$ipm->error ){
		    $covering_block = $ipm->get_covering_block($addr, $prefix);
		}
	    }else{
		if ( !(@list = $ipm->searchblocks_addr($search)) && !$ipm->error ){
		    $covering_block = $ipm->get_covering_block($search);
		}
	    }
	}elsif ( $_action eq "SEARCH_REGEX" ){
	    @list = $ipm->searchblocks_regex($search);
	}elsif ( $_action eq "SEARCH_OTHER" ){
	    @list = $ipm->searchblocks_other($search);
	}else {
	    $m->comp('error.mhtml', error => "Unrecognized action parameter: $_action");	
	}

</%perl>      
	<div class="container">
          <div class="containerhead">
              Query <em><% $search %></em> returned: <% scalar(@list) %> matches
          </div>
          <div class="containerbody">
%         if ( @list ){
              <& ipblock_list.mhtml, objects => \@list  &>
%         }else{
%             if ( $ipm->error ){
                 <p><strong><% $ipm->error %></strong>
%             }
	      <form action="ip-ws.html" method="POST">
                <p>
                <label for="search"><% $S_LBL{$_action} %>:</label>
                <input type="text" name="search" class="txt" value="<% $search %>"> 
                <input name="submit" value="search" class="btn" type="submit">
                <input type="hidden" name="_action" value="<% $_action %>">
                </p>
              </form> 
%         }
          </div>
       </div>

%      if ( $covering_block ){
         <p>
         <div class="container">
           <div class="containerhead">Closest Covering Block:</div>
           <div class="containerbody">
              <& ipblock_list.mhtml, objects =>[$covering_block] &>
           </div>
         </div>
%      }

%   }
<%perl>

#######################################################################################
# Show Root Blocks
#
#######################################################################################
}elsif( $_action eq "SHOW_ROOTS" && !$id && $rootversion ){
    
    @list = $ipm->getrootblocks($rootversion);
    
</%perl>
       <div class="container">
          <div class="containerheadleft">Root Blocks: (<% scalar(@list) %>)</div>
          <div class="containerheadright">
	    <form name="netdotform" action="ip-ws.html" method="POST">
	      <input type="hidden" name="_action" value="SHOW_ROOTS">
	      Version: <select name="rootversion" onChange="submit();">
%	      foreach my $version ('4', '6', 'all'){
%	        if ($version eq $rootversion){
		    <option value="<% $version %>" SELECTED><% $version %></option>
%		}else{
		    <option value="<% $version %>"><% $version %></option>
%		}
%	      }
              </select>
            </form>
	  </div>
          <div class="containerbody">
%             if ( @list ){
                  <& ipblock_list.mhtml, objects => \@list, type => "block"  &>
%             }elsif ( $ipm->error ){
                  <p><strong><% $ipm->error %></strong>
%             }
          </div>
       </div>

<%perl>

#######################################################################################
# Update
# 
#######################################################################################

}elsif( $_action eq "UPDATE" ){

    if ($submit eq "cancel") {
        # Get rid of the new block
        unless ( $ipm->removeblock( id => $id ) ){
        	$m->comp('error.mhtml', error => $ipm->error);	
        }
        
        # reset all request variables to make this look like a view request
        $view = 1;
        $edit = 0;
        $id = $parent;
        if ($id != 0){
        	unless ( $o = Ipblock->retrieve($id) ){
        	    $m->comp('error.mhtml', error => "Can't retrieve Ipblock id $id");
        	}
        }

    } else {
        if ( $ui->form_to_db(%ARGS) ){
        	# Do this to 'flush' the values associated with the object
        	# before redisplaying
        	$o = undef;
            if ($id){
        	    $o = Ipblock->retrieve($id);
        	}
        }else{
        </%perl>
           <div class="container">
             <div class="containerhead">
               <strong>Error!</strong>   
             </div>
             <div class="containerbody">
    	   <p><strong><% $ui->error %></strong>
             </div>
           </div>
        <%perl>
       }
    }

#######################################################################################
# Allocate
#
#######################################################################################
}elsif ( $_action eq "ALLOCATE" ){
    my ($address, $prefix);
    if ($allocate =~ /\//){
	($address, $prefix) = split /\//, $allocate;
    }else{
	# If not passed,
	# assign a host prefix automatically
	if ( $allocate =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/ ){
	    ($address, $prefix) = ($allocate, '32');
	}elsif( $allocate =~ /:/ ){
	    ($address, $prefix) = ($allocate, '128');
	}else{
</%perl>
	    <div class="container">
              <div class="containerhead">
		<strong>Error!</strong>   
	      </div>
	      <div class="containerbody">
		<p><strong><em><% $allocate %></em> does not look like a valid IP address</strong>
	      </div>
   	    </div>
<%perl>
            $m->abort;
	}
    }
    my $newblock; 
    unless( $newblock = $ipm->insertblock(address     => $address, 
					  prefix      => $prefix, 
					  statusname  => "Container")){
</%perl>
	    <div class="container">
              <div class="containerhead">
		<strong>Error!</strong>   
	      </div>
	      <div class="containerbody">  
	        <p><strong><% $ipm->error %></strong>
	      </div>
   	    </div>
<%perl>
    }
    if ($newblock){
    	$o = $newblock;
    	$id = $newblock->id;

        if( $ipm->isaddress($o) ) {
            $edit_ip = 1;
            $edit = "ipinfo";
            $add_ip = 1;
        } else {
            $edit_block = 1;
            $edit = "blockinfo";
            $add_block = 1;
        }
    }

#######################################################################################
# Auto-Allocate
#
#######################################################################################
}elsif ( $_action eq "AUTOALLOCATE" ){
    # Strip "/" if any
    $length =~ s/\///;
    my $newblock;
    unless ( $newblock = $ipm->auto_allocate($parent, $length, $strategy) ){
</%perl>
    <div class="container">
      <div class="containerhead">
        <strong>Error!</strong>   
      </div>
      <div class="containerbody">  
        <p><strong><% $ipm->error %></strong>
      </div>
    </div>
%    }else {
%     # Present new block and ask for confirmation
      <form action="ip-ws.html">
        <input type="hidden" name="_action" value="CONFIRM_AUTOALLOCATE">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="newblock" value="<% $newblock->id %>">
	<div class="container">
	  <div class="containerhead">
            <strong>Confirm</strong>   
	  </div>
	  <div class="containerbody">  
	    <p>Do you want to use <strong><em><% $newblock->address %>/<% $newblock->prefix %></em></strong> ?
	    <p><input type="submit" name="submit" value="Yes" >
	    <input type="submit" name="submit" value="No" >
	  </div>
	</div>
      </form>
<%perl>    
   #  Do not continue with object display
      $view = 0;
   }

#######################################################################################
# Confirm Auto-Allocate
#
#######################################################################################

}elsif ( $_action eq "CONFIRM_AUTOALLOCATE" && $submit eq "Yes"){
    undef $o;
    unless ( $o = Ipblock->retrieve($newblock) ){
	$m->comp('error.mhtml', error => "Could not retrieve Ipblock id: $newblock");
    }
    # Replace current object with newblock
    $id = $o->id;

}elsif ( $_action eq "CONFIRM_AUTOALLOCATE" && $submit eq "No"){
    # Get rid of the new block
    unless ( $ipm->removeblock( id => $newblock ) ){
	$m->comp('error.mhtml', error => $ipm->error);	
    }

#######################################################################################
# Delete
#
#######################################################################################
}elsif ( $_action eq "DELETE" ){

</%perl>

  <form action="ip-ws.html">
    <input type="hidden" name="_action" value="CONFIRM_DELETE">
    <input type="hidden" name="id" value="<% $id %>">
    
    <div class="container">
      <div class="containerhead">
        <strong>Confirm</strong>   
      </div>
      <div class="containerbody">  
        <p>Are you sure you want to delete <strong><em><% $o->address %>/<% $o->prefix %></em></strong> ?
        <p>Delete children blocks <input type="checkbox" name="recursivedel">
        <p><input type="submit" name="submit" value="Yes" >
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
      </div>
    </div>
  </form>


<%perl>

# Do not continue with object display
  $view = 0;

#######################################################################################
# Confirm Delete
#
#######################################################################################
}elsif ( $_action eq "CONFIRM_DELETE" ){
  
    my ($parentid, $address, $prefix, $version) = ($o->parent->id, $o->address, $o->prefix, $o->version);
    # Remove from Database
    #
    my $rec = ($recursivedel)? 1 : 0;
    unless ( $ipm->removeblock( id => $o->id, recursive => $rec ) ){
	$m->comp('error.mhtml', error => $ipm->error);
    }
    
</%perl>
       <div class="container">
         <div class="containerhead">
           <strong>Message</strong>   
         </div>
         <div class="containerbody">
%        if ($rec){
           <p><strong>Block <em><% $address %>/<% $prefix %></em> and all its children blocks have been deleted</strong> <br>
%        }else{
           <p><strong>Block <em><% $address %>/<% $prefix %></em> has been deleted</strong> <br>
%        }
         </div>
       </div>

<%perl>
#    Show parent block
#    after block has been deleted
    $id = $parentid;
    if ($id != 0){
	unless ( $o = Ipblock->retrieve($id) ){
	    $m->comp('error.mhtml', error => "Can't retrieve Ipblock id $id");
	}
    }

}

#######################################################################################
# View
#
#######################################################################################

if ( $id && $view ){
    if ( $edit ){	 
</%perl>

    <form name="netdotform" action="ip-ws.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="_action" value="UPDATE">

%    }

<%perl>

my @line;
if ( my @parents = $ipm->getparents($o) ){
    foreach my $par ( reverse @parents ){
    	push (@line, "<a href=\"ip-ws.html?id=" . $par->id . "\">" . $par->address . "/" . $par->prefix . "</a>");
    }
    if( $view_availability == 1 ) {  
  	    push (@line, "<a href=\"ip-ws.html?id=" . $o->id . "\">" . $o->address . "/" . $o->prefix . "</a>");  
        push (@line, "Addresses");  
    } else {  
        push (@line, $o->address . "/" . $o->prefix);  
    }
}    
 
</%perl>

 <div class="container">

    <div class="containerheadleft">
      <a href="ip-ws.html?_action=SHOW_ROOTS&rootversion=all">[*]</a>: 
%     if ( @line ){
%        print join ' : ', @line;
%     }else{
         <% $o->address."/".$o->prefix %>
%     }
    </div>

% if ( $ipm->isaddress($o) ){  

%#######################################################################################
%# View IP address
%#######################################################################################


    <div class="containerheadright">
%	 if ($edit eq "ipinfo"){	 
%        if ($add_ip) {
    	    <input type="submit" name="submit" value="cancel">
%           my @parents = $ipm->getparents($o);
            <input type="hidden" name="parent" value="<% $parents[0] %>">
%        } else {
    	    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
%        }
         <input type="submit" name="submit" value="save">
%	 }else{
            <a href="ip-ws.html?id=<% $id %>">[refresh]</a>
            <a href="ip-ws.html?id=<% $id %>&edit=ipinfo">[edit]</a>
            <a href="ip-ws.html?id=<% $id %>&_action=DELETE">[delete]</a>
%	 }
    </div>

    <div class="containerbody">
      <!-- this is for the two-column layout of the body -->
      <table width="100%">
       <tr>
        <td width="50%" valign="top">

<%perl>
       my @field_headers;
       my @cell_data;

       push( @field_headers, "Address:" );
       push( @cell_data, "<strong>".$ui->text_field(object=>$o, column=>"address", edit=>$edit_ip, htmlExtra=>"style='width: 15em'", returnAsVar=>1)."/".$o->prefix."</strong>" );

       push( @field_headers, "Status:" );
            my $status;
            my @valid_block_status = qw ( Static Dynamic Reserved );
            if ( my $sn = $o->status->name ){
                if ( $edit eq "ipinfo" ){
                   $status = qq(<select name="Ipblock__).$o->id.qq(__statusname">);
                   foreach my $st ( @valid_block_status ){
                      if ( $st eq $sn ){
                         $status .= qq(<option value="$st" SELECTED>$st</option>);
                      }else{
                         $status .= qq(<option value="$st">$st</option>);
                      }
                   }
                   $status .= "</select>";
                }else{
                   $status = qq(<strong>$sn</strong>);
                }
            }
       push( @cell_data, $status );

       push( @field_headers, "Description:" );
       push( @cell_data, $ui->text_field(object=>$o, column=>"description", edit=>$edit_ip, htmlExtra=>"style='width: 25em'", returnAsVar=>1) );

       push( @field_headers, "Comments:" );
       push( @cell_data, $ui->text_area(object=>$o, column=>"info", edit=>$edit_ip, htmlExtra=>"cols=45", returnAsVar=>1) );

       if (!scalar($o->arecords)) {
           push( @field_headers, "&nbsp;" );
           push( @cell_data, "[Add DNS Records]" );
       }
</%perl>
<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>


%   if (scalar($o->arecords)) {
<%perl>
    my @headers = ("DNS A Record", "Zone");
    my @rows;
    foreach my $ar ($o->arecords){
	push( @rows, [ $ui->text_field(object=>$ar->rr, column=>"name", edit=>$edit_ip, linkPage=>"view.html", 
				       returnAsVar=>1, htmlExtra=>"style=\"width: 20em;\"" ),
		       $ui->select_lookup(object=>$ar->rr, column=>"zone", lookup=>"Zone", 
					  edit=>$edit_ip, linkPage=>"view.html", returnAsVar=>1 ) ] );
    } 
</%perl>
      <& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>
%   } #endif arecords

%   if (scalar($o->services)){	   
      <%perl>
          my @headers = ("Service", "Contact List");
          my @rows;
          foreach my $ipservice ($o->services){
              push( @rows,
                [ eval {
                    if ($edit eq "ipinfo"){	 
                        $ui->select_lookup(object=>$ipservice, column=>"service", lookup=>"Service", edit=>$edit_ip);
	            }else{
		        qq(<a href="view.html?table=Service&id=).$ipservice->service->id.qq(">).$ipservice->service->name."</td></a>";
                    }
                  } ,
                  eval {
                    if ($edit eq "ipinfo"){
                        $ui->select_lookup(object=>$ipservice, column=>"contactlist", lookup=>"ContactList", edit=>$edit_ip);
                    }elsif ($o->used_by){
                        qq(<a href="view.html?table=ContactList&id=).$ipservice->contactlist.qq(">).$ipservice->contactlist->name."</td></a>";
                    }
                  }
                ]  );
          } 
      </%perl>
      <& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>
%   } #endif services


      </td>
      <td valign="top" width="50%">

<%perl>
    @field_headers = ();
    @cell_data = ();

    push( @field_headers, "First Seen:" );
    push( @cell_data, $ui->text_field(object=>$o, column=>"first_seen", edit=>$edit_ip, htmlExtra =>"style='width: 25em'", returnAsVar=>1) );

    push( @field_headers, "Last Seen:" );
    push( @cell_data, $ui->text_field(object=>$o, column=>"last_seen", edit=>$edit_ip, htmlExtra =>"style='width: 25em'", returnAsVar=>1) );

    push( @field_headers, "Interface:" );
    push( @cell_data, 
        eval {
            if ( $o->interface && $o->interface->id ){
                qq(<a href="view.html?table=Interface&id=).$o->interface->id.qq(">).$o->interface->name."</a>";
            }else{
                "&nbsp;";
            }
        }  );

    push( @field_headers, "Device:" );
    push( @cell_data, 
        eval {
            if ( $o->interface && $o->interface->device ){
                qq(<a href="device.html?id=).$o->interface->device->id.qq(">).$ui->getobjlabel($o->interface->device, ", ")."</a>";
            }else{
                "&nbsp;";
            }
        }  );
</%perl>

%# actually output the table to the browser
<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

%     if ( $o->arpentries ){
        <%perl>
            @field_headers = ("ARP-cached by", "With MAC", "On");
            my @rows;
            foreach my $arpentry ($o->arpentries){
                push( @rows, 
                    [ "<a href=\"view.html?table=Interface&id=".$arpentry->arpcache->interface->id."\">".
                      $ui->getobjlabel($arpentry->arpcache->interface, ", ")."</a>"
                     ,
                      "<a href=\"view.html?table=PhysAddr&id=".$arpentry->physaddr->id."\">".$arpentry->physaddr->address."</a>"
                    ] );
            } 
        </%perl>
        <& data_table.mhtml, field_headers=>\@field_headers, data=>\@rows &>
%     }

           </td>
         </tr>
      </table>
    </div>
</div>


%} else {     
%#######################################################################################
%# View Block
%#######################################################################################

    <div class="containerheadright">
%  if ($edit eq "blockinfo"){	 
%        if ($add_ip) {
    	    <input type="submit" name="submit" value="cancel">
%           my @parents = $ipm->getparents($o);
            <input type="hidden" name="parent" value="<% $parents[0] %>">
%        } else {
    	    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
%        }
    <input type="submit" name="submit" value="save">
%  }else{
    <a href="ip-ws.html?id=<% $id %>">[refresh]</a>
	<a href="ip-ws.html?id=<% $id %>&edit=blockinfo">[edit]</a>
	<a href="ip-ws.html?id=<% $id %>&_action=DELETE">[delete]</a>
%  }
    </div>

    <div class="containerbody">
    <!-- this is for the two-column layout of the body -->
    <table width="100%">
     <tr>
      <td width="50%" valign="top">

<%perl>

my @field_headers = ( );
my @cell_data = ( );

    push( @field_headers, "Address:" );
    push( @cell_data, $ui->text_field(object=>$o, column=>"address", edit=>$edit_block, htmlExtra=>"style='width: 15em'", returnAsVar=>1)."/".$ui->text_field(object=>$o, column=>"prefix", edit=>$edit_block, htmlExtra =>"style='width: 2em'", returnAsVar=>1) );

    push( @field_headers, "Status:" );
    my $status;
	       my @valid_block_status = qw ( Container Subnet Reserved );
	       if ( my $sn = $o->status->name ){
	          if ( $edit eq "blockinfo" ){
                    $status .= "<select name=\"Ipblock__".$o->id."__statusname\">";
	            foreach my $st ( @valid_block_status ){
		      if ( $st eq $sn ){
  		         $status .= "<option value=\"".$st."\" SELECTED>".$st."</option>";
		      }else{
  		         $status .= "<option value=\"".$st."\">".$st."</option>";
		      }
		    }
		    $status .= "</select>";
                  }else{
	            $status .= "<strong>".$sn."</strong>";
                  }
	       }
    push( @cell_data, $status );

    push( @field_headers, "Description:" );
    push( @cell_data, $ui->text_field(object=>$o, column=>"description", edit=>$edit_block, htmlExtra =>"style='width: 25em'", returnAsVar=>1) );

    push( @field_headers, "Comments:" );
    push( @cell_data, $ui->text_area(object=>$o, column=>"info", edit=>$edit_block, htmlExtra=>"cols=45", returnAsVar=>1) );

    push( @field_headers, "Owner:" );
    my $owner = $ui->select_lookup(object=>$o, column=>"owner", lookup=>"Entity", edit=>0, 
				   linkPage=>"view.html", returnAsVar=>1);
    # For some fields, we will provide a way to update the values recursively in all 
    # descendant blocks.
    $owner .= " <input type=\"button\" value=\"edit\" onClick=\"edit_recursive(" . $o->id . ",\'owner\', \'1\')\">";
    push( @cell_data, $owner );
    
    push( @field_headers, "Used by:" );
    my $used_by = $ui->select_lookup(object=>$o, column=>"used_by", lookup=>"Entity", edit=>$edit_block, 
				     linkPage=>"view.html", returnAsVar=>1);
    push( @cell_data, $used_by );

</%perl>

%# actually output the table to the browser
<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

    </td>
    <td width="50%" valign="top">

<%perl>

@field_headers = ( );
@cell_data = ( );

    push( @field_headers, "Created:" );
    push( @cell_data, $o->first_seen );

    push( @field_headers, "Last Updated:" );
    push( @cell_data, $o->last_seen );

    my $delegate_dns = $ui->radio_group_boolean(object=>$o, column=>"dns_delegated", edit=>$edit_block, returnAsVar=>1);

use Math::BigInt;
if ($o->status->name eq "Subnet") {
      my $used = new Math::BigInt(scalar $o->children);
      my $total = new Math::BigInt($ipm->subnet_num_addr($o));
      my $avail = $total - $used;
      my $avail_percent = $ui->friendly_percent(value=>$avail,total=>$total);
      my $used_percent  = $ui->friendly_percent(value=>$used,total=>$total);
      my $percent = ($used*100)/$total;

    my $available_text;
    if ($o->version == 4) {
        $available_text = "Used: ".$used." of ".$total." &nbsp;&nbsp; Available: ".$avail." ".$avail_percent."(%)";
    } else {
        my $used_text;
        if ($used <= 65536) {
            $used_text = 'Used: '.$used;
            if ($total <= 65536) {
                $used_text .= ' of '.$total;
            }
            $used_text .= ' &nbsp;&nbsp; ';
        }
        my $avail_text = 'Available: ';
        if ($avail <= 65536) {
            $avail_text .= $avail.' &nbsp;(';
        }
        $avail_text .= $ui->friendly_percent(value=>$avail,total=>$total);
        if ($avail <= 65536) {
            $avail_text .= ')';
        }
        $available_text = $used_text.$avail_text;
    }

    push( @field_headers, "Utilization:" );
    push( @cell_data, ($ui->percent_bar(percent=>$percent))
        .'<div class="small">'.$available_text.'</div>' );

    push( @field_headers, "Enable DHCP:" );
    push( @cell_data, $ui->radio_group_boolean(object=>$o, column=>"dhcp_enabled", edit=>$edit_block, returnAsVar=>1) );

    push( @field_headers, "DNS delegated?:" );
    push( @cell_data, $delegate_dns );

} elsif( $o->status->name eq "Container" ) {
      my $total = new Math::BigInt($ipm->subnet_num_addr($o));

      my $used_a = new Math::BigInt($ipm->address_usage($o));
      my $avail_a = $total - $used_a;
      my $used_s = new Math::BigInt($ipm->subnet_usage($o));
      my $avail_s = $total - $used_s;

      my $address_percent = $used_a*100/$total;
      my $subnet_percent = $used_s*100/$total;

    my $address_text;
    my $subnet_text;

    $subnet_text = 'Available: '.($ui->friendly_percent(value=>$avail_s,total=>$total));

    if ( $o->version == 4 ) {
        $address_text = 'Used: '.$used_a.' of '.$total.' &nbsp;&nbsp; Available: '.$avail_a.' ('.(100-$address_percent).'%)';
    } else {
        if( $used_a <= 65536 ) {
            $address_text .= 'Used: '.$used_a;
            if( $total <= 65536 ) {
                $address_text .= ' of '.$total;
            }
            $address_text .= ' &nbsp;&nbsp; Available: ';
            if( $total <= 65536 ) {
                $address_text .= $avail_a;
            }
            $address_text .= ' '.$ui->friendly_percent(value=>$avail_a,total=>$total);
        } else {
            $address_text .= 'Available: '.$avail_a.' ('.(100-$address_percent).'%)';
        }
    }

    push( @field_headers, "Address Utilization:" );
    push( @cell_data, $ui->percent_bar(percent=>$address_percent).'<div class="small">'.$address_text.'</div>' );

    push( @field_headers, "Space Allocated:" );
    push( @cell_data, $ui->percent_bar(percent=>$subnet_percent).'<div class="small">'.$subnet_text.'</div>' );

    push( @field_headers, "DNS delegated?:" );
    push( @cell_data, $delegate_dns );
}

    if ($edit eq "blockinfo"){
        # don't show new subnet form

    }elsif ($o->status->name eq "Container"){
        push( @field_headers, "New subnet of length: /" );
        my $new_subnet_form = "
	     <form name=\"netdotform\" action=\"ip-ws.html\" method=\"POST\">
	     <input type=\"hidden\" name=\"id\" value=\"".$id."\">
	     <input type=\"hidden\" name=\"_action\" value=\"AUTOALLOCATE\">
	     <input type=\"hidden\" name=\"parent\" value=\"".$id."\">
	     <input type=\"text\" size = \"4\" name=\"length\" value=\"".($o->prefix + 1)."\">
	     <select name=\"strategy\">
	       <option value=\"first\">First Fit</option>
	       <option value=\"last\">Last Fit</option>
	     </select>
	     <input name=\"submit\" value=\"Allocate\" type=\"submit\">
        ";
        push( @cell_data, $new_subnet_form );

        push( @field_headers, "Choose Manually:" );
        if( $o->version == 4 ) {
            push( @cell_data, '<a href="ip-ws.html?id='.$id.'&view_availability=1">[view availablilty]</a>' );
        } else {
            push( @cell_data, '<div title="Not yet supported for IPv6 addresses">[view availablilty]</div>' );
        }

    }elsif ($o->status->name eq "Subnet"){
        push( @field_headers, "New address:" );
        my $new_address_form = "
	     <form name=\"netdotform\" action=\"ip-ws.html\" method=\"POST\">
	     <input type=\"hidden\" name=\"id\" value=\"".$id."\">
	     <input type=\"hidden\" name=\"_action\" value=\"AUTOALLOCATE\">
 	     <input type=\"hidden\" name=\"parent\" value=\"".$id."\">
             ";
	     if ($o->version == 4){
 	        $new_address_form .= "<input type=\"hidden\" name=\"length\" value=\"32\">";
	     }elsif ($o->version == 6){
	        $new_address_form .= "<input type=\"hidden\" name=\"length\" value=\"128\">";
	     }
             $new_address_form .= "
	     <select name=\"strategy\">
	       <option value=\"first\">First Fit</option>
	       <option value=\"last\">Last Fit</option>
	     </select>
	     <input name=\"submit\" value=\"Get\" type=\"submit\">
             ";
        push( @cell_data, $new_address_form );

        push( @field_headers, "Choose Manually:" );
        if( $o->version == 4 ) {
            push( @cell_data, '<a href="ip-ws.html?id='.$id.'&view_availability=1">[view availablilty]</a>' );
        } else {
            push( @cell_data, '<div title="Not yet supported for IPv6 addresses">[view availablilty]</div>' );
        }

   }
</%perl>

%# actually output the table to the browser
<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

      </td>
     </tr>

    </table>
    <!-- end two-column layout table -->
    </div>

</div>

% if( $view_availability == 1 ) {  
%     if( $o->status->name eq "Subnet" ) {  
       <div class="container">  
          <div class="containerheadleft"> 
             Choose an Address  
          </div>  
          <div class="containerheadright">
            Legend:
            <span class="ipaddr_available">Available</span>
            <span class="ipaddr_dynamic">Dynamic</span>
            <span class="ipaddr_static">Static</span>
            <span class="ipaddr_reserved">Reserved</span>
          </div>
          <div class="containerbody" id="ipaddresstable">  
          <& subnet.mhtml, network => $o &>  
          </div>  
       </div>  
%     }  
%     if( $o->status->name eq "Container" ) {  
       <div class="container">  
          <div class="containerheadleft"> 
             Usage for <% $o->address.'/'.$o->prefix %>  
          </div>  
          <div class="containerheadright">
            Legend:
            <span class="ipaddr_available">Available</span>
            <span class="ipaddr_subnet">Subnet</span>
            <span class="ipaddr_reserved">Reserved</span>
          </div>
          <div class="containerbody" id="ipaddresstable">  
          <& container.mhtml, network => $o, rowsize => $rowsize, dividefreespace => $dividefreespace &>  
          </div>  
       </div>  
%     }  
% } else {  
%   #  
%   # Get children  
%   #  
%   my @children;   
%   if (scalar( @children = $ipm->getchildren($o->id) )){  

       <div class="container">
          <div class="containerhead">
             Children Addresses/Blocks
          </div>
          <div class="containerbody">
          <& ipblock_list.mhtml, objects => \@children &>
          </div>
       </div>

%   }
% }
<!-- End Block Info Table -->
% } 
% if ($edit){	 
    </form>
% }

% }
</div>
