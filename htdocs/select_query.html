<%doc>

Calls UI::select_query to perform a recursive search for keywords
in a table's label fields
Creates a dummy form with results, which are then copied by select.js
into the working webpage.

Arguments:
- table:  Foreign key table to search.
- field:  Name of the original field for which we're searching foreign values
          Needed by the caller
- crit:   Criteria.  A string with one or more keywords to search

- form_name: optional form name for original caller. If not specified assumes
             form name is "netdotform".

</%doc>
%
%
<%flags>
inherit => undef
</%flags>
%
%
<%args>
$table     => $ARGS{table};
$field     => $ARGS{field};
$crit      => $ARGS{crit};
$form_name => $ARGS{form_name};
</%args>

<%init>
my $r;
my @terms;
my $MAX   = 100;
my $DEBUG = 0;

</%init>

<%perl>

print "<pre> ", Dumper(%ARGS), "</pre><br>" if $DEBUG;

if ($crit =~ /\w+/){
    $crit =~ s/^\s*(.*)\s*$/$1/;
    @terms = split /\s+/, $crit;
    print "terms are: ",  join ', ', @terms, "<br>" if $DEBUG;
}
</%perl>

<body bgcolor="#FFFFFF" onLoad="opener.getlist(<% "\'" . $field . "\'" %>, <% "\'" . $form_name . "\'" %>)">

%$r = $ui->select_query(table => $table, terms => \@terms, max => $MAX);

<form>
%if (my $n = scalar (keys %$r) ){
%    my $count = 0;
     <input type="hidden" name="0" value="">
%    if ($n >= $MAX){
       <input type="hidden" name="" value="More than <% $MAX %> matches.  Refine search">
%    }
%    my @objs = map { $r->{$_} } keys %$r;
%    my $lblfield = ( $ui->getlabels($table) )[0];
%    my %coltypes = $ui->getcolumntypes($table);
%    my $type = $coltypes{$lblfield};
%    if ( $type =~ /int/ || $table eq "Interface" ){  # Ugly hack
%       @objs = sort { $a->$lblfield <=> $b->$lblfield } @objs;
%    }else {
%       @objs = sort { $a->$lblfield cmp $b->$lblfield } @objs;
%    }
%    foreach my $o (@objs){
%       my $delim;
%       if ( $table eq "Ipblock" ){
%	   $delim = "/";
%       }else{
%	   $delim = ", "
%	}
%       my $lbl = $ui->getobjlabel($o, $delim);
        <input type="hidden" name="<% $o->id %>" value="<% $lbl %>">
%       last if ($count++) == $MAX;
%    }
%}else{
       <input type="hidden" name="0" value="No matches">
%}
</form>
</body>

