#
# Make the necessary modifications to upgrade Netdot's schema and data
#
use strict;
use vars qw( $dbh $DEBUG $DB_TYPE $DB_HOST $DB_PORT 
	     $DB_DBA $DB_DATABASE $DB_DBA_PASSWORD);

use DBUTIL;

($DB_TYPE, $DB_HOST, $DB_PORT, $DB_DBA, $DB_DBA_PASSWORD, $DB_DATABASE) = @ARGV;

if ( my $dbh = &dbconnect($DB_TYPE, $DB_HOST, $DB_PORT, $DB_DBA, $DB_DBA_PASSWORD, $DB_DATABASE) ){
    
    # Convert Mysql tables from MyISAM to INNODB
    my @lines;
    foreach my $table ( $dbh->tables ){
	push @lines, "ALTER TABLE $table ENGINE=INNODB";
    }
    
    # Drop the obsolete Meta table
    push @lines, "
DROP TABLE Meta";
    
    # column nsdname should be an integer, not a varchar
    push @lines, "
ALTER TABLE RRNS CHANGE nsdname nsdname int(11) default NULL";

    # Add VLanGroup and modify related stuff
    push @lines, "
CREATE TABLE VlanGroup (
  info LONGBLOB NULL  ,
  name varchar(128) NOT NULL  ,
  id INTEGER NOT NULL  AUTO_INCREMENT,
  description varchar(255) NULL  ,
  end integer NOT NULL  ,
  start integer NOT NULL  ,
  PRIMARY KEY (id)
);
CREATE UNIQUE INDEX VlanGroup1 ON VlanGroup (name);
CREATE TABLE VlanGroup_history (
  info LONGBLOB NULL  ,
  name varchar(128) NOT NULL  ,
  vlangroup_id integer NOT NULL  ,
  description varchar(255) NULL  ,
  modifier varchar(32) NULL  ,
  modified DATETIME NOT NULL  ,
  end integer NOT NULL  ,
  id INTEGER NOT NULL  AUTO_INCREMENT,
  start integer NOT NULL  ,
  PRIMARY KEY (id)
);
CREATE INDEX VlanGroup_history1 ON VlanGroup_history (vlangroup_id);
ALTER TABLE Vlan DROP COLUMN subnet;
ALTER TABLE Vlan ADD COLUMN name varchar(255) AFTER vid;
ALTER TABLE Ipblock ADD COLUMN vlan integer AFTER dhcp_enabled;
";
    
    &processdata($dbh, \@lines);
    
    &dbdisconnect($dbh);
}


