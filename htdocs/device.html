<& index.html, title => "Device Worksheet: $name ", s2name => $s2name  &>
<script language="javascript" src="select.js"></script>

<script language="javascript">
<!--
/* 
 * Show only interfaces belonging to selected VLAN
 * 
*/
function showVlan(){
    var name = document.showvlans.showvlan.value;
    window.location = "device.html?id=<% $id %>&showvlan="+name;
}
-->
</script>

% if ( $search ){
<table border="0" width="95%" align="center" cellpadding="3" cellspacing="0" class="tablebackground">
 <tr class="rowtitle0" >
    <td valign="top" align="left">
       <b><% scalar(@$list) %> results for <i><% $search %></i> </b>
    </td>
 </tr>
 <tr>
   <td valign="top" width="50%" align="center">
      <& sortresults.mhtml, table => "Device", object => $list, view => "row", page => "device.html" &>
  </td>
  </tr>
</table>
% }elsif ( ! $search ){

<!-- Header Table -->
<table border="0" width="95%" align="center" cellpadding="3" cellspacing="0" class="tablebackground">
 <tr class="rowtitle0" >
    <td valign="top" align="left">
     Device: <b><% $name %></b>&nbsp;&nbsp;
    </td>
    <td valign="top" align="left">
    <form name="showvlans">
    VLAN view 
    <select name="showvlan" onchange="showVlan()">
%      if ( $showvlan eq 'all' ){
	 <option value="all" SELECTED>all</option>
%      }else{
	 <option value="all">all</option>
%      }
%      foreach my $vid ( sort keys %vlans ){
%        if ( $showvlan eq $vid ){
            <option value="<% $vid %>" SELECTED><% $vid %></option>     
%        }else{
          <option value="<% $vid %>"><% $vid %></option>     
%        }
%      }
    </select>
    </form>
    <td width="50%" valign="top" align="left">&nbsp;</td>
    <td valign="top" align="right">
    <a href="device.html?id=<% $id %>"> [refresh]</a>&nbsp;
    <a href="deldevice.html?id=<% $id %>"> [delete]</a>&nbsp;
    </td>
 </tr>
</table>

<!-- Margins Table -->
<table border="0" width="95%" align="center"  class="tablebackground">
 <tr>
   <td valign="top" width="50%" align="center">

% if ( $editgen || $editloc || $editmgmt || $editips || $editints ){	 
    <form name="netdotform" action="device.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="s2name" value="<% $s2name %>">
% }
<!-- General Info Table -->
   <table border="0" width="100%" cellpadding="0" cellspacing="2" class="formtablebg">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">General</th>
%	 if ($editgen){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&editgen=1">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
      <td valign="top" width="50%">
         <table border="0" width="100%">
	    <tr>
	      <td class="formtablec1">Name: </td>
	      <td class="formtablec2"> 
%	         if ($o->name && $o->name->name){
%	      	   if ($editgen){	 
		      <input type="text" name="RR__<% $o->name->id %>__name" value="<% $o->name->name %>">  
%	           }else{
		      <b><a href="view.html?table=RR&id=<% $o->name->id %>"><% $o->name->name %></a></b>
%		   }
%		 }
%		 else{ 
		   Name N/A!
%		 }
	      </td>
	    </tr>
           <tr>
             <td class="formtablec1">Type: </td>
	     <td class="formtablec2"> 
%	       if (($o->productname) && ($o->productname->type)){	 
    	        <a href="view.html?table=Product&id=<% $o->productname->id %>"><% $o->productname->type->name %></a>
%	       }
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">S/N: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"serialnumber", edit=>$editgen);
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">MAC: </td>
	     <td class="formtablec2"> 
%               $ui->selectLookup(object=>$o, column=>"physaddr", lookup=>"PhysAddr", edit=>"$editgen", linkPage=>"view.html");
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">First Discovered:</td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"dateinstalled", edit=>$editgen);
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">Last updated:</td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"lastupdated", edit=>$editgen);
	     </td> 
	   </tr>
	 </table>
      </td>
      <td valign="top" width="50%">
         <table  border="0" width="100%">
           <tr>
             <td class="formtablec1">Product: </td>
	     <td class="formtablec2"> 
%               $ui->selectLookup(object=>$o, column=>"productname", lookup=>"Product", edit=>"$editgen", linkPage=>"view.html");
	     </td>
	   </tr>
           <tr>
             <td class="formtablec1">Part of: </td>
	     <td class="formtablec2"> 
%               $ui->selectLookup(object=>$o, column=>"part_of", lookup=>"Device", edit=>"$editgen");
	     </td>
	   </tr>
           <tr>
             <td class="formtablec1">Inventory #: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"inventorynumber", edit=>$editgen);
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">System Descr: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"sysdescription", edit=>$editgen);
             </td> 
	   </tr>
	 </table>
      </td>
  </tr>
   <tr>
     <td colspan="2" align="center">Comments:</td>
   </tr>
   <tr>
     <td colspan="2" align="left">
%               $ui->textArea(object=>$o, column=>"info", edit=>$editgen, htmlExtra=>"cols=80");
     </td>
   </tr>
 </table>
% if ($editgen){	 
    </form>
% }
<!-- End General Info Table -->

<br>
<!-- IPs Table -->

  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">IPs</th>
%	 if ($editips){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&editips=1">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0" width="100%">
%	if (scalar @ips){
         <tr>
	   <td align="left"><a href="device.html?id=<% $id %>&ipsort=Ipblock.address">Address</a></td>
	   <td align="left"><a href="device.html?id=<% $id %>&ipsort=Ipblock.parent">Subnet</a></td>
	   <td align="left"><a href="device.html?id=<% $id %>&ipsort=Interface.name">Interface</a></td>
	   <td align="left">DNS Name</td>
	   <td align="left">Monitored?</td>
         </tr>
%	}

%	foreach my $ip (@ips){	   
%	 $ci = ($ci + 1) % 2;
	 <tr class="<% $cssitem{$ci} %>">
	   <td align="left">
%	      	 if ($editips){	 
		    <input type="checkbox" name="<% "Ipblock__" . $ip->id . "__delete" %>" >[del]
		    <input type="text" size="15" name="<% "Ipblock__" . $ip->id . "__address" %>" value="<% $ip->address %>">
		    <br>
%	         }else{
		    <a href="ip-ws.html?id=<% $ip->id %>"><% $ip->address %></a><br>
%		 }
	   </td>
	   <td align="left">
%	     if ( int($ip->parent) != 0  ){
	       <a href="ip-ws.html?id=<% $ip->parent->id %>"><% $ip->parent->address %>/<% $ip->parent->prefix %></a><br>
%            }
	   </td>
	   <td align="left"><% $ip->interface->name %></td>
           <td align="left">
%              if ( $ip->arecords ){
%                 foreach my $ar ($ip->arecords){
%	             if ($editips){	 
  	                <input type="checkbox" name="<% "RR__" . $ar->rr->id . "__delete" %>" >[del]
%	             }
%                    $ui->textField(object=> $ar->rr, column=>"name", edit=>$editips, linkPage=>"view.html");
%		  }
%              }else{
	          
%	       }
           </td>
           <td align="left">
%              $ui->radioGroupBoolean(object=>$ip->interface, column=>"monitored", edit=>$editips);
           </td>
	  </tr>
%	}# foreach	
     </table>
    </td>
   </tr>
  </table>
% if ($editips){	 
    </form>
% }

<!-- End IPs Table -->

</td>
<td valign="top" align="center">

<!-- Location Table -->
%   if ($editloc) {
    <script language="JavaScript">
    <!--
    var closetList = new DynamicList("netdotform", "Device__<% $id %>__closet", "site", "Closet", "Device__<% $id %>__site");
    var roomList = new DynamicList("netdotform", "Device__<% $id %>__room", "floor", "Room", "Device__<% $id %>__site");
    roomList.setQueryURL("room_site_query.html");
    LIST_MANAGER.addList(closetList, roomList);


    function setNull(field)
    {
        if (!field)
            return;

        for (var i = 0; i < field.options.length; ++i)
        {
            if (field.options[i].value == 0 || field.options[i].value == -1)
            {
                field.options[i].selected = true;
                break;
            }
        }
    }
    -->
    </script>

%   }

  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Group/Location</th>
%	 if ($editloc){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&editloc=1">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0" width="100%">
        <tr>
	   <td class="formtablec1">Entity: </td>
	   <td class="formtablec2"> 
%               $ui->selectLookup(object=>$o, column=>"entity", lookup=>"Entity", edit=>"$editloc", linkPage=>"view.html");
	   </td>
	   <td class="formtablec1">Site: </td>
	   <td class="formtablec2">
%               $ui->selectLookup(object=>$o, column=>"site", lookup=>"Site", edit=>"$editloc", makeLink=>1, linkPage=>"view.html", htmlExtra=>'onChange="closetList.doIt(); roomList.doIt();"');
	   </td>
	</tr>
        <tr>
	   <td class="formtablec1">Room: </td>
	   <td class="formtablec2"> 
%               if ($editloc) {
                <select name="Device__<% $id %>__room" onChange="setNull(document.netdotform.Device__<% $id %>__closet);">
                <option value="">-- Make your selection --</option>
%               if (defined($o)) {
%                   foreach my $floor ($o->site->floors) {
%                       foreach my $room ($floor->rooms) {
%                           printf("<option value=\"%d\" %s>%s</option>\n", $room->id, ($o->room && $room->id == $o->room->id ? "SELECTED" : ""), $room->name);
%                       }
%                   }
%               }
                <option value="0">[null]</option>
                </select>
%               } else {
                <% $o->room ? sprintf("<A HREF=\"view.html?table=Room&id=%d\">%s</A>", $o->room->id, $o->room->name) : "" %>
%               }
	   </td>
	   <td class="formtablec1"> <i>- or -</i> Closet: </td>
	   <td class="formtablec2">
%               my $closet_js = sprintf("onChange=\"setNull(document.netdotform.Device__%d__room);\"", $id);
%               $ui->selectLookup(object=>$o, column=>"closet", lookup=>"Closet", edit=>$editloc, where=>{site=>($o ? $o->site : "")}, makeLink=>1, linkPage=>"closet.html", htmlExtra=>$closet_js);
	   </td>
        <tr>
	   <td class="formtablec1">Rack: </td>
	   <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"rack", edit=>$editloc);
	   </td>
	   <td>&nbsp; </td>
	   <td>&nbsp; </td>
	</tr>
      </table>
     </td>
   </tr>
   </tr>
  </table>
% if ($editloc){	
    </form>
% }

<!-- End Location Table -->
<br>
<!-- Management Table -->
  <table border="0" width="100%" class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle">
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Management</th>
%	 if ($editmgmt){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&editmgmt=1">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td valign="top" width="50%">
      <table border="0" width="100%">
        <tr>
	   <td class="formtablec1">Contact Group: </td>
	     <td class="formtablec2"> 
%               $ui->selectLookup(object=>$o, column=>"contactlist", lookup=>"ContactList", edit=>"$editmgmt", linkPage=>"view.html");
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">User: </td>
	     <td class="formtablec2"> 
%               $ui->selectLookup(object=>$o, column=>"person", lookup=>"Person", edit=>"$editmgmt", linkPage=>"view.html");
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">Out-of-band hostname: </td>
	     <td class="formtablec2">
%               $ui->textField(object=>$o, column=>"oobname", edit=>$editmgmt);
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">Out-of-band tel: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"oobnumber", edit=>$editmgmt);
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">SNMP Community: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"community", edit=>$editmgmt);
	     </td>
	</tr>
       </table>
     </td>
     <td valign="top" width="50%">
      <table border="0" width="100%">
         <tr>
	   <td class="formtablec1">Monitored?: </td>
	     <td class="formtablec2"> 
%                $ui->radioGroupBoolean(object=>$o, column=>"monitored", edit=>$editmgmt);
	     </td>
	</tr>
         <tr>
	   <td class="formtablec1">Customer-managed?: </td>
	     <td class="formtablec2"> 
%                $ui->radioGroupBoolean(object=>$o, column=>"customer_managed", edit=>$editmgmt);
	     </td>
	</tr>
         <tr>
	   <td class="formtablec1">SNMP-managed?: </td>
	     <td class="formtablec2"> 
%                $ui->radioGroupBoolean(object=>$o, column=>"snmp_managed", edit=>$editmgmt);
	     </td>
	</tr>
         <tr>
	   <td class="formtablec1">Auto-update?: </td>
	     <td class="formtablec2"> 
%                $ui->radioGroupBoolean(object=>$o, column=>"canautoupdate", edit=>$editmgmt);
	     </td>
	</tr>
         <tr>
	   <td class="formtablec1">NATted?: </td>
	     <td class="formtablec2"> 
%                $ui->radioGroupBoolean(object=>$o, column=>"natted", edit=>$editmgmt);
	     </td>
	</tr>
      </td>
     </tr>
    </table>
%	if (! $editmgmt){	 
        <tr>
	   <td class="formtablec1">Fetch SNMP info and update DB</td>
	     <td class="formtablec2"><b><a href="updatedevice.html?host=<% $name %>&action=discover">[update]</a></b></td>
	</tr>
        <tr>
	   <td class="formtablec1">Connect via: </td>
	   <td colspan="2" class="formtablec2" ><a href="http://<% $name %>">[HTTP]</a> <a href="ssh://<% $user %>@<% $name %>">[SSH]</a> <a href="telnet://<% $name %>">[Telnet]</a></td>
	</tr>
%       } 
  </table>

% if ($editmgmt){	 
    </form>
% }

<!-- End Management Table -->

  </td>
 </tr>
 <tr>
  <td colspan="2">

<!-- Interface Table -->

  <table border="0" width="100%" align="left" class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle"> 
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Interfaces</th>
%	 if ($editints){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&editints=1">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0" width="100%">
        <tr>
%	   if ($editints){	 
	      <td align="center">[del]</td>
%	   }
	   <td valign="top" align="left"><strong>No.</strong></td>
	   <td valign="top" align="left"><strong>Name</strong></td>
	   <td valign="top" align="left"><strong>Speed</strong></td>
	   <td valign="top" align="left"><strong>Duplex</strong><br>[oper/admin]</td>
	   <td valign="top" align="left"><strong>Status</strong><br>[oper/admin]</td>
	   <td valign="top" align="left"><strong>VLAN</strong></td>
	   <td valign="top" align="left"><strong>Jack</strong></td>
	   <td valign="top" align="left"><strong>Descr.</strong></td>
	   <td valign="top" align="left"><strong>Uplink<br>Connections</strong></td>
	   <td valign="top" align="left"><strong>Downlink<br>Connections</strong></td>
        </tr>

%	#####################################
%	# Sort numerically by port number
%	#
%	# Hub ports have dots, so add a fake '.0' after numbers with no dots, and then
%	# split in two and sort first part and then second part
%	# (i.e: 1.10 goes after 1.2)
%	my @tmp;
%	foreach my $if ($o->interfaces) {
%	   my $num = $if->number;
%	   if ($num !~ /\./ ){
%	      $num .= '.0';
%	   }
%	   push @tmp, [(split /\./, $num), $if];
%	}	
%	my @ordered_ifs = sort { $a->[0] <=> $b->[0] 
%	                                  ||
%			         $a->[1] <=> $b->[1] } @tmp;
			  
%       foreach my $if (map { $_->[2] } @ordered_ifs){
%         next if ( ! exists $ifvlans{$if}{$showvlan} && $showvlan ne "all");
%	  $ci = ($ci + 1) % 2;
	  <tr class="<% $cssitem{$ci} %>">
%	       if ($editints){	 
		<td align="left">
		  <input type="checkbox" name="<% "Interface__" . $if->id . "__delete" %>" >
		</td>	   
%	       }
	   <td align="left"> 
%               $ui->textField(object=>$if, column=>"number", edit=>$editints, htmlExtra =>"style=\"width: 20px;\"", linkPage=>"view.html");
	   </td>
	   <td align="left"> 
%               $ui->textField(object=>$if, column=>"name", edit=>$editints, htmlExtra =>"style=\"width: 80px;\"");
	   </td>
	   <td align="left"> 
               <% $if->speed %>
	   </td>
	   <td align="left"> 
               <% $if->oper_duplex %>/<% $if->admin_duplex %>
	   </td>
	   <td align="left"> 
               <% $if->oper_status %>/<% $if->admin_status %>
	   </td>
	   <td align="left"> 
%	      if (exists $ifvlans{$if}){
%	         my @links;
%	         foreach my $v ( keys %{$ifvlans{$if}} ){
%		   push @links, sprintf("<a href=\"view.html?table=Vlan&id=%s\">%s</a>", $v, $v );
%		 }
%		 print join ', ', @links;
%	      }
	   </td>
	   <td align="left">
%           $ui->selectLookup(object=>$if, table=>"Interface", column=>"jack", lookup=>"HorizontalCable", 
%                             edit=>$editints, linkPage=>"cable_horizontal.html");
	   </td>
	   <td align="left"> 
%               $ui->textField(object=>$if, column=>"description", edit=>$editints);
	   </td>

<!-- UpLink Connections Field -->
	   <td align="left">
%	   my @parents = $if->parents;
%	   if (scalar(@parents)){
%	     foreach my $par (@parents){	   
%		 my $lbl = $ui->getobjlabel($par->parent, ", ");
%	      	 if ($editints){	 
%		 # Check for amount of objects in table before retrieving all
%		    my $count = Interface->count_all;
%		    if ( $count <= $maxselect ){			      
%		       my @allifs = Interface->retrieve_all;
%		       @allifs = sort { $a->number <=> $b->number } @allifs; 
   		       <select name="<% "InterfaceDep__" . $par->id ."__parent" %>">
		         <option value="$par->parent->id" selected><% $lbl %> </option> 
%		          foreach my $if ( @allifs ) {
		            <option value="<% $if->id %>"><% $ui->getobjlabel($if, ", ") %></option>
%			  }
		         <option></option> 
		       </select>
%		    }else{  #too many instances.  Offer a keyword search
%		       my $srchf = '_' . $if->id . 'parent_srch';  #name of the form input tag
                       <input type="text" name="<% $srchf %>" value="Keywords">&nbsp;
		       <input type="button" name="" value="List" 
		       onClick="sendquery(<% "_InterfaceDep__" . $par->id . "__parent" %>, <% $srchf . '.value' %>, 'Interface')" >
		       <br><select name="<% "_InterfaceDep__" . $par->id . "__parent" %>">
		          <option value="<% $par->parent->id %>" selected><% $lbl %></option>
			  <option value="0">[null]</option>
		       </select>
		       <input type="checkbox" name=<% "InterfaceDep__" . $par->id . "__delete" %> >[del]
%		    }
%	         }else{
		    <a href="device.html?id=<% $par->parent->device->id %>"><% $lbl %></a><br>
%		 }
%	     } #foreach my $par
%	   }else{ # No parents exist
%	      if ($editints){	 
%	        my $srchf = '_' . $if->id . 'parent_srch';  #name of the form input tag
		<input type="text" name="<% $srchf %>" value="Keywords">
	        &nbsp;<input type="button" name="" value="List" 
	        onClick="sendquery(<% "_InterfaceDep__" . $if->id ."__newparent" %>, <% $srchf . '.value' %>, 'Interface')" >
	        <br>
		<select name="<% "_InterfaceDep__" . $if->id ."__newparent" %>">
%#	 	  <option value="0">[null]</option>
	        </select>	      
%	     }
%	   }
	   </td>
<!-- End UpLink Connections Field -->
<!-- DownLink Connections Field -->
	   <td align="left">
%	   my @children = $if->children;
%	   if (scalar(@children)){
%	     foreach my $ch (@children){	   
%		 my $lbl = $ui->getobjlabel($ch->child, ", ");
%	      	 if ($editints){	 
%		 # Check for amount of objects in table before retrieving all
%		    my $count = Interface->count_all;
%		    if ( $count <= $maxselect ){			      
%		       my @allifs = Interface->retrieve_all;
%		       @allifs = sort { $a->number <=> $b->number } @allifs; 
   		       <select name="<% "InterfaceDep__" . $ch->id ."__child" %>">
		         <option value="$ch->child->id" selected><% $lbl %> </option> 
%		          foreach my $if ( @allifs ) {
		            <option value="<% $if->id %>"><% $ui->getobjlabel($if, ", ") %></option>
%			  }
		         <option></option> 
		       </select>
%		    }else{  #too many instances.  Offer a keyword search
%		       my $srchf = '_' . $if->id . 'child_srch';  #name of the form input tag
		       <input type="text" name="<% $srchf %>" value="Keywords">
		       &nbsp;<input type="button" name="" value="List" 
		       onClick="sendquery(<% "_InterfaceDep__" . $ch->id . "__child" %>, <% $srchf . '.value' %>, 'Interface')" >
		       <br><select name="<% "_InterfaceDep__" . $ch->id . "__child" %>">
		          <option value="<% $ch->child->id %>" selected><% $lbl %></option>
			  <option value="0">[null]</option>
		       </select>
		       <input type="checkbox" name=<% "InterfaceDep__" . $ch->id . "__delete" %> >[del]
%		    }
%	         }else{
		    <a href="device.html?id=<% $ch->child->device->id %>"><% $lbl %></a><br>
%		 }
%	     } #foreach my $ch
%	   }else{ # No children exist
%	      if ($editints){	 
%	        my $srchf = '_' . $if->id . 'child_srch';  #name of the form input tag
		<input type="text" name="<% $srchf %>" value="Keywords">
	        &nbsp;<input type="button" name="" value="List" 
	        onClick="sendquery(<% "_InterfaceDep__" . $if->id ."__newchild" %>, <% $srchf . '.value' %>, 'Interface')" >
	        <br>
		<select name="<% "_InterfaceDep__" . $if->id ."__newchild" %>">
%#	 	  <option value="0">[null]</option>
	        </select>	      
%	     }
%	   }

	   </td>
<!-- End DownLink Connections Field -->

	  </tr>
%       } #foreach
     <tr>
%    if ($editints){	 
            <td colspan="8" width="100%" align="right">
	       <input name="submit" value="save" type="submit">
	    </td>
	    </form>
%    }else{
	    <form action="device.html" method="POST">
	      <td colspan="8" width="100%" align="left">
	        Manually 
	        <input type="hidden" name="id" value="<% $id %>">
	        <input type="submit" name="intadd" value="Add">
	        <input type="text" name="intaddnum" value="0" size="3"> interfaces
              </td>
	    </form>
%    }
     </tr>
     </table>
    </td>
       </tr>
  </table>
<!-- End Interface Table -->

 </td></tr>
</table>
<!-- End Margins Table -->
%} # if !defined search


<%args>
$id       => undef
$search   => undef
$edit     => undef
$editgen  => undef
$editloc  => undef
$editmgmt => undef
$editips  => undef
$editints => undef
$ipsort   => "Ipblock.address"
$s2name   => "Management"
$user     => $ENV{REMOTE_USER}
$showvlan => "all"
$intadd   => undef
$submit   => undef
</%args>

<%init>
my $DEBUG = 0;
my $ui = Netdot::UI->new();
my $dns = Netdot::DNSManager->new();
my $ipm = Netdot::IPManager->new();
my %cssitem = ( 0 => "formtablec1", 1 => "formtablec2" );
my $maxselect = 100;
my $o = undef;
my $ci = 0;
my %arg;
my $name;
my %ifvlans;
my %vlans;
my $list;
my @ips;

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

if ( defined($search) && $search =~ /\w+/ ){
    unless ( ($list = $dns->getdevbynamelike($search)) ){
	$m->comp("index.html", title => "Device Worksheet: $name ", s2name => $s2name);
	print  "<p><b>No results</b>";
	$m->comp("footer.mhtml");
	$m->abort;
    }
    my $num = scalar(@$list);
    if ( $num == 1 ){
	# Don't offer list.  Just display device
	$o = $list->[0];
	$id = $o->id;
	$search = undef;
    }

}elsif ( defined($search) && $search !~ /\w+/ ){
    $m->comp("index.html", title => "Device Worksheet: $name ", s2name => $s2name);
    print "<p><b>No search criteria</b>";   
    $m->comp("footer.mhtml");    

}elsif( $intadd ){
	# Add a group of interfaces
	if (defined ($ARGS{intaddnum}) &&  $ARGS{intaddnum} > 0){
	    my %tmpint;
	    $tmpint{device}    = $id;
	    $tmpint{monitored} = 0;
	    $tmpint{number}    = 1000;
	    my $i;
	    for ($i = 0; $i < $ARGS{intaddnum}; $i++){
		$tmpint{number}++;
		if (!($ui->insert(table => "Interface", state => \%tmpint)) ){
		    $m->comp('error.mhtml', error => $ui->error);
		}
	    }
	}
}elsif( $submit ){
	# insert/update
	if (!$ui->form_to_db(%ARGS)){
	    $m->comp('error.mhtml', error => $ui->error);
	}
}

if ($id){
    $o = Device->retrieve($id);
    $name = ($o->name && $o->name->name) ? $o->name->name : "Name N/A!";

    # Build a hash of Interface Vlans
    foreach my $if ($o->interfaces){
	if (scalar( my @ifv = $if->vlans)){
	    foreach my $ifv (@ifv){
		my $vid = $ifv->vlan->vid;
		$ifvlans{$if}{$vid} = "";
		$vlans{$vid} = "";
	    }
	}
    }
    
    Ipblock->set_sql(allips => qq{
	SELECT Device.id, Interface.id, Interface.name, Interface.device, Ipblock.id, Ipblock.interface, Ipblock.address
	    FROM Ipblock, Interface, Device
	    WHERE Interface.id = Ipblock.interface AND
	    Device.id = Interface.device AND
	    Device.id = ?
	    ORDER BY $ipsort
	});
    
    
@ips = Ipblock->search_allips($o->id);

}else{
    $name = "Search";
}


</%init>

<%doc>
-- Device Worksheet --
Interface for viewing/updating a particular Device 
and all its relevant info in one page

</%doc>
