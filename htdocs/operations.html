<%doc>
$Id$

-- Operations Worksheet -- 

Interface (similar to device worksheet) for viewing/updating
NOC relevant information.  This includes customer contacts, 
devices, sites, circuits.

</%doc>
%
%
<%args>
$id     => undef
$table  => undef
$search => undef
$_action => undef
$status => undef
$view   => "Basics"
$edit   => undef
$user => undef
</%args>
%
%
<%flags>
inherit => 'section_operations.html' 
</%flags>
%
%
<%attr>
title   => 'Operations' 
section => 'Operations'
</%attr>
%
%
<%init>
my $DEBUG     = 0;
my %cssitem   = ( 0 => "formtablec1", 1 => "formtablec2" );
my $maxselect = 100;
my $obj       = undef;
my $ci        = 0;
my $list;
my $name;
my @tables;
my %arg;
my %results;
my %stables;
my %entities;
my %caller_args = $m->caller_args(-1);

@{ $list } = ();
if( exists( $caller_args{page} ) ) {
    $user->setAttribute($r, "OPERATIONS_PAGE", $caller_args{page});
}
my $page = $user->getAttribute("OPERATIONS_PAGE");

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;


if( $search ) {

    @tables = qw( Connection Device Entity Person Site RR );
    if( defined( $search ) && $search =~ /\w+/ ) {

        # walk through a set of tables and search each column
        foreach my $tbl ( @tables ) {
            my @columns = $tbl->_essential();
            if( $tbl ne "Connection" && $tbl ne "RR" ) {
                push @columns, "aliases";
            }
            my %linksto = $ui->getlinksto($tbl);
            foreach my $col ( @columns ) {
                if( $col eq "id" || $linksto{$col} ) {
                    next;
                } else {
		    $stables{$tbl}{$col} = 1;
                }
            }
        }
        foreach my $tbl ( keys %stables ) {
            foreach my $col ( keys %{ $stables{$tbl} } ) {
                my $q = "%" . $search . "%";
                map { 
                    $results{$tbl}{$_->id} = $_ 
                } $tbl->search_like( $col => $q );
            }
        }

    } elsif( defined( $search ) && $search !~ /\w+/ ) {

        print "<p><b>No search criteria</b>";
        $m->abort;

    } elsif( defined( $id ) && defined( $table ) ) {

        $obj = $table->retrieve($id);
        if( ! defined( $obj) ) {
            $m->comp( 'error.mhtml', error => "Could not retrieve $table with id $id" );
        }

    }

} elsif( $status ) {

    @tables = qw( BGPPeering Device Interface IpService );

} elsif( defined( $id ) && defined( $table ) ) {

     $obj = $table->retrieve($id);
     if( ! defined( $obj) ) {
         $m->comp( 'error.mhtml', error => "Could not retrieve $table with id $id" );
     }
}

if( %results ) {

    # Tables with entity column: Connection Device Person
    # Site must use EntitySite to look up the corresponding Entity
    foreach my $tbl ( keys %results ) {
        foreach my $id ( keys %{ $results{$tbl} } ) {
            if( $tbl eq "RR" ) {
                my $s = ( Device->search( name => $results{$tbl}{$id} ) )[0];
                if( $s ) {
		    $results{"Device"}{$s->id()} = $s;
                }
                delete( $results{$tbl}{$id} );
            }
        }
    }
    delete( $results{"RR"} );
    if( %results && scalar( keys %results ) == 1 ) {
        my $tbl = ( keys %results )[0];
        if( scalar( keys %{ $results{$tbl} } ) == 1 ) {
            undef( $search );
            $obj = ( values %{ $results{$tbl} } )[0];
	    $table = $tbl;
            $id = $obj->id();
        }
    }
    if( defined( $search ) ) {
        foreach my $tbl ( keys %results ) {
	    map {
                push @{ $list }, $results{$tbl}{$_}
            } keys %{ $results{$tbl} };
        }
    }

} elsif( $obj ) {

    ; # do nothing

} else {

    print  "<p><b>No results</b>";
    $m->abort;

}

</%init>
%
<div id="sectiondetail">
%
% if( $search ) {
%
<div class="containeroutside">
    <div class="containerheadoutside">
       <% scalar( @{$list} ) %> results for <i><% $search %></i>
    </div>
    <div class="containerbodyoutside">
%   foreach my $tbl ( sort keys %results ) {
%       my @list = values %{ $results{$tbl} };
        <div class="container">
            <div class="containerhead">
            <% $tbl %>
            </div>
            <div class="containerbody">
                <& sortresults.mhtml, table => $tbl, object => \@list, view => "row", page => "operations.html", withedit => 1 &>
            </div>
    </div>
%   }
%
% } elsif( $obj ) {
%
% my $lbl = $ui->getobjlabel($obj, ", ");
<div class="containeroutside">
   <div class="containerheadleftoutside">
       <% $table %>: <b><% $lbl %></b>&nbsp;<br/>
       View:
%       if( $view eq "Basics" ) {
       [Basics]
%       } else {
       <a href="operations.html?id=<% $id %>&view=Basics">[Basics]</a>
%       }
    </div>
    <div class="containerheadrightoutside">
%       if( $table eq "Device" ) {
            <a href="device.html?id=<% $id %>&view=<% $view %>"> [view details]</a>&nbsp;
       	    <a href="deldevice.html?id=<% $id %>"> [delete]</a>&nbsp;<br/>
%       } else {
            <br/>
%       }
            <br/>
    </div>
    <div class="containerbodyoutside">
        <% $lbl %>
    </div>
</div>
%
% } elsif( $status ) {

    print  "<p><b>No yet implemented.</b>";

% }
%
</div>

