<& index.html, title => "Cable Plant: Circuit", s2name => $s2name  &>

<%perl>
print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

# code for inserting/updating
# -----------------------------------------------------------------------------
if (defined($ARGS{_action}) && $ARGS{_action} eq "UPDATE_CIRCUIT") {
    my %update_info = ();
    print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
    if (!(%update_info = $ui->form_to_db(%ARGS))) {
        $m->comp("error.mhtml", $ui->error());
	}

    if ($update_info{Circuit}{key}) {
        $id = $update_info{Circuit}{key};
        $editCircuit = 0;
    }

    # Do this to 'flush' the values associated with the object
    # before redisplaying
    $o = undef;
    if ($id && $id ne "NEW") {
        $o = Circuit->retrieve($id);
    }
} elsif (defined($ARGS{_action}) && $ARGS{_action} eq "ADD_STRANDS" && $ARGS{sequence_list}) {
    my @sequences;
    if (UNIVERSAL::isa($ARGS{sequence_list}, "ARRAY")) {
        @sequences = @{$ARGS{sequence_list}};
    } else {
        push(@sequences, $ARGS{sequence_list});
    }

    my $circuit_id = $o->id;
    foreach my $seq (@sequences) {
        $cable_manager->assigncircuit($circuit_id, split(/,/o, $seq));
    }
}
# end insertion/update code
# -----------------------------------------------------------------------------
</%perl>

% if (defined($o) && $o->connectionid) {
<!-- Header Table -->
<table border="0" width="95%" align="center" cellpadding="3" cellspacing="0" class="tablebackground">
 <tr class="rowtitle0">
    <td align="left">
        Circuit for Connection: <a href="view.html?table=Connection&id=<% $o->connectionid %>"><% %></a>&nbsp;&nbsp;&nbsp;
    </td>
 </tr>
</table>
% }

<!-- Circuit Table -->
<table border="0" width="95%" align="center"  class="tablebackground">
    <tr>
    <td valign="top" width="50%" align="center">
        <form name="netdotform" action="circuit.html" method="POST">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="_action" value="UPDATE_CIRCUIT">
        <input type="hidden" name="s2name" value="<% $s2name %>">
        <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
        <tr class="formtabletitle">
            <td colspan="2" align="left">Circuit</td>
%           if ($editCircuit) {
            <td align="right"><input name="submit" value="save" type="submit"></td>
%           } else {
            <td align="right"><a href="circuit.html?id=NEW">[new]</a> || <a href="circuit.html?id=<% $id %>&edit=circuitinfo">[edit]</a> || <a href="delete.html?table=Circuit&id=<% $id %>">[delete]</a></td>
%           }
        </tr>
        <tr align="left" valign="top">
            <td width="40%">
            <table width="100%" border="0" cellspacing="2" cellpadding="0">
            <tr align="left" valign="top">
                <td align="left">Circuit ID: </td>
                <td align="left" class="formtablec2">
%               $ui->textField(object=>$o, table=>"Circuit", column=>"cid", edit=>$editCircuit);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Vendor: </td>
                <td align="left" class="formtablec2">
%               $ui->selectLookup(object=>$o, table=>"Circuit", column=>"vendor", lookup=>"Entity", edit=>$editCircuit);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Near Interface: </td>
                <td align="left" class="formtablec2">
%               if ($editCircuit) {
%                   $ui->selectLookup(object=>$o, table=>"Circuit", column=>"nearend", lookup=>"Interface",
%                                     edit=>$editCircuit);
%               } else {
                    <a href="interface.html?id=<% $o->nearend %>"><% $o->nearend->name %></a>
%               }
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Far Interface: </td>
                <td align="left" class="formtablec2">
%               if ($editCircuit) {
%                   $ui->selectLookup(object=>$o, table=>"Circuit", column=>"farend", lookup=>"Interface",
%                                     edit=>$editCircuit);
%               } else {
                    <a href="interface.html?id=<% $o->farend %>"><% $o->farend->name %></a>
%               }
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Circuit Type: </td>
                <td align="left" class="formtablec2">
%                   $ui->selectLookup(object=>$o, table=>"Circuit", column=>"type", lookup=>"CircuitType",
%                                     edit=>$editCircuit);
                </td>
            </tr>            
            </table>
            </td>
            
            <td width="40%">
            <table width="100%" border="0" cellspacing="2" cellpadding="0">
            <tr align="left" valign="top">
                <td align="left">Speed: </td>
                <td align="left" class="formtablec2">
%               $ui->textField(object=>$o, table=>"Circuit", column=>"speed", edit=>$editCircuit);
                </td>
            </tr>
            
            <tr align="left" valign="top">
                <td align="left">DLCI: </td>
                <td align="left" class="formtablec2">
%               $ui->textField(object=>$o, table=>"Circuit", column=>"dlci", edit=>$editCircuit);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Install Date: </td>
                <td align="left" class="formtablec2">
%               $ui->textField(object=>$o, table=>"Circuit", column=>"installdate", default=>$ui->date(), edit=>$editCircuit);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Connection ID: </td>
                <td align="left" class="formtablec2">
%               $ui->selectLookup(object=>$o, table=>"Circuit", column=>"connectionid", lookup=>"Connection",
%                                 edit=>$editCircuit);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Status: </td>
                <td align="left" class="formtablec2">
%               $ui->selectLookup(object=>$o, table=>"Circuit", column=>"status", lookup=>"CircuitStatus",
%                                 edit=>$editCircuit);
                </td>
            </tr>
            </table>
            </td>
            <td>&nbsp;</td>
        </tr>

        <tr><td colspan="3">&nbsp;<br></td></tr>

        <tr align="left" valign="top">
            <td colspan="2">
            <I>Comments:</I> &nbsp;&nbsp;&nbsp;
%           $ui->textArea(object=>$o, table=>"Circuit", column=>"info",
%                         edit=>$editCircuit, htmlExtra=>"rows='3' cols='80'");
            </td>
            <td>&nbsp;</td>
        </tr>

        <tr><td colspan="3">&nbsp;<br></td></tr>
        </table>
        </form>
    </td>
    </tr>
</table>
<!-- End Circuit Table -->


<!-- Begin Cable Strand Sequence Table -->
%   if (defined($o)) {
%   my @strands = ();
%   foreach my $s ($o->strands) {
%       push(@strands, $s->id);
%   }
    <& display_sequence.mhtml, strands=>\@strands, table_view=>1 &>
%   }

%   # Allow the user to add strands to this circuit by backbone.
%   # First select a start site, then an end site, and then a backbone
%   # from the populated list. Hit submit and all strands for that backbone
%   # are associated with this circuit.
%	if (defined($o) && $edit ne "strandinfo") {
    <script language="JavaScript">
    <!--
        /* getStrandList()
         *
         * Displays list of available strand sequences.
         *
        */
        function getStrandList()
        {
            var start_id = document.add_strand_form.start_id.value;
            var end_id = document.add_strand_form.end_id.value;

            if (!start_id || !end_id)
            {
                alert("You must select a start and end site.");
                return false;
            }

            var url = "get_strand_sequence_list.html?start=";
            url += start_id + "&end=" + end_id;
            url += "&field_name=sequence_list";
            url += "&form_name=add_strand_form";
            var wind = window.open(url, "tmp", "width=1,height=1");
            wind.blur();
        }
    -->
    </script>

    <form name="add_strand_form" action="circuit.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="_action" value="ADD_STRANDS">
    <table border="0" width="700" align="left">
        <tr align="left" class="<% $cssitem{0} %>">
            <td align="center" valign="top" colspan="2"><B>Add Strands</B><hr></td>
        </tr>
        <tr align="left" class="<% $cssitem{0} %>">
            <td align="left" valign="top">
            <%perl>
            my @sites = Site->retrieve_all();
            @sites = sort { $a->name cmp $b->name } @sites;
            </%perl>
                    <input type="hidden" name="page_type" value="BACKBONE">
        Backbones connected from:<br>
        <select name="start_id" style="width: 225px">
        <option value="">-- Make your selection --</option>
        <%perl>
        foreach my $site (@sites) {
            printf("<option value=\"%s\">%s</option>\n", $site->id, $site->name);
        }
        </%perl>
        </select> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<B>- TO -</B><br>
   
        <select name="end_id" style="width: 225px;">
        <option value="">-- Make your selection --</option>
        <%perl>
        foreach my $site (@sites) {
            printf("<option value=\"%s\">%s</option>\n", $site->id, $site->name);
        }
        </%perl>
        </select>
        <input type="button" name="get_bb_list" value="Get Strand List" onClick="getStrandList();">
        </td>
        <td align="left" valign="top">Available Strand Sequence(s):<BR>
        <select name="sequence_list" style="width: 500px;" multiple size="4"></select>
	        &nbsp;<input type="submit" name="strand_add" value="Add">&nbsp;
         </td>
        </tr>
    </table>
    </form>
%   }
</td>
</tr>
</table>
<!-- End Cable Strand Table -->


<%args>
$id => undef;
$edit => undef;
$strand_sort => undef;
$s2name => "Plant";
</%args>

<%init>
my $DEBUG = 0;
my $ui = Netdot::UI->new();
my $cable_manager = Netdot::CablePlantManager->new();
my %cssitem = (0 => "formtablec1", 1 => "formtablec2");
my $o = undef;
my $editCircuit = 0;
my $editStrand = 0;

$o = Circuit->retrieve($id) if ($id && $id ne "NEW");
$editCircuit = 1 if ($id eq "NEW" || $edit eq "circuitinfo");
$editStrand = 1 if ($edit eq "strandinfo");
</%init>
