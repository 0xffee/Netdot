<%doc>

Performs advanced searches in specific tables.
User is allowed to specify values for one or more fields.
Fields that are foreign keys are shown as a drop-down list of possible values.
If the foreign table has more than $maxselect objects, the user will be 
presented with a text box to fill in with keywords.  A javascript
script will then call another CGI which will return a set of matched 
objects.  These will be copied to the list of <options>

Arguments:
   table - The name of the table to search
   res   - A flag to distinguish between showing the form or 
           showing the results
   ARGS  - The rest are fields to be passed to the 
           search_like method. 

</%doc>

<%args>
$table => undef
$res   => undef
</%args>

<%flags>
inherit => 'section_generic.html' 
</%flags>

<%attr>
title   => 'Specific Search' 
section => 'Generic'
</%attr>

<%init>
my $maxselect = 100;
my $DEBUG     = 0;

print "%ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

my %reserved = ( 'user'   => '',
		 'submit' => '',
		 'table'  => '',
		 'res'    => '',
);         

unless ( $table ){ # offer a list of tables to select

  $m->comp( 'table.mhtml', width => 3, link => "search_obj.html", title => "Please select a table to search:");

} else {  # we have a table

   # Get some Meta info
    my %linksto   = $ui->getlinksto($table);

</%init>

%if ( ! $res ){ # show the fill-out form

<script language="javascript" src="select.js"></script>

<form name="netdotform" action="search_obj.html" method="POST">
   <input type="hidden" name="res" value="1">

   <table width="100%"  cellpadding="3" cellspacing="1" border="0" class="formtablebg">
      <tr class="rowtitle0"> 
         <td colspan="2" align="center">
            <strong>Specify one or more of the following as search criteria:</strong>
	 </td>
      </tr>
      <tr>
         <td>
            <& form.mhtml, table => $table, allow_create => 0  &>     
         </td>
      </tr>
      <tr class="rowtitle0" >
         <td align="center" colspan="2">
	    <input name="submit" value="Search" type="submit">
	    <input type="reset">
	 </td>
      </tr>
   </table>
</form>

%   } else { # Process input and search
<%perl>

my %sarg;

foreach my $j (keys %ARGS){
    
    # Ignore empty, zeroed and reserved fields
    next unless ( $ARGS{$j} );
    next if ( exists $reserved{$j} );
    next if ( $j =~ /_srch/ );
    
    # "/^_/" is added to avoid using reserved words in javascript
    # chop it off
    my $k = $j;
    $k =~ s/^_//;
    $sarg{$k} = $ARGS{$j};	   
    
    if (! exists( $linksto{$k} )){  # The column is 'local'
	$sarg{$k} = "%" . $sarg{$k} . "%";  # Add wildcards
    }
}
print "sarg is  <pre>", Dumper(%sarg), "</pre><br>" if $DEBUG;

# Check that we have at least one parameter
unless (scalar keys(%sarg)){
    $m->comp('error.mhtml', error => "Missing Search Criteria");	    
}
my @objs = $table->search_like(\%sarg);

</%perl>
<table align="center" border="0" width="100%">
   <tr>
      <td>
         Total matches: <strong><% scalar (@objs) %></strong>
      </td>
   </tr>
   <tr>
      <td>
         <& sortresults.mhtml, table => "$table", object => \@objs, view => "row", withdelete => 1 &>
      </td>
   </tr>
</table>

<p><br>

%   } # endif !res


%} 
