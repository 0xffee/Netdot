<%perl>
foreach	my $j (keys %ARGS){
	next if ($ARGS{$j} !~ /\w+/ || $j eq 'submit');
	$arg{$j} = $ARGS{$j};	
}	

unless ( $arg{table} && $arg{id} ){
   print "<strong>Missing required parameters 'table' and/or 'id'</strong>";
   exit;
}
$table = $arg{table};
$obj = $table->retrieve($arg{id});

# Get some Meta info
$mi = (Meta->search( name => $arg{table} ))[0];
undef( %linksto );
map { my($j, $k) = split( /:/, $_ ); $linksto{$j} = $k }
   split( /,/, $mi->linksto );
undef( %linksfrom );
map { my($i, $j, $k) = split( /:/, $_ ); $linksfrom{$i}{$j} = $k }
   split( /,/, $mi->linksfrom );
my $i = 1;
undef( %order );
if( defined( $mi->columnorder ) ) {
   map { $order{$_} = $i++; } split( /,/, $mi->columnorder );
} else {
   $order{"id"} = $i++;
   foreach ( sort { $a cmp $b } $mi->name->columns() ) {
      next if( $_ eq "id" );
      $order{$_} = $i++;
   }
}
</%perl>


%#  Display-only option
%if( !$arg{edit} ) {

<& header, title=>" $table Details" &>

% # First show values that are not foreign keys
<p><br> 
<table cellpadding="3" cellspacing="1" border="0" bgcolor="CCCCCC">
<tr> 
<td align="left" bgcolor="#FFFFFF"><strong><% $table %></strong></td>
<td align="right" colspan="2" bgcolor="#FFFFFF"><a href="expview.html?table=<% $table %>&id=<% $obj %>&edit=1">edit</a>
&nbsp;<a href="delete.html?table=<% $table %>&id=<% $obj %>&edit=1">delete</a>
</td>
</tr>

%   foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%      next if ($c eq 'id' || $c eq 'aliases');
       <tr> 
       <td bgcolor="#DDDDDD"><% $c %>:</td>
%      if (!exists($linksto{$c}) ){
	  <td><strong><% $obj->$c %></strong></td>
%      }else{
         <td>
         <table cellpadding="3" cellspacing="1" border="0" bgcolor="CCCCCC">
         <tr><td>
%	 my $fkobj;
%	 unless( defined($obj->$c) && defined($fkobj = $linksto{$c}->retrieve($obj->$c->id) )){
	 - </td></tr></table> 
%	 next;
%        }
         <& sortresults.html, table => $linksto{$c}, object => [$fkobj]  &>
         </td></tr>
         </table>
	 </td>
%      }
     </tr>
%   }
</tr>
<tr> 
</tr>
</table>

%# List all the has_many objects for this object             
%foreach my $i (keys %linksfrom){
%  my ($j, $rtbl, @robjs, @jobjs, $col);
%  map { $j = $_ } keys %{ $linksfrom{$i} };
%  my $meta = ( Meta->search(name => $j) )[0];
%  # Do some magic if table is a join table
%  if ( defined($meta) && ($meta->mainobject == 0) ){
%     @jobjs = $obj->$i();  # these are the join table objects
%     next unless (scalar(@jobjs));
%     my $jclass = ref($jobjs[0]);  #name of the join table class
%     # Pick the fk column of the other table
%     map { $col = $_  if ($_ ne $linksfrom{$i}{$j}); } $jclass->columns();
%     map { push @robjs, $_->$col } @jobjs;
%     $rtbl = ref($robjs[0]); 
%  } else{
%     @robjs = $obj->$i();
%     next unless (scalar(@robjs));
%     $rtbl = $j;
%  }
           <p>
           <table cellpadding="0" border="0"  bgcolor="#CCCCCC">
	   <tr>
           <td><strong><% $i %></strong>
	   <& sortresults.html, table => $rtbl, object => \@robjs, view => "expanded" &>
	   </td></tr>
	   </table>

%}

%} else {     # option edit

<& header, title=>" Edit $table Details" &>
<p><br>
   <form action="update.html" method="POST">
      <& form.html, table => $table, id => $arg{id} &>
      <p><br>
      <input name="submit" value="Update" type="submit">
      <input name="cancel" value="Cancel" type="submit">
   </form>

%} #endif ($arg{edit})

<p>
<& footer &>
<%init>
use lib "/home/netdot/public_html/lib";
use Netdot::DBI;

my( %arg, %linksto, %linksfrom, $obj, $table, $mi, %order);
               
</%init>

<%doc>

######################################################################
#  $Log: view.html,v $
#  Revision 1.10  2003/05/23 01:10:11  netdot
#  Took out the object id from the display
#  Added a cancel button in edit option.
#  Ignores 'aliases' fields at display time
#  Hides join tables when referring to has_many objects
#
#  Revision 1.9  2003/05/21 17:59:48  netdot
#  *** empty log message ***
#
#  Revision 1.8  2003/05/14 16:28:02  netdot
#  added id arg to call to form.html
#
#  Revision 1.7  2003/05/14 16:27:34  netdot
#  initial checkin
#

</%doc>
