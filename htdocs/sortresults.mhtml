<%doc>

Given a list of objects, sorts by given criteria and prints a page with the essential columns.
Performs paging by passing the sorted/indexed list to itself, together with the current offset

Supported arguments:

  table:      name of a table in the database
  object:     reference to a list of objects in that table for displaying in html
  objindex:   sortresults will pass this when calling itself, for paging.
              reference to a hash whose keys are sorted index numbers and value is the object
  view:       [row|column]
  sort:       column to sort by
  page:       page to link to with results (default is view.html)
  withdelete: create a form with a check-box per item, which will call delete.html
  withedit:   add the ability to show form fields to edit selected fields in the table

  # The following are passed to itself in subsequent calls
  per_page:   Maximum entries displayed per page
  offset:     Current position
  total:      Total number of items in list
  sid:        Session id
</%doc>

<%args>

$table      => undef
$object     => undef
$view       => "column"
$sort       => undef
$page       => undef
$withdelete => 0
$withedit   => 0
$per_page   => 50;
$offset     => 0;
$total      => undef;
$sid        => undef;

</%args>

<%init>
my %tags;
my %linksto;
my %linksfrom;
my %order;
my $cellspc    = 0;
my $cellpad    = 0;
my $lbl;
my %cssitem    = ( 0 => "formtablec1", 1 => "formtablec2" );
my $ci         = 1;
my $last_item;
my $session;
my $TMP = $ui->{config}->{TMP};
my %objindex;

my $DEBUG      = 0;
my $numcols    = 0;

print "<pre>", Dumper(%ARGS), "</pre>" if $DEBUG;

# Things to do on first call

if ( defined ($object) ){
    unless ( $session = $ui->mksession( $TMP ) ){
	$m->comp('error.mhtml', error => $ui->error);
    }
    # Determine table name if not passed to us
    #
    unless ( $table ){
	if ( my $fo = $object->[0] ){
	    $table = $fo->table;
	}else{
	    print "No elements";
	    $m->abort;
	}
    }
    # Some tables have a specific view page. 
    # Point to those when appropriate
    #
    my %viewpage = ( BinFile => "display_bin.html",
		     Ipblock => "ip-ws.html",
		     Device  => "device.html",
		     );
    unless ( $page ){
	foreach my $tname ( keys %viewpage ){
	    if ($table eq $tname){
		$page = $viewpage{$tname};
		last;
	    }
	}
    }
    $page ||= "view.html";
    if( $view ) {
	unless ( $view eq "row" || $view eq "column" ) {
	    $m->comp('error.mhtml', error => "Invalid value for view: $view");
	}
    }

    my $i = 0;
    ##############################################
    # get the label for this table (as defined in Meta)
    $lbl = ($ui->getlabels( $table ))[0];
    
    ##############################################
    # If sort arg
    if( defined( $sort ) ) {
	if ( $sort == 0 || $sort eq "no"){
	    # We're told not to sort
	    map { $objindex{$i++} = $_ } @{ $object };
	}else{
	    my(%col);
	    map { $col{$_}++ } $table->columns;
	    if( exists( $col{ $sort } ) ) {
		map { $objindex{$i++} = $_ } sort { $a->$sort cmp $b->$sort } @{ $object };
	    }
	}
	##############################################
	# If no sort arg, sort by actual label
	# 
    }else{
	my @labels = $ui->getlabelarr( $table );
	map { $objindex{$i++} = $_ } map  { $_->[0] }
	sort { $a->[1] cmp $b->[1] }
	map { [$_ , $ui->getlabelvalue($_, \@labels)] } @{ $object };
	
    }
    # Total number of items
    $total = $i;
    
    ##############################################
    # get linksto info
    %linksto = $ui->getlinksto( $table );
    ##############################################
    # define order
    %order   = $ui->getcolumnorderbrief( $table );
    ##############################################
    # Get tags
    %tags = $ui->getcolumntags( $table );
    ##############################################
    # remove id and aliases (if present)
    if( exists( $order{id} ) ) {
	delete( $order{id} );
    }
    if( exists( $order{aliases} ) ) {
	delete( $order{aliases} );
    }
    ##############################################
    # munge so that label is first 
    if( defined( $lbl ) && length( $lbl ) > 0 ) {
	unless( $order{$lbl} == 1 ) {
	    my $j        = $order{$lbl};
	    my %rev      = reverse %order;
	    my $k        = $rev{1} ;
	    $order{$k}   = $j;
	    $order{$lbl} = 1;
	}
    }
    
#########################################################
# This happens on subsequent calls (paging)
#
}elsif( $sid ) {
    unless ( $session = $ui->getsession( $TMP, $sid ) ){
	$m->comp('error.mhtml', error => $ui->error);
    }
    %linksto    = %{ $session->{linksto} };
    %order      = %{ $session->{order} };
    %tags       = %{ $session->{tags} };
    %objindex   = %{ $session->{objindex} };
    $table      = $session->{table};
    $page       = $session->{page};
    $view       = $session->{view};
    $sort       = $session->{sort};
    $withdelete = $session->{withdelete};
    $withedit   = $session->{withedit};
    $offset     = $session->{offset};    
    $total      = $session->{total};    

print "<pre>", Dumper($session), "</pre>" if $DEBUG;

}

# Calculate last item to show
$last_item = ( ($offset + $per_page) < $total )? $offset + $per_page : $total;

</%init>

%
% if( %objindex ) {

<!-- begin sortresults -->
% #####################################################################
% # Begin the table for this instance of sortresults
% #####################################################################
% if( $view eq "row" ) {
%   ($cellspc, $cellpad) = ( 0, 0 );
%   $numcols = scalar keys %order;
% } elsif( $view eq "column" ) {
%   ($cellspc, $cellpad) = ( 0, 1 );
%   $numcols = 2;
% }

% if ( $withedit || $withdelete ) {
    <form action="edit-multiple.html" method="post" name="form_<% $table %>">
    <input type="hidden" name="table" value="<% $table %>">
% }

% if ( $withedit ) {
  <script language="javascript">
  <!--
    function toggleEditLayers(table) {
        toggleLayer('fieldchoices_'+table);
    }
    function docheckboxes_<% $table %>() {
        // if no checkboxes are selected, select them all
        var ids = new Array();
%       my $pos = $offset;
%       my $i=0;
%       while ( $pos < $last_item ) {
%           my $o;
%           if ( $o = $objindex{$pos} ){
                ids[<% $i %>] = <% $o->id %>;
%           }
%           $pos++; $i++;
%       }
        var docheckall = 1;
        for(i=0; i<ids.length; i++) {
            docheckall = docheckall & !document.getElementById('edit_check_'+ids[i]).checked;
        }
        if( docheckall == 1 ) {
            for(i=0; i<ids.length; i++) {
                document.getElementById('edit_check_'+ids[i]).checked = 1;
            }
        }
    }
  //-->
  </script>

  <div class="container" style="margin:3px;display:none" id="fieldchoices_<% $table %>">
    <div class="containerheadleft">Choose fields to edit</div>
    <div class="containerheadright"><a href="javascript:toggleEditLayers('<% $table %>')">[hide]</a></div>
    <div class="containerbody">

%   my %order        = $ui->getcolumnorder( $table );
%   my %orderbrief   = $ui->getcolumnorderbrief( $table );
%   my %tags         = $ui->getcolumntags( $table );
%
%   my @cells;
%
%   foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%     next if( $c eq 'id' );
%       my $caption;
%       if ( exists($tags{$c}) ){
%           $caption = $tags{$c};
%	    }else{
%           $caption = $c;
%	    }
%       my $selected = "";
%       if ( exists($orderbrief{$c}) ) {
%           $selected = " CHECKED";
%       }
%       my $html = '<input type="checkbox" name="tablefields[]" value="'.$c.'" '.$selected.'>'.$caption;
%
%       push(@cells, $html);
%
%   }
    <& wrapping_table.mhtml, data => \@cells, cols => 5  &>     
    <div align="right">
        <input type="submit" name="submit" value="Go" onclick="docheckboxes_<% $table %>()">
    </div>

    </div>
  </div>
% }

% if ( $withdelete ){
%   $numcols += 1;
% }
  <table border="0" cellspacing="<% $cellspc %>" cellpadding="<% $cellpad %>" class="tablebackground">
% ##################################################################
% # If the VIEW is a row, print the column headers.  
% # Otherwise, print an empty row.
% #####################################################################
%    if( $view eq "row" ) {
       <tr class="rowtitle2">
%      foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%        if( exists( $tags{$c} ) ) {
           <th><% $tags{$c} %></th>
%        } else {
           <th><% $c %></th>
%	     }
%      }
%      if ( $withdelete ){
           <th>Delete</th>
%      }
%      if ( $withedit ){
           <th align="center"><a href="javascript:toggleEditLayers('<% $table %>');">Edit</a></th>
%      }
       </tr>
%    } else {
       <tr>
          <td colspan="<% $numcols %>" class="delimiter"></td>
       </tr>
%    }

% ####################################################################
% # Loop around the window of items that we are showing in this page
% ####################################################################

% my $pos = $offset;
% while ( $pos < $last_item ) {
%    my $o;
%    unless ( $o = $objindex{$pos} ){
%	$m->comp("error.mhtml", error=>"Object not valid at index $pos");
%    }
%    $pos++;
%    my $flag = 1;
%    $ci = ($ci + 1) % 2;

% ####################################################################
% # Print relevant delimiters for whether a ROW or COLUMN view
% ####################################################################

%
%    if( $view eq "row" ) {
      <tr class="<% $cssitem{$ci} %>">
%    } elsif( $view eq "column" ) {
    <tr height="1" class="delimiter">
      <td colspan="<% $numcols %>" height="1"></td>
    </tr>
%    }
%
% ####################################################################
% # Get the column order and process each item.
% ####################################################################
%    my @order = sort { $order{$a} <=> $order{$b} } keys %order;
%    foreach my $c ( @order ) {
%
% ####################################################################
% # If a COLUMN view, start a row with the column name.
% #####################################################################
%
%       if( $view eq "column" ) {
          <tr class="<% $cssitem{$ci} %>">
           <td align="right" valign="top" width="18%">
%	     if ( exists($tags{$c}) ){
               <b><% $tags{$c} %></b>:&nbsp;
%	     } else {
               <b><% $c %></b>:&nbsp;
%	     }
          </td>
%       }
      <td align="left" valign="middle">

% #####################################################################
% # If it is a link to another column....
% #####################################################################

%          if ( exists($linksto{$c}) ) {
%             my $ft = $ui->getmeta( $linksto{$c} );
%             if( ! defined( $ft ) ) {
%             ##########################
%             # foreign table does not exist
      No such object <% $linksto{$c} %>
%             } elsif( int($o->$c) == 0 ) {
%             ##########################
%             # it's a pointing to zero, so it's nada
      &nbsp -
%             } elsif( ! defined( $linksto{$c}->retrieve( int( $o->$c ) ) ) ) {
%             ##########################
%             # the id pointed to does not exist
      &nbsp -
%             } else {
%                my $obj = $linksto{$c}->retrieve( int( $o->$c ) );
%                my $lbl = $ui->getobjlabel( $obj, ", " );
%                if( $flag ) {
      &nbsp;
%                #######################
%                # if flag is set, make the item a url
%#      <strong>
      <a href="<% $page %>?table=<% $table %>&id=<% $o->id %>">
%                   if( length( $lbl ) < 1 ) {
      N/A
%                   } else {
      <% $lbl %>
%                   }
      </a> 
%#      </strong>
%                } else {
%                #######################
%                # otherwise, just print the instance
      <% $lbl %>
%                }
%            }
%          } else {
%
% #####################################################################
% # It s not a pointer to another column
% #####################################################################
%
%             if( $flag ) {
      <a href="<% $page %>?table=<% $table %>&id=<% $o->id %>">
%                if( length( $o->$c ) < 1 ) {
      N/A
%                } else {
      <% $o->$c %>
%                }
      </a>
%             } else {
      <% $o->$c %>
%             }
%          } # else fi
      </td>
% #####################################################################
% # Wrap this row up.
% #####################################################################
%       $flag = 0 if( $flag );          
%       if( $view eq "column" ) {
    </tr>
%       }
%     } # for c
%

%     if( $view eq "column" ) {
%        if ( $withdelete ){
           <tr class="<% $cssitem{$ci} %>">
             <td align="right" valign="top" width="18%">delete</td>
             <td align="left" valign="middle">
               <input type="checkbox" name="<% $table %>__<% $o->id %>">
             </td>
           </tr>
%     }
    <tr height="1" class="delimiter">
      <td colspan="<% $numcols %>" height="1"></td>
    </tr>

%     } elsif( $view eq "row" ) {
%         if ( $withdelete ){
            <td style="text-align:center" valign="middle" width="50">
                <input type="checkbox" id="chk_<% $table.'_'.$o->id %>" name="<% $table %>__<% $o->id %>" onclick="document.getElementById('delete_<% $table.'_'.$o->id %>').checked = document.getElementById('chk_<% $table.'_'.$o->id %>').checked">
            </td>
%         }
%         if ( $withedit ){
            <td style="text-align:center" valign="middle" width="40">
                <input type="checkbox" id="edit_check_<% $o->id %>" name="editids[]" value="<% $o->id %>">
            </td>
%         }
    </tr>
    <tr class="delimiter" height="1">
      <td colspan="<% $numcols %>"></td>
    </tr>
%     }
%} # for o
% ####################################################################

  </table>

% if ( $total > $per_page ){

    <div class="containerheadright">
    Results: [<% $offset+1 %>-<% $last_item %>] of <% $total %> 

%   # Make a new session.  We want to be able to go back
%
%    undef ($session);
%    unless ( $session = $ui->mksession( $TMP ) ){
%      $m->comp('error.mhtml', error => $ui->error);
%    }

%    $session->{linksto}    = \%linksto;
%    $session->{order}      = \%order;
%    $session->{tags}       = \%tags;
%    $session->{objindex}   = \%objindex;
%    $session->{table}      = $table;
%    $session->{page}       = $page;
%    $session->{view}       = $view;
%    $session->{sort}       = $sort;
%    $session->{withdelete} = $withdelete;
%    $session->{withedit}   = $withedit;
%    $session->{offset}     = $last_item;
%    $session->{total}      = $total;

%    if ( $sid ){
        <a href="#" onClick="history.go(-1);">[<<] </a>
%    }
     <a href="list.html?sid=<% $session->{_session_id} %>">[>>] </a>

     </div>
%  }

% if ( $withdelete ){
    <div class="containerheadright">
	   <input type="button" name="submit" value="Delete" onclick="document.deleteform_<% $table %>.submit()">
	   <input type="button" name="cancel" value="Cancel" onClick="history.go(-1);">
    </div>
% }

% if ( $withedit || $withdelete ) {
    </form>
% }

% if ($withdelete) {
    <div style="display:none">
    <form action="delete.html" method="post" name="deleteform_<% $table %>">
%       my $pos = $offset;
%       while ( $pos < $last_item ) {
%           my $o;
%           if ( $o = $objindex{$pos} ){
%               print '<input type="checkbox" id="delete_'.$table.'_'.$o->id.'" name="'.$table.'__'.$o->id.'">';
%           }
%           $pos++;
%       }
    </form>
    </div>
% }

<!-- end sortresults -->
% } # if
