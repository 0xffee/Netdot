<%doc>

  Generic object view
  Uses metadata to display all fields with their values
  and lists of each group of 'has_many' related objects

  Required Arguments:
    table name and either id or position

</%doc>

<%args>
$table
$id
$view    => "all"
$edit    => undef
</%args>

<%flags>
#inherit => 'section_generic.html' 
</%flags>

<%attr>
title   => 'View Object' 
#section => 'Generic'
</%attr>

<%init>
my($obj, $prevobj );
my %ftables;

unless ( $obj = $table->retrieve($id) ){
   $m->comp('error.mhtml', error => "Nonexistent record: $id");
}

my $labelstr  = $ui->getobjlabel($obj, ", ");
my %linksto   = $ui->getlinksto($table);
my %linksfrom = $ui->getlinksfrom($table);
my %order     = $ui->getcolumnorder($table);
my %tags      = $ui->getcolumntags($table);

my $DEBUG = 0;

if ( $DEBUG ){
    print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>';
    print '%linksto is  <pre>', Dumper(%linksto), '</pre><br>';
    print '%linksfrom is  <pre>', Dumper(%linksfrom), '</pre><br>';
    print '%order is  <pre>', Dumper(%order), '</pre><br>';
    print '%tags is  <pre>', Dumper(%tags), '</pre><br>';
}

# List all the has_many objects for this object
#
foreach my $i (keys %linksfrom){
    # Table that points to us
    my $j = (keys %{ $linksfrom{$i} })[0];

    #column in the other table that points to this table
    $ftables{$i}{ffield} = $linksfrom{$i}{$j};  
    
    if ( $ui->isjointable($j) ){
	# Foreign table is a join table
	$ftables{$i}{join} = 1;
	# Get has_a entries 
	my %jlinksto = $ui->getlinksto($j);
	# Column in join table that points to third table
	my $col;
	map { $col = $_ if ($_ ne $linksfrom{$i}{$j}) } keys %jlinksto;
	map { push @{ $ftables{$i}{robjs} }, $_->$col } $obj->$i;
	@{$ftables{$i}{objs}} = $obj->$i;
	$ftables{$i}{dtbl} = $jlinksto{$col};  # table to display
	$ftables{$i}{ctbl} = $j;               # table to pass to create.html
    }else{  
	# table is not a join table
	$ftables{$i}{join} = 0;
	@{$ftables{$i}{robjs}} = $obj->$i;
	$ftables{$i}{dtbl} = $j;
	$ftables{$i}{ctbl} = $j; 
    }
}

print '%ftables is  <pre>', Dumper(%ftables), '</pre><br>' if $DEBUG;

</%init>

<div id="sectiondetail">

%  if ($table !~ /_history/){
      <div class="container">
	<div class="containerhead">View</div>
	   <div class="containerbody">
%	      if ($view eq "all"){
		  [all]
%	      }else{
		  <a href="view.html?table=<% $table %>&id=<% $obj %>&view=all">[all]</a>
%             }
%	      if ($view eq $table){
		  [<% lc($table) %>]
%	      }else{
                  <a href="view.html?table=<% $table %>&id=<% $obj %>&view=<% $table %>">[<% lc($table) %>]</a>
%             }
%             foreach my $i (keys %ftables){
%               if ($view eq $i){
                   [<% $i %>]
%               }else{
                   <a href="view.html?table=<% $table %>&id=<% $obj %>&view=<% $i %>">[<% $i %>]</a>
%               }   
%             }
              <a href="view.html?table=<% $table %>&id=<% $obj %>&view=history">[history]</a>
	   </div>
	</div>
      </div>
%  }

  <div class="containeroutside">

<%perl>

if ($view eq 'all' || $view eq "$table"){
    
    my (@fields, @data);
    
    foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
	next if ($c eq 'id' || $c eq 'aliases');

        my $linkPage;
        if( exists($linksto{$c}) ) {
            $linkPage = 'view.html';
        }
	
        my %tmp;
        %tmp = $ui->form_field(object=>$obj, column=>$c, edit=>0, linkPage=>$linkPage);

        push( @fields, $tmp{label} );
        push( @data, $tmp{value} );
    }

</%perl>

	<div class="containerheadleftoutside"><strong><% $table %></strong></div>
	<div class="containerheadrightoutside">
%         if ($table !~ /_history/){
              <a href="edit.html?table=<% $table %>">[new]</a>
              <a href="edit.html?table=<% $table %>&id=<% $obj %>">[edit]</a>
%	      }
%         if ($table eq "Device"){
              <a href="device.html?id=<% $obj %>">[custom]</a>
%         }elsif ( $table eq "Ipblock" ){
              <a href="ip-ws.html?id=<% $obj %>">[custom]</a>
%         }
          <a href="delete.html?table=<% $table %>&id=<% $obj %>">[delete]</a>
	</div>

	<div class="containerbodyoutside">
	  <& attribute_table.mhtml, field_headers=>\@fields, data=>\@data, 
	                            width=>"2", headercolwidth=>"15%", datacolwidth=>"35%" &>
	</div>
%}
<!-- End Display main object values -->


<!-- Display has_many objects -->

%   foreach my $i (sort keys %ftables){
%     if ( ($view eq 'all' || $view eq $i ) && $view ne "$table"){
          <div class="container">
	    <div class="containerheadleft"><% $i %></div>
	    <div class="containerheadright">
%           if ( $edit eq $i ){	    
               &nbsp;
%           }else{
	       <a href="edit.html?table=<% $ftables{$i}{ctbl} %>&<% $ftables{$i}{ffield} %>=<% $obj %>">[add]</a>
%	       if ( $ftables{$i}{join} && $ftables{$i}{objs} ){
                  <a href="view.html?table=<% $table %>&id=<% $id %>&edit=<% $i %>">[edit]</a>    
%	       }
%           }
	    </div>
%	       if ( $edit eq $i ){
                 <& sortresults.mhtml, table => $ftables{$i}{dtbl}, object => $ftables{$i}{robjs}, view => "row", withdelete => 1, withedit => 1 &>
%	       }else{
                 <& sortresults.mhtml, table => $ftables{$i}{dtbl}, object => $ftables{$i}{robjs}, view => "row" &>
%              }
          </div>
%     }
%   } 

<!-- End Display has_many objects -->

<!-- Display history objects associated with this object-->

%  if ( $view eq 'history' ){
%   my @ho = $ui->gethistoryobjs($obj);
    <& sortresults.mhtml, object => \@ho , view => "row" &>
%  } 

<!-- End Display history objects -->

   </div>
</div>
