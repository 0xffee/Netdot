<%doc>

Given a list of objects, sorts by given criteria and prints a page with the essential columns.
Performs paging by passing the sorted/indexed list to itself, together with the current offset

Supported arguments:

  table:      name of a table in the database
  object:     referece to a list of objects in that table for displaying in html
  sort:       column to sort by
  page:       page to link to with results (default is view.html)
  withedit:   add checkboxes to allow user to edit or delete selected objects

  # The following are passed to itself in subsequent calls
  per_page:   Maximum entries displayed per page
  offset:     Current position
  total:      Total number of items in list
  sid:        Session id
</%doc>

<%args>

$table      => undef
$object     => undef
$sort       => undef
$page       => undef
$withedit   => 0
$per_page   => 50;
$offset     => 0;
$total      => undef;
$sid        => undef;

</%args>

<%init>
my %order;
my %orderbrief;
my $lbl;
my %cssitem    = ( 0 => "formtablec1", 1 => "formtablec2" );
my $ci         = 1;
my $last_item;
my $session;
my %objindex;
my $numcols;
my $DEBUG      = 0;

print "<pre>", Dumper(%ARGS), "</pre>" if $DEBUG;

#########################################################
#
# This happens on first call
#
#########################################################

if ( defined($object) && scalar @$object ){

    ##############################################
    # Determine table name if not passed to us
    $table = $object->[0]->short_class 
	unless $table;

    %order      = $table->meta_data->get_column_order();
    %orderbrief = $table->meta_data->get_column_order_brief();

    ##############################################
    # get the first label field for this table (as defined in metadata)
    $lbl = ($table->meta_data->get_labels)[0];
    
    ##############################################
    # If sort arg
    my $i = 0;
    if( defined( $sort ) ) {
	if ( $sort == 0 || $sort eq "no"){
	    # We're told not to sort
	    map { $objindex{$i++} = $_ } @{ $object };
	}else{
	    my(%col);
	    map { $col{$_}++ } $table->columns;
	    if( exists( $col{ $sort } ) ) {
		map { $objindex{$i++} = $_ } sort { $a->$sort cmp $b->$sort } @{ $object };
	    }
	}
	##############################################
	# If no sort arg, sort by actual label
	# 
    }else{
	# Be smart about sorting numerically or alphabetically
	my @lbls;
	my $alpha = 0;
	foreach my $obj ( @{ $object } ){
	    my $lbl = $obj->get_label;
	    $alpha = 1 if ( $lbl =~ /[A-Za-z]+/ );
	    push @lbls, [$obj , $lbl];
	}
	if ( $alpha ){ 
	    @lbls = sort { $a->[1] cmp $b->[1] } @lbls; 
	}else{
	    @lbls = sort { $a->[1] <=> $b->[1] } @lbls; 
	}
 	map { $objindex{$i++} = $_ } map  { $_->[0] } @lbls;
    }
    # Total number of items
    $total = $i;
    
    ##############################################
    # remove id and aliases (if present)
    if( exists( $orderbrief{id} ) ) {
	delete( $orderbrief{id} );
    }
    if( exists( $orderbrief{aliases} ) ) {
	delete( $orderbrief{aliases} );
    }
    ##############################################
    # munge so that label is first 
    if( defined( $lbl ) && length( $lbl ) > 0 ) {
	unless( $orderbrief{$lbl} == 1 ) {
	    my $j        = $orderbrief{$lbl};
	    my %rev      = reverse %orderbrief;
	    my $k        = $rev{1} ;
	    $orderbrief{$k}   = $j;
	    $orderbrief{$lbl} = 1;
	}
    }
    
#########################################################
#
# This happens on subsequent calls (paging)
#
#########################################################
}elsif( $sid ) {
    $session = $ui->get_session($sid);

    %objindex   = %{ $session->{objindex} };
    $table      = $session->{table};
    %order      = %{ $session->{order} };
    %orderbrief = %{ $session->{orderbrief} };
    $page       = $session->{page};
    $sort       = $session->{sort};
    $withedit   = $session->{withedit};
    $offset     = $session->{offset};    
    $total      = $session->{total};    

    print "<pre>", Dumper($session), "</pre>" if $DEBUG;

}

#########################################################
#
# This happens always
#
#########################################################

# Some tables have a specific view page. 
# Point to those when appropriate
#
unless ( $page ){
    $page = $ui->table_view_page($table);
}
$page ||= "view.html";

# Calculate last item to show
$last_item = ( ($offset + $per_page) < $total )? $offset + $per_page : $total;

if ( $total > $per_page ){
    # Make a session.  We want to be able to go back
    undef ($session);
    $session = $ui->mk_session();
    
    $session->{objindex}   = \%objindex;
    $session->{table}      = $table;
    $session->{order}      = \%order;
    $session->{orderbrief} = \%orderbrief;
    $session->{page}       = $page;
    $session->{sort}       = $sort;
    $session->{withedit}   = $withedit;
    $session->{offset}     = $last_item;
    $session->{total}      = $total;
}

</%init>

%
% if( %objindex ) {

<!-- begin sortresults -->
% #####################################################################
% # Begin the table for this instance of sortresults
% #####################################################################

%     if ( $withedit ) {
         <form name="form_<% $table %>" method="POST" >
         <input type="hidden" name="table" value="<% $table %>">
%     }

      <table border="0" cellspacing="0" cellpadding="0" class="tablebackground">

%     #####################################################################
%     # Header row
      <tr class="rowtitle2">
%     foreach my $c ( sort { $orderbrief{$a} <=> $orderbrief{$b} } keys %orderbrief ) {
%          $numcols++;
%          my $tag = $table->meta_data->get_column($c)->tag;
%          if( defined($tag) ) {
               <th><% $tag %></th>
%          } else {
               <th><% $c %></th>
%	   }
%     }
%     if ( $withedit ){
          <th align="center">Select</th>
%         $numcols++;
%     }
      </tr>
%     ####################################################################
%     # Loop around the window of items that we are showing in this page
%     ####################################################################

%     my $pos = $offset;
%     while ( $pos < $last_item ) {
%         my $o;
%         unless ( $o = $objindex{$pos} ){
%             $m->comp("error.mhtml", error=>"Object not valid at index $pos");
%         }
%         $pos++;
%         my $first_column = 1;
%         $ci = ($ci + 1) % 2;

          <tr class="<% $cssitem{$ci} %>">
%
%         ####################################################################
%         # Get the column order and process each item.
%         ####################################################################
%         my @orderbrief = sort { $orderbrief{$a} <=> $orderbrief{$b} } keys %orderbrief;
%
%         foreach my $c ( @orderbrief ) {
              <td align="left" valign="middle">
%             #####################################################################
%             # If it is a link to another column....
%             #####################################################################
%             my $ftable = $table->meta_data->get_column($c)->links_to;
%             if ( defined $ftable ) {
%                 if ( int(my $fo = $o->$c) != 0  ) {
%                     my $lbl = $fo->get_label;
                      &nbsp;
                      <a href="<% $page %>?table=<% $ftable %>&id=<% $fo->id %>">
%                     if( length( $lbl ) < 1 ) {
                          N/A
%                     }else {
                          <% $lbl %>
%                     }
                      </a> 
%                 }else{
                      &nbsp -
%                 }
%            }else{
%            #####################################################################
%            # It s not a link to another column
%            #####################################################################
%                if( $first_column ) {
                     <a href="<% $page %>?table=<% $table %>&id=<% $o->id %>">
%                    if( length( $o->$c ) < 1 ) {
                         N/A
%                    }else{
                         <% $o->$c %>
%                    }
                     </a>
%               }else{
                    <% $o->$c %>
%               }
%           } # else fi
            </td>
% #####################################################################
% # Wrap this row up.
% #####################################################################
%           $first_column = 0 if( $first_column );          
%     } # for c
%
%     if ( $withedit ){
          <td style="text-align:center" valign="middle" width="40">
              <input type="checkbox" name="<% $table %>__<% $o->id %>">
          </td>
%     }
      </tr>
% } # end while
% ####################################################################

% ## Last row
% if( $withedit ) {
%     my $selectall_ids = join ', ', map { $objindex{$_}{id} } keys %objindex;
      <tr class="rowtitle">
%         for( my $i=0; $i<($numcols-2); $i++ ) {
              <td>&nbsp;</td>
%         }
          <td>
            <div align="right" valign="middle">Select All <% $total %> results:</div>
            <input type="hidden" name="selectall_ids" value="<% $selectall_ids %>">
          </td>
          <td style="text-align:center" valign="middle" width="40">
	      <input type="checkbox" name="selectall" id="selectall">
          </td>
      </tr>
% }
% ## Empty row
      <tr class="rowtitle">
%      for( my $i=0; $i<$numcols; $i++ ) {
           <td>&nbsp;</td>
%      }
      </tr>
  </table>

  <div class="containerheadright">
% if ( $total > $per_page ){
      Results: [<% $offset+1 %>-<% $last_item %>] of <% $total %> 
%     if ( $sid ){
          <a href="#" onClick="history.go(-1);">[<<] </a>
%     }
      <a href="../generic/list.html?sid=<% $session->{_session_id} %>">[>>] </a>
% }
% if ( $withedit ){
      <p>
      <input type="button" name="Edit" value="Edit" onClick="document.form_<% $table %>.action='edit-multiple.html';document.form_<% $table %>.submit();">
      <input type="button" name="Delete" value="Delete" onClick="document.form_<% $table %>.action='delete.html';document.form_<% $table %>.submit();">
      <input type="button" name="Cancel" value="Cancel" onClick="history.go(-1)">
      </p>
      </form>
% }
  </div>


<!-- end sortresults -->
% } # endif %objindex
