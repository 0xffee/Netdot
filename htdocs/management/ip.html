<%doc>
Interface for IP blocks (both addresses and subnets)
</%doc>
%
%
<%attr>
title   => 'IP' 
section => 'Management'
</%attr>
%
%
<%args>
$id                => undef
$user              => $ui->get_current_user($r)
$search            => undef
$_action           => 'SHOW_ROOTS'
$delete            => undef
$recursivedel      => undef
$add_range_start   => undef
$add_range_end     => undef
$add_block_prefix  => undef
$add_block_parent  => undef
$range_owner       => undef
$range_status      => undef
$range_used_by     => undef
$range_description => undef
$range_parent      => undef
$range_gen_dns     => undef
$range_fw_zone     => undef
$range_rev_zone    => undef
$name_prefix       => undef
$name_suffix       => undef
$block_owner       => undef
$block_status      => undef
$block_used_by     => undef
$block_description => undef
$newblock          => undef
$parent            => undef
$length            => undef
$edit              => undef
$edit_children     => undef
$editattr          => undef
$submit            => undef
$rootversion       => 4 
$view_format       => 'block'
$rowsize           => 22
$dividefreespace   => 'max'
$arp_limit         => 10
</%args>
%
%
<%init>
use integer;

my $DEBUG = 0;
my $o;
my $ci = 0;
my $title;
my @list;
my $edit_ip     = ( $edit && $edit eq "ipinfo"    ) ? 1 : 0;
my $edit_block  = ( $edit && $edit eq "blockinfo" ) ? 1 : 0;
my $max_ips     = Netdot->config->get('SHOW_COUNT_THRESHOLD');
my $added_ip    = 0;
my $added_block = 0;
my $covering_block;

# Some regular expressions
my $IPV4 = Netdot->get_ipv4_regex();
my $IPV6 = Netdot->get_ipv6_regex();

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

my $manager = $ui->get_permission_manager($r);

if ( $id ){
    if ( $o = Ipblock->retrieve($id) ){
	# Check if user can view this object
	my $manager = $ui->get_permission_manager($r);
	unless ( $manager && $manager->can($user, "view", $o) ){
	    $m->comp('/generic/error.mhtml', error=>"You don't have permission to view this object");
	}
	$title = $o->get_label;
	if ( $o->version == 6 ){
	    $view_format = 'list' 
		if $view_format eq 'block';
	}
    }else{
	$m->comp('/generic/error.mhtml', error => "Could not retrieve Ipblock id: $id");
    }

    unless ( $manager && $manager->can($user, 'view', $o) ){
	$m->comp('/generic/error.mhtml', error=>"You don't have permission to view this object");
    }


}else{
    $title = "Search";
}

# By default, view object after any operation
# ( some exceptions will override )
my $view = 1;

</%init>
%
<div id="sectiondetail">

<script language="javascript">
<!--

function edit_recursive(id, field, rec){
    var url = "ip-rec.html?id="+id+"&field="+field+"&recursive="+rec;
    var wind = window.open(url, 'Edit recursively', "width=600,height=200");
}

function setCheckbox(formname, name, val) {
    var form = document.forms[formname];
    var myfield = form.getElementsByTagName('input');
    for ( var i = 0; i < myfield.length; i++ ) {
        if ( name && myfield[i].name != name ) continue;
        if ( myfield[i].type != 'checkbox' ) continue;

        myfield[i].checked = val;
    }
}

-->
</script>

<%perl>
#######################################################################################
# Show Root Blocks
#
#######################################################################################
if( $_action eq "SHOW_ROOTS" && !$id && $rootversion ){
    
    unless ( $manager && $manager->can($user, "access_section", 'ip.html:show_roots') ){
	$m->comp('/generic/error.mhtml', error => "You do not have permission to view this section");
    }

    @list = Ipblock->get_roots($rootversion);

</%perl>
       <div class="container">
          <div class="containerheadleft">Root Blocks: (<% scalar(@list) %>)</div>
          <div class="containerheadright">
	    <form name="netdotform" action="ip.html" method="POST">
	      <input type="hidden" name="_action" value="SHOW_ROOTS">
	      Version: <select name="rootversion" onChange="submit();">
%	      foreach my $version ('4', '6', 'all'){
%	        if ( $version eq $rootversion ){
		    <option value="<% $version %>" SELECTED><% $version %></option>
%		}else{
		    <option value="<% $version %>"><% $version %></option>
%		}
%	      }
              </select>
            </form>
	  </div>
          <div class="containerbody">
%             if ( @list ){
                  <& ipblock_list.mhtml, objects => \@list, type => "block"  &>
%             }
          </div>
       </div>

<%perl>
#######################################################################################
# Update
# 
#######################################################################################

}elsif( $_action eq "UPDATE" ){

    if ($submit eq "cancel") {
        # Get rid of the new block
        if ( $id != 0 ){
	    unless ( $o = Ipblock->retrieve($id) ){
		$m->comp('/generic/error.mhtml', error => "Can't retrieve Ipblock id $id");
	    }
	    $o->delete;
        }

	# Show parent block
        # reset all request variables to make this look like a view request
        $view = 1;
        $edit = 0;
        $id = $parent;
        if ( $id != 0 ){
	    unless ( $o = Ipblock->retrieve($id) ){
		$m->comp('/generic/error.mhtml', error => "Can't retrieve Ipblock id $id");
	    }
        }

    } else {
	eval {  $ui->form_to_db(%ARGS)	};
        if ( my $e = $@  ){
	    $m->comp('/generic/error.mhtml', error=>$e);
        }else{
	    # Do this to 'flush' the values associated with the object
	    # before redisplaying
	    $o = undef;
            if ( $id ){
		$o = Ipblock->retrieve($id);
	    }
       }
    }

#######################################################################################
# Update Children
# 
#######################################################################################

}elsif( $_action eq "UPDATE_CHILDREN" ){

    eval { $ui->form_to_db(%ARGS) };
    if ( my $e = $@  ){
	$m->comp('/generic/error.mhtml', error=>$e);
    }else{
	# Do this to 'flush' the values associated with the object
	# before redisplaying
	$o = undef;
	if ( $id ){
	    $o = Ipblock->retrieve($id);
	}
    }

#######################################################################################
# ADD/MODIFY RANGE
#
#######################################################################################
}elsif ( $_action eq 'EDIT_RANGE'){

    unless ( $manager && $manager->can($user, "edit", $o) ){
        $m->comp('/generic/error.mhtml', error=>"You don't have permission to edit this object");
    }
    
    if ( $add_range_start && $add_range_end ){
	if ( $range_status eq 'Available' ){
	    Ipblock->remove_range(start => $add_range_start, 
				  end   => $add_range_end);
	}else{
	    eval {
		$o = Ipblock->add_range(start       => $add_range_start, 
					end         => $add_range_end,
					status      => $range_status,
					owner       => $range_owner,
					used_by     => $range_used_by,
					description => $range_description,
					parent      => $range_parent,
					gen_dns     => $range_gen_dns,
					name_prefix => $name_prefix,
					name_suffix => $name_suffix,
					fzone       => $range_fw_zone,
					rzone       => $range_rev_zone,
		    );
	    };
	}
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);
	}else{
	    $m->comp('.show_message', title=>"Action Message", msg=>"Address Range Modified Successfully");
	    $id = $o->id;
	}
    }else{
	$m->comp('/generic/error.mhtml', error=>"You need to specify start and end addresses");
    }

#######################################################################################
# ADD/MODIFY BLOCK
#
#######################################################################################
}elsif ( $_action eq "ADD_BLOCK" ){
    
    if ( $add_block_prefix ){

	$add_block_prefix =~ s/\s+//g; # Remove spaces

	unless ( $add_block_prefix =~ /\// ){
	    $m->comp('/generic/error.mhtml', error=> "$add_block_prefix not a valid CIDR string.");
	}
	my ($address, $prefix) = split /\//, $add_block_prefix;
	if ( (($address =~ $IPV4 && $prefix ne '32') ||
	      ($address =~ $IPV6 && $prefix ne '128')) &&
	     ($block_status eq 'Dynamic' || $block_status eq 'Static') ){
	    $m->comp('/generic/error.mhtml', error=>"IP block cannot be 'Dynamic' or 'Static'.  Specify IP Range instead.");
        }
	my $block;
	eval {
	    my %args = (status      => $block_status,
			owner       => $block_owner,
			used_by     => $block_used_by,
			description => $block_description,
		);
	    if ( $block = Ipblock->search(address=>$address, prefix=>$prefix)->first ){
		$block->update(\%args);
	    }else{
		$args{address} = $address;
		$args{prefix}  = $prefix;
		$args{parent}  = $add_block_parent if $add_block_parent;
		$block = Ipblock->insert(\%args);
	    }
	};
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);
	}elsif ( $block ){
	    $o  = $block;
	    $id = $block->id;
	    if( $o->is_address ) {
		$added_ip  = 1;
	    }else {
		$added_block = 1;
	    }
	    if ( $o->version == 6 ){
		$view_format = 'list';
	    }
	}
    }else{
	$m->comp('/generic/error.mhtml', error=>"You need to specify IP/prefix");
    }

#######################################################################################
# ENABLE DHCP
#
#######################################################################################
}elsif ( $_action eq 'ENABLE_DHCP'){
    
    unless ( $manager && $manager->can($user, "edit", $o) ){
        $m->comp('/generic/error.mhtml', error=>"You don't have permission to edit this object");
    }

    if ( $ARGS{dhcp_global_scope} ){
	my %args = (container=>$ARGS{dhcp_global_scope});

	# Grab all the dhcp options & declarations
	foreach my $arg ( %ARGS ){
	    if ( $arg =~ /^dhcp_/ ){
		next if $arg eq 'dhcp_global_scope';
		my $value = $ARGS{$arg};
		if ( $arg =~ /^dhcp_(.*)_(\d+)$/ ){
		    my $attr = $1;
		    my $sid  = $2;
		    $attr =~ s/^option_/option /;
		    $attr =~ s/_/-/g;
		    if ( $sid eq $id ){
			$args{attributes}{$attr} = $value;
		    }else{
			$args{shared_nets}{$id}{$attr} = $value;
		    }
		};
	    }
	}
	eval {
	    $o->enable_dhcp(%args);
	};
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);
	}else{
	    $m->comp('.show_message', title=>"Action Message", msg=>"DHCP enabled Successfully");
	}
    }else{
	$m->comp('/generic/error.mhtml', error=>"You need to specify at least the global scope");
    }

#######################################################################################
# Delete
#
#######################################################################################
}elsif ( $_action eq "DELETE" ){

</%perl>

%  unless ( $manager && $manager->can($user, "delete", $o) ){
%      $m->comp('/generic/error.mhtml', error=>"You don't have permission to delete this object");
%  }

  <form action="ip.html">
    <input type="hidden" name="_action" value="CONFIRM_DELETE">
    <input type="hidden" name="id" value="<% $id %>">
    
    <div class="container">
      <div class="containerhead">
        <strong>Confirm</strong>   
      </div>
      <div class="containerbody">  
        <p>Are you sure you want to delete <strong><em><% $o->get_label %></em></strong> ?
%	if ( $o->children ){
            <p>Delete children blocks <input type="checkbox" name="recursivedel">
%       }
        <p><input type="submit" name="submit" value="Yes" >
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
      </div>
    </div>
  </form>


<%perl>

# Do not continue with object display
  $view = 0;

#######################################################################################
# Confirm Delete
#
#######################################################################################
}elsif ( $_action eq "CONFIRM_DELETE" ){
  
    unless ( $manager && $manager->can($user, "delete", $o) ){
	$m->comp('/generic/error.mhtml', error=>"You don't have permission to delete this object");
    }

    my ($address, $prefix, $version) = ($o->address, $o->prefix, $o->version);
    my $parentid = $o->parent->id if ( $o->parent );
    # Remove from Database
    #
    my $rec = ($recursivedel)? 1 : 0;
    eval { $o->delete( recursive => $rec ) };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>$e);
    }
    
    if ($rec){
	$m->comp('.show_message', title=>"Action Message", msg=>"<p><strong>Block <em>$address/$prefix</em> and all its children blocks have been deleted</strong>");
    }else{
	$m->comp('.show_message', title=>"Action Message", msg=>"<p><strong>Block <em>$address/$prefix</em> has been deleted</strong>");
    }
    
    # Show parent block
    # after block has been deleted
    $id = $parentid;
    if ($id != 0){
	unless ( $o = Ipblock->retrieve($id) ){
	    $m->comp('/generic/error.mhtml', error => "Can't retrieve Ipblock id $id");
	}
    }
}

#######################################################################################
# View
#
#######################################################################################

if ( $id && $view ){
    if ( $edit ){	 
</%perl>

    <form name="netdotform" action="ip.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
%      if ( $edit_ip || $edit_block ){
	 <input type="hidden" name="_action" value="UPDATE">
%      }

%    }

<%perl>

my @line;
if ( my @parents = $o->get_ancestors ){
    foreach my $par ( reverse @parents ){
    	push (@line, "<a href=\"ip.html?id=" . $par->id . "\">" . $par->get_label . "</a>");
    }
    if( $view_format eq 'block' && !$o->is_address ) {  
	push (@line, "<a href=\"ip.html?id=" . $o->id . "\">" . $o->get_label . "</a>");  
    } else {  
        push (@line, $o->get_label);  
    }
}    
 
</%perl>

 <div class="container">

    <div class="containerheadleft">
      <a href="ip.html?_action=SHOW_ROOTS&rootversion=all">[*]</a>: 
%     if ( @line ){
%        print join ' : ', @line;
%     }else{
         <% $o->get_label %>
%     }
    </div>

% if ( $o->is_address ){

%#######################################################################################
%# View IP address
%#######################################################################################


    <div class="containerheadright">
%	 if ($edit eq "ipinfo"){	 
%        if ($added_ip) {
    	    <input type="submit" name="submit" value="cancel">
%           my @parents = $o->get_ancestors;
            <input type="hidden" name="parent" value="<% $parents[0] %>">
%        } else {
    	    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
%        }
         <input type="submit" name="submit" value="save">
%	 }else{
            <a href="ip.html?id=<% $id %>">[refresh]</a>
%           if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_ipinfo') ){
                <a href="ip.html?id=<% $id %>&edit=ipinfo">[edit]</a>
%           }
%           if ( $manager && $manager->can($user, "access_section", 'ip.html:delete_ip') ){
                <a href="ip.html?id=<% $id %>&_action=DELETE">[delete]</a>
%           }
%	 }
    </div>

    <div class="containerbody">

<%perl>
       my @field_headers;
       my @cell_data;

       # Address:
       my %addr_tmp = $ui->form_field(object=>$o, column=>"address", edit=>$edit_ip, htmlExtra=>"style='width: 15em'");
       push( @field_headers, $addr_tmp{'label'} );
       push( @cell_data, $addr_tmp{'value'} );

       push( @field_headers, $ui->col_descr_link('Ipblock', 'status', 'Status: ')  );

       my $status;
       my @valid_block_status = qw ( Static Dynamic Reserved );
       if ( my $sn = $o->status->name ){
           if ( $edit eq "ipinfo" ){
              $status = qq(<select name="Ipblock__).$o->id.qq(__status">);
              foreach my $st ( @valid_block_status ){
                 if ( $st eq $sn ){
                    $status .= qq(<option value="$st" SELECTED>$st</option>);
                 }else{
                    $status .= qq(<option value="$st">$st</option>);
                 }
              }
              $status .= "</select>";
           }else{
              $status = qq(<strong>$sn</strong>);
           }
       }

       push( @cell_data, $status );

       my @fields = ('description','info', 'first_seen','last_seen');
       $ui->add_to_fields(o=>$o, edit=>$edit_ip, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);

       push( @field_headers, "Interface:" );
       push( @cell_data, 
	     $ui->select_lookup(object=>$o, table=>"Ipblock", column=>'interface', lookup=>"Interface",
				edit=>$edit_ip, returnAsVar=>1, linkPage=>1)
	     );
    push( @field_headers, "Device:" );
    push( @cell_data, 
        eval {
	    my $device;
	    $device = $o->interface->device if ($o->interface);
	    $device ||= ($o->snmp_devices)[0];
            if ( $device ){
                qq(<a href="device.html?id=).$device->id.qq(">).$device->get_label()."</a>";
            }else{
                "&nbsp;";
            }
        }  );
</%perl>

%# actually output the table to the browser
<& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data,
                          width=>"2", headercolwidth=>"15%", datacolwidth=>"35%" &>


    </div>
</div>

<%perl>

if (!$edit){
    my @rraddrs = $o->arecords();
    my @rrs = map { $_->rr } @rraddrs;
    print '<div class="container">';
    print '<div class="containerheadleft">DNS A Records</div>';
    print '<div class="containerheadright">';
    if (!@rraddrs) {
	print "<a href=\"host.html?ipblock=$o&action=new\">[add]</a>";
    }else{
	print '&nbsp;';
    }
    print '</div>';
    print '<div class="containerbody">';
    $m->comp('/generic/sortresults.mhtml', object=>\@rrs);
    print '</div>';
    print '</div>';

    my @ptrs = $o->ptr_records();
    my @prrs = map { $_->rr } @ptrs;
    print '<div class="container">';
    print '<div class="containerhead">DNS PTR Records</div>';
    print '<div class="containerbody">';
    $m->comp('/generic/sortresults.mhtml', object=>\@prrs);
    print '</div>';
    print '</div>';
}

# Do not show DHCP scope unless the subnet has DHCP enabled
if ($o->parent && $o->parent->dhcp_scopes) {
    my $gscope = $o->parent->dhcp_scopes->first->container;
    my @scopes  = $o->dhcp_scopes;
    
    print '<div class="container">';
    print '<div class="containerhead"><b>DHCP Host</b></div>';
    print '<div class="containerbody">';
    $m->comp('/generic/sortresults.mhtml', object=>\@scopes);
    print '</div>'; #close containerbody of DHCP
    print '</div>'; #close container of DHCP
}

if ( $edit ){
    print '</form>';
}

</%perl>
% if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_ipinfo') ){

<div class="container">
    <div class="containerheadleft">Services</div>
    <div class="containerheadright">
	<a href="edit.html?table=IpService&ip=<% $o %>">[add]</a>
    </div>
<%perl>
    my @headers = ("Service", "Contact List");
    my @rows = ();
    foreach my $ipservice ($o->services){
	push( @rows,
	      [ eval {
		  if ($edit eq "ipinfo"){	 
		      $ui->form_field(object=>$ipservice, column=>"service", edit=>$edit_ip, returnValOnly=>1);
		  }else{
		      qq(<a href="view.html?table=Service&id=).$ipservice->service->id.qq(">).$ipservice->service->name."</td></a>";
		  }
	      } ,
		eval {
                    if ($edit eq "ipinfo"){
                        $ui->form_field(object=>$ipservice, column=>"contactlist", edit=>$edit_ip, returnValOnly=>1);
                    }elsif ($o->used_by){
                        qq(<a href="view.html?table=ContactList&id=).$ipservice->contactlist.qq(">).$ipservice->contactlist->name."</td></a>";
                    }
		}
                ]  );
    } 
    $m->comp('/generic/data_table.mhtml', field_headers=>\@headers, data=>\@rows ) if ( $o->services ); 
</%perl>
</div>

% }

%################################################################
%# Custom Attributes
%################################################################
<!-- Display Custom Attributes -->
% my @attributes = $o->attributes;
  <div class="container">
    <div class="containerheadleft"><strong>Custom Attributes</strong></div>
    <div class="containerheadright">
%     if ( @attributes ) {
        <a href="ip.html?id=<% $o %>&editattr=1">[edit]</a>
%     }
        <a href="edit.html?table=IpblockAttr&ipblock=<% $o %>">[add]</a>
    </div>
    <div class="containerbody">
        <& /generic/sortresults.mhtml, object=>\@attributes, withedit=>$editattr, return_args=>"?id=$id" &>
    </div>
  </div>
<!-- End Display Custom Attributes -->


<!-- Display ARP -->
<%perl>
# Get latest arp entries
    if ( my $arp = $o->get_last_n_arp($arp_limit) ){
        my @rows;
	my %tstamps;
        foreach my $row ( @$arp ){
            my ($iid, $macid, $tstamp) = @$row;
            my $lbl    = Interface->retrieve($iid)->get_label;
            my $lnk   = "<a href=\"interface.html?id=$iid\">$lbl</a>";
	    push @{$tstamps{$tstamp}{$macid}}, $lnk;
        }
	foreach my $tstamp ( reverse sort keys %tstamps ){
	    foreach my $macid ( keys %{$tstamps{$tstamp}} ){
		my $maclbl   = PhysAddr->retrieve($macid)->get_label;
		my $maclnk   = "<a href=\"../management/mac.html?id=$macid\">$maclbl</a>";
		push @rows, [$tstamp, $maclnk, (join ', ', @{$tstamps{$tstamp}{$macid}})];
	    }
	}
       
</%perl>
<div class="container">
    <div class="containerheadleft"><strong>Last <% $arp_limit %> ARP entries</strong></div>
          <div class="containerheadright">
	    <form name="netdotform" action="ip.html" method="POST">
	      <input type="hidden" name="id" value="<% $id %>">
	      Last <input type="text" size="3" name="arp_limit" value="<% $arp_limit %>"> ARP entries <input type="submit" name="submit" value="show">
            </form>
	  </div>
    <div class="containerbodyoutside">
        <& /generic/data_table.mhtml, field_headers=>['Time Seen', 'MAC', 'Interfaces'], data=>\@rows, style=>['', '', 'width: 60%'] &>
    </div>
</div>

%     }
<!-- End Display ARP -->


%} else {     
%#######################################################################################
%# View Block
%#######################################################################################

    <div class="containerheadright">
%  if ($edit eq "blockinfo"){	 
%        if ($added_block) {
    	    <input type="submit" name="submit" value="cancel">
%           my @parents = $o->get_ancestors;
            <input type="hidden" name="parent" value="<% $parents[0] %>">
%        } else {
    	    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
%        }
    <input type="submit" name="submit" value="save">

%  }elsif ( $edit ){
    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
    <input type="submit" name="submit" value="save">

%  }else{
    <a href="ip.html?id=<% $id %>">[refresh]</a>
%      if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_blockinfo') ){
	    <a href="ip.html?id=<% $id %>&edit=blockinfo">[edit]</a>
%	    if ( $o->status->name eq 'Subnet' ){
	        <a href="ip.html?id=<% $id %>&edit=address_range">[range]</a>
%           }
	    <a href="ip.html?id=<% $id %>&_action=DELETE">[delete]</a>
%       }
%  }
    </div>

    <div class="containerbody">

% if ( $edit eq 'address_range' ){

%     unless ( $manager && $manager->can($user, "edit", $o) ){
%          $m->comp('/generic/error.mhtml', error=>"You don't have permission to edit this object");
%     }

    <p><b>Add/Modify Address Range</b>
    <input type="hidden" name="_action" value="EDIT_RANGE">
    <input type="hidden" name="range_parent" value="<% $id %>">

<%perl>	
    my @fields;
    my @data;     
    push @fields,'IP Range:';
    push @data, '<input type="text" name="add_range_start" class="txt" value=""> - <input type="text" name="add_range_end" class="txt" value="">';
    
    push @fields, 'Status:';
    push (@data, &{sub{ 
	my $x;
	$x .= '<select name="range_status" id="range_used_by">';
        $x .= '<option value="0">-- Select --</option>';
	my @allstatus = qw( Dynamic Reserved Static Available ); 
	foreach my $status ( @allstatus ){
	    $x .= '<option value="'.$status.'">'.$status.'</option>';
	}
	$x .= '</select>';
	$x;
    }});

    my @allents = sort { $a->name cmp $b->name } Entity->retrieve_all; 

    push @fields, 'Owner:';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="range_owner" id="range_owner">';
	$x .= '<option value="0">-- Select --</option>';
	foreach my $ent ( @allents ){
	    $x .= '<option value="'. $ent->id .'">'. $ent->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=Entity&select_id=range_owner&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

    push @fields, 'Used By:';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="range_used_by" id="range_used_by">';
	$x .= '<option value="0">-- Select --</option>';
	foreach my $ent ( @allents ){
	    $x .= '<option value="'. $ent->id .'">'. $ent->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=Entity&select_id=range_used_by&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

    push @fields, 'Description:';
    push @data, '<input type="text" class="longtxt" name="range_description">';

    push @fields, 'Auto-generate DNS records:';
    push @data, '<input type="checkbox" name="range_gen_dns" checked="checked">';

    push @fields, 'DNS name prefix/suffix:';
    push @data, '<input type="text" size="5" name="name_prefix"> <input type="text" size="5" name="name_suffix">';

    my $fwzone   = $o->forward_zone();
    my $revzone  = $o->reverse_zone();
    my @allzones = Zone->retrieve_all();

    push @fields, 'Forward Zone';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="range_fw_zone" id="range_fw_zone">';
	$x .= '<option value="0">-- Select --</option>';
	if ( $fwzone ){
	    $x .= '<option value="'. $fwzone->id .'" SELECTED>'. $fwzone->name .'</option>';
	}
	foreach my $z ( @allzones ){
	    next unless defined $z;
	    next if ( $z->name =~ /\.arpa$|\.int$/ );
	    $x .= '<option value="'. $z->id .'">'. $z->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=Zone&select_id=range_fw_zone&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

    push @fields, 'Rerverse Zone';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="range_rev_zone" id="range_rev_zone">';
	$x .= '<option value="0">-- Select --</option>';
	if ( $revzone ){
	    $x .= '<option value="'. $revzone->id .'" SELECTED>'. $revzone->name .'</option>';
	}
	foreach my $z ( @allzones ){
	    next unless defined $z;
	    next unless ( $z->name =~ /\.arpa$|\.int$/ );
	    $x .= '<option value="'. $z->id .'">'. $z->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=Zone&select_id=range_rev_zone&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

</%perl>

<& /generic/attribute_table.mhtml, field_headers=>\@fields, data=>\@data,
	                            width=>"2", headercolwidth=>"15%", datacolwidth=>"35%" &>



% }elsif ( $edit eq 'enable_dhcp' ){

    <p><b>Create a DHCP Scope for this subnet</b>
    <input type="hidden" name="_action" value="ENABLE_DHCP">

<%perl>

    my @fields;
    my @data;     

    push @fields,'Global Scope:';
    push (@data, &{sub{
	my $x;
	$x .= '<select name="dhcp_global_scope" id="dhcp_global_scope">';
	$x .= '<option value="0">-- Select --</option>';
	foreach my $ent ( DhcpScope->search(type=>'global') ){
	    $x .= '<option value="'. $ent->id .'">'. $ent->name .'</option>';
	}
	$x .= '</select>';
	$x .= '<a class="hand" onClick="openinsertwindow(\'table=DhcpScope&select_id=dhcp_global_scope&selected=1&dowindow=1\')">[new]</a>';
	$x;
    }});

    my @shared_subs = $o->shared_network_subnets();
    my @subs = ($o);
    if ( @shared_subs ){
	print "<p> (*) It looks like this is a shared network<p>";
	push @subs, @shared_subs;
    }
    foreach my $s ( @subs ){
	push @fields, "&nbsp;";
	push @data,   "&nbsp;";
	push @fields, "Subnet:";
	push @data,   $s->get_label();
	push @fields, 'Option routers:';
	push @data,   '<input type="text" name="dhcp_option_routers_'.$s->id.'" class="txt" value="'.($s->_netaddr->network+1)->addr().'">';
    }

</%perl>	

<& /generic/attribute_table.mhtml, field_headers=>\@fields, data=>\@data,
	                            width=>"1", headercolwidth=>"15%", datacolwidth=>"35%" &>

    
<%perl>

 }else{

my @field_headers = ( );
my @cell_data = ( );

################
# Address:
my %addr_tmp = $ui->form_field(object=>$o, column=>"address", edit=>$edit_block, htmlExtra=>"style='width: 15em'");
my %pref_tmp = $ui->form_field(object=>$o, column=>"prefix", edit=>$edit_block, htmlExtra =>"style='width: 2em'");
push( @field_headers, $addr_tmp{'label'} );
push( @cell_data, $addr_tmp{'value'}."/".$pref_tmp{'value'} );

################
# Status:
push( @field_headers, $ui->col_descr_link('Ipblock', 'status', 'Status: ') );
my $status;
my @valid_block_status = qw ( Container Subnet Reserved );
if ( my $sn = $o->status->name ){
    if ( $edit eq "blockinfo" ){
	$status .= "<select name=\"Ipblock__".$o->id."__status\">";
	foreach my $st ( @valid_block_status ){
	    if ( $st eq $sn ){
		$status .= "<option value=\"".$st."\" SELECTED>".$st."</option>";
	    }else{
		$status .= "<option value=\"".$st."\">".$st."</option>";
	    }
	}
	$status .= "</select>";
    }else{
	$status .= "<strong>".$sn."</strong>";
    }
}
push( @cell_data, $status );

################
# Created, Modified
push (@field_headers, "First Created", "Last Modified");
my %createdtmp = $ui->form_field(object=>$o, column=>'first_seen', edit=>0);
my %modtmp     = $ui->form_field(object=>$o, column=>'last_seen',  edit=>0);
push( @cell_data, $createdtmp{'value'}, $modtmp{'value'} );

################
# Vlan

{
    my %tmp = $ui->form_field(object=>$o, column=>'vlan', edit=>$edit_block, linkPage=>'view.html');
    push( @field_headers, $tmp{'label'} );
    push( @cell_data, $tmp{'value'} );
}

################
# Description, Info (no link)
{
    my @fields = ('description','info');
    $ui->add_to_fields(o=>$o, edit=>$edit_block, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);
}

################
# Owner
# For some fields, we will provide a way to update the values recursively in all 
# descendant blocks.
my %owner_tmp = $ui->form_field(object=>$o, column=>"owner", edit=>$edit_block, linkPage=>"view.html");
my $owner = $owner_tmp{value};

if ( ! $edit_block ){
    $owner .= '<a href="#" onClick="edit_recursive(' . $o->id . ',\'owner\', \'1\')">[edit]</a>';
}
push( @field_headers, $owner_tmp{label} );
push( @cell_data, $owner );

################
# Used by    
my %usedby_tmp = $ui->form_field(object=>$o, column=>"used_by", edit=>$edit_block, linkPage=>"view.html");
push( @field_headers, $usedby_tmp{'label'} );
push( @cell_data, $usedby_tmp{'value'} );

</%perl>

<%perl>

my $ip = new NetAddr::IP($o->address, $o->prefix);

push( @field_headers, "Netmask:", "Broadcast:" );
push( @cell_data, $ip->mask);
push( @cell_data, ($ip->version == 6?$ip->broadcast->short:$ip->broadcast->addr) );

################
# Usable address range

push( @field_headers, "Usable Addresses:" );
my ($num_addresses, $first_address, $last_address);
if ( $o->version == 4 ){
    if ( $o->prefix == 31 ){
	$num_addresses = 2;
	$first_address = $ip->addr;
	$last_address  = $ip->broadcast->addr;
    }else{
	$num_addresses = $ip->num;
	$first_address = $ip->first->addr;
	$last_address  = $ip->last->addr;
    }
}else{
    $num_addresses = $ip->num;
    $first_address = $ip->first->short;
    $last_address  = $ip->last->short;
}
push( @cell_data, ($num_addresses." (". $first_address."-".$last_address.")") );
	
if ($o->status->name eq "Subnet") {
      my $used  = new Math::BigInt($o->num_children);
      my $total = new Math::BigInt($o->num_addr);
      my $avail = $total - $used;
      my $avail_percent = $ui->friendly_percent(value=>$avail,total=>$total);
      my $used_percent  = $ui->friendly_percent(value=>$used,total=>$total);
      my $percent = ($used*100)/$total;

    my $available_text;
    {
        my $used_text;
        if ($used <= $max_ips) {
            $used_text = 'Used: '.$used;
            if ($total <= $max_ips) {
                $used_text .= ' of '.$total;
            }
            $used_text .= ' &nbsp;&nbsp;';
        }
        my $avail_text = 'Available: ';
        if ($avail <= $max_ips) {
            $avail_text .= $avail.' &nbsp;(';
        }
        $avail_text .= $ui->friendly_percent(value=>$avail,total=>$total);
        if ($avail <= $max_ips) {
            $avail_text .= ')';
        }
        $available_text = $used_text.$avail_text;
    }

################
# Utilization
    push( @field_headers, "Utilization:" );
    push( @cell_data, ($ui->percent_bar(percent=>$percent))
        .'<div class="small">'.$available_text.'</div>' );

} elsif( $o->status->name eq "Container" ) {
      my $total = new Math::BigInt($o->num_addr);

      my $used_a = new Math::BigInt($o->address_usage);
      my $avail_a = $total - $used_a;
      my $used_s = new Math::BigInt($o->subnet_usage);
      my $avail_s = $total - $used_s;

      my $address_percent = $used_a*100/$total;
      my $subnet_percent = $used_s*100/$total;

    my $address_text;
    my $subnet_text;

    $subnet_text = 'Available: '.($ui->friendly_percent(value=>$avail_s,total=>$total));

        if( $used_a <= $max_ips ) {
            $address_text .= 'Used: '.$used_a;
            if( $total <= $max_ips ) {
                $address_text .= ' of '.$total;
            }
            $address_text .= ' &nbsp;&nbsp; Available: ';
            if( $total <= $max_ips ) {
                $address_text .= $avail_a.' &nbsp;(';
            }
            $address_text .= $ui->friendly_percent(value=>$avail_a,total=>$total);
            if ($total <= $max_ips) {
                $address_text .= ')';
            }
        } else {
            if( $avail_a <= $max_ips ) {
                $address_text .= 'Available: '.$avail_a.' ('.(100-$address_percent).'%)';
            } else {
                $address_text .= 'Available: '.(100-$address_percent).'%';
            }
        }

################
# Address Utilization
    push( @field_headers, "Address Utilization:" );
    push( @cell_data, $ui->percent_bar(percent=>$address_percent).'<div class="small">'.$address_text.'</div>' );

################
# Space allocated
    push( @field_headers, "Space Allocated:" );
    push( @cell_data, $ui->percent_bar(percent=>$subnet_percent).'<div class="small">'.$subnet_text.'</div>' );

}

</%perl>

%# actually output the table to the browser
<& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data,
	                            width=>"2", headercolwidth=>"15%", datacolwidth=>"35%" &>

% }

    </div>
</div>

% if ( $edit ){	 
    </form>
% }

%################################################################
%# DHCP Scopes
%################################################################
% if ( int($o->status) && $o->status->name eq 'Subnet' ){
    <div class="container">
      <div class="containerheadleft">DHCP Scope</div>
%   if ( my @scopes = $o->dhcp_scopes ){
      <div class="containerheadright">&nbsp;</div>
      <div class="containerbody">
         <& /generic/sortresults.mhtml, object=>\@scopes &>
      </div>
%   }else{
      <div class="containerheadright"><a href="ip.html?id=<% $id %>&edit=enable_dhcp">[enable]</a></div>
%   }
% }
    </div>

%################################################################
%# Sites
%################################################################
% my @ss = $o->sites;
  <div class="container">
    <div class="containerheadleft">Sites</div>
       <div class="containerheadright">
%      if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_sites') ){
%          if ( $edit eq 'edit_sites' ){
               &nbsp;
%          }else{
               <a href="ip.html?id=<% $o %>&edit=edit_sites">[edit]</a>
               <a href="edit.html?table=SiteSubnet&subnet=<% $o %>">[add]</a>
%          }
%       }
%       else{
            &nbsp;
%      }
       </div>
    <div class="containerbody">
       <& /generic/sortresults.mhtml, object=>\@ss, withedit=>($edit eq 'edit_sites')? 1 : 0 &>
    </div>
  </div>

%################################################################
%# Zones
%################################################################
% if ( $manager && $manager->can($user, "access_section", 'ip.html:edit_zones') ){

%     my @sz = $o->zones;
      <div class="container">
      <div class="containerheadleft">DNS Zones</div>
      <div class="containerheadright">
%     if ( $edit eq 'edit_zones' ){
        &nbsp;
%     }else{
        <a href="ip.html?id=<% $o %>&edit=edit_zones">[edit]</a>
        <a href="edit.html?table=SubnetZone&subnet=<% $o %>">[add]</a>
%     }
      </div>
      <div class="containerbody">
         <& /generic/sortresults.mhtml, object=>\@sz, withedit=>($edit eq 'edit_zones')? 1 : 0 &>
      </div>
      </div>
% }


%################################################################
%# Graphical Views
%################################################################
% if( $view_format eq 'block' ) {  
%     if( $o->status->name eq "Subnet" ) {  
       <div class="container">  
          <div class="containerheadleft"> 
             Choose an Address 
          </div>  
          <div class="containerheadright">
            Legend:
            <span class="ipaddr_available">Available</span>
            <span class="ipaddr_discovered">Discovered</span>
            <span class="ipaddr_dynamic">Dynamic</span>
            <span class="ipaddr_static">Static</span>
            <span class="ipaddr_reserved">Reserved</span>
			&nbsp;&nbsp;
         	<a href="ip.html?id=<% $id %>&view_format=list">[List View]</a>
          </div>
          <div class="containerbody" id="ipaddresstable">  
          <& subnet.mhtml, network => $o &>  
          </div>  
       </div>  
%     }  
%     if( $o->status->name eq "Container") {  
       <div class="container">  
          <div class="containerheadleft"> 
             Usage for <% $o->get_label %>  
          </div>  
          <div class="containerheadright">
            Legend:
            <span class="ipaddr_available">Available</span>
            <span class="ipaddr_container">Container</span>
            <span class="ipaddr_static">Static</span>
            <span class="ipaddr_reserved">Reserved</span>
			&nbsp;&nbsp;
         	<a href="ip.html?id=<% $id %>&view_format=list">[List View]</a>
		<a href="ip.html?id=<% $id %>&view_format=tree">[Tree View]</a>
          </div>
          <div class="containerbody" id="ipaddresstable">  
          <& container.mhtml, network => $o, rowsize => $rowsize, dividefreespace => $dividefreespace &>  
          </div>  
       </div>  
%     }  
% }elsif( $view_format eq 'tree' ) {  
%     if( $o->status->name eq "Subnet" || $o->status->name eq "Container" ) {  
       <div class="container">  
          <div class="containerheadleft"> 
             Tree View
          </div>  
          <div class="containerheadright">
            Legend:
            <span class="ipaddr_container">Container</span>
            <span class="ipaddr_static">Static</span>
            <span class="ipaddr_reserved">Reserved</span>
			&nbsp;&nbsp;
%	        if ( $o->version == 4 ){
         	    <a href="ip.html?id=<% $id %>&view_format=block">[Block View]</a>
%               }
         	<a href="ip.html?id=<% $id %>&view_format=list">[List View]</a>
          </div>
          <div class="containerbody" id="ipaddresstable">  
          <& tree.mhtml, network => $o &>  
          </div>  
       </div>  
%     }  
% } elsif ( $view_format eq 'list' ) {  
%   #  
%   # Get children  
%   #  
%   my @children;   
%   if (scalar( @children = $o->children )){  
       <div class="container">
%      if ( $edit_children ){

	     <form name="edit_children" id="edit_children" action="ip.html" method="POST">
%      }
          <div class="containerheadleft">
             Children Addresses/Blocks
          </div>
          <div class="containerheadright">
%             if( $o->version == 4 ) {
%		 if ( $edit_children ){
			 <input type="hidden" name="id" value="<% $id %>">
			 <input type="hidden" name="_action" value="UPDATE_CHILDREN">
			 <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
			 <input type="submit" name="submit" value="save">
%		 }else{
%                    if ( $manager && $manager->can($user, 'access_section', 'ip.html:edit_children') ){
%		         print '<a href="ip.html?id='.$id.'&edit_children=1&view_format=list">[edit]</a>&nbsp;';
%		         print '<a href="ip.html?id='.$id.'&view_format=block">[Block View]</a>';
%                    }
%                    if ( $o->status->name eq 'Container' ){
                         <a href="ip.html?id=<% $id %>&view_format=tree">[Tree View]</a>
%                    }
%		 }
%             } else {
%	            print '<a href="ip.html?id='.$id.'&view_format=tree">[Tree View]</a>';
%             }
          </div>
          <div class="containerbody">
          <& ipblock_list.mhtml, objects => \@children, edit => $edit_children &>
%	  if ( $edit_children ){
                  <input type="button" value="Check All" onclick="setCheckbox('edit_children', '', true);return false;" class="button" />
                  <input type="button" value="Clear All" onclick="setCheckbox('edit_children', '', false);return false;" class="button" />
%	  }
          </div>

%    if ( $edit_children ){
         </form>
%    }
     </div>

%   }
% }else{
%    $m->comp('/generic/error.mhtml', error => "Unknown view format: $view_format");
% }
<!-- End Block Info Table -->
% }

% }
</div>


<%def .show_message>
<%args>
$title => undef
$msg   => undef
</%args>

<div class="container">
    <div class="containerhead">
       <strong><% $title %></strong>   
    </div>
    <div class="containerbody">
       <% $msg %><br>
    </div>
</div>

</%def>
