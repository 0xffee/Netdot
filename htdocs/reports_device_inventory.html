<%doc>
Device Inventory Report

</%doc>

<%flags>
inherit => 'section_reports.html' 

</%flags>

<%attr>
title   => 'Device Inventory' 
section => 'Reports'
</%attr>

<%init>
my $DEBUG      = 0;
my $grandtotal = 0;
my %t;

foreach my $pt ( sort { $a->name cmp $b->name } ProductType->retrieve_all ){
    $t{$pt->name}{total} = 0;
    $t{$pt->name}{id}    = $pt->id;
    my @prods            = $dm->getproductsbytype($pt);
    foreach my $o ( @prods ){
	$t{$pt->name}{prod}{$o->name}{id}   = $o->id;
	$t{$pt->name}{prod}{$o->name}{num}  = $o->numdevs;
	$t{$pt->name}{total}               += $o->numdevs;
    }
    $grandtotal += $t{$pt->name}{total};
}
# Look for products with no type
foreach my $o ( $dm->getproductsbytype(0) ){
    $t{'Unknown'}{prod}{$o->name}{id}  = $o->id;
    $t{'Unknown'}{prod}{$o->name}{num} = $o->numdevs;
    $t{'Unknown'}{total}              += $o->numdevs;
}

# Look for devices with no product set

my @noprod = Device->search( productname => 0 );

if ( my $num = scalar @noprod ){
    $t{'Unknown'}{prod}{'Unknown'}{id}   = 0;
    $t{'Unknown'}{prod}{'Unknown'}{num}  = $num;
    $t{'Unknown'}{total}                += $num;
}
if ( exists $t{'Unknown'} ){
    $grandtotal += $t{'Unknown'}{total};
}

</%init>

<div class="container">
<div class="containerhead">Device Inventory</div>
<div class="containerbody">

<%perl>
my (@headers, @rows) = ();

@headers = ( 'Type', 'Product', 'Count', );

    my @row = ();
    push( @row, "Total Devices in Inventory:" );
    push( @row, "&nbsp;" );
    push( @row, $grandtotal );
    push( @rows, \@row );

foreach my $pt ( sort keys %t ){
    my @row = ();
    push( @row, "<strong><a href=\"device.html?submit=search&search=ProductType:$t{$pt}{id}\">" . $pt . "</a></strong>" );
    push( @row, "" );
    push( @row, '<strong>' . $t{$pt}{total} . '</strong>' );
    push( @rows, \@row );

    foreach my $product ( sort keys %{ $t{$pt}{prod} } ){
	my @row = ();
	push( @row, "" );
	if ( $t{$pt}{prod}{$product}{id} ){
	    push( @row, '<a href="view.html?table=Product&id=' . $t{$pt}{prod}{$product}{id} . '">' . $product . '</a>' );
	}elsif ( $product eq "Unknown" ){
	    push( @row, '<a href="device.html?submit=search&search=productname:0">' . $product . '</a>' );
	}
	push( @row, $t{$pt}{prod}{$product}{num}  );
	push( @rows, \@row );
    }

}
</%perl>
<& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>

</div>
</div>
