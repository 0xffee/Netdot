<%doc>
Supported arguments:

  table  - name of a table in the database
  object - reference to a list of objects in that table for displaying in html
  view   - [row|column]
  sort   - column to sort by
  page   - page to link to with results (default is view.html)
</%doc>
<%args>

%args       => undef
%order      => undef
%tags       => undef
%linksto    => undef
%linksfrom  => undef
$cellspc    => 0
$cellpad    => 0
$SORT       => undef
$META       => undef
$LBL        => undef
$PAGE       => "view.html"
$ui         => Netdot::UI->new()
$VIEW       => "column"
$table      => undef
$withdelete => 0
</%args>

<%init>
my @sorted;

</%init>

<%perl>
# expect name of Table & objects that require sorting
foreach my $j ( keys %ARGS ) {
  next if( $ARGS{$j} !~ /\w+/ || $j eq "submit" );
  $args{$j} = $ARGS{$j};
}
if( exists( $args{view} ) ) {
  $args{view} = lc( $ARGS{view} );
  if( $args{view} eq "row" || $args{view} eq "column" ) {
    $VIEW = $args{view};
  }
}
if( exists( $args{page} ) ) {
  $PAGE = $args{page};
}
if( $table ) {
  undef( $META );
  $META = $ui->getmeta( $table );
  if( defined( $META ) ) {
    my $i = 1;
    my @tmp;
    ##############################################
    # if sort arg; check to make sure column exists & set SORT
    if( exists( $args{sort} ) ) {
      my(%col);
      map { $col{$_}++ } $table->columns;
      if( exists( $col{ $args{sort} } ) ) {
        $SORT = $args{sort};
	@sorted = sort { $a->$SORT cmp $b->$SORT } @{ $args{object} };
      }
    }
    ##############################################
    # get the label for this table (as defined in Meta)
    $LBL = ($ui->getlabels( $table ))[0];

    ##############################################
    # If no sort arg, sort by actual label
    # 
    if( ! defined( $SORT ) ) {
	my @labels = $ui->getlabelarr( $table );
	@sorted = map  { $_->[0] }
	sort { $a->[1] cmp $b->[1] }
	map { [$_ , $ui->getlabelvalue($_, \@labels)] } @{ $args{object} };
	    
    }
    ##############################################
    # get linksto info
    %linksto = $ui->getlinksto( $table );
    ##############################################
    # define order
    %order = $ui->getcolumnorderbrief( $table );
    ##############################################
    # Get tags
    %tags = $ui->getcolumntags( $table );
    ##############################################
    # remove id and aliases (if present)
    if( exists( $order{id} ) ) {
      delete( $order{id} );
    }
    if( exists( $order{aliases} ) ) {
      delete( $order{aliases} );
    }
    ##############################################
    # munge so that label is first 
    if( defined( $LBL ) && length( $LBL ) > 0 ) {
      unless( $order{$LBL} == 1 ) {
        my $j = $order{$LBL};
        my %rev = reverse %order;
        my $k = $rev{1} ;
        $order{$k} = $j;
        $order{$LBL} = 1;
      }
    }
  }
}
</%perl>
%
% if( defined( $META ) && defined( $args{object} ) ) {
<!-- begin sortresults -->
% ####################################################################
<%doc>
Begin the table for this instance of sortresults
</%doc>
% ####################################################################
% if( $VIEW eq "row" ) {
%   ($cellspc, $cellpad) = ( 0, 0 );
% } elsif( $VIEW eq "column" ) {
%   ($cellspc, $cellpad) = ( 0, 1 );
% }
  <TABLE BORDER="0" CELLSPACING="<% $cellspc %>" CELLPADDING="<% $cellpad %>" width="100%" class="tablebackground">
% if ( $withdelete ){
    <FORM ACTION="delete.html" METHOD="POST">
% }
%    if( $VIEW eq "row" ) {
% ####################################################################
<%doc>
If the VIEW is a row, print the column headers.  
Otherwise, print an empty row.
</%doc>
% ####################################################################
    <TR class="rowtitle2">
%       foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%	   if( exists( $tags{$c} ) ) {
      <TH><% $tags{$c} %></TH>
%	   } else {
      <TH><% $c %></TH>
%	   }
%       }
%   if ( $withdelete ){
      <TH>Delete</TH>
%   }
    </TR>
%    } else {
    <TR>
      <TD width="1" colspan="2" class="delimiter"></TD>
    </TR>
%    }
% ####################################################################
% foreach my $o ( @sorted ) {
%    my $flag = 1;
%
% ####################################################################
<%doc>
Print relevant delimiters for whether a ROW or COLUMN view
</%doc>
% ####################################################################
%
%    if( $VIEW eq "row" ) {
    <TR class="rowtitle3">
%    } elsif( $VIEW eq "column" ) {
    <TR height="1" class="delimiter">
      <TD colspan="2" height="1"></TD>
    </TR>
%    }
%
% ####################################################################
<%doc>
Get the column order and process each item.
</%doc>
% ####################################################################
%    my @order = sort { $order{$a} <=> $order{$b} } keys %order;
%    foreach my $c ( @order ) {
%
% ####################################################################
<%doc>
If a COLUMN view, start a row with the column name.
</%doc>
% ####################################################################
%
%       if( $VIEW eq "column" ) {
    <TR>
      <TD align="RIGHT" valign="TOP" WIDTH="18%" class="column1">
%	   if ( exists($tags{$c}) ){
      <b><% $tags{$c} %></b>:&nbsp;
%	   } else {
      <b><% $c %></b>:&nbsp;
%	   }
      </TD>
%       }
      <TD align="LEFT" valign="MIDDLE" class="column2">
% ####################################################################
<%doc>
If it's a link to another column....
</%doc>
% ####################################################################
%          if ( exists($linksto{$c}) ) {
%             my $ft = $ui->getmeta( $linksto{$c} );
%             if( ! defined( $ft ) ) {
%             ##########################
%             # foreign table does not exist
      No such object <% $linksto{$c} %>
%             } elsif( int($o->$c) == 0 ) {
%             ##########################
%             # it's a pointing to zero, so it's nada
      &nbsp -
%             } elsif( ! defined( $linksto{$c}->retrieve( int( $o->$c ) ) ) ) {
%             ##########################
%             # the id pointed to does not exist
      &nbsp -
%             } else {
%                my $obj = $linksto{$c}->retrieve( int( $o->$c ) );
%                my $lbl = $ui->getobjlabel( $obj, ", " );
%                if( $flag ) {
      &nbsp;
%                #######################
%                # if flag is set, make the item a url
      <strong>
      <a href="<% $PAGE %>?table=<% $table %>&id=<% $o->id %>">
%                   if( length( $lbl ) < 1 ) {
      N/A
%                   } else {
      <% $lbl %>
%                   }
      </a> 
      </strong>
%                } else {
%                #######################
%                # otherwise, just print the instance
      <% $lbl %>
%                }
%            }
%          } else {
%
% ####################################################################
<%doc>
It's not a pointer to another column
</%doc>
% ####################################################################
%
%             if( $flag ) {
      <strong>
      <a href="<% $PAGE %>?table=<% $table %>&id=<% $o->id %>">
%                if( length( $o->$c ) < 1 ) {
      N/A
%                } else {
      <% $o->$c %>
%                }
      </a>
      </strong>
%             } else {
      <% $o->$c %>
%             }
%          } # else fi
      </TD>
% ####################################################################
<%doc>
Wrap this row up.
</%doc>
% ####################################################################
%       $flag = 0 if( $flag );          
%       if( $VIEW eq "column" ) {
    </TR>
%       }
%     } # for c
%

%     if( $VIEW eq "column" ) {
%        if ( $withdelete ){
           <TR>
             <TD align="RIGHT" valign="TOP" WIDTH="18%" class="column1"></TD>
             <TD align="LEFT" valign="MIDDLE" class="column2">
               <input type="checkbox" name="<% $table %>__<% $o->id %>">
             </TD>
           </TR>
%     }
    <TR height="1" class="delimiter">
      <TD colspan="2" height="1"></TD>
    </TR>

%     } elsif( $VIEW eq "row" ) {
%         if ( $withdelete ){
            <TD align="LEFT" valign="MIDDLE" class="column2">
              <input type="checkbox" name="<% $table %>__<% $o->id %>">
            </TD>
%         }
    </TR>
    <TR class="delimiter" height="1">
      <TD colspan="15"></TD>
%     }
%} # for o
% ####################################################################
  </TABLE>

% if ( $withdelete ){
<TABLE>
  <TR class="rowtitle1">
    <TD align="CENTER">
     <input type="submit" name="submit" value="Delete">
     <input type="submit" name="submit" value="Cancel">
    </TD>
  </TR>
</TABLE>
  </FORM>
% }
<!-- end sortresults -->
% } # if

% ####################################################################
