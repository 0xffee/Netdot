<%doc>

Given a table (an optionally an id), build a form with corresponding
fields.  Can be called from within other components for editing/adding
objects to the database.

Arguments:  
  table         -  name of table (REQUIRED)
  id            -  id (row) from the above table  (OPTIONAL)
  session       -  ref to a hash with values to insert (if object ! exist)
  title         -  a title string to show in first line of form

</%doc>

<%args>

$table   => undef
$id      => undef
%session => undef
$title   => undef

</%args>

<%init>

my $maxselect = 100;
my $DEBUG     = 0;

unless ( $table  ) {
    $m->comp("error.mhtml", error => "Missing required arguments");
}
my $obj;
if ( $id ){
    unless ( $obj = $table->retrieve($id) ){
	$m->comp("error.mhtml", error => "Could not retrieve $table id $id");	
    }
}
my $META;
unless ( $META = $ui->getmeta( $table ) ) {
    $m->comp("error.mhtml", error => "Could not determine meta info table");
}
my %order   = $ui->getcolumnorder( $table );
my %linksto = $ui->getlinksto( $table );
my %tags    = $ui->getcolumntags( $table );

</%init>

<script language="javascript" src="select.js"></script>

% ####################################################################
<!-- begin form --> 
% if( defined( $table ) ) {
    <table width="100%" cellpadding="3" cellspacing="0" border="0" class="formtablebg">
    <tr>
    <input type="hidden" name="table" value="<% $table %>">
%   if( $id ) {
    <input type="hidden" name="id" value="<% $id %>">
%   }
%   foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%     next if( $c eq 'id' );
% ################################################
%     if( ! exists( $linksto{$c} ) ) { # local field
        <tr>
%       if ( exists($tags{$c}) ){
           <td class="formtablec1"><strong><% $tags{$c} %>:</strong></td>
%	}else{
           <td class="formtablec1"><strong><% $c %>:</strong></td>
%	}
%       if( defined( $id ) ) {
	    <td class="formtablec2" colspan="2"><% $ui->getinputtag($c, $obj) %></td>
%       } elsif( exists( $session{$c} ) ) {
	    <td class="formtablec2" colspan="2"><% $ui->getinputtag($c, $linksto{$c}, $session{$c}) %></td>
%       } else {
	    <td class="formtablec2" colspan="2"><% $ui->getinputtag($c, $table) %></td>
%       }
        </tr>
% ################################################
%     } else {  # The column is a foreign key. Provide a list to select.
        <tr>
%       if ( exists($tags{$c}) ){
           <td class="formtablec1"><strong><% $tags{$c} %>:</strong></td>
%	}else{
           <td class="formtablec1"><strong><% $c %>:</strong></td>
%	}
	<td class="formtablec2">
%       my $flag = 1;
%	# Check for amount of objects in table before retrieving all
%	my $count = $linksto{$c}->count_all;
%	if ( $count <= $maxselect ){			      
%	   my @fkobjs = $linksto{$c}->retrieve_all;

   	   <select name="<% $c %>">
%          if( defined( $obj ) && ( ! $obj->$c 
%              || ! defined( $linksto{$c}->retrieve( $obj->$c->id ) ) ) ) {
              <option value="0" selected>[null]</option>
%             $flag = 0;
%          } else {
              <option value="0">[null]</option>
%          }
% ##################################################
% # Order by label value
%         my @lbls = $ui->getlabelarr( $linksto{$c} );
%         my @fk;
%         map  { push @fk, [$_->[0], $_->[1]] }
%         sort { $a->[0] cmp $b->[0] }
%         map  { [$ui->getlabelvalue($_, \@lbls, ", "), $_->id] } @fkobjs;
%         foreach my $r ( @fk ){
%             my ($lbl, $id) = ($r->[0], $r->[1]);
%             if( ( defined( $obj ) && $flag && $id == $obj->$c->id ) 
%             	|| ( $id == $session{$c} ) ) {
            	<option value="<% $id %>" selected><% $lbl %></option>
%             } else {
            	<option value="<% $id %>"><% $lbl %></option>
%             }
%	   } #end foreach
	   </select>
%	}else{ #we have too many 
%	   my $srchf = $c . '_srch';  #name of the form input tag
	   <input type="text" name="<% $srchf %>" value="Keywords">
	   &nbsp;<input type="button" name="" value="List" 
	   onClick="sendquery(<% '_' . $c  %>, <% $srchf . '.value' %>, <% "\'" . $linksto{$c} . "\'" %>)" >
	   <br><select name="<% '_' . $c %>"> 
%             if( defined( $obj ) && defined( $obj->$c ) && $flag && $obj->$c->id ) {
%		if (my $fkobj = $linksto{$c}->retrieve( $obj->$c->id )){
%                 my $lbl = $ui->getobjlabel( $fkobj, ", " );
            	  <option value="<% $fkobj->id %>" selected><% $lbl %></option>
%		}
%             }elsif ( exists $session{$c} ){
%		if (my $fkobj = $linksto{$c}->retrieve( $session{$c} ) ){
%                  my $lbl = $ui->getobjlabel( $fkobj, ", " );
            	   <option value="<% $fkobj->id %>" selected><% $lbl %></option>
%		}
%	      }    
              <option value="0">[null]</option>
	   </select>
%	}

        </td>

	<td class="formtablec2">
          <input name="T_<% $linksto{$c} %>" value="New" type="submit">
        </td>

        </tr>
%     } # else
%   } # for
    </tr>
    </table>
% } # if
<!-- end form --> 
