<& index.html, title => "Cable Plant: Cable Strand", s2name => $s2name  &>

<%perl>
print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

# code for inserting/updating
# -----------------------------------------------------------------------------
if (defined($ARGS{_action}))
{
    print "ARGS is <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
    
    my %update_info = ();
    if (!(%update_info = $ui->form_to_db(%ARGS)))
    {
        my $err = $ui->error();
        die("Error: $err\n");
	}

    if ($update_info{CableStrand}{key})
    {
        $id = $update_info{CableStrand}{key};
        $editStrand = 0;
    }
    
    # Do this to 'flush' the values associated with the object
    # before redisplaying
    $o = undef;
    if ($id && $id ne "NEW")
    {
        $o = CableStrand->retrieve($id);
    }
}  
# end insertion/update code
# -----------------------------------------------------------------------------
</%perl>     

% # interface...
% # ---------------------------------------------------------------------------
<!-- Header Table -->
% if (defined($o)) {
<table border="0" width="95%" align="center" cellpadding="3" cellspacing="0" class="tablebackground">
 <tr class="rowtitle0" >
    <td align="left">
        Cable Strand for Backbone: <a href="cable_backbone.html?id=<% $o->cable %>"><% $o->cable->name %></a>
    </td>
 </tr>
</table>
%}
<!-- End Header Table -->

<!-- Begin Cable Strand Table -->
<table border="0" width="95%" align="center"  class="tablebackground">
    <tr>
    <td valign="top" width="50%" align="center">
        <form name="netdotform" action="cable_strand.html" method="POST">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="_action" value="<% $id eq "NEW" ? "NEW" : "UPDATE" %>">
        <input type="hidden" name="s2name" value="<% $s2name %>">
        <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
        <tr class="formtabletitle">
            <td colspan="2" align="left">Cable Strand</td>
%           if ($editStrand) {
            <td align="right"><input name="submit" value="save" type="submit"></td>
%           } else {
            <td align="right"><a href="cable_strand.html?id=NEW">[new]</a> || <a href="cable_strand.html?id=<% $id %>&edit=strandinfo">[edit]</a> || <a href="delete.html?table=CableStrand&id=<% $id %>">[delete]</a></td>
%           }
        </tr>

        <tr align="left" valign="top">
            <td width="40%">
            <table width="100%" border="0" cellspacing="0" cellpadding="2">
            <tr align="left" valign="top">
                <td>Name: </td>
                <td>
%               $ui->textField(object=>$o, table=>"CableStrand", column=>"name", edit=>$editStrand);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Backbone: </td>
                <td>
%               $ui->selectLookup(object=>$o, table=>"CableStrand", column=>"cable", lookup=>"BackboneCable", 
%                                 where=>{id=>($backbone_id ? $backbone_id : "")}, edit=>$editStrand);
%               if ($editStrand) {
%               my $srchf = "backbone_srch";  # name of the form input tag
	            <input type="text" name="<% $srchf %>" value="Keywords" onFocus="if (this.value == 'Keywords') { this.value = ''; } return true;" style="width: 100px;">
	            &nbsp;<input type="button" name="" value="Lookup" onClick="sendquery(<% 'CableStrand__' . $id . '__cable' %>, <% $srchf . '.value' %>, 'BackboneCable')">
%               }
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Status: </td>
                <td>
%               $ui->selectLookup(object=>$o, table=>"CableStrand", column=>"status", lookup=>"StrandStatus", edit=>$editStrand);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Spliced with: </td>
                <td>
%               if (!$editStrand && $o->parent) {
                <a href="cable_strand.html?id=<% $o->parent->id %>"><% $o->parent->name %></a>
%               } elsif ($editStrand && defined($o)) {
                <%perl>
                # first we need to grab all backbones for start and end sites of this strand.
                my ($start_site, $end_site) = ($o->cable->start_closet->floor->site, $o->cable->end_closet->floor->site);
                my @backbones = ();
                
                foreach my $closet (($start_site->closets, $end_site->closets))
                {
                    map { push (@backbones, $_) } (BackboneCable->search(start_closet=>$closet),
                                                   BackboneCable->search(end_closet=>$closet));
                }
                </%perl>

                <script language="JavaScript">
                <!--
                var backboneList = new DynamicList("netdotform", "CableStrand__<% $id %>__parent", "cable", "CableStrand", "backbone_list_srch");
                LIST_MANAGER.addList(backboneList);
                -->
                </script>

                <SELECT NAME="backbone_list_srch" onChange="backboneList.doIt();">
                <OPTION VALUE="">Lookup by Backbone</OPTION>
                <%perl>
                my %stored = ();
                foreach my $bb (sort { $a->name cmp $b->name } @backbones)
                {
                    next if ($bb->id == $o->cable || exists($stored{$bb}));
                    $stored{$bb} = 1;
                    printf("<OPTION VALUE=\"%s\">%s</OPTION>\n", $bb->id, $bb->name);
                }
                </%perl>
                </SELECT> &nbsp;                
%               $ui->selectLookup(object=>$o, table=>"CableStrand", column=>"parent", lookup=>"CableStrand", edit=>$editStrand,
%                                 where=>{cable=>$o->parent->cable});
%               } else {
%               my $srchfld = "strand_srch";  # name of the form input tag
	            <input type="text" name="<% $srchfld %>" value="Keywords" onFocus="if (this.value == 'Keywords') { this.value = ''; } return true;" style="width: 100px;">
	            &nbsp;<input type="button" name="" value="Lookup" onClick="sendquery(<% 'CableStrand__' . $id . '__parent' %>, <% $srchfld . '.value' %>, 'CableStrand')"> &nbsp;
%               $ui->selectLookup(object=>$o, table=>"CableStrand", column=>"parent", lookup=>"CableStrand", edit=>$editStrand,
%                                 where=>{cable=>0});
%               }
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Circuit: </td>
                <td>
%               if (!$editStrand) {
                <a href="view.html?table=Circuit&id=<% $o->circuit_id %>"><% $o->circuit_id ? $o->circuit_id->cid : "" %></a>
%               } else {
%               $ui->selectLookup(object=>$o, table=>"CableStrand", column=>"circuit_id", lookup=>"Circuit", edit=>$editStrand);
%               if ($editStrand) {
%                   my $srchfld = "circuit_srch";  # name of the form input tag
	                <input type="text" name="<% $srchfld %>" value="Keywords" onFocus="if (this.value == 'Keywords') { this.value = ''; } return true;" style="width: 100px;">
	                &nbsp;<input type="button" name="" value="Lookup" onClick="sendquery(<% 'CableStrand__' . $id . '__circuit_id' %>, <% $srchfld . '.value' %>, 'Circuit')">
%               }                    
%               }
                </td>
            </tr>
            </table>
            </td>

            <td width="40%">
            <table width="100%" border="0" cellspacing="0" cellpadding="2">
            <tr align="left" valign="top">
                <td>Tested on: <font size="-1">(yyyy-mm-dd)</font>: </td>
                <td>
%               $ui->textField(object=>$o, table=>"CableStrand", column=>"datetested", edit=>$editStrand);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Loss: </td>
                <td>
%               $ui->textField(object=>$o, table=>"CableStrand", column=>"loss", edit=>$editStrand);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Direction: </td>
                <td>
%               $ui->textField(object=>$o, table=>"CableStrand", column=>"direction", edit=>$editStrand);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Description: </td>
                <td>
%               $ui->textField(object=>$o, table=>"CableStrand", column=>"description", edit=>$editStrand);                
                </td>
            </tr>
            </table>
            </td>
            <td>&nbsp;</td>
        </tr>

        <tr><td colspan="3">&nbsp;<br></td></tr>

        <tr align="left" valign="top">
            <td colspan="2">
            <I>Comments:</I> &nbsp;&nbsp;&nbsp;
%           $ui->textArea(object=>$o, table=>"CableStrand", column=>"info",
%                         edit=>$editStrand, htmlExtra=>"rows='3' cols='80'");
            </td>
            <td>&nbsp;</td>
        </tr>

        <tr><td colspan="3">&nbsp;<p></td></tr>

        </table>
        </form>
    </td>
    </tr>
</table>
<!-- End Cable Strand Table -->

<%args>
$id => undef;
$backbone_id => undef;
$edit => undef;
$s2name => "Plant";
</%args>

<%init>
my $DEBUG = 0;
my $ui = Netdot::UI->new();
my %cssitem = (0 => "formtablec1", 1 => "formtablec2");
my $o = undef;
my $editStrand = 0;

if ($id && $id ne "NEW") 
{
   $o = CableStrand->retrieve($id);
   $backbone_id = $o->cable;
}

$editStrand = 1 if ($id eq "NEW" || $edit eq "strandinfo");
</%init>

<%doc>
Cable management stuff...
</%doc>
