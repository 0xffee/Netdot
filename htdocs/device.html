<%doc>

-- Device Worksheet --

Interface for viewing/updating a particular Device 
and all its relevant info in one page

</%doc>
%
%
<%flags>
inherit => 'section_management.html' 
</%flags>
%
%
<%attr>
title   => 'Device' 
section => 'Management'
</%attr>
%
%
<%args>
$id        => undef
$search    => undef
$edit      => undef
$editgen   => undef
$editloc   => undef
$editmgmt  => undef
$editips   => undef
$editints  => undef
$editbgp   => undef
$ipsort    => "address"
$ifsort    => "number"
$peersort  => "ip"
$user      => undef
$showvlan  => "all"
$intadd    => undef
$submit    => undef
$view      => "Basics"
$intaddnum => undef
$deviceadd => undef
$newhost   => undef
$newip     => undef
</%args>
%
%
<%init>
my $DEBUG      = 0;
my %cssitem    = ( 0 => "formtablec1", 1 => "formtablec2" );
my $maxselect  = 100;
my $o          = undef;
my $ci         = 0;
my $name;
my %ifvlans;
my %vlans;
my $list;

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

if( defined($search) && $search =~ /\w+/ ){
    # remove spaces
    $search =~ s/\s*//g;
    unless ( ($list = $dns->getdevbynamelike($search)) ){
	print  "<p><b>No results</b>";
	$m->abort;
    }
    my $num = scalar(@$list);
    if ( $num == 1 ){
	# Don't offer list.  Just display device
	$o      = $list->[0];
	$id     = $o->id;
	$search = undef;
    }
    
}elsif( defined($search) && $search !~ /\w+/ ){
    print "<p><b>No search criteria</b>";   
    
}elsif( $intadd ){
    unless ( $dm->add_interfaces($id, $intaddnum) ){
	$m->comp('error.mhtml', error => $dm->error);	
    }
    
}elsif( $deviceadd && $newhost && $newip ){
    # Minimal info to create device manually
    my %tmp = ( host   => $newhost, 
	        dev    => { interface => { '1' => {'name'   => "eth0",
						   'number' => 1,
						   'ips'    => {$newip} } } } );
    unless ( $o = $dm->update_device(%tmp) ){
	$m->comp('error.mhtml', error => $dm->error);	
    }
}elsif( $submit ){
    # insert/update
    if ( ! $ui->form_to_db(%ARGS) ){
	$m->comp('error.mhtml', error => $ui->error);
    }
}

if ( $id ){
    unless ($o = Device->retrieve($id)){
	$m->comp('error.mhtml', error=>"Could not retrieve Device with id $id");
    }   
}elsif ( $o ){
    unless ( $id = $o->id ){
	$m->comp('error.mhtml', error=>"Object passed was not a valid Device object");
    }   
    print "Got id OK<br>" if $DEBUG;
}
if ( $o && $o->name ){
    $name = ($o->name->name) ? $o->name->name : "Name N/A!";
}else{
    $name = "Search";
}


</%init>

<div id="sectiondetail">

<script language="javascript" src="select.js"></script>

<script language="javascript">
<!--
/* 
 * Show only interfaces belonging to selected VLAN
 * 
*/
function showVlan(){
    var name = document.showvlans.showvlan.value;
    window.location = "device.html?id=<% $id %>&view=<% $view %>&showvlan="+name;
}

function addService(ip){
    var url = "addservice.html?ip="+ip;
    var wind = window.open(url, "Create IP service", "width=400,height=200");
}

function addLink(int_id, role){
    var url = "addlink.html?int_id="+int_id+"&role="+role;
    var wind = window.open(url, "Add Link", "width=600,height=200");     
}

var closetList = new DynamicList("netdotform", "Device__<% $id %>__closet", "site", "Closet", "Device__<% $id %>__site");
var roomList = new DynamicList("netdotform", "Device__<% $id %>__room", "floor", "Room", "Device__<% $id %>__site");
roomList.setQueryURL("room_site_query.html");
LIST_MANAGER.addList(closetList, roomList);

function setNull(field){
    if (!field)
	return;
    for (var i = 0; i < field.options.length; ++i){
	if (field.options[i].value == 0 || field.options[i].value == -1){
	    field.options[i].selected = true;
	    break;
	}
    }
}

-->
</script>

% if ( $search ){
<table border="0" width="100%" align="center" class="tablebackground">
 <tr class="rowtitle0" >
    <td valign="top" align="left">
       <b><% scalar(@$list) %> results for <i><% $search %></i></b>
    </td>
 </tr>
 <tr>
   <td valign="top" width="50%" align="center">
      <& sortresults.mhtml, object => $list, view => "row", page => "device.html", withdelete => 1 &>
  </td>
 </tr>
</table>

% }else{  # we're not searching

<!-- Header Table -->
<table border="0" width="100%" cellpadding="1" cellspacing="0" align="center" class="tablebackground">
 <tr class="rowtitle0" >
    <td valign="top" width="50%" align="left">
         Device: <b><% $name %></b>&nbsp;
    </td>
    <td valign="top" width="50%" align="right">
        <a href="device.html?id=<% $id %>&view=<% $view %>"> [refresh]</a>&nbsp;
	<a href="deldevice.html?id=<% $id %>"> [delete]</a>&nbsp;
    </td>
 </tr>
 <tr class="rowtitle0" >
    <td valign="top" width="50%" align="left">
       View: 
%    if ( $view eq "Basics" ){
	[Basics]
%    }else{
         <a href="device.html?id=<% $id %>&view=Basics">[Basics]</a>
%    }
%    if ( $view eq "Interfaces" ){
	[Interfaces]
%    }else{
	 <a href="device.html?id=<% $id %>&view=Interfaces">[Interfaces]</a>
%    }
%    if ( $view eq "IP" ){
	[IP info]
%    }else{
	 <a href="device.html?id=<% $id %>&view=IP">[IP info]</a>
%    }
%    if ( $o->bgppeers ){
%      if ( $view eq "BGP" ){
	 [BGP Peers]
%      }else{
	 <a href="device.html?id=<% $id %>&view=BGP">[BGP Peers]</a>
%      }
%    }
%    if ( $view eq "Topology" ){
	 [Topology]
%      }else{
	 <a href="device.html?id=<% $id %>&view=Topology">[Topology]</a>
%    }
%    if ( $view eq "History" ){
	 [History]
%      }else{
	 <a href="device.html?id=<% $id %>&view=History">[History]</a>
%    }
%    if ( $view eq "All" ){
	[All]
%    }else{
	 <a href="device.html?id=<% $id %>&view=All">[All]</a>
%    }
    </td>
    <td valign="top" width="50%" align="right">
<%perl>
 if ( $view eq "Interfaces" || $view eq "All" ){
    # Build a hash of Interface Vlans
    foreach my $if ( $o->interfaces ){
	if (scalar( my @ifv = $if->vlans)){
	    foreach my $ifv (@ifv){
		my $vid = $ifv->vlan->vid;
		$ifvlans{$if}{$vid} = "";
		$vlans{$vid} = $ifv->vlan->id;
	    }
	}
    }
</%perl>

    <form name="showvlans">
    VLAN view 
    <select name="showvlan" onchange="showVlan()">
%   if ( $showvlan eq 'all' ){
       <option value="all" SELECTED>all</option>
%   }else{
       <option value="all">all</option>
%   }
%   foreach my $vid ( sort keys %vlans ){
%     if ( $showvlan eq $vid ){
        <option value="<% $vid %>" SELECTED><% $vid %></option>     
%     }else{
        <option value="<% $vid %>"><% $vid %></option>     
%     }
%   }
    </select>
    </form>
% }

    </td>
 </tr>
</table>

% if ( $editgen || $editloc || $editmgmt || $editips || $editints || $editbgp ){	 
    <form name="netdotform" action="device.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="view" value="<% $view %>">
% }

% if ( $view eq "Basics" || $view eq "All" ){

<!-- Division Table -->
<table border="0" width="100%" align="center">
  <tr>
    <td valign="top" width="50%" align="center">

<!-- General Info Table -->
   <table border="0" width="100%" cellpadding="0" cellspacing="2" class="formtablebg">
     <tr class="formtabletitle" >
       <td colspan="2">
         <table width="100%" border="0">
           <tr>
             <td width="10%" align="left">&nbsp;</td>
             <th width="80%" align="center">General</th>
%	     if ($editgen){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	    }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&view=<% $view %>&editgen=1">[edit]</a></td>
%	    }
          </tr>
        </table>
       <td>
     </tr>
     <tr>
       <td valign="top" width="50%">
         <table border="0" width="100%">
	   <tr>
	     <td class="formtablec1">Name: </td>
	     <td class="formtablec2"> 
%	         if ($o->name && $o->name->name){
%	      	   if ($editgen){	 
		      <input type="text" name="RR__<% $o->name->id %>__name" value="<% $o->name->name %>">  
%	           }else{
		      <b><a href="view.html?table=RR&id=<% $o->name->id %>"><% $o->name->name %></a></b>
%		   }
%		 }else{ 
		   Name N/A!
%		 }
	      </td>
	    </tr>
            <tr>
              <td class="formtablec1">Type: </td>
	      <td class="formtablec2"> 
%	       if (($o->productname) && ($o->productname->type)){	 
    	        <a href="view.html?table=Product&id=<% $o->productname->id %>"><% $o->productname->type->name %></a>
%	       }
	      </td> 
	   </tr>
           <tr>
             <td class="formtablec1">S/N: </td>
	     <td class="formtablec2"> 
%               $ui->text_field(object=>$o, column=>"serialnumber", edit=>$editgen);
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">MAC: </td>
	     <td class="formtablec2"> 
%               $ui->select_lookup(object=>$o, column=>"physaddr", lookup=>"PhysAddr", edit=>"$editgen", linkPage=>"view.html");
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">First Discovered:</td>
	     <td class="formtablec2"> 
%               $ui->text_field(object=>$o, column=>"dateinstalled", edit=>$editgen);
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">Last updated:</td>
	     <td class="formtablec2"> 
%               $ui->text_field(object=>$o, column=>"lastupdated", edit=>$editgen);
	     </td> 
	   </tr>
	 </table>
      </td>
      <td valign="top" width="50%">
         <table  border="0" width="100%">
           <tr>
             <td class="formtablec1">Product: </td>
	     <td class="formtablec2"> 
%               $ui->select_lookup(object=>$o, column=>"productname", lookup=>"Product", edit=>"$editgen", linkPage=>"view.html");
	     </td>
	   </tr>
           <tr>
             <td class="formtablec1">Inventory #: </td>
	     <td class="formtablec2"> 
%               $ui->text_field(object=>$o, column=>"inventorynumber", edit=>$editgen);
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">System Descr: </td>
	     <td class="formtablec2"> 
%               $ui->text_field(object=>$o, column=>"sysdescription", edit=>$editgen);
             </td> 
	   </tr>
	 </table>
      </td>
    </tr>
    <tr>
      <td colspan="2" align="center">Comments:</td>
    </tr>
    <tr>
      <td colspan="2" align="left">
%       $ui->text_area(object=>$o, column=>"info", edit=>$editgen, htmlExtra=>"cols=60");
     </td>
    </tr>
  </table>
<!-- End General Info Table -->
% if ($editgen){	 
   </form>
% }

  </td>
  <td valign="top"  width="50%" align="center">

<!-- Location Table -->
  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
    <tr class="formtabletitle" >
      <td>
        <table width="100%" border="0">
          <tr>
            <td width="10%" align="left">&nbsp;</td>
            <th width="80%" align="center">Group/Location</th>
%	 if ($editloc){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&view=<% $view %>&editloc=1">[edit]</a></td>
%	 }
         </tr>
       </table>
     <td>
   </tr>
   <tr>
     <td>
       <table border="0" width="100%">
         <tr>
	   <td class="formtablec1">Entity: </td>
	   <td class="formtablec2"> 
%               $ui->select_lookup(object=>$o, column=>"entity", lookup=>"Entity", edit=>"$editloc", linkPage=>"view.html");
	   </td>
	   <td class="formtablec1">Site: </td>
	   <td class="formtablec2">
%               $ui->select_lookup(object=>$o, column=>"site", lookup=>"Site", edit=>"$editloc", makeLink=>1, linkPage=>"view.html", htmlExtra=>'onChange="closetList.doIt(); roomList.doIt();"');
	   </td>
	 </tr>
         <tr>
	   <td class="formtablec1">Room: </td>
	   <td class="formtablec2"> 
%               if ($editloc) {
                <select name="Device__<% $id %>__room" onChange="setNull(document.netdotform.Device__<% $id %>__closet);">
                <option value="">-- Make your selection --</option>
%               if (defined($o)) {
%                   foreach my $floor ($o->site->floors) {
%                       foreach my $room ($floor->rooms) {
%                           printf("<option value=\"%d\" %s>%s</option>\n", $room->id, ($o->room && $room->id == $o->room->id ? "SELECTED" : ""), $room->name);
%                       }
%                   }
%               }
                <option value="0">[null]</option>
                </select>
%               } else {
                <% $o->room ? sprintf("<A HREF=\"view.html?table=Room&id=%d\">%s</A>", $o->room->id, $o->room->name) : "" %>
%               }
	   </td>
	   <td class="formtablec1"> <i>- or -</i> Closet: </td>
	   <td class="formtablec2">
%               my $closet_js = sprintf("onChange=\"setNull(document.netdotform.Device__%d__room);\"", $id);
%               $ui->select_lookup(object=>$o, column=>"closet", lookup=>"Closet", edit=>$editloc, where=>{site=>($o ? $o->site : "")}, makeLink=>1, linkPage=>"closet.html", htmlExtra=>$closet_js);
	   </td>
         <tr>
	   <td class="formtablec1">Rack: </td>
	   <td class="formtablec2"> 
%               $ui->text_field(object=>$o, column=>"rack", edit=>$editloc);
	   </td>
	   <td>&nbsp; </td>
	   <td>&nbsp; </td>
	</tr>
      </table>
     </td>
   </tr>
  </table>
<!-- End Location Table -->

% if ($editloc){	
    </form>
% }

<br>
<!-- Management Table -->
  <table border="0" width="100%" class="formtablebg" cellpadding="0" cellspacing="2">
    <tr class="formtabletitle">
      <td colspan="2">
        <table width="100%" border="0">
          <tr>
            <td width="10%" align="left">&nbsp;</td>
            <th width="80%" align="center">Management</th>
%	 if ($editmgmt){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&view=<% $view %>&editmgmt=1">[edit]</a></td>
%	 }
         </tr>
       </table>
      <td>
    </tr>
    <tr>
      <td valign="top" width="50%">
        <table border="0" width="100%">
          <tr>
	    <td class="formtablec1">Contact Group: </td>
	    <td class="formtablec2"> 
%               $ui->select_lookup(object=>$o, column=>"contactlist", lookup=>"ContactList", edit=>"$editmgmt", linkPage=>"view.html");
	    </td>
	  </tr>
          <tr>
	    <td class="formtablec1">User: </td>
	    <td class="formtablec2"> 
%               $ui->select_lookup(object=>$o, column=>"person", lookup=>"Person", edit=>"$editmgmt", linkPage=>"view.html");
	    </td>
	</tr>
        <tr>
	   <td class="formtablec1">Out-of-band hostname: </td>
	    <td class="formtablec2">
%               $ui->text_field(object=>$o, column=>"oobname", edit=>$editmgmt);
	    </td>
	</tr>
        <tr>
	   <td class="formtablec1">Out-of-band tel: </td>
	   <td class="formtablec2"> 
%               $ui->text_field(object=>$o, column=>"oobnumber", edit=>$editmgmt);
	   </td>
	</tr>
        <tr>
	   <td class="formtablec1">SNMP Community: </td>
	   <td class="formtablec2"> 
%               $ui->text_field(object=>$o, column=>"community", edit=>$editmgmt);
	   </td>
	</tr>
       </table>
     </td>
     <td valign="top" width="50%">
       <table border="0" width="100%">
         <tr>
	   <td class="formtablec1">Monitored?: </td>
	   <td class="formtablec2"> 
%                $ui->radio_group_boolean(object=>$o, column=>"monitored", edit=>$editmgmt);
	   </td>
	 </tr>
         <tr>
	   <td class="formtablec1">Customer-managed?: </td>
	   <td class="formtablec2"> 
%                $ui->radio_group_boolean(object=>$o, column=>"customer_managed", edit=>$editmgmt);
	   </td>
	 </tr>
         <tr>
	   <td class="formtablec1">SNMP-managed?: </td>
	   <td class="formtablec2"> 
%                $ui->radio_group_boolean(object=>$o, column=>"snmp_managed", edit=>$editmgmt);
	   </td>
	 </tr>
         <tr>
	   <td class="formtablec1">Auto-update?: </td>
	   <td class="formtablec2"> 
%                $ui->radio_group_boolean(object=>$o, column=>"canautoupdate", edit=>$editmgmt);
	   </td>
	 </tr>
         <tr>
	   <td class="formtablec1">NATted?: </td>
	   <td class="formtablec2"> 
%                $ui->radio_group_boolean(object=>$o, column=>"natted", edit=>$editmgmt);
	   </td>
	 </tr>
       </table>
     </td>
   </tr>
%	if (! $editmgmt){	 
   <tr>
	   <td class="formtablec1">Fetch SNMP info and update DB</td>
	   <td class="formtablec2"><b><a href="updatedevice.html?host=<% $name %>&action=discover">[update]</a></b></td>
   </tr>
   <tr>
	   <td class="formtablec1">Connect via: </td>
	   <td colspan="2" class="formtablec2" ><a href="http://<% $name %>">[HTTP]</a> <a href="ssh://<% $user->getUsername() %>@<% $name %>">[SSH]</a> <a href="telnet://<% $name %>">[Telnet]</a></td>
   </tr>
%       } 
  </table>
<!-- End Management Table -->

% if ($editmgmt){	 
    </form>
% }

  </td>
 </tr>
</table>
<!-- End Division Table -->

% } 

% if ( $view eq "IP" || $view eq "All" ){

%  # Get all ip address info
%  my @ips;
%  if ( $o && $ipsort ){
%    @ips = $dm->getdevips( $o->id, $ipsort );
%  }

<!-- IPs Table -->

  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
    <tr class="formtabletitle" >
      <td>
        <table width="100%" border="0">
          <tr>
            <td width="10%" align="left">&nbsp;</td>
            <th width="80%" align="center">IPs</th>
%	    if ($editips){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	    }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&view=<% $view %>&editips=1">[edit]</a></td>
%	    }
         </tr>
       </table>
     </td>
   </tr>
   <tr>
     <td>
       <table border="0" width="100%">
%    if (scalar @ips){
         <tr>
	   <th align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&ipsort=address">Address</a></th>
	   <th align="left">Subnet</th>
	   <th align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&ipsort=interface">Interface</a></th>
	   <th align="left">DNS Name</th>
	   <th align="left">Monitored?</th>
	   <th align="left">Services</th>
         </tr>

%      foreach my $ip (@ips){	   
%        next if ( ! exists $ifvlans{$ip->interface}{$showvlan} && 
%                  $showvlan ne "all" );
%	 $ci = ($ci + 1) % 2;
	 <tr class="<% $cssitem{$ci} %>">
	   <td align="left">
%	      	 if ($editips){	 
		    <input type="checkbox" name="<% "Ipblock__" . $ip->id . "__delete" %>" >[del]
		    <% $ip->address %>
		    <br>
%	         }else{
		    <a href="ip-ws.html?id=<% $ip->id %>"><% $ip->address %></a><br>
%		 }
	   </td>
	   <td align="left">
%	     if ( int($ip->parent) != 0  ){
%	     	 if ($editips){	 
                   <% $ip->parent->address %>/<% $ip->parent->prefix %>
%                }else{
	           <a href="ip-ws.html?id=<% $ip->parent->id %>"><% $ip->parent->address %>/<% $ip->parent->prefix %></a><br>
%                }
%            }
	   </td>
	   <td align="left"><% $ip->interface->name %></td>
           <td align="left">
%              if ( $ip->arecords ){
%                 foreach my $ar ($ip->arecords){
%	             if ($editips){	 
  	                <input type="checkbox" name="<% "RR__" . $ar->rr->id . "__delete" %>" >[del]
%	             }
%                    $ui->text_field(object=> $ar->rr, column=>"name", edit=>$editips, linkPage=>"view.html");
%		  }
%              }else{
	          
%	       }
           </td>
           <td align="left">
%              $ui->radio_group_boolean(object=>$ip, column=>"monitored", edit=>$editips);
           </td>
           <td align="left">
%	      if ( scalar ($ip->services) ){
%	       foreach my $ipsrv ($ip->services){
%#                $ui->select_lookup(object=>$ipsrv, column=>"service", lookup=>"Service", edit=>"$editips", linkPage=>"view.html");       
                  <a href="view.html?table=IpService&id=<% $ipsrv->id %>"><% $ipsrv->service->name %></a>
%                if ( $editips ){
		   <input type="checkbox" name="<% "IpService__" . $ipsrv->id . "__delete" %>" > [del]
%	         }
                   <br>
%	       }
%            }
%            if ( $editips ){
               <a href="#" onClick="addService('<% $ip->id %>')">[add]</a>
%            }
           </td>
	  </tr>
%	}# foreach	
%     }else{ # No ips exist
%        if ( $editips ){
%        # Let user add a new IP           
           <tr>
	     <th align="left">Interface</th>
	     <th align="left">Address</th>
	     <th align="left">Monitored?</th>	     
           </tr>
           <tr>
             <td>
	     <select name="<% "Ipblock__" . "NEW" . "__interface" %>" >
	       <option value="0">Select Interface</option>
%	         foreach my $int ( sort { $a->number <=> $b->number } $o->interfaces ){
		   <option value="<% $int->id %>"><% $int->name %></option>                        
%		 }
	    </select>
	    </td>
	    <td>
	      <input type="text" name="<% "Ipblock__" . "NEW" . "__address" %>" >
	      <input type="hidden" name="<% "Ipblock__" . "NEW" . "__statusname" %>" value="Static">
            </td>
            <td>
	      Y <input type="radio" name="<% "Ipblock__" . "NEW" . "__monitored" %>" value="1" CHECKED>                 
	      N <input type="radio" name="<% "Ipblock__" . "NEW" . "__monitored" %>" value="0">
            </td>
         </tr>
%      }else{
         <tr>
            <td>Click [edit] to add a new IP</td>
         </tr>
%      }  
%    }
       </table>
    </td>
   </tr>
  </table>
<!-- End IPs Table -->

% if ($editips){	 
    </form>
% }

% } 

% if ( $view eq "Interfaces" || $view eq "All" ){

<!-- Interface Table -->
  <table border="0" width="100%" class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle"> 
     <td>
       <table width="100%" border="0">
        <tr>
          <th width="10%" align="left">&nbsp;</th>
          <th width="80%" align="center">Interfaces</th>
%	  if ($editints){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	  }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&view=<% $view %>&editints=1">[edit]</a></td>
%	  }
       </tr>
      </table>
     </td>
   </tr>
   <tr>
    <td>
      <table border="0" width="100%">
        <tr>
%	   if ( $editints ){	 
	     <th valign="top" align="center">[del]</th>
%	   }
	   <th valign="top" align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&ifsort=number">No.</a></th>
	   <th valign="top" align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&ifsort=name">Name</a></th>
%	   if ( ! $editints ){	 
	     <th valign="top" align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&ifsort=speed">Speed</a></th>
	     <th valign="top" align="left">Duplex<br>[oper/admin]</th>
	     <th valign="top" align="left">Status<br>[oper/admin]</th>
	     <th valign="top" align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&ifsort=vlan">VLAN</a></th>
%	   }
	   <th valign="top" align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&ifsort=jack">Jack</a></th>
	   <th valign="top" align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&ifsort=descr">Descr.</a></th>
	   <th valign="top" align="left">Uplink</th>
	   <th valign="top" align="left">Downlink</th>
       </tr>

<%perl>
	my @ifs;
       if ( $ifsort eq "number" ){
	  @ifs = $dm->interfaces_by_number( $o );
	}elsif ( $ifsort eq "name"){
	  @ifs = $dm->interfaces_by_name ( $o );
	}elsif ( $ifsort eq "speed"){
	  @ifs = $dm->interfaces_by_speed ( $o );
	}elsif ( $ifsort eq "vlan"){
	  @ifs = $dm->interfaces_by_vlan ( $o );
	}elsif ( $ifsort eq "jack"){
	  @ifs = $dm->interfaces_by_jack ( $o );
	}elsif ( $ifsort eq "descr"){
	  @ifs = $dm->interfaces_by_descr ( $o );
	}
</%perl>
			  
%       foreach my $if ( @ifs ){
%         next if ( ! exists $ifvlans{$if}{$showvlan} && $showvlan ne "all");
%	  $ci = ($ci + 1) % 2;
       <tr class="<% $cssitem{$ci} %>">
%	       if ( $editints ){	 
		<td align="left">
		  <input type="checkbox" name="<% "Interface__" . $if->id . "__delete" %>" >
		</td>	   
%	       }
	   <td align="left"> 
%               $ui->text_field(object=>$if, column=>"number", edit=>$editints, htmlExtra =>"style=\"width: 2em;\"", linkPage=>"view.html");
	   </td>
	   <td align="left"> 
%               $ui->text_field(object=>$if, column=>"name", edit=>$editints, htmlExtra =>"style=\"width: 10em;\"");
	   </td>
%	       if ( ! $editints ){	 
                 <td align="left"><% $dm->convert_ifspeed($if->speed) %></td>
		 <td align="left"><% $if->oper_duplex %>/<% $if->admin_duplex %></td>
		 <td align="left"><% $if->oper_status %>/<% $if->admin_status %></td>
		 <td align="left"> 
%	           if (exists $ifvlans{$if}){
%	             my @links;
%	             foreach my $v ( keys %{$ifvlans{$if}} ){
%		       push @links, sprintf("<a href=\"view.html?table=Vlan&id=%s\">%s</a>", $vlans{$v}, $v );
%		     }
%		     print join ', ', @links;
%	          }
	        </td>
%              }
	   <td align="left">
%           $ui->select_lookup(object=>$if, table=>"Interface", column=>"jack", lookup=>"HorizontalCable", 
%                             edit=>$editints, linkPage=>"cable_horizontal.html");
	   </td>
	   <td align="left"> 
%               $ui->text_field(object=>$if, column=>"description", edit=>$editints);
	   </td>

<!-- UpLink Connections Field -->
	   <td align="left">
%	   my @parents = $if->parents;
%	   if (scalar(@parents)){
%	     foreach my $link (@parents){
%                if ( $editints ){
		   <input type="checkbox" name="<% "InterfaceDep__" . $link->id . "__delete" %>" > [del]
%	         }   
%		 my $lbl = $ui->getobjlabel($link->parent, ", ");
                 <a href="device.html?id=<% $link->parent->device->id %>"><% $lbl %></a><br>
%	     }
%         }
%	  if ( $editints ){	 
            <a href="#" onClick="addLink('<% $if->id %>', 'child')">[add]</a>
%	  }
	  </td>
<!-- End UpLink Connections Field -->
<!-- DownLink Connections Field -->
	   <td align="left">
%	   my @children = $if->children;
%	   if (scalar(@children)){
%	     foreach my $link (@children){
%                if ( $editints ){
		   <input type="checkbox" name="<% "InterfaceDep__" . $link->id . "__delete" %>" > [del]
%	         }   
%		 my $lbl = $ui->getobjlabel($link->child, ", ");
                 <a href="device.html?id=<% $link->child->device->id %>"><% $lbl %></a><br>
%	     }
%	   }
%	   if ( $editints ){	 
             <a href="#" onClick="addLink('<% $if->id %>', 'parent')">[add]</a>
%	   }
	   </td>
<!-- End DownLink Connections Field -->

	</tr>
%       } #foreach
%    if ($editints){	 
       <tr class="formtabletitle">
            <td colspan="11" width="10%" align="right"><input name="submit" value="save" type="submit"></td>
	    </form>
%    }else{
       <tr>
	    <form action="device.html" method="POST">
	      <td colspan="11" width="100%" align="left">
	        Manually 
	        <input type="hidden" name="id" value="<% $id %>">
	        <input type="hidden" name="view" value="Interfaces">
	        <input type="submit" name="intadd" value="Add">
	        <input type="text" name="intaddnum" value="0" size="3"> interfaces
              </td>
	    </form>
%    }
       </tr>
     </table>
    </td>
  </tr>
 </table>
<!-- End Interface Table -->
% } 

% if ( $view eq "BGP" || $view eq "All" ){


<%perl>
    my @peers;
if ( $peersort eq "ip" ){
    @peers = $dm->bgppeers_by_ip( $o );
}elsif ( $peersort eq "id"){
    @peers = $dm->bgppeers_by_id( $o );
}elsif ( $peersort eq "entity"){
    @peers = $dm->bgppeers_by_entity( $o, "name" );
}elsif ( $peersort eq "asname"){
    @peers = $dm->bgppeers_by_entity( $o, "asname" );
}elsif ( $peersort eq "asnumber"){
    @peers = $dm->bgppeers_by_entity( $o, "asnumber" );
} 
</%perl>



%   if ( scalar @peers ){
<!-- BGP Peers Table -->
  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">BGP Peers</th>
%	 if ($editbgp){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device.html?id=<% $id %>&view=<% $view %>&editbgp=1">[edit]</a></td>
%	 }
      </tr>
     </table>
    <td>
   </tr>
   <tr>
     <td>
      <table border="0" width="100%">
%	if (scalar @peers){
         <tr>
	   <th align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&peersort=ip">Remote IP</a></th>
	   <th align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&peersort=id">ID</a></th>
	   <th align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&peersort=entity">Entity</a></th>
	   <th align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&peersort=asname">AS Name</a></th>
	   <th align="left"><a href="device.html?id=<% $id %>&view=<% $view %>&peersort=asnumber">AS Number</a></th>
	   <th align="left">Monitored?</th>
         </tr>
%	 foreach my $peer (@peers){
          <tr>
	   <td align="left"><% $peer->bgppeeraddr %></td>
	   <td align="left"><% $peer->bgppeerid %></td>
	   <td align="left">
%#           $ui->text_field(object=>$peer->entity, column=>"name", edit=>$editbgp, linkPage=>"view.html");
	     <a href="view.html?table=Entity&id=<% $peer->entity->id %>"><% $peer->entity->name %></a>
	   </td>
	   <td align="left"><% $peer->entity->asname %></td>
	   <td align="left"><% $peer->entity->asnumber %></td>
	   <td align="left">
%	      $ui->radio_group_boolean(object=>$peer, column=>"monitored", edit=>$editbgp);
	   </td>
          </tr>
%        }	   
%      }
      </table>
    </td>
   </tr>
 </table>
<!-- End BGP Peers Table -->
%   }
% }  
%
% if ($editbgp){	 
    </form>
% }
%
% if ( $view eq "History" || $view eq "All" ){
%   my @h_objs = $ui->gethistoryobjs($o);
%
<!-- History Table -->
  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
    <tr class="formtabletitle" >
      <td>
        <table width="100%" border="0">
          <tr>
            <td width="10%" align="left">&nbsp;</td>
            <th width="80%" align="center">History</th>
	    <td width="10%" align="right">&nbsp;</td>
         </tr>
       </table>
      <td>
   </tr>
   <tr>
      <td>
        <& sortresults.mhtml, object => \@h_objs , view => "row" &>
      </td>
    </tr>
  </table
<!-- End History Table -->
% }
%
%} # if !defined search
%
</div>
