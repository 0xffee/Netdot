<%doc>

Performs searches whose return values are used to fill in objects in HTML pages
via asynnchronous javascript calls.

It supports wildcards, regex expressions or partial matching. Such as:
* ab+ matches abc and abcc.
Notice that * indicates there are zero or more of the preceding element, such as ab*c matches "ac","abc","abbc", and so on,
while, .* indicates there are zero or more of any elements, such as ab.*c matches abdc, abedc...
  
When debugging, turn DEBUG flag on and execute directly from browser:
 
* Searching a single field:

     /generic/jsrs_netdot.html?table=Floor&form_field=floor_id&keywords=82&field=site

* Searching label fields recursively:

     /generic/jsrs_netdot.html?table=Site&form_field=site_srch&keywords=computing

</%doc>


<%flags>
inherit => undef
</%flags>

<%shared>
my $DEBUG = 0;
</%shared>

<%args>
$table      => undef
$form_field => 'form_field'
$val        => undef
$field      => undef
</%args>

<%perl>
if ( $DEBUG ){
    use Data::Dumper;
    print "<pre> ", Dumper(%ARGS), "</pre><br>";
    if ( $table ){
	print &keyword_search($table, $form_field, $val, $field);
    }
}else{
    # Do not use 'require' here.  
    # We need to make sure the file is read *each time*
    do "jsrsServer.pm";
    jsrsDispatch("keyword_search");
}


# Arguments:
# - table:      Table to search.
# - form_field: Name of the form field to add the results into
# - val:   keywords to search for
# - field:      Name of the field for which we\'re searching foreign values
#               if undefined, search will be performed recursively on the 
#               "label" fields of the table, as defined in metadata Arguments:
sub keyword_search {
    my ( $table, $form_field , $val, $field) = @_;
    my $response = $form_field."&";
    my $tmprsp;
    my $MAX   = $ui->config->get('DEFAULT_SELECTMAX');
    my $count = 0;
   
    # Added this select tag so that the user is able to select
    # something which will trigger updating of related select
    # lists.  This is important because if there is only one result then the
    # user can't trigger a change event, which is needed to trigger the
    # select update code specified via the onChange event handler
    # attribute of the selects in question.
    
    $response .= "0=-- Select -- &";
    
    if ( $table eq 'Ipblock' ){
	my $dbh = Netdot::Model->db_Main();
	my $rows = $dbh->selectall_arrayref("SELECT   id,version,address,prefix 
                                             FROM     ipblock
                                             WHERE    (version=4 AND prefix!=32)
                                                OR    (version=6 AND prefix!=128) 
                                             ORDER BY address");
     
	if ( my $n = scalar @$rows ){
            foreach my $row ( @$rows ){
		my ($id, $version, $intaddr, $prefix) = @$row;
                my $address = Ipblock->int2ip($intaddr, $version);
                my $lbl = $address.'/'.$prefix;
                if ( $lbl =~ /.*$val.*/ ){
                    $tmprsp .= $id."=".$ui->url_encode($lbl)."&"; 
                    $count++;
                }
            }
        }
    }else{
        my @rows;
        if( $field ){
           my $dbh = Netdot::Model->db_Main();
           my $dbquery = "SELECT ".$field." FROM ".$table;
           @rows = $dbh->selectall_arrayref($dbquery);         
        }else{
	   @rows = $table->retrieve_all();
	}
        if ( my $n = scalar @rows ){
              
	    my @objs = sort { $a->get_label cmp $b->get_label } @rows;
	    foreach my $o ( @objs ){
		my $lbl = $o->get_label();
                if ( $lbl =~ /.*$val.*/){
	            $tmprsp .= $o->id."=".$ui->url_encode($lbl)."&"; 
                    $count++;
	        }
            }
         }
    }
    
    if ( $count > $MAX ){
        $response .= "0=".$ui->url_encode("More than ".$MAX." matches.")."&";
        $response .= "0=".$ui->url_encode("Refine search."); 
    }elsif( $count == 0 ){
        $response .= "0=".$ui->url_encode("No matches");
    }else{
        $response .= $tmprsp;
    }

    return $response;    
}


</%perl>

