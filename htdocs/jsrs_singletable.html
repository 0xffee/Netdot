<%doc>

Calls UI::single_table_search to perform a NOT RECURSIVE search for keywords
in a table's specified label field

</%doc>


<%flags>
inherit => undef
</%flags>

<%init>
my $DEBUG = 0;
</%init>

<%perl>
print "<pre> ", Dumper(%ARGS), "</pre><br>" if $DEBUG;

do "jsrsServer.pl";
jsrsDispatch("keyword_search");

sub keyword_search {
# Arguments:
# - table:  Table to search.
# - field:  Name of the field for which we're searching foreign values
# - keyword:   keyword to search for in the "field" field of "table"
# - form_field: Name of the form field to add the results into

    my $table = shift;
    my $field = shift;
    my $keyword = shift;
    my $form_field = shift;

    my $DEBUG = 0;

    my $r;
    my $MAX   = 100;

    my $response = $form_field."&";

    $r = $ui->single_table_search(table => $table, field => $field, keyword => $keyword, max => $MAX);

    if (my $n = scalar (keys %$r) ){
        my $count = 0;

        if ($n >= $MAX){
            $response .= "0=".URLEncode("More than ".$MAX." matches. Refine search")."&";
        }
        my @objs = map { $r->{$_} } keys %$r;
        my $lblfield = ( $ui->meta->get_labels($table) )[0];
        my $type = $ui->meta->get_column_types($table, $lblfield);
        if ( $type =~ /int/ || $table eq "Interface" ){  # Ugly hack
           @objs = sort { $a->$lblfield <=> $b->$lblfield } @objs;
        }else {
           @objs = sort { $a->$lblfield cmp $b->$lblfield } @objs;
        }
        # Added this select tag so that the user is able to select
        # something which will trigger updating of related select
        # lists.  This is important because if there is only one result then the
        # user can't trigger a change event, which is needed to trigger the
        # select update code specified via the onChange event handler
        # attribute of the selects in question.
        $response .= "0=-- Select --&";

        foreach my $o (@objs){
            my $delim;
            if ( $table eq "Ipblock" ){
                $delim = "/";
            }else{
                $delim = ", "
            }
           my $lbl = $ui->getobjlabel($o, $delim);
           $response .= $o->id."=".URLEncode($lbl)."&";
           last if ($count++) == $MAX;
        }
    }else{
        $response .= "0=".URLEncode("No matches");
    }

    return $response;
}

sub URLEncode {
    my $theURL = $_[0];
   $theURL =~ s/([\W])/"%" . uc(sprintf("%2.2x",ord($1)))/eg;
   return $theURL;
}

sub URLDecode {
    my $theURL = $_[0];
    $theURL =~ tr/+/ /;
    $theURL =~ s/%([a-fA-F0-9]{2,2})/chr(hex($1))/eg;
    $theURL =~ s/<!--(.|\n)*-->//g;
    return $theURL;
}


</%perl>
