<%doc>

Web interface for device discovery and updates

</%doc>
%
%
<%attr>
title   => 'Update Device' 
section => 'Management'
</%attr>
%
%
<%args>
$action
$user
$device          => undef
$host            => undef
$comstr          => "public"
$id              => undef
$sid             => undef
$insert          => undef
$owner           => undef
$used_by         => undef
$site            => undef
$contacts        => undef
$addsubnets      => undef
$subnets_inherit => undef
</%args>
%
%
%######################################################################
%#
%# Initialization
%# 
%######################################################################
<%init>
my $DEBUG      = 0;
my $TMP        = $ui->{config}->{TMP};

my $o;
my $name;
my %argv;
my $session;
my $guessed_user_ent;
my $guessed_site;
my $guessed_cl;
my $webuser;
my $info;
my $default_owner;
my $default_cl;

my @allcls = ContactList->retrieve_all; 

print "<pre>", Dumper(%ARGS), "</pre>" if $DEBUG;

if( $action eq "discover" && ! $sid ) {
    unless ( $session = $ui->mksession( $TMP ) ){
	$m->comp('/generic/error.mhtml', error => $ui->error);
    }
}
if( $sid ) {
    unless ( $session = $ui->getsession( $TMP, $sid ) ){
	$m->comp('/generic/error.mhtml', error => $ui->error);
    }
}
if( $user ) {
    $webuser = $user->getUsername();
}

if ( $action eq "discover" ){
    if ( $device ){
	# We got a device id, so we're most likely updating
	my $devobj = Device->retrieve($device);
	# Use FQDN always
	$host = $devobj->name->name . "." . $devobj->name->zone->mname;
	$argv{comstr} = $devobj->community;
	$argv{device} = $devobj;
    }elsif ( $host ){
	$host =~ s/\s*//g;
	# We're not aware of an existing device yet
	# Probably discovering for the first time.

	# See if device exists
	if ( my $res = $dm->find_dev($host) ){
	    # We now have device and comstr in $argv
	    $argv{device} = $res->{device};
	}else{
	    # Tell update_device to not look for a device object
	    $argv{device}  = 'NEW'; 
	    # Give preference to the community being passed
	    $argv{comstr} = $comstr;
	    
	    # Try to guess the user entity based on the subnet
	    # Note that we're using the first IP address found
	    # So it might not be totally accurate, especially for
	    # routers.
	  LOOP:  foreach my $int ( keys %{ $info->{interface} } ){
	      foreach my $ip ( keys %{ $info->{interface}->{$int}->{ips} } ){ 
		  my $mask = $info->{interface}->{$int}->{ips}->{$ip};
		  if ( my $subnetaddr = $ipm->getsubnetaddr($ip, $mask) ){
		      if ( my $subnet = $ipm->searchblocks_addr($subnetaddr) ){
			  if ( my $user_ent = $subnet->used_by ){
			      $guessed_user_ent = $user_ent;
			      if ( my $cl = $user_ent->contactlist ){
				  $guessed_cl = $cl->id;
			      }if ( my @entsites = $user_ent->sites ){
				  $guessed_site = $entsites[0]->site;
			      }
			      last LOOP;  #just grab the first one
			  }
		      }
		  }
	      }
	  }
	    
	    # Get the default owner entity from config
	    $default_owner = (Entity->search(name=>$dm->{config}->{DEFAULT_DEV_OWNER}))[0];
	    
	    # If we could not determine it before, 
	    # try to guess site based on SNMP location
	    if ( ! $guessed_site ){
		if ( my $loc = $info->{syslocation} ){
		    my $loc = "%" . $loc . "%";
		    if ( my $site = (Site->search_like( name => $loc ))[0] ){
			$guessed_site = $site;
		    }
		}
	    }
	    
	    # Get the default contactlist from config
	    $default_cl = (ContactList->search(name=>$dm->{config}->{DEFAULT_CONTACTLIST}))[0];
	}
    }else{
	$m->comp('/generic/error.mhtml', error => "Discovery needs either device id or hostname");
    }
    # Fetch SNMP info
    $argv{host} = $host;
    unless ( $info = $dm->get_dev_info(%argv) ){
	$m->comp('/generic/error.mhtml', error => $dm->error);
    }
    print "<pre>", Dumper(%$info), "</pre>" if $DEBUG;
    
    $argv{info}      = $info;
    $session->{argv} = \%argv;
    
}elsif ( $action eq "update" ){
    if ( $insert ){
        my $argv              = $session->{argv};
	$argv->{owner}        = $owner          ||  0;
	$argv->{used_by}      = $used_by        ||  0;
	$argv->{site}         = $site           ||  0;
	$argv->{contacts}     = $contacts       ||  "";
	$argv->{user}         = $webuser        ||  0;
	# These two can't be 'defaulted' because
	# we are using checkboxes for user input
        $argv->{addsubnets}      = $addsubnets;
        $argv->{subnets_inherit} = $subnets_inherit;

	print "<pre>",  Dumper(%$argv), "</pre>" if $DEBUG;

        # Update database
        $o = $dm->update_device($argv);
        unless ($o){
            $m->comp('/generic/error.mhtml', error => $dm->error);
        }
        unless ($o->name && ($name = $o->name->name)){
            $name = "device";
	}
    }

}else{
    $m->comp('/generic/error.mhtml', error => "Unknown action: $action");
}

</%init>
    
%######################################################################
%#
%# User Interface
%# 
%######################################################################

<div id="sectiondetail">
 <div class="container">
   <div class="containerhead">
      Device: <strong><% $host %></strong>
   </div>

%if ( $action eq "discover" ){

    <& /generic/attribute_table.mhtml, field_headers=>["Description"], data=>[ $info->{sysdescription} ] &>
    <form name="netdotform" action="updatedevice.html" method="POST">
    <input type="hidden" name="sid" value="<% $session->{_session_id} %>">
    <input type="hidden" name="host" value="<% $host %>">
    <input type="hidden" name="action" value="update">


%     if ( ! $argv{device} || scalar($argv{device}) eq 'NEW' ){
%
%        my (@field_headers, @cell_data) = ();

% push( @field_headers, "Owner:" );
<&| "/generic/HERE.mhtml" &>
           <select name="owner" id="owner">
           <option value="0">-- Select --</option>
%          my @allents = Entity->retrieve_all; 
%          @allents = sort { $a->name cmp $b->name } @allents;
%          foreach my $ent (@allents){
%                if ( $default_owner && ($ent->id == $default_owner->id) ){
                   <option value="<% $ent->id %>" SELECTED><% $ent->name %></option>                
%                }else{
                   <option value="<% $ent->id %>"><% $ent->name %></option>
%                }
%          }
           </select>
           <a href="#" onClick="openinsertwindow('table=Entity&select_id=owner')">[new]</a>
</&>
% push( @cell_data, $_ );

% push( @field_headers, "Used by:" );
<&| "/generic/HERE.mhtml" &>
           <select name="used_by" id="used_by">
           <option value="0">-- Select --</option>
%          my @allents = Entity->retrieve_all; 
%          @allents = sort { $a->name cmp $b->name } @allents;
%          foreach my $ent (@allents){
%                if ( $guessed_user_ent && ($ent->id == $guessed_user_ent->id) ){
                   <option value="<% $ent->id %>" SELECTED><% $ent->name %></option>                
%                }else{
                   <option value="<% $ent->id %>"><% $ent->name %></option>
%                }
%          }
           </select>
           <a href="#" onClick="openinsertwindow('table=Entity&select_id=used_by')">[new]</a>
</&>
% push( @cell_data, $_ );

% push( @field_headers, "Site:" );
<&| "/generic/HERE.mhtml" &>
           <select name="site" id="site">
           <option value="0">-- Select --</option>
%          my @allsites = Site->retrieve_all; 
%          @allsites = sort { $a->name cmp $b->name } @allsites;
%          foreach my $site (@allsites){
%                if ( $guessed_site && ($site->id == $guessed_site->id) ){
                   <option value="<% $site->id %>" SELECTED><% $site->name %></option>
%                }else{
                   <option value="<% $site->id %>"><% $site->name %></option>
%                }
%          }
           </select>
           <a href="#" onClick="openinsertwindow('table=Site&select_id=site')">[new]</a>
</&>
% push( @cell_data, $_ );

% push( @field_headers, "Contacts:" );
<&| "/generic/HERE.mhtml" &>
           <select name="contacts" id="contacts" size="6" MULTIPLE>
           <option value="">-- Select --</option>
%          @allcls = sort { $a->name cmp $b->name } @allcls;
%          foreach my $cl (@allcls){
%                if ( $default_cl && ($cl->id == $default_cl->id) ){
                   <option value="<% $cl->id %>" SELECTED><% $cl->name %></option>
%                }else{
                   <option value="<% $cl->id %>"><% $cl->name %></option>
%                }
%          }
           </select>
	       Select all that apply
</&>
% push( @cell_data, $_ );

%################################################################
%# The following block only applies to routers
%################################################################
% if ( $info->{router} ){
%    push( @field_headers, "Add new Subnets (if any)?:" );
<&| "/generic/HERE.mhtml" &>
%    if ( $ui->{config}->{ADDSUBNETS} ){
	<input type="checkbox" name="addsubnets" checked>
%    }else{
	<input type="checkbox" name="addsubnets">
%    }
</&>
%    push( @cell_data, $_ );

%    push( @field_headers, "Should new subnets <br>inherit device owner/user?:" );
<&| "/generic/HERE.mhtml" &>
%    if ( $ui->{config}->{SUBNET_INHERIT_DEV_INFO} ){
	<input type="checkbox" name="subnets_inherit" checked>
%    }else{
	<input type="checkbox" name="subnets_inherit">
%    }
</&>
%    push( @cell_data, $_ );
% }


<& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

%     }
         <input name="insert" value="Update" type="submit">&nbsp;
         <input type="button" name="cancel" value="Cancel" onClick="history.go(-1);">
      </form>

%}elsif ( $action eq "update" ){

%      if ($dm->output){
                <pre><% $dm->output %></pre> <br />
%      }
	        <b><a href="device.html?id=<% $o->id %>">[Go to <% $name %>]</a></b>
%  }

 </div>
</div>
