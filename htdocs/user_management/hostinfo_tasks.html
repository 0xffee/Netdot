<%doc>

-- HOST tasks --

</%doc>
%
<%attr>
title        => 'Host Tasks' 
</%attr>
%
%
%#######################################################################
%#
%# Args section
%#
%#######################################################################
<%args>
$action     => undef
$search     => undef
$user       => undef
$submit     => undef
$show_tasks => undef
$show_block_records  => undef
$show_ipblock  => undef
$showheader => 1
</%args>
%
%
%
%#######################################################################
%#
%# INIT section
%#
%#######################################################################
%
<%init>
my $DEBUG = 0;
print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

$show_tasks = $show_tasks || $user->getAttribute("SHOW_TASKS");
if ( $show_tasks eq "" ) {
    $user->setAttribute($r, "SHOW_TASKS", "show");
    $show_tasks = "show";
}
*print_showtaskslink = $m->comp('SELF:.sub_print_showtaskslink'); 
my $hideheader = 'style="display:none"' if ( !$showheader );

my $IPV4 = Netdot->get_ipv4_regex();
my $IPV6 = Netdot->get_ipv6_regex();
my $MAC  = Netdot->get_mac_regex();

my $manager = $ui->get_permission_manager($r);

</%init>

<div id="sectiontools" <% $hideheader %>>
  <div class="container">
    <div class="containerheadleft">
        DNS/DHCP Tasks
    </div>
    <div class="containerheadright">
%       print_showtaskslink($show_tasks);
    </div>
    <div class="containerbody" id="tasks" style="display:<% ($show_tasks eq "show"?"block":"none") %>">

<%perl>
my @ipblocks;
my $ao = $ui->get_allowed_objects($r, $user);
if ( exists $ao->{Ipblock} ){
    foreach my $id ( keys %{$ao->{Ipblock}} ){
	if ( my $ip = Ipblock->retrieve($id) ){
	    push @ipblocks, $ip;
	}else{
	    delete $ao->{Ipblock}->{$id};
	}
    }
}
</%perl>

<p>

<table>
 <tr>
  <td>
    <fieldset class="small">
        <legend>Search</legend>
        <form action="hostinfo_tasks.html" method="POST">
        <label for="Find">Host:</label>
        <input type="text" name="search" class="longtxt" value="<% $search %>"> 
        </form>
    </fieldset>

    <fieldset class="small">
        <legend>Browse Records</legend>
% if ( @ipblocks ){
        <form name="zone_form" action="hostinfo_tasks.html" method="POST">
        <select name="show_block_records" onChange="document.zone_form.submit();">
            <option value="0">- Select Block -</option>
%       foreach my $o ( sort { $a->address_numeric <=> $b->address_numeric } @ipblocks ){
            <option value="<% $o %>"><% $o->get_label %></option>
%       }
        </select>
        </form>
% }else{
     No IP blocks available for this user.
% }

    </fieldset>

    <fieldset class="small">
        <legend>Add new host in</legend>
% if ( @ipblocks ){
        <form name="add_host_form" action="add_host.html" method="POST">
        <select name="add_host_block" onChange="document.add_host_form.submit();">
            <option value="0">- Select Block -</option>
%       foreach my $o ( sort { $a->address_numeric <=> $b->address_numeric } @ipblocks ){
            <option value="<% $o %>"><% $o->get_label %></option>
%       }
        </select>
        </form>
% }else{
     No IP blocks available for this user.
% }
    </fieldset>


  </td>
 </tr>
</table>

    </div> <!-- close containerbody -->
  </div> <!-- close container -->
</div> <!-- close sectiontools -->

<%perl>
if ( $show_block_records ){
    my $ipblock = Ipblock->retrieve($show_block_records);
    if ( my $zone = $ipblock->forward_zone ){
	my $records = $zone->get_hosts($ipblock->id);
	$m->comp('/management/hostlist.mhtml', records=>$records, withedit=>1, return_args=>"?show_block_records=$show_block_records");
    }else{
	$m->comp('/generic/error.mhtml', error=>$ipblock->get_label." not associated with a zone");
    }

}elsif ( $show_ipblock ){
    $m->comp('../management/ip.html', id=>$show_ipblock, user=>$user);

}elsif ( $search ){
    $search =~ s/^\s*(.*)\s*$/$1/g;
    my @list;
    if ( $search =~ /$MAC/ ){
	my @macs = PhysAddr->search(address=>$search);
	foreach my $mac ( @macs ){
	    if ( my @dhcp_hosts = $mac->dhcp_hosts ){
		foreach my $host ( @dhcp_hosts ){
		    push @list, $host->ipblock;
		}
	    }
	}
    }elsif ( $search =~ /$IPV4|$IPV6/ ){
	@list = Ipblock->search(address=>$search);
    }else{
	@list = RR->search_like(name=>$search);
    }
    # Display search results
    if ( @list ){
	if ( scalar @list == 1 ){
	    my $obj = $list[0];
	    my $class = $obj->short_class;
	    if ( $class eq 'RR' ){
		$m->comp('/management/host.html', id=>$obj->id);
	    }elsif ( $class eq 'Ipblock' ){
		unless ( $manager && $manager->can($user, "view", $obj) ){
		    $m->comp('/generic/error.mhtml', error=>"You don't have permission to view this object");
		}
		# Get the RRs associated with this IP
		if ( my @a_records = $obj->arecords() ){
		    my @rrs = map { $_->rr } @a_records;
		    $m->comp('/generic/show_search_results.mhtml', search=>$search, list=>\@rrs);
		}else{
		    $m->comp('/generic/no_search_results.html', search=>$search);
		}
	    }elsif ( $class eq 'PhysAddr' ){
		my @rrs;
		if ( my @dhcp_hosts = $obj->dhcp_hosts ){
		    if ( my @ips = map { $_->ipblock } @dhcp_hosts ){
			foreach my $ip ( @ips ){
			    if ( $manager && $manager->can($user, "view", $ip) ){
				# Get the RRs associated with this IP
				if ( my @a_records = $ip->arecords() ){
				    push @rrs, map { $_->rr } @a_records;
				}
			    }
			}
		    }
		}
		if ( @rrs ){
		    $m->comp('/generic/show_search_results.mhtml', search=>$search, list=>\@rrs);
		}else{
		    $m->comp('/generic/no_search_results.html', search=>$search);
		}
	    } 
	}else{
	    $m->comp('/generic/show_search_results.html', search=>$search, list=>@list);
	}
    } else {
	$m->comp('/generic/no_search_results.html', search=>$search);
    }
}
</%perl>


