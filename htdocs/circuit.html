<%doc>

Circuit Interface

</%doc>

<%args>

$id          => undef;
$edit        => undef;
$strand_sort => undef;
$search      => undef;
</%args>

<%flags>
inherit => 'section_cable.html' 
</%flags>

<%attr>
title   => 'Circuit' 
section => 'Plant'
</%attr>

<%init>

my $DEBUG       = 0;
my %cssitem     = (0 => "formtablec1", 1 => "formtablec2");
my $o           = undef;
my $editCircuit = 0;
my $editStrand  = 0;
my @list;

print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

$o              = Circuit->retrieve($id) if ($id && $id ne "NEW");
$editCircuit    = 1 if ($id eq "NEW" || $edit eq "circuitinfo");
$editStrand     = 1 if ($edit eq "strandinfo");

    
if ( defined($ARGS{_action}) && $ARGS{_action} eq "SEARCH" ) {

    if ( $search =~ /\w+/ ){
	# remove spaces at beginning and end
	$search =~ s/^\s*(.*)\s*$/$1/;
	unless ( @list = $cable_manager->search_circuits($search) ){
	    print  "<p><b>No results</b>";
	    $m->abort;
	}
	my $num = scalar(@list);
	if ( $num == 1 ){
	    # Don't offer list.  Just display this circuit
	    $o      = $list[0];
	    $id     = $o->id;
	    $search = undef;
	}
    }else{
	print "<p><b>No search criteria</b>";   
	$m->abort;
    }
}

# code for inserting/updating
# -----------------------------------------------------------------------------
elsif (defined($ARGS{_action}) && $ARGS{_action} eq "UPDATE_CIRCUIT") {
    my %update_info = ();
    print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
    if (!(%update_info = $ui->form_to_db(%ARGS))) {
	$m->comp("error.mhtml", $ui->error());
    }
    
    if ($update_info{Circuit}{id}) {
	$id = (keys %{$update_info{Circuit}{id}})[0];
	$editCircuit = 0;
    }
    
    # Do this to 'flush' the values associated with the object
    # before redisplaying
    $o = undef;
    if ($id && $id ne "NEW") {
	$o = Circuit->retrieve($id);
    }
} elsif (defined($ARGS{_action}) && $ARGS{_action} eq "ADD_STRANDS" && $ARGS{sequence_list}) {
    my @sequences;
    if (UNIVERSAL::isa($ARGS{sequence_list}, "ARRAY")) {
	@sequences = @{$ARGS{sequence_list}};
    } else {
	push(@sequences, $ARGS{sequence_list});
    }
    
    my $circuit_id = $o->id;
    foreach my $seq (@sequences) {
	$cable_manager->assigncircuit($circuit_id, split(/,/o, $seq));
    }
} elsif (defined($ARGS{_action}) && $ARGS{_action} eq "UPDATE_SEQUENCES") {
    foreach my $key (keys(%ARGS)) {
	next if ($key !~ /^__unassign_(\d+)/o);
	$cable_manager->removecircuit(split(/,/o, $ARGS{"__sequence_" . $1}));
    }
}

# end insertion/update code
# -----------------------------------------------------------------------------
    
</%init>

% if ( $search && @list ){

<div class="container">
  <div class="containerhead">
    <% scalar(@list) %> results for <i><% $search %></i>
  </div>
  <div class="containerbody">
      <& sortresults.mhtml, object => \@list, view => "row", page => "circuit.html", withdelete => 1, withedit => 1 &>
  </div>
</div>

% }else{  # we're not searching


<div id="sectiondetail">

% if ( $o ) {
<!-- Header Table -->
<div class="containeroutside">
    <div class="containerheadoutside">
%    if ( $o->connectionid ){
        Circuit for Connection: <a href="view.html?table=Connection&id=<% $o->connectionid %>"><% $o->connectionid->name %></a>
%    }else{
        Circuit ID: <% $o->cid %>
%    }
    </div>
    <div class="containerbodyoutside">
% }

<!-- Circuit Table -->
<form name="netdotform" action="circuit.html" method="POST">
<input type="hidden" name="id" value="<% $id %>">
<input type="hidden" name="_action" value="UPDATE_CIRCUIT">

<div class="container">
    <div class="containerheadleft">Circuit</div>
    <div class="containerheadright">
%       if ($editCircuit) {
        <input type="button" name="cancel_button" value="Cancel" onClick="history.go(-1);"> &nbsp;&nbsp; <input name="submit" value="Save" type="submit">
%           } else {
        <a href="circuit.html?id=NEW">[new]</a>  <a href="circuit.html?id=<% $id %>&edit=circuitinfo">[edit]</a>  <a href="delete.html?table=Circuit&id=<% $id %>">[delete]</a>
%           }
    </div>
    <div class="containerbody">
        <table>
         <tr>
          <td width="50%">
<div class="left">
<%perl>
my (@field_headers, @cell_data);

push( @field_headers, "Circuit ID: " );
push( @cell_data, $ui->text_field(object=>$o, table=>"Circuit", column=>"cid", edit=>$editCircuit, returnAsVar=>1 ) );

push( @field_headers, "Part of Connection: " );
push( @cell_data, $ui->select_lookup(object=>$o, table=>"Circuit", column=>"connectionid", lookup=>"Connection", edit=>$editCircuit, linkPage=>"view.html", returnAsVar=>1 ) );

push( @field_headers, "Vendor: " );
push( @cell_data, $ui->select_lookup(object=>$o, table=>"Circuit", column=>"vendor", lookup=>"Entity", edit=>$editCircuit, linkPage=>"view.html", returnAsVar=>1 ) );

push( @field_headers, "Near Interface: " );
push( @cell_data, $ui->select_lookup(object=>$o, table=>"Circuit", column=>"nearend", lookup=>"Interface", edit=>$editCircuit, linkPage=>"view.html", returnAsVar=>1 ) );

push( @field_headers, "Far Interface: " );
push( @cell_data, $ui->select_lookup(object=>$o, table=>"Circuit", column=>"farend", lookup=>"Interface", edit=>$editCircuit, linkPage=>"view.html", returnAsVar=>1 ) );

</%perl>


<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

          </td>
          <td width="50%">

<%perl>

(@field_headers, @cell_data) = ();

push( @field_headers, "Circuit Type: " );
push( @cell_data, $ui->select_lookup(object=>$o, table=>"Circuit", column=>"type", lookup=>"CircuitType", edit=>$editCircuit, returnAsVar=>1 ) );

push( @field_headers, "DLCI: " );
push( @cell_data, $ui->text_field(object=>$o, table=>"Circuit", column=>"dlci", edit=>$editCircuit, returnAsVar=>1 ) );

push( @field_headers, "Speed: " );
push( @cell_data, $ui->text_field(object=>$o, table=>"Circuit", column=>"speed", edit=>$editCircuit, returnAsVar=>1 ) );

            
push( @field_headers, "Install Date: " );
push( @cell_data, $ui->text_field(object=>$o, table=>"Circuit", column=>"installdate", default=>$ui->date(), edit=>$editCircuit, returnAsVar=>1 ) );

push( @field_headers, "Status: " );
push( @cell_data, $ui->select_lookup(object=>$o, table=>"Circuit", column=>"status", lookup=>"CircuitStatus", edit=>$editCircuit, returnAsVar=>1 ) );

</%perl>

<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

          </td>
         </tr>
       </table>
       <div class="containerseparator">Comments</div>
%           $ui->text_area(object=>$o, table=>"Circuit", column=>"info", edit=>$editCircuit, htmlExtra=>"rows='3' cols='80'");
    </div> <!-- close containerbody -->
</div> <!-- close container -->

</form>
<!-- End Circuit Table -->


<!-- Begin Cable Strand Sequence Table -->
%   if (defined($o)) {
%   my @strands = ();
%   foreach my $s ($o->strands) {
%       push(@strands, $s->id);
%   }
    <form name="sequence_form" action="circuit.html" method="POST">
    <input type="hidden" name="_action" value="UPDATE_SEQUENCES">
    <input type="hidden" name="id" value="<% $id %>">
    <& display_sequence.mhtml, strands=>\@strands, table_view=>1 &>
%   if (scalar(@strands)) {    
    <div align="left"><input type="submit" name="submit_seq" value="Unassign"></div>
%   }    
    </form>
    <P>
%   }

%   # Allow the user to add strands to this circuit by backbone.
%   # First select a start site, then an end site, and then a backbone
%   # from the populated list. Hit submit and all strands for that backbone
%   # are associated with this circuit.
%	if (defined($o) && $edit ne "strandinfo") {
    <script language="JavaScript">
    <!--
        /* getStrandList()
         *
         * Displays list of available strand sequences.
         *
        */
        function getStrandList()
        {
            var start_id = document.add_strand_form.start_id.value;
            var end_id = document.add_strand_form.end_id.value;

            if (!start_id || !end_id)
            {
                alert("You must select a start and end site.");
                return false;
            }

            var url = "get_strand_sequence_list.html?start=";
            url += start_id + "&end=" + end_id;
            url += "&field_name=sequence_list";
            url += "&form_name=add_strand_form";
            var wind = window.open(url, "tmp", "width=1,height=1");
            wind.blur();
        }
    -->
    </script>


    <div class="container">
        <div class="containerhead">Add Strands</div>
        <div class="containerbody">

        <form name="add_strand_form" action="circuit.html" method="POST">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="_action" value="ADD_STRANDS">

        <div class="left">
            <%perl>
            my @sites = Site->retrieve_all();
            @sites = sort { $a->name cmp $b->name } @sites;
            </%perl>
            <input type="hidden" name="page_type" value="BACKBONE">
            Backbones connected from:<br>
            <select name="start_id" style="width: 225px">
                <option value="">-- Make your selection --</option>
                <%perl>
                foreach my $site (@sites) {
                    printf("<option value=\"%s\">%s</option>\n", $site->id, $site->name);
                }
                </%perl>
            </select> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<B>- TO -</B><br>
   
            <select name="end_id" style="width: 225px;">
                <option value="">-- Make your selection --</option>
                <%perl>
                foreach my $site (@sites) {
                    printf("<option value=\"%s\">%s</option>\n", $site->id, $site->name);
                }
                </%perl>
            </select> <br />
            <input type="button" name="get_bb_list" value="Get Strand List" onClick="getStrandList();">

        </div>
        <div class="right">
            Available Strand Sequence(s):<br />
            <select name="sequence_list" style="width: 500px;" multiple size="4"></select>
    	        <br />&nbsp;<input type="submit" name="strand_add" value="Add">&nbsp;
        </div><div class="clear"></div>
        </form>

        </div> <!-- close containerbody -->
    </div> <!-- close container -->
%   }
<!-- End Cable Strand Table -->

% if (defined($o) && $o->connectionid) {
    </div> <!-- close containerbodyoutside -->
</div> <!-- close containeroutside -->
% }

</div> <!-- close sectiondetail -->

%}
