<%doc>

  Generic object view
  Uses metadata to display all fields with their values
  and lists of each group of 'has_many' related objects

  Required Arguments:
    table name and either id or position

</%doc>

<%args>
$table
$id
$view    => "all"
</%args>

<%flags>
inherit => 'section_generic.html' 

</%flags>

<%attr>
title   => 'View Object' 
section => 'Generic'
</%attr>

<%init>
my($obj, $prevobj );
my %ftables;

unless ( $obj = $table->retrieve($id) ){
   $m->comp('error.mhtml', "Nonexistent record: $id");
}

my $labelstr  = $ui->getobjlabel($obj, ", ");
my %linksto   = $ui->getlinksto($table);
my %linksfrom = $ui->getlinksfrom($table);
my %order     = $ui->getcolumnorder($table);
my %tags      = $ui->getcolumntags($table);

if ($table !~ /_history/){
    # List all the has_many objects for this object
    #
    foreach my $i (keys %linksfrom){
	my $j;
	map { $j = $_ } keys %{ $linksfrom{$i} };
	$ftables{$i}{ffield} = $linksfrom{$i}{$j};  #column in the other table that points to this table
	# If foreign table is a join table, try to hide it
	# THIS MAYBE SHOULD CHANGE TO USE THE MAPPING FEATURE FROM CLASS::DBI INSTEAD
	if ( $ui->isjointable($j) ){
	    # Get has_a entries 
	    my %jlinksto = $ui->getlinksto($j);
	    # Column in join table that points to third table
	    my $col;
	    map { $col = $_ if ($_ ne $linksfrom{$i}{$j}) } keys %jlinksto;
	    map { push @{ $ftables{$i}{robjs} }, $_->$col } $obj->$i;
	    $ftables{$i}{dtbl} = $jlinksto{$col};  # table to display
	    $ftables{$i}{ctbl} = $j;               # table to pass to create.html
	}else{  # table is not a join table
	    @{$ftables{$i}{robjs}} = $obj->$i;
	    $ftables{$i}{dtbl} = $j;
	    $ftables{$i}{ctbl} = $j; 
	}
    }
}

my $h_table = $ui->gethistorytable($obj);
my $h_meta = $ui->getmeta($h_table);

</%init>

<div id="sectiondetail">

%  if ($table !~ /_history/){
      <div class="container">
	<div class="containerhead">View</div>
	   <div class="containerbody">
%	      if ($view eq "all"){
		  [all]
%	      }else{
		  <a href="view.html?table=<% $table %>&id=<% $obj %>&view=all">[all]</a>
%             }
%	      if ($view eq $table){
		  [<% lc($table) %>]
%	      }else{
                  <a href="view.html?table=<% $table %>&id=<% $obj %>&view=<% $table %>">[<% lc($table) %>]</a>
%             }
%             foreach my $i (keys %ftables){
%               if ($view eq $i){
                   [<% $i %>]
%               }else{
                   <a href="view.html?table=<% $table %>&id=<% $obj %>&view=<% $i %>">[<% $i %>]</a>
%               }   
%             }
%             if ( defined($h_meta) ){  # only if there's a history table.
                 <a href="view.html?table=<% $table %>&id=<% $obj %>&view=history">[history]</a>
%             }
	   </div>
	</div>
      </div>
%  }

  <div class="containeroutside">

<%perl>

if ($view eq 'all' || $view eq "$table"){
  
my (@fields, @data);

    foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
	next if ($c eq 'id' || $c eq 'aliases');
	
	if ( exists($tags{$c}) ){
	    push @fields, $tags{$c};
	}else{
	    push @fields, $c;
	}

	if (!exists($linksto{$c}) ){  ## Column is local
	    if ( $ui->getsqltype($table,$c) =~ /bool/ ){
		push @data, $ui->radio_group_boolean(object=>$obj, column=>$c, edit=>0, returnAsVar=>1);
		
	   }elsif ($c eq "info"){
	       push @data, $ui->text_area(object=>$obj, column=>$c, edit=>0, returnAsVar=>1);
	   }else{
	       push @data, $ui->text_field(object=>$obj, column=>$c, edit=>0, returnAsVar=>1);
	   }

      } else {  # Column is foreign key
            push @data, $ui->select_lookup(object=>$obj, column=>$c, lookup=>$linksto{$c}, edit=>0, linkPage=>"view.html", returnAsVar=>1);	     
      }
   }

</%perl>

	<div class="containerheadleftoutside"><strong><% $table %></strong></div>
	<div class="containerheadrightoutside">
%	          if ($table !~ /_history/){
	             <a href="edit.html?table=<% $table %>&id=<% $obj %>">[edit]</a>
%	          }
%	          if ($table eq "Device"){
	             <a href="device.html?id=<% $obj %>">[custom]</a>
%		  }elsif ( $table eq "Ipblock" ){
	             <a href="ip-ws.html?id=<% $obj %>">[custom]</a>
%                 }
	          <a href="delete.html?table=<% $table %>&id=<% $obj %>">[delete]</a>
%	          if ($table !~ /_history/){
	             <a href="edit.html?table=<% $table %>">[new]</a>
%	          }
	</div>

	<div class="containerbodyoutside">
	  <& attribute_table.mhtml, field_headers=>\@fields, data=>\@data, headercolwidth=>"20%" &>
	</div>
%}
<!-- End Display main object values -->


<!-- Display has_many objects -->

%   foreach my $i (keys %ftables){
%     if ( ($view eq 'all' || $view eq $i ) && $view ne "$table"){
          <div class="container">
	    <div class="containerheadleft"><% $i %></div>
	    <div class="containerheadright">
	       <a href="edit.html?table=<% $ftables{$i}{ctbl} %>&<% $ftables{$i}{ffield} %>=<% $obj %>">[Add]</a>
	    </div>
	    <div class="containerbody">
              <& sortresults.mhtml, table => $ftables{$i}{dtbl}, object => $ftables{$i}{robjs}, view => "row" &>
	    </div>
          </div>
%     }
%   } 

<!-- End Display has_many objects -->

<!-- Display history objects associated with this object-->

%  if ( $view eq 'history' ){
%   my @ho = $ui->gethistoryobjs($obj);
    <& sortresults.mhtml, object => \@ho , view => "row" &>
%  } 

<!-- End Display history objects -->

   </div>
</div>
