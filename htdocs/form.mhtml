
<script language="javascript" src="select.js"></script>

% ####################################################################
<!-- begin form --> 
% if( defined( $args{table} ) ) {
    <table width="95% cellpadding="3" cellspacing="1" border="0" class="formtablebg">
    <tr>
    <input type="hidden" name="table" value="<% $args{table} %>">
%   if( $args{id} ) {
    <input type="hidden" name="id" value="<% $args{id} %>">
%   }
%   foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%     next if( $c eq 'id' );
%     next if( $c eq 'disabled' && ! $args{showdisabled} );
% ################################################
%     if( ! exists( $linksto{$c} ) ) { # local field
        <tr>
%       if ( exists($tags{$c}) ){
           <td class="formtablec1"><strong><% $tags{$c} %>:</strong></td>
%	}else{
           <td class="formtablec1"><strong><% $c %>:</strong></td>
%	}
%       if( defined( $args{id} ) ) {
	    <td class="formtablec2" colspan="2"><% $ui->getinputtag($c, $obj) %></td>
%       } elsif( exists( $session{$c} ) ) {
	    <td class="formtablec2" colspan="2"><% $ui->getinputtag($c, $linksto{$c}, $session{$c}) %></td>
%       } else {
	    <td class="formtablec2" colspan="2"><% $ui->getinputtag($c, $args{table}) %></td>
%       }
        </tr>
% ################################################
%     } else {  # The column is a foreign key. Provide a list to select.
        <tr>
%       if ( exists($tags{$c}) ){
           <td class="formtablec1"><strong><% $tags{$c} %>:</strong></td>
%	}else{
           <td class="formtablec1"><strong><% $c %>:</strong></td>
%	}
	<td class="formtablec2">
%       my $flag = 1;
%	# Check for amount of objects in table before retrieving all
%	my $count = $linksto{$c}->count_all;
%	if ( $count <= $maxselect ){			      
%	   my @fkobjs = $linksto{$c}->retrieve_all;
%	   my $lblfield = ( $ui->getlabels($linksto{$c}) )[0];	 
%	   @fkobjs = sort { $a->$lblfield cmp $b->$lblfield } @fkobjs; 
   	   <select name="<% $c %>">
%          if( defined( $obj ) 
%            && ( ! $obj->$c 
%              || ! defined( $linksto{$c}->retrieve( $obj->$c->id ) ) ) ) {
              <option value="0" selected>[null]</option>
%             $flag = 0;
%          } else {
              <option value="0">[null]</option>
%          }
%	   foreach my $fkobj ( @fkobjs ) {
%             my $lbl = $ui->getobjlabel( $fkobj, ", " );
%             if( ( defined( $obj ) && $flag && $fkobj->id == $obj->$c->id ) 
%             	|| ( $fkobj->id == $session{$c} ) ) {
            	<option value="<% $fkobj->id %>" selected><% $lbl %></option>
%             } else {
            	<option value="<% $fkobj->id %>"><% $lbl %></option>
%             }
%	   } #foreach
	   </select>
%	}else{ #we have too many 
%	   my $srchf = $c . '_srch';  #name of the form input tag
	   <input type="text" name="<% $srchf %>" value="Keywords">
	   &nbsp;<input type="button" name="" value="List" 
	   onClick="sendquery(<% '_' . $c  %>, <% $srchf . '.value' %>, <% "\'" . $linksto{$c} . "\'" %>)" >
	   <br><select name="<% '_' . $c %>"> 
%             if( defined( $obj ) && defined( $obj->$c ) && $flag && $obj->$c->id ) {
%		if (my $fkobj = $linksto{$c}->retrieve( $obj->$c->id )){
%                 my $lbl = $ui->getobjlabel( $fkobj, ", " );
            	  <option value="<% $fkobj->id %>" selected><% $lbl %></option>
%		}
%             }elsif ( exists $session{$c} ){
%		if (my $fkobj = $linksto{$c}->retrieve( $session{$c} ) ){
%                  my $lbl = $ui->getobjlabel( $fkobj, ", " );
            	   <option value="<% $fkobj->id %>" selected><% $lbl %></option>
%		}
%	      }    
              <option value="0">[null]</option>
	   </select>
%	}

        </td>

	<td class="formtablec2">
          <input name="T_<% $linksto{$c} %>" value="New" type="submit">
        </td>

        </tr>
%     } # else
%   } # for
    </tr>
    </table>
% } # if
<!-- end form --> 

% ####################################################################
<%args>
%args => undef
%order => undef
%orderbrief => undef
%linksto => undef
%tags => undef
$obj => undef
%session => undef
$META => undef
$ui => Netdot::UI->new()
$DEBUG => 0
</%args>

<%init>
my $maxselect = 100;

# expect name of Table & objects that require sorting
foreach my $j ( keys %ARGS ) {
  # next if( $ARGS{$j} !~ /\w+/ || $j eq "submit" );
  $args{$j} = $ARGS{$j};
}
if( exists( $args{session} ) ) {
  %session = %{ $args{session} };
}
unless( defined( $args{showdisabled} ) ) {
  $args{showdisabled} = 0;
}
undef $obj;
if( $args{table} ) {
  if( defined( $args{id} ) ) {
    $obj = $args{table}->retrieve($args{id}) ;
  }
  $META = $ui->getmeta( $args{table} );
  if( defined( $META ) ) {
    my $i = 1;
    %order = $ui->getcolumnorder( $args{table} );
    %linksto = $ui->getlinksto( $args{table} );
    %tags = $ui->getcolumntags( $args{table} );
  }
}
</%init>

<%doc>

Arguments:  
  table         -  name of table (REQUIRED)
  id            -  id (row) from the above table  (OPTIONAL)
  showdisabled  -  1|0  whether to show disabled columns
  session       -  ref to a hash with values to insert (if object ! exist)
  title         -  a title string to show in first line of form

</%doc>
