<%doc>

Cable management stuff...

</%doc>

<%args>
$id       => undef;
$edit     => undef;
$int_sort => undef;
</%args>

<%flags>
inherit => 'section_cable.html' 
</%flags>

<%attr>
title   => 'Horizontal Cable' 
section => 'Plant'
</%attr>

<%init>
my $DEBUG     = 0;
my %cssitem   = (0 => "formtablec1", 1 => "formtablec2");
my $o         = undef;
my $site      = undef;
my $editCable = 0;
my $editInt   = 0;

if ($id && $id ne "NEW") {
   $o = HorizontalCable->retrieve($id);
   $site = $o->closet->site;
}

$editCable = 1 if ($id eq "NEW" || $edit eq "cableinfo");
$editInt   = 1 if ($edit eq "intinfo");

# For table building modules:
my (@field_headers, @cell_data, @headers, @rows);
</%init>

<%perl>
print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

# code for inserting/updating
# -----------------------------------------------------------------------------
if (defined($ARGS{_action}) && $ARGS{_action} eq "UPDATE" || $ARGS{_action} eq "NEW") {
    my %update_info = ();
    print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
    if (!(%update_info = $ui->form_to_db(%ARGS))) {
        $m->comp("error.mhtml", $ui->error());
	}

    if ($update_info{HorizontalCable}{id}) {
        $id = (keys %{$update_info{HorizontalCable}{id}})[0];
    }

    # Do this to 'flush' the values associated with the object
    # before redisplaying
    $o = undef;
    $site = undef;
    if ($id && $id ne "NEW") {
        $o = HorizontalCable->retrieve($id);
        $site = $o->closet->site;
        
        $editCable = 0;
        $editInt = 0;
    }
} elsif (defined($ARGS{_action}) && $ARGS{_action} eq "ADD_INTERFACE") {
    print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
    my @interfaces;
    if (UNIVERSAL::isa($ARGS{interfaces}, "ARRAY")) {
        @interfaces = @{$ARGS{interfaces}};
    } else {
        push(@interfaces, $ARGS{interfaces});
    }

    $m->comp("error.mhtml", $cable_manager->error()) if (!($cable_manager->insertinterfaces($o, @interfaces)));
}

# end insertion/update code
# -----------------------------------------------------------------------------
</%perl>

% if ($editCable) {

<script language="JavaScript">
<!--
var closetSearchList = new DynamicList("horizform", "HorizontalCable__<% $id %>__closet", "site", "Closet", "closet_srch");

/* Code for looking up a room. User selects a site and is presented with:
*     - a list of all floors for that site.
*     - a list of all rooms for that site.
* The user can select a floor and narrow the selection to rooms on that floor.
*/
var roomFloorLookup = new DynamicList("horizform", "HorizontalCable__<% $id %>__room", "floor", "Room", "room_floor_srch");
var siteFloorLookup = new DynamicList("horizform", "room_floor_srch", "site", "Floor", "room_site_srch", roomFloorLookup);

LIST_MANAGER.addList(closetSearchList, roomFloorLookup, siteFloorLookup);

// createJackID()
// Attempts to generate a JackID based on Site, Closet, and a user supplied
// jack number. Format for a jack id is: <building number><closet><jack number>
// ----------------------------------------------------------------------------
function createJackID()
{
    var closetid = document.horizform.HorizontalCable__<% $id %>__closet.value;
    var jackno = document.horizform.__jackno.value;
    if (!jackno)
    {
        alert("You must specify a Jack Number in order to create a new Jack ID.");
        return false;
    }

    if (!closetid || closetid == -1)
    {
        alert("You must specify a Closet in order to create a new Jack ID.");
        return false;
    }

    var url = "suggest_jackid.html?closetid=";
    url += closetid + "&jackno=" + jackno;
    url += "&name=HorizontalCable__<% $id %>__jackid";

    var wind = window.open(url, "tmp_<% $id %>", "width=1,height=1");
    wind.blur();
}
-->
</script>

% }

<%perl>
my @sites = Site->retrieve_all();
@sites = sort { $a->name cmp $b->name } @sites;
</%perl>

% # interface...
% # ---------------------------------------------------------------------------

<div class="containeroutside">

% if ($site) {
<!-- Header Table -->
<div class="containerheadoutside">
        Horizontal Cable for Site: <a href="cable_plant.html?id=<% $site->id %>&page_type=HORIZONTAL"><% $site->name %></a>&nbsp;&nbsp;&nbsp;
</div>
% }

<div class="containerbodyoutside">
  <!-- Horizontal Cable Table -->
  <div class="container">
    <form name="horizform" action="cable_horizontal.html" method="POST">
      <input type="hidden" name="id" value="<% $id %>">
      <input type="hidden" name="HorizontalCable__<% $id %>__jackid" value="<% $o ? $o->jackid : "" %>">
      <input type="hidden" name="_action" value="<% $id eq "NEW" ? "NEW" : "UPDATE" %>">

      <div class="containerheadleft">
           Horizonal Cable
      </div>

      <div class="containerheadright">
%	if ($editCable) {
	  <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);"> &nbsp;&nbsp; <input name="submit" value="save" type="submit">
%	} else {
	  <a href="cable_horizontal.html?id=NEW">[new]</a>
	  &nbsp;&nbsp; <a href="cable_horizontal.html?id=<% $id %>&edit=cableinfo">[edit]</a>
	  &nbsp;&nbsp; <a href="delete.html?table=HorizontalCable&id=<% $id %>">[delete]</a>
%       }
      </div>

      <div class="containerbody">
	<table> <!-- Start two column layout table -->
	  <tr>

	    <!-- start left subtable -->
	    <td>
	      <%perl>
	      (@field_headers, @cell_data) = ();
		push( @field_headers, "Jack ID: " );
		push( @cell_data, 
		    &{sub{
			my $ac = "";
			if ($editCable) {
			    $ac .= '<input type="text" name="__jackid" value="' . ($o ? $o->jackid : "") . '" onChange="document.horizform.HorizontalCable__'
				. $id . '__jackid.value = this.value" DISABLED>';
			} else {
			    $ac .= $o->jackid;
			}
			$ac;
		    }} );
		if ($editCable) {
		    push( @field_headers, "Jack Number: " );
		push( @cell_data, 
		      '<input type="text" value="" name="__jackno">'
		      . '<input type="button" value="Create Jack ID" name="createjack" onClick="return createJackID();"> '
		      );
		}
        my @fields = ('faceplateid','type','installdate','datetested','testpassed');
        $ui->add_to_fields(o=>$o, edit=>$editCable, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);

        </%perl>

	      <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>
	    </td> <!-- End left subtable -->

	    <td> <!-- Start right subtable -->
	      <%perl>
		    (@field_headers, @cell_data) = ();
		push( @field_headers, "Closet: " );
		push( @cell_data, 
		    &{sub{
			my $ac = "";
			if ($editCable) {
			    $ac .= $ui->select_lookup(object=>$o, table=>"HorizontalCable", column=>"closet", lookup=>"Closet", 
						      edit=>$editCable, where=>{site=>($site ? $site->id : "")}, returnAsVar=>1);
			    $ac .= '&nbsp;<select name="closet_srch" onChange="closetSearchList.doIt();">';
			    $ac .= '<option value="">Lookup by Site</option>';
			    foreach my $s (@sites) {
				$ac .= sprintf("<option value=\"%s\">%s</option>\n", $s->id, $s->name);
			    }
			    $ac .= '</select>';
			} else {
			    $ac .= '<a href="closet.html?id='.$o->closet.'">'.$o->closet->name.'</a>';
			}
			$ac;
		    }} );
		push( @field_headers, "Room: " );
		push( @cell_data, 
		    &{sub{
			my $ac = "";
			if ($editCable) {
			    $ac .= $ui->select_lookup(object=>$o, table=>"HorizontalCable", column=>"room", lookup=>"Room",
						      edit=>$editCable, where=>{id=>($o ? $o->room : "")}, returnAsVar=>1);
			    $ac .= '&nbsp;<select name="room_site_srch" onChange="siteFloorLookup.doIt();">';
			    $ac .= '<option value="">Lookup by Site</option>';
			    foreach my $s (@sites) {
				$ac .= sprintf("<option value=\"%s\">%s</option>\n", $s->id, $s->name);
			    }
			    $ac .= '</select>';
			    $ac .= '&nbsp;&nbsp;Floor:<select name="room_floor_srch" onChange="roomFloorLookup.doIt();"></select>';
			} else {
			    $ac .= '<a href="view.html?table=Room&id='.$o->room.'">'.$o->room->name.'</a>';
			}
			$ac;
		    }} );

            @fields = ('account','contactlist');
            $ui->add_to_fields(o=>$o, edit=>$editCable, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);

	      </%perl>

	      <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>
	    </td> <!-- End right subtable -->	    
	  </tr>
	</table> <!-- End two column layout table -->
	<div class="containerseparator">
	  Comments
	</div>
%       $ui->text_area(object=>$o, table=>"HorizontalCable", column=>"info",
%                      edit=>$editCable, htmlExtra=>"rows='3' cols='80'");
      </form>
    </div>
  </div>
  <!-- End Horizontal Cable Table -->

  <!-- Interface Table -->
%   if (defined($o)) {
%     if (!$editCable) {
        <div class="container">
	  <div class="containerhead">
	    <A NAME="interface"></A>
	    Add Interfaces
	  </div>

	  <div class="containerbody">
	    <form name="netdotform" action="cable_horizontal.html" method="POST">
	      <input type="hidden" name="id" value="<% $id %>">
	      <input type="hidden" name="_action" value="ADD_INTERFACE">

%             my $srchf = "interface_srch";  # name of the form input tag
	      <input type="text" name="<% $srchf %>" value="Keywords" onFocus="if (this.value == 'Keywords') { this.value = ''; } return true;" />
	      &nbsp;<input type="button" name="" value="Interface Lookup" 
	      onClick="sendquery(<% 'interfaces' %>, <% $srchf . '.value' %>, 'Interface')" />
	      &nbsp;&nbsp;
	      <select name="interfaces" multiple size="3">
		<option value="0">[null]</option>
              </select> &nbsp;<input type="submit" name="add_interfaces" value="Add">
	    </form>

	  </div>
	</div>
%     }

    <%perl>
    my @ints;
    map { push (@ints, $_) } $o->interfaces;
    </%perl>

%   if (scalar(@ints)) {
      <div class="container">
	<form name="int_form" action="cable_horizontal.html" method="POST"> <!-- Whole div is a form -->
	  <input type="hidden" name="id" value="<% $id %>">
	  <input type="hidden" name="_action" value="UPDATE">

	    <div class="containerheadleft">
	      Interfaces
	    </div>

	    <div class="containerheadright">
%	      if ($editInt) {	 
	        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
		  &nbsp;&nbsp; <input name="submit" value="save" type="submit">
%	      } else {
                <a href="cable_horizontal.html?id=<% $id %>&edit=intinfo#interface">[edit]</a>
%	      }
            </div>

	    <div class="containerbody">
	      <%perl>
		(@headers, @rows) = ();
		push( @headers, '<a href="cable_horizontal.html?id=' . $id . '&int_sort=name#interface">Name</a>' );
		push( @headers, '<a href="cable_horizontal.html?id=' . $id . '&int_sort=number#interface">Number</a>' );
		push( @headers, '<a href="cable_horizontal.html?id=' . $id . '&int_sort=type#interface">Type</a>' );
		push( @headers, '<a href="cable_horizontal.html?id=' . $id . '&int_sort=device#interface">Device</a>' );
	      </%perl>

	      <%perl>
  	        $int_sort = "name" if (!defined($int_sort) || $int_sort eq "");
		my @sorted_ints;
		if ($int_sort eq "device") {
		    @sorted_ints = sort { $a->device->name cmp $b->device->name } @ints;
		} else {
		    @sorted_ints = sort { $a->$int_sort cmp $b->$int_sort } @ints;
		}
	      </%perl>

	      <%perl>
		foreach my $int (@sorted_ints) {
		    my @row = ();
		    push( @row, 
			  &{sub{
			      my $ac = "";
			      if ($editInt) {
				  $ac .= '<input type="checkbox" name="' . "Interface__" . $int->id . "__delete" . '">[del] ';
				  $ac .= $ui->form_field(object=>$int, column=>"name", edit=>($edit eq "intinfo"), returnValOnly=>1);
			      } else {
				  $ac .= '<a href="view.html?table=Interface&id=' . $int->id . '">' . $int->name . '</a>';
			      }
			      $ac;
			  }} );
		    push( @row, $ui->form_field(object=>$int, column=>"number", edit=>$editInt, returnValOnly=>1) );
		    push( @row, $ui->form_field(object=>$int, column=>"type", edit=>$editInt, returnValOnly=>1) );
		    push( @row, 
			  &{sub{
			      my $ac = "";
			      if ($editInt) {        
				  $ac .= $ui->form_field(object=>$int, column=>"device", edit=>$editInt, returnValOnly=>1);
			      } else {
				  $ac .= '<a href="device.html?id=' . $int->device . '">' . $int->device->name->name . '</a>';
			      }
			      $ac;
			  }} );
		    push( @rows, \@row );
		}
	      </%perl>

	      <& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>
	    </form>	<!-- Whole div is a form -->

	  </div>
	</div>
%     } #if (scalar(@ints))    
%   } #if (defined($o))
    <!-- End Interface Table -->
  </div>
</div>

