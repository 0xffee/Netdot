<%doc>

Web interface for device discovery and updates

</%doc>
%
%
<%flags>
inherit => 'section_management.html' 
</%flags>
%
%
<%attr>
title   => 'Update Device' 
section => 'Management'
</%attr>
%
%
<%args>
$action
$user
$device       => undef
$host         => undef
$comstr       => "public"
$id           => undef
$sid          => undef
$insert       => undef
$entity       => undef
$site         => undef
$contactlist  => undef
$contactlist2 => undef
</%args>
%
%
<%init>
my $DEBUG = 0;
my $TMP = $ui->{config}->{TMP};
my $ADDSUBNETS = 1;

my $o;
my $name;
my %argv;
my $session;
my $guessed_ent;
my $guessed_site;
my $guessed_cl;
my $webuser;
my $dev;
my $default_cl;

my @allcls = ContactList->retrieve_all; 

print "<pre>", Dumper(%ARGS), "</pre>" if $DEBUG;

if( $action eq "discover" && ! $sid ) {
    unless ( $session = $ui->mksession( $TMP ) ){
	$m->comp('error.mhtml', error => $ui->error);
    }
}
if( $sid ) {
    unless ( $session = $ui->getsession( $TMP, $sid ) ){
	$m->comp('error.mhtml', error => $ui->error);
    }
}
if( $user ) {
    $webuser = $user->getUsername();
}

if ( $action eq "discover" ){
    if ( $device ){
	# We got a device id, so we're most likely updating
	my $devobj = Device->retrieve($device);
	$host = $devobj->name->name;
	$argv{comstr} = $devobj->community;
	$argv{device} = $devobj;
    }elsif ( $host ){
	$host =~ s/\s*//g;
	# We're not aware of an existing device yet
	# Probably discovering.

	# See if device exists
	my (undef, $d) = $dm->find_dev($host);
	# We probably want to use the community that is being passed
	$argv{comstr} = $comstr;
	$argv{device} = $d;
    }else{
	$m->comp('error.mhtml', error => "Discovery needs either device id or hostname");
    }
    # Fetch SNMP info
    $dev = $dm->get_dev_info($host, $argv{comstr});
    unless ($dev){
	$m->comp('error.mhtml', error => $dm->error);
    }
    print "<pre>", Dumper($dev), "</pre>" if $DEBUG;
    
    $argv{dev}       = $dev;
    $argv{host}      = $host;
    $session->{argv} = \%argv;
    
    # Try to guess the Entity based on the ip address
LOOP:   foreach my $int ( keys %{ $dev->{interface} } ){
            foreach my $ip ( keys %{ $dev->{interface}->{$int}->{ips} } ){ 
		my $mask = $dev->{interface}->{$int}->{ips}->{$ip};
		if ( my $subnetaddr = $ipm->getsubnetaddr($ip, $mask) ){
		    if ( my $subnet = $ipm->searchblocks_addr($subnetaddr) ){
			if ( my $ent = $subnet->entity ){
			    $guessed_ent = $ent;
			    if ( my $cl = $ent->contactlist ){
				$guessed_cl = $cl->id;
			    }if ( my @entsites = $ent->sites ){
				$guessed_site = $entsites[0]->site;
			    }
			    last LOOP;  #just grab the first one
			}
		    }
		}
	    }
	}
    # If we could not determine it before, 
    # try to guess site based on SNMP location
    if ( ! $guessed_site ){
	if ( my $loc = $dev->{syslocation} ){
	    my $loc = "%" . $loc . "%";
	    if ( my $site = (Site->search_like( name => $loc ))[0] ){
		$guessed_site = $site;
	    }
	}
    }
    
    # Get the default contactlist from config
    $default_cl = (ContactList->search(name=>$dm->{config}->{DEFAULT_CONTACTLIST}))[0];
    
}elsif ( $action eq "update" ){
    if ( $insert ){
        %argv               = %{ $session->{argv} };
	$argv{entity}       = $entity       ||  0;
	$argv{site}         = $site         ||  0;
	$argv{contactlist}  = $contactlist  ||  0;
	$argv{contactlist2} = $contactlist2 ||  0;
	$argv{user}         = $webuser      ||  0;

	print "<pre>",  Dumper(%argv), "</pre>" if $DEBUG;

        # Update database
        $argv{addsubnets} = $ADDSUBNETS;
        $o = $dm->update_device(%argv);
        unless ($o){
            $m->comp('error.mhtml', error => $dm->error);
        }
        unless ($o->name && ($name = $o->name->name)){
            $name = "device"
            }
    }

}else{
    $m->comp('error.mhtml', error => "Unknown action: $action");
}
    
</%init>

<div id="sectiondetail">
 <div class="container">
   <div class="containerhead">
      Device: <strong><% $host %></strong>
   </div>

%if ( $action eq "discover" ){

    <& attribute_table.mhtml, field_headers=>["Description"], data=>[ $dev->{sysdescription} ] &>
    <form name="netdotform" action="updatedevice.html" method="POST">
    <input type="hidden" name="sid" value="<% $session->{_session_id} %>">
    <input type="hidden" name="host" value="<% $host %>">
    <input type="hidden" name="action" value="update">

%     unless ($argv{device}){

% my (@field_headers, @cell_data) = ();

% push( @field_headers, "Entity/Group:" );
<&| "HERE.mhtml" &>
           <select name="entity" id="entity">
           <option value="0">-- Select --</option>
%          my @allents = Entity->retrieve_all; 
%          @allents = sort { $a->name cmp $b->name } @allents;
%          foreach my $ent (@allents){
%                if ( $guessed_ent && ($ent->id == $guessed_ent->id) ){
                   <option value="<% $ent->id %>" SELECTED><% $ent->name %></option>                
%                }else{
                   <option value="<% $ent->id %>"><% $ent->name %></option>
%                }
%          }
           </select>
           <a href="#" onClick="openinsertwindow('Entity', 'entity')">[new]</a>
</&>
% push( @cell_data, $_ );

% push( @field_headers, "Site:" );
<&| "HERE.mhtml" &>
           <select name="site" id="site">
           <option value="0">-- Select --</option>
%          my @allsites = Site->retrieve_all; 
%          @allsites = sort { $a->name cmp $b->name } @allsites;
%          foreach my $site (@allsites){
%                if ( $guessed_site && ($site->id == $guessed_site->id) ){
                   <option value="<% $site->id %>" SELECTED><% $site->name %></option>
%                }else{
                   <option value="<% $site->id %>"><% $site->name %></option>
%                }
%          }
           </select>
           <a href="#" onClick="openinsertwindow('Site', 'site')">[new]</a>
</&>
% push( @cell_data, $_ );

% push( @field_headers, "Contacts:" );
<&| "HERE.mhtml" &>
           <select name="contactlist" id="contactlist">
           <option value="0">-- Select --</option>
%          @allcls = sort { $a->name cmp $b->name } @allcls;
%          foreach my $cl (@allcls){
%                if ( $default_cl && ($cl->id == $default_cl->id) ){
                   <option value="<% $cl->id %>" SELECTED><% $cl->name %></option>
%                }else{
                   <option value="<% $cl->id %>"><% $cl->name %></option>
%                }
%          }
           </select>
           <a href="#" onClick="openinsertwindow('ContactList', 'contactlist')">[new]</a>
</&>
% push( @cell_data, $_ );

% push( @field_headers, "Secondary Contacts:" );
<&| "HERE.mhtml" &>
           <select name="contactlist2" id="contactlist2">
           <option value="0">-- Select --</option>
%          @allcls = sort { $a->name cmp $b->name } @allcls;
%          foreach my $cl (@allcls){
%                # We don't want to repeat the selection
%                if ( $guessed_cl && ($cl->id == $guessed_cl) && ($cl->id != $default_cl) ){
                   <option value="<% $cl->id %>" SELECTED><% $cl->name %></option>
%                }else{
                   <option value="<% $cl->id %>"><% $cl->name %></option>
%                }
%          }
           </select>
           <a href="#" onClick="openinsertwindow('ContactList', 'contactlist2')">[new]</a>
</&>
% push( @cell_data, $_ );

<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

%     }
         <input name="insert" value="Update" type="submit">&nbsp;
         <input type="button" name="cancel" value="Cancel" onClick="history.go(-1);">
      </form>

%}elsif ( $action eq "update" ){

%      if ($dm->output){
                <pre><% $dm->output %></pre> <br />
%      }
	        <b><a href="device.html?id=<% $o->id %>">[Go to <% $name %>]</a></b>
%  }

 </div>
</div>
