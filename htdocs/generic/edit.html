<%doc>
edit.html - present a form to either insert a new object or update an existing one.

  Arguments:

    table -- name of table to create/edit
    id    -- row in a specific table if editing
    cancel - cancels all existing state and returns to null state
    submit - 
    column names from any/all tables

  Possible states:

    - null 
    new page to create any table

    - table is set
    present page to create that table

    - table and id are set
    present page to edit particular instance of that table

    - submit
    Table has been submitted to be added/updated; go to View page.

</%doc>


<%attr>
title   => 'Edit' 
section => 'Generic'
</%attr>

<%args>
$table       => undef
$id          => undef
$submit      => undef
$cancel      => undef
$showheader  => 1
$select_id   => undef
$selected    => undef
$dowindow    => undef
</%args>

<%init>
my %args;
my $DEBUG = 0;
my %reserved = (submit     => '',
		commit     => '',
		table      => '',
		showheader => '',
		user       => '',
		select_id  => '',
		selected   => '',
		onload     => '',
		dowindow   => '',
		request    => '',
		page       => '',
		);

my $page;
if( $showheader ) {
    $page = 'edit.html';
} else {
    $page = 'insertentry.html';
}

##################################################
# grab arguments to this script
foreach my $j ( keys %ARGS ) {
    ################################################
    # in case apache makes the value an array, set to last value
    if( ref( $ARGS{$j} ) eq "ARRAY" ) {
	my @t = @{ $ARGS{$j} };
	$ARGS{$j} = $t[$#t];
    }
    next if( $j !~ /\w+/ );

  ################################################
  # Ignore fields that don't belong to the table
    next if exists $reserved{$j};
    
    # /_srch/ elements are added for javascript only
    # we don't need them here
    next if ($j =~ /_srch/ );
    
    ################################################
    # "/^_/" is added to avoid using reserved words in javascript
    # chop it off
    my $k = $j;
    $k =~ s/^_//;
    $args{$k} = $ARGS{$j};
}


##################################################
if( $DEBUG ) {
    print "ARGS: ";
    printf "<pre>%s</pre>\n", Dumper( \%ARGS );
    print "args: ";
    printf "<pre>%s</pre>\n", Dumper( \%args );
}

##################################################
# Start the actual work
#
if ( $table ){
    if ( $id ){
	my $obj = $table->retrieve($id);
	if ( $submit eq "Update" ){
	    eval{
		$obj->update(\%args);
	    };
	    if ( my $e = $@ ){
		$m->comp('error.mhtml', error=>$e);
	    }
	    $m->comp('view.html', table=>$table, id=>$id);
	    
	}else{
	    $m->comp('.show_form', table=>$table, id=>$id, 
		     showheader=>$showheader, select_id=>$select_id, selected=>$selected,
		     page=>$page);
	}
    }else{
	if ( $submit eq "Insert" ){
	    my $new;
	    eval{
		$new = $table->insert(\%args);
	    };
	    if ( my $e = $@ ){
		$m->comp('error.mhtml', error=>$e);
	    }
	    if ( $dowindow ){
		$m->comp('.show_inserted', table=>$table, id=>$new->id,
			 showheader=>$showheader, select_id=>$select_id, selected=>$selected);
	    }else{
		$m->comp('view.html', table=>$table, id=>$new->id);
	    }
	    
	}else{
	    $m->comp('.show_form', table=>$table, 
		     showheader=>$showheader, select_id=>$select_id, selected=>$selected,
		     page=>$page, dowindow=>$dowindow);
	}
    }
    
}else{
    $m->comp('table.mhtml', width=>2, link=>"$page", title => "Please select an object to create:");
}

</%init>



% ########################################################
% # BEGIN HTML STUFF
% ########################################################


% ########################################################
% # HTML form wrapper for the form component
% ########################################################

<%def .show_form>
<%args>
$table
$id         => undef
$select_id  => undef
$selected   => undef
$showheader => undef
$page       => undef
$dowindow   => 0
</%args>

<%init>
my $title = "$table " . $ui->table_descr_link($table, "[?]");
</%init>

<div class="container">
    <div class="containerhead">
        <% $title %>
    </div>
    <div class="containerbody">
      <form name="netdotform" action="<% $page %>" method="POST">
      <input type="hidden" name="showheader" value="<% $showheader %>"> 
      <input type="hidden" name="select_id" value="<% $select_id %>">
      <input type="hidden" name="selected" value="<% $selected %>">
      <input type="hidden" name="dowindow" value="<% $dowindow %>">
%     if( $id ) {
%         $m->comp('form.mhtml', table=>$table, id=>$id);
      <br>
      <input name="submit" type="submit" value="Update">
%     }else{
%         $m->comp('form.mhtml', table=>$table);
      <br>
      <input name="submit" type="submit" value="Insert">
%     }
%    if ( $dowindow ){
	<input name="cancel" value="Cancel" onClick="window.close()" type="button">
%    }else{
    	<input name="cancel" value="Cancel" onClick="history.go(-1)" type="button">
%    }
      </form>
    </div>
</div>

% if ( $showheader ){
    </div>
% }

</%def>



% ########################################################
% # This subcomponent shows an intermediate window
% # just after an object has been created in a detached 
% # window.  The javascript code inserts the new object's
% # id and label in the caller window's form.
% ########################################################

<%def .show_inserted>
<%args>
$table
$id
$select_id  => undef
$selected   => undef
$showheader => undef
</%args>
<%init>
use URI::Escape;

my ( $obj, $lbl );
$obj = $table->retrieve($id);
$lbl = $obj->get_label;

</%init>

% my $onload_action = uri_escape("addandclose()");

<script language="javascript">
<!--

    function addandclose() {
	insertOption('<% $select_id %>', '<% $lbl %>', '<% $id %>', '<% $selected %>'); 
	window.close();
    }
-->
</script>

<div class="container">
    <div class="containerhead">
    OK
    </div>
    <div class="containerbody">
    <br>
    New <% $table %>: <% $lbl %> inserted.
    <br>
    <center>
    <a class="hand" onClick="<% $onload_action %>">[close]</a>
    </center>
    </div>
</div>

</%def>


