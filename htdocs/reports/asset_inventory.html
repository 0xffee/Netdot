<%args>
$report_type => 'product_not_installed'
</%args>

<%init>
my $DEBUG = 0;
my (@headers, @rows, @assets) = ();

# We want to hash devices and devicemodules by asset_id
my $dbh  = Netdot::Model->db_Main();
my $query = "SELECT id,asset_id FROM device";
my $rows = $dbh->selectall_arrayref($query);
my (%devs, %devmods);
foreach my $row ( @$rows ){
    my ($id, $asset_id) = @$row;
    $devs{$asset_id} = $id;
}
$query = "SELECT id,asset_id FROM devicemodule";
$rows = $dbh->selectall_arrayref($query);
foreach my $row ( @$rows ){
    my ($id, $asset_id) = @$row;
    $devmods{$asset_id} = $id;
}

</%init>

<div class="container">
  <div class="containerhead">Asset Inventory</div>
    <div class="containerbody"
    <p>
      <form name="report_form" action="asset_inventory.html" method="POST">
         By <select name="report_type" onChange="document.report_form.submit()">
         <option value="product_not_installed" <% ($report_type eq "product_not_installed")?"SELECTED":"" %>>Type/Model (not installed)</option>
         <option value="product_installed" <% ($report_type eq "product_installed")?"SELECTED":"" %>>Type/Model (installed)</option>
         </select>
      </form>

<%perl>
my %t;
@assets = Asset->retrieve_all();
my $grandtotal;
foreach my $pt ( ProductType->retrieve_all ){
    $t{$pt->name}{total} = 0;
    $t{$pt->name}{id}    = $pt->id;
}

foreach my $o (@assets){
    if ( $report_type eq 'product_not_installed' &&
	 (exists $devs{$o->id} || exists $devmods{$o->id}) ){
	next;	
    }elsif ($report_type eq 'product_installed' &&
	    !(exists $devs{$o->id} || exists $devmods{$o->id}) ){
	next;
    }
    if ( (!$o->product_id) || (!$o->product_id->type) ){
        $t{'Unknown'}{prod}{'Unknown'}{num} += 1;
        $t{'Unknown'}{total} += 1;
    }else{
        $t{$o->product_id->type->name}{prod}{$o->product_id->name} = $o->product_id;
        $t{$o->product_id->type->name}{prod}{$o->product_id->name}{num} += 1;
        $t{$o->product_id->type->name}{total} += 1;
	$grandtotal++;
    }
}

@headers = ( 'Type', 'Model', 'Count' );
my @row = ();
push( @row, "Total Assets in Inventory:" );
push( @row, "&nbsp;" );
push( @row, $grandtotal );
push( @rows, \@row );

foreach my $pt ( sort keys %t ){
    my @row = ();
    push( @row, "<strong>$pt</strong>" );
    push( @row, "" );
    push( @row, '<strong>' . $t{$pt}{total} . '</strong>' );
    push( @rows, \@row );

    foreach my $product ( sort keys %{ $t{$pt}{prod} } ){
        my @row = ();
        push( @row, "" );
        if ( $t{$pt}{prod}{$product}{id} ){
            push( @row, '<a href="../generic/view.html?table=Product&id=' . $t{$pt}{prod}{$product}{id} . '">' . $product . '</a>' );
        }
        elsif ( $product eq "Unknown" ){
            push( @row, '<a href="../generic/search_obj.html?table=Device&product=0&res=1">' . $product . '</a>' );
        }
        push( @row, $t{$pt}{prod}{$product}{num}  );
        push( @rows, \@row );
    }

}

$m->comp('/generic/data_table.mhtml', field_headers=>\@headers, data=>\@rows);
</%perl>


    </div>
  </div>
</div>

