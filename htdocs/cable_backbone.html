<& index.html, title => "Cable Plant: Backbone", s2name => $s2name  &>

<%perl>
print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

# code for inserting/updating
# -----------------------------------------------------------------------------
if (defined($ARGS{_action}) && ($ARGS{_action} eq "UPDATE" || $ARGS{_action} eq "STRAND_UPDATE"))
{
    my %update_info = ();
    
    print "inserting/updating, ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

    if (!(%update_info = $ui->form_to_db(%ARGS)))
    {
        my $err = $ui->error();
        die("Error: $err\n");
	}

    # Ignore id changes for anything but BackboneCable.
    # (i.e., we do not care about CableStrand id update).
    if ($update_info{BackboneCable}{key})
    {
        $id = $update_info{BackboneCable}{key};
    }

    print "update info is <pre>", Dumper(%update_info), "</pre><br>" if $DEBUG;
    
    # Do this to 'flush' the values associated with the object
    # before redisplaying
    $o = undef;
    if ($id && $id ne "NEW")
    {
        $o = BackboneCable->retrieve($id);
        $start_site = $o->start_closet->floor->site; 
        $end_site = $o->end_closet->floor->site;
        $start_site_id = $start_site->id if ($start_site);
        $end_site_id = $end_site->id if ($end_site);
        
        $editBackbone = 0;
        $editStrand = 0;
    }
}

# insert N number of strands...
elsif (defined($ARGS{_action}) && $ARGS{_action} eq "ADD_STRANDS")
{
    die ($cable_manager->error()) if (!($cable_manager->insertstrands($o, $ARGS{number_strands})));
}

# splice cables by a range of strands
elsif (defined($ARGS{_action}) && $ARGS{_action} eq "ADD_SPLICE_RANGE")
{
    die("range1, range2, or backbone not specified!") if (!$ARGS{__range1} || !$ARGS{__range2} || !$ARGS{__splice_bb_end});

    my ($start_low, $start_high) = split(/\-/o, $ARGS{__range1});
    my ($end_low, $end_high) = split(/\-/o, $ARGS{__range2});
    my $bb_end = BackboneCable->retrieve($ARGS{__splice_bb_end});

    if (($start_high - $start_low) != $end_high - $end_low)
    {
        die("Mismatch between ranges...\n");
    }

    # build up arrays of strands we care about.
    my (@start_strands, @end_strands);
    for (my $i = $start_low; $i <= $start_high; ++$i)
    {
        push(@start_strands, CableStrand->search(cable=>$id, number=>$i));
    }

    for (my $i = $end_low; $i <= $end_high; ++$i)
    {
        push(@end_strands, CableStrand->search(cable=>$bb_end->id, number=>$i));
    }

    if (scalar(@start_strands) != scalar(@end_strands))
    {
        die("Mismatch betwen start_strands and end_strands length...\n");
    }

    # first delete all splices associated with our starting strands
    die($cable_manager->error()) if (!($cable_manager->deletesplices(@start_strands)));
    
    # and now lets add our splices...
    for (my $i = 0, my $len = scalar(@start_strands); $i < $len; ++$i)
    {
        # the indexes are coordinated in start_strands and end_strands
        die ("Error " . $ui->error()) if (!($ui->insert(table=>"Splice", 
                                                        state=>{strand1=>$start_strands[$i]->id, strand2=>$end_strands[$i]->id})));
        die ("Error " . $ui->error()) if (!($ui->insert(table=>"Splice",
                                                        state=>{strand1=>$end_strands[$i]->id, strand2=>$start_strands[$i]->id})));
    }
}


# special case for updating splices
# -----------------------------------------------------------------------------
if (defined($ARGS{_action}) && $ARGS{_action} eq "STRAND_UPDATE")
{
    my @splices = ("__splice1_", "__splice2_");
    my @strands = ();

    # user can by either be operating on a subset of strands...
    if ($ARGS{__edit_list})
    {
        foreach my $l (split(/,/o, $ARGS{__edit_list}))
        {
            push(@strands, CableStrand->retrieve($l));
        }
    }
    # ...or all strands for this cable.
    else
    {
        @strands = $o->strands;
    }

    
    # first delete all splices for these strands
    die($cable_manager->error()) if (!($cable_manager->deletesplices(@strands)));
    
    # then work through the post data and recreate splices as needed.
    foreach my $strand (@strands)
    {
        foreach my $sp (@splices)
        {
            next if (!defined($ARGS{$sp . $strand->id}) || $ARGS{$sp . $strand->id} eq "");
            die ("Error " . $ui->error()) if (!($ui->insert(table=>"Splice", 
                                                        state=>{strand1=>$strand->id, strand2=>$ARGS{$sp . $strand->id}})));
            die ("Error " . $ui->error()) if (!($ui->insert(table=>"Splice",
                                                        state=>{strand1=>$ARGS{$sp . $strand->id}, strand2=>$strand->id})));
        }
    }
}

# end insertion/update code
# -----------------------------------------------------------------------------
</%perl>

<script language="JavaScript">
<!--
/* suggestName()
 *
 * Suggests a backbone cable name. This typically takes on the format:
 * <startsite>/<endsite>-<number>
 * Not sure if there is a better way to generate this name than post off
 * to a new window.
 *
 * TODO: This should probably have better duplicate checking.
*/
function suggestName()
{
    var start = document.netdotform.BackboneCable__<% $id %>__start_closet.value;
    var end = document.netdotform.BackboneCable__<% $id %>__end_closet.value;

    if (!start || !end)
    {
        alert("Please specify both a start and end closet.");
        return;
    }

    var url = "suggest_backbonename.html?start=";
    url += start + "&end=" + end;
    url += "&name=" + "BackboneCable__<% $id %>__name";

    var wind = window.open(url, "tmp", "width=1,height=1");
    wind.blur();
}
-->
</script>

% # interface...
% # ---------------------------------------------------------------------------
<!-- Header Table -->
% if (defined($o)) {
<table border="0" width="95%" align="center" cellpadding="3" cellspacing="0" class="tablebackground">
 <tr class="rowtitle0" >
    <td align="left">
        Start:
        <% $start_site ? "<a href=\"cable_plant.html?start_id=" . $start_site->id . "&page_type=BACKBONE\">" . $start_site->name . "</a>" 
                         : "<i>undefined</i>" %>
        &nbsp;&nbsp;
        End:
        <% $end_site ? "<a href=\"cable_plant.html?start_id=" . $end_site->id . "&page_type=BACKBONE\">" . $end_site->name . "</a>"
                         : "<i>undefined</i>" %>
    </td>
 </tr>
</table>
%}
<!-- End Header Table -->

<!-- Begin Backbone Cable Table -->
<table border="0" width="95%" align="center"  class="tablebackground">
    <tr>
    <td valign="top" width="50%" align="center">
        <form name="netdotform" action="cable_backbone.html" method="POST">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="_action" value="UPDATE">
        <input type="hidden" name="s2name" value="<% $s2name %>">
        <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
        <tr class="formtabletitle">
            <td colspan="2" align="left">Backbone Cable</td>
%           if ($editBackbone) {
            <td align="right"><input name="submit" value="save" type="submit"></td>
%           } else {
            <td align="right"><a href="cable_backbone.html?id=NEW">[new]</a> || <a href="cable_backbone.html?id=<% $id %>&edit=cableinfo">[edit]</a> || <a href="delete.html?table=BackboneCable&id=<% $id %>">[delete]</a></td>
%           }
        </tr>
        <tr align="left" valign="top">
            <td width="40%">
            <table width="100%" border="0" cellspacing="2" cellpadding="0">
            <tr align="left" valign="top">
                <td>Name: </td>
                <td class="formtablec2">
%               $ui->textField(object=>$o, table=>"BackboneCable", column=>"name", edit=>$editBackbone); 
%               if ($editBackbone) {                
                    &nbsp;&nbsp;&nbsp;<input type="button" name="suggest_name" value="Suggest Name" onClick="suggestName();">
%               }
               </td>
            </tr>

            <tr align="left" valign="top">
                <td>Cable Type: </td>
                <td class="formtablec2">
%               $ui->selectLookup(object=>$o, table=>"BackboneCable", column=>"type", lookup=>"CableType", edit=>$editBackbone);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Owner: </td>
                <td class="formtablec2">
%               $ui->selectLookup(object=>$o, table=>"BackboneCable", column=>"owner", lookup=>"Entity", edit=>$editBackbone);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Installed on <font size="-1">(yyyy-mm-dd)</font>: </td>
                <td class="formtablec2">
%               $ui->textField(object=>$o, table=>"BackboneCable", column=>"installdate", default=>$ui->date(),
%                              edit=>$editBackbone);
                </td>
            </tr>
            </table>
            </td>
            
            <td width="40%">
            <table width="100%" border="0" cellspacing="2" cellpadding="0">
            <tr align="left" valign="top">
                <td>Start Closet: </td>
                <td class="formtablec2">
%               if ($editBackbone) {
%               $ui->selectLookup(object=>$o, table=>"BackboneCable", column=>"start_closet", lookup=>"Closet", 
%                                 edit=>$editBackbone);
%               } else {
                <a href="closet.html?id=<% $o->start_closet %>"><% $o->start_closet->name %></a> 
%               }
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>End Closet: </td>
                <td class="formtablec2">
%               if ($editBackbone) {
%               $ui->selectLookup(object=>$o, table=>"BackboneCable", column=>"end_closet", lookup=>"Closet", 
%                                 edit=>$editBackbone);
%               } else {
                <a href="closet.html?id=<% $o->end_closet %>"><% $o->end_closet->name %></a>
%               }
                </td>
            </tr>

            <tr align="left" valign="top">
                <td>Length: </td>
                <td class="formtablec2">
%               $ui->textField(object=>$o, table=>"BackboneCable", column=>"length", edit=>$editBackbone);                
                </td>
            </tr>
            </table>
            </td>
            <td>&nbsp;</td>
        </tr>

        <tr><td colspan="3">&nbsp;<br></td></tr>

        <tr align="left" valign="top">
            <td colspan="2">
            <I>Comments:</I> &nbsp;&nbsp;&nbsp;
%           $ui->textArea(object=>$o, table=>"BackboneCable", column=>"info",
%                         edit=>$editBackbone, htmlExtra=>"rows='3' cols='80'");
            </td>
            <td>&nbsp;</td>
        </tr>

        <tr><td colspan="3">&nbsp;<p></td></tr>
        </table>
        </form>
    </td>
    </tr>
</table>
<!-- End Backbone Cable Table -->


<!-- Begin Cable Strand Cable -->
<%perl>
my @backbones = ();

if ($editStrand)
{
    # we need to grab all backbones for start and end sites of this strand.
    my ($start_site, $end_site) = ($o->start_closet->floor->site, $o->end_closet->floor->site);
    foreach my $closet (($start_site->closets, $end_site->closets))
    {
        map { push (@backbones, $_) } (BackboneCable->search(start_closet=>$closet),
                                       BackboneCable->search(end_closet=>$closet));
    }
}
</%perl>

% if (defined($o)) {
<script language="JavaScript">
<!--
/* Code to allow user to edit specific rows in table. Added to increase
 * usability and performance. XXX: need to test w/ IE.
*/
var editable = new Array(); // array of selected items to edit.
function editCheck(field)
{
    if (!field)
        return;

    var id = field.name.substr(field.name.indexOf("_") + 1);

    if (field.checked)
    {
        editable.push(id);
    }

    else
    {
        for (var i = 0; i < editable.length; ++i)
            if (editable[i] == id)
                editable[i] = null;
    }
}

function editSelected(id)
{
    var url = "cable_backbone.html?id=" + id + "&edit=strandinfo&edit_list=" + editable.join(",") + "#cable_strand";
    location.href = url;
    return true;
}
-->
</script>
<A NAME="cable_strand"></A>
<table border="0" width="95%" align="center"  class="tablebackground">
    <tr>
    <td valign="top" width="50%" align="center">
    <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
    <tr class="formtabletitle">
     <td colspan="2">
     <form name="cable_strand_form" action="cable_backbone.html" method="POST">
     <input type="hidden" name="id" value="<% $id %>">
     <input type="hidden" name="_action" value="STRAND_UPDATE">
     <input type="hidden" name="s2name" value="<% $s2name %>">
%    if ($editStrand && $ARGS{edit_list}) {
     <input type="hidden" name="__edit_list" value="<% $ARGS{edit_list} %>">
%    }
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Cable Strands</th>
%	 if ($editStrand) {	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 } else {
            <td width="10%" align="right">
                <a href="cable_strand.html?id=NEW&backbone_id=<% $o->id %>">[new]</a> &nbsp;||&nbsp;
                <a href="#" onClick="editSelected(<% $id %>);">[edit]</a> &nbsp;||&nbsp;
                <a href="cable_backbone.html?id=<% $id %>&edit=strandinfo#cable_strand">[edit all]</a>
            </td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      
    <table border="0" width="90%">
    <%perl>
    my @strands;
    if ($ARGS{edit_list})
    {
        # if the user has selected specific rows, only display those selected.
        foreach my $l (split(/,/o, $ARGS{edit_list}))
        {
            push(@strands, CableStrand->retrieve($l));
        }
    }
    else
    {
        map { push (@strands, $_) } $o->strands;
    }
    </%perl>

%	if (scalar(@strands)) {
    <tr>
        <td align="left">
            <a href="cable_backbone.html?id=<% $id %>&strand_sort=name#cable_strand">Name</a>
        </td>
        <td align="left">
            <a href="cable_backbone.html?id=<% $id %>&strand_sort=status#cable_strand">Status</a>
        </td>
        <td align="left">
            <a href="cable_backbone.html?id=<% $id %>&strand_sort=direction#cable_strand">Direction</a>
        </td>
        <td align="left">
            Spliced with
        </td>
%       if (!$editStrand) {        
        <td align="left">
            Part of Sequence
        </td>
        <td align="left">
            <B>Edit?</B>
        </td>
%       }
    </tr>

    <%perl>

    my @sorted_strands;
    if ($strand_sort eq "name" || !$strand_sort)
    {
        # sort by name
        # -----------------------------------------------------------
        @sorted_strands = sort { (split(/\./o, $a->name, 2))[1] <=> (split(/\./o, $b->name, 2))[1] } @strands;
    }

    elsif ($strand_sort eq "status")
    {
        # sort by status
        # -----------------------------------------------------------
        @sorted_strands = sort { uc($a->status->name) cmp uc($b->status->name) } @strands;
    }

    elsif ($strand_sort eq "direction")
    {
        # sort by direction
        # -----------------------------------------------------------
        @sorted_strands = sort { int($a->direction) <=> int($b->direction) } @strands;
    }
    </%perl>

%   my $i = 0;
%   foreach my $st (@sorted_strands) {
%   $i = ($i + 1) % 2;
    <tr align="left" class="<% $cssitem{$i} %>">
        <td align="left">
%       if ($editStrand) {
            <input type="checkbox" name="<% "CableStrand__" . $st->id . "__delete" %>">[del]
%           $ui->textField(object=>$st, table=>"CableStrand", column=>"name", edit=>$editStrand);            
%       } else {
            <a href="cable_strand.html?id=<% $st->id %>"><% $st->name %></a>
%       }
        </td>

        <td align="left">
%           $ui->selectLookup(object=>$st, column=>"status", lookup=>"StrandStatus", edit=>$editStrand);
        </td>

        <td align="left">
%          if ($editStrand) {
%              my $dir_name = "CableStrand__" . $st->id . "__direction";
               <input type="radio" name="<% $dir_name %>" value="0" <% ($st && int($st->direction) == 0 ? "CHECKED" : "") %>>TX &nbsp;&nbsp;&nbsp; 
               <input type="radio" name="<% $dir_name %>" value="1" <% ($st && int($st->direction) == 1 ? "CHECKED" : "") %>>RX
%          } elsif (defined($st)) {
               <% (int($st->direction) == 1 ? "RX" : "TX") %>
%          }
        </td>
        <td align="left">
%           if (!$editStrand) {
%               my @splices = $st->splices;
%               if (scalar(@splices)) {
                    <a href="cable_strand.html?id=<% $splices[0]->strand2->id %>"><% $splices[0]->strand2->name %></a>
%               }
%               if (scalar(@splices) == 2) {
                , <a href="cable_strand.html?id=<% $splices[1]->strand2->id %>"><% $splices[1]->strand2->name %></a> 
%               }
%           } else {
                <script language="JavaScript">
                <!--
                function lookupStrands(bb_id, field_name, form_name)
                {
                    if (!bb_id)
                    {
                        alert("You must select a backbone.");
                    }
                    
                    var url = "strand_backbone_list_query.html?bb_id=";
                    url += bb_id + "&field_name=" + field_name;
                    url += "&form_name=" + form_name;
                    
                    var wind = window.open(url, "tmp", "width=1,height=1");
                    wind.blur();
                }
                -->
                </script>

                <SELECT NAME="backbone_list_srch1_<% $st->id %>" onChange="lookupStrands(this.value, '__splice1_<% $st->id %>', 'cable_strand_form');">
                <OPTION VALUE="">Lookup by Backbone</OPTION>
                <%perl>
                my @splices = $st->splices;
                my %stored = ();
                foreach my $bb (sort { $a->name cmp $b->name } @backbones)
                {
                    next if ($bb->id == int($st->cable) || exists($stored{$bb}));
                    $stored{$bb} = 1;
                    printf("<OPTION VALUE=\"%s\">%s</OPTION>\n", $bb->id, $bb->name);
                }
                </%perl>
                </SELECT> &nbsp; 
                <select name="__splice1_<% $st->id %>">
                <option value="">-- Make your selection --</option>
%               if (scalar(@splices)) {
                <option value="<% $splices[0]->strand2->id %>" SELECTED><% $splices[0]->strand2->name %></option>
%               }
                <option value="">[null]</option>
                </select>
                <br>
                <SELECT NAME="backbone_list_srch2_<% $st->id %>" onChange="lookupStrands(this.value, '__splice2_<% $st->id %>', 'cable_strand_form');">
                <OPTION VALUE="">Lookup by Backbone</OPTION>
                <%perl>
                %stored = ();
                foreach my $bb (sort { $a->name cmp $b->name } @backbones)
                {
                    next if ($bb->id == int($st->cable) || exists($stored{$bb}));
                    $stored{$bb} = 1;
                    printf("<OPTION VALUE=\"%s\">%s</OPTION>\n", $bb->id, $bb->name);
                }
                </%perl>
                </SELECT> &nbsp; 
                <select name="__splice2_<% $st->id %>">
                <option value="">-- Make your selection --</option>
%               if (scalar(@splices) == 2) {
                <option value="<% $splices[1]->strand2->id %>" SELECTED><% $splices[1]->strand2->name %></option>
%               }
                <option value="">[null]</option>
                </select>
%           }
        </td>

%       if (!$editStrand) {        
        <td align="left">
%           my @strands = ($st->id);
            <& display_sequence.mhtml, strands=>\@strands &>
        </td>
        
        <td align="left">
        <input type="checkbox" name="edit_<% $st->id %>" onChange="editCheck(this);">
        </td>
%       }
    </tr>
%   }
%}
    </table>
    </td>
    </tr>
    </table>
    </form>
%	 if ($edit ne "strandinfo") {
    <form action="cable_backbone.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="_action" value="ADD_STRANDS">
    <table border="0" width="100%">
        <tr align="left" class="<% $cssitem{0} %>">
            <td align="left">
	        Manually 
	        &nbsp;<input type="submit" name="strand_add" value="Add">&nbsp;
	        <input type="text" name="number_strands" value="0" size="3"> strands
            </td>
        </tr>
    </table>
    </form>
%   }

%	 if ($edit ne "strandinfo") {
<%perl>
    my @bbones = ();
    # we need to grab all backbones for start and end sites of this strand.
    my ($start_site, $end_site) = ($o->start_closet->floor->site, $o->end_closet->floor->site);
    foreach my $closet (($start_site->closets, $end_site->closets))
    {
        map { push (@bbones, $_) } (BackboneCable->search(start_closet=>$closet),
                                    BackboneCable->search(end_closet=>$closet));
    }
</%perl>
    <form action="cable_backbone.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="_action" value="ADD_SPLICE_RANGE">
    <table border="0" width="100%">
        <tr align="left" class="<% $cssitem{0} %>">
            <td align="left">
	        Manually 
	        &nbsp;<input type="submit" name="splice_add" value="Add Splice Range"> (i.e., strands 1-16)&nbsp; strands &nbsp;
	        <input type="text" name="__range1" value="" size="4">&nbsp;from this backbone, to strands &nbsp;
            <input type="text" name="__range2" value="" size="4">&nbsp;from 
            <SELECT NAME="__splice_bb_end">
            <OPTION VALUE="">Backbone...</OPTION>
            <%perl>
            my %stored = ();
            foreach my $bb (sort { $a->name cmp $b->name } @bbones)
            {
                next if ($bb->id eq $id || exists($stored{$bb}));
                $stored{$bb} = 1;
                printf("<OPTION VALUE=\"%s\">%s</OPTION>\n", $bb->id, $bb->name);
            }
            </%perl>
            </SELECT>
            </td>
        </tr>
    </table>
    </form>
%   }
</td>
</tr>
</table>
% }
<!-- End Cable Strand Table -->


<%args>
$id => undef;
$strand_sort => undef;
$edit => undef;
$s2name => "Plant";
</%args>

<%init>
my $DEBUG = 0;
my $ui = Netdot::UI->new();
my $cable_manager = Netdot::CablePlantManager->new();
my %cssitem = (0 => "formtablec1", 1 => "formtablec2");
my $editBackbone = 0;
my $editStrand = 0;
my ($o, $start_site, $end_site) = (undef, undef, undef);
my ($start_site_id, $end_site_id) = (0, 0);

if ($id && $id ne "NEW") 
{
    $o = BackboneCable->retrieve($id);
    $start_site = $o->start_closet->floor->site; 
    $end_site = $o->end_closet->floor->site;
    $start_site_id = $start_site->id if ($start_site);
    $end_site_id = $end_site->id if ($end_site);
}

$editBackbone = 1 if ($id eq "NEW" || $edit eq "cableinfo");
$editStrand = 1 if ($edit eq "strandinfo");
</%init>

<%doc>
Cable management stuff...
</%doc>
