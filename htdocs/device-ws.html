<script language="javascript" src="select.js"></script>

<& header, title => "Device Worksheet: $name "  &>

<%perl>

if ( defined($search) && $search =~ /\w+/ ){

 my $query = "%" . $search . "%";
 my @list = Device->search_like(name => "$query");
 
</%perl>     
  

%  if (my $num = scalar(@list)){
 <table width="97%" border="0" align="center"> 
 <tr><td>
   <p><br>
   <b>Total matches: <% $num %></b>
   <p>
   <table BORDER="0" width="100%" CELLSPACING="0" CELLPADDING="1" BGCOLOR="whitesmoke" class="tablebackground">
  
%    foreach my $dev (@list){
      <tr>
         <td align="RIGHT" valign="TOP" WIDTH="18%" class="column1" bgcolor="#DDDDDD">
	    <b>Name: </b>
	 </td>
	 <td align="LEFT" valign="MIDDLE" class="column2">
	    <b><a href="device-ws.html?id=<% $dev->id %>"><% $dev->name %></a></b>
	 </td>   
      </tr>
      <tr>
         <td align="RIGHT" valign="TOP" WIDTH="18%" class="column1" bgcolor="#DDDDDD">
	    <b>Type: </b>
	 </td>
	 <td align="LEFT" valign="MIDDLE" class="column2">
	    <b><% $dev->type->name %></b>
	 </td>   
      </tr>
      <tr>
         <td align="RIGHT" valign="TOP" WIDTH="18%" class="column1" bgcolor="#DDDDDD">
	    <b>Product: </b>
	 </td>
	 <td align="LEFT" valign="MIDDLE" class="column2">
	    <b><% $dev->productname->name %></b>
	 </td>   
      </tr>
      <tr height="1" class="delimiter">
        <td colspan="2" height="1"></td>
      </tr>
      <tr>
        <td colspan="2"><br></td>
      </tr>
%    }   

   </table>
% }else{
     <p><br><b>No results</b>
     <p>
     <table BORDER="0" CELLPADDING="2" CELLSPACING="3" class="tablebackground">
        <tr ROWSPAN=2>
          <td>&nbsp;
          </td>
          <td>
            <form action="device-ws.html" method="post">
            <input type="text" name="search" size="20" value=""> 
            <input name="submit" value="search" type="submit">
            </form>
          </td>
        </tr>
     </table>
     <br>
     <& footer &>
%    $m->abort;
</td></tr></table>

% }
%} elsif ( defined($search) && $search !~ /\w+/ ){
     <p><br><b>No search criteria</b>   
     <p>
     <table BORDER="0" CELLPADDING="2" CELLSPACING="3" class="tablebackground">
        <tr ROWSPAN=2>
          <td>&nbsp;
          </td>
          <td>
            <form action="device-ws.html" method="post">
            <input type="text" name="search" size="20" value=""> 
            <input name="submit" value="search" type="submit">
            </form>
          </td>
        </tr>
     </table>
     <br>
     <& footer &>
%    $m->abort;

<%perl>
} elsif( defined($ARGS{intadd}) ){

  # Add a group of interfaces

  if (defined ($ARGS{intaddnum}) &&  $ARGS{intaddnum} > 0){
     my %tmpint;
     $tmpint{device} = $id;
     $tmpint{managed} = 1;
     $tmpint{number} = 1000;
   my $i;
     for ($i = 0; $i <= $ARGS{intaddnum}; $i++){
        $tmpint{number}++;
     	if (!($gui->insert(table => "Interface", state => \%tmpint)) ){
	   my $err = $gui->error;
	   die "Error: $err"; 
	}
     }
    
  }

}elsif( defined($ARGS{submit}) ){

  # Define control field names
  my %control = ( 
                 'id'     => '',
                 'submit' => '',
                 'edit'   => '',
		 'save'   => '',
		 'show'   => '',
  );
  
  print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

  # Ignore empty and control fields
  # for saving purposes
  # / _srch/ elements are added for javascript only
  # we don't need them here

  foreach my $j (keys %ARGS){
     next if ( exists ($control{$j}) );
     next if ($j =~ /_srch/ );
     # "/^_/" is added to search field names 
     # to avoid using reserved words in javascript
     # chop it off
     my $k = $j;
     $k =~ s/^_//;
     $arg{$k} = $ARGS{$j};	   
  }
  print "arg is  <pre>", Dumper(%arg), "</pre><br>" if $DEBUG;
	 
  # Check that we have at least one parameter
  unless (scalar keys(%arg)){
    print "<strong>Missing name/value pairs</strong>";
  }

  # Store objects, fields and values in a hash
  my %objs;
  foreach my $item (keys %arg){
     my ($table, $id, $field) = split /__/, $item;
     $objs{$table}{$id}{$field} = $arg{$item};
  }
  print "objs is <pre>", Dumper{%objs}, "</pre><br>" if $DEBUG;
  print "Content Length: $ENV{'CONTENT_LENGTH'}" if $DEBUG; 

  # Now do the actual updating
  # First check for "action" fieldnames
  # Actions (like delete) take precedence over value updates

  foreach my $table ( keys %objs ){
    foreach my $id ( keys %{ $objs{$table} } ){
      my $act = 0;
      foreach my $field ( keys %{ $objs{$table}{$id} } ){
	   if ( $field eq "delete" && $objs{$table}{$id}{$field} eq "on" ){
	      # Remove object from DB
	      if (! ($gui->remove(table => "$table", id => "$id")) ){
	          my $err = $gui->error;
		  die "Error: $err";
	      }
	      # Set the 'action' flag
	      $act = 1;
	      last;
	   }elsif($field eq "new"){
	      my %state;
	      # This is a little hack
	      if ($table eq "InterfaceDep" && $objs{$table}{$id}{$field} ne "0"){
	         $state{child} = $id;
		 $state{parent} = $objs{$table}{$id}{$field};
	      }
	      if ( scalar(keys %state) ){
	         if (!($gui->insert(table => $table, state => \%state)) ){
      	            my $err = $gui->error;
		    die "Error: $err"; 
	         }
	      }
	      $act = 1;
	      last;
	   }
      }
      # Now update the thing
      if (!$act){ #only if no other actions were performed
         my $o;
         if (! ($o = $table->retrieve($id)) ){
            die "Couldn't retrieve id $id from table $table";
         }
         if (! ($gui->update(object => $o, state => \%{ $objs{$table}{$id} } ))){
            my $err = $gui->error;
	    die "Error: $err";
         }
      }
    }
  }  
  # Do this to 'flush' the values associated with the object
  # before redisplaying
  $o = undef;
  if ($id){
     $o = Device->retrieve($id);
     $name = $o->name;
   }
}

</%perl>

%if (!defined($search)){
<!-- sub header table -->
<table border="0" width="97%" align="center" >
 <tr>
   <td valign="top" width="50%" align="center">

  <!-- Device Search Table -->
  
   <table border="0" width="100%" bgcolor="whitesmoke" cellpadding="0" cellspacing="2" >
     <tr>
       <td align="right">
         <form action="device-ws.html" method="post">
            Device: <input type="text" name="search" size="20" value=""> 
            <input name="submit" value="search" type="submit">
         </form>
       </td>
     </tr>
   </table> 
<!-- End Device Search Table -->
    
   </td>
 <tr>
</table>

<!-- Margins Table -->
<table border="0" width="97%" align="center" >
 <tr>
   <td valign="top" width="50%" align="center">

% if ( $edit ){	 
    <form name="netdotform" action="device-ws.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
% }
<!-- General Info Table -->
   <table border="0" width="100%" bgcolor="whitesmoke" cellpadding="0" cellspacing="2">
   <tr bgcolor="#CCCCCC">
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">General</th>
%	 if ($edit eq "geninfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="5%" align="right"><a href="device-ws.html?id=<% $id %>&edit=geninfo">[edit]</a></td>
            <td width="5%" align="right"><a href="delete.html?table=Device&id=<% $id %>">[delete]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
      <td valign="top" width="50%">
         <table border="0">
	    <tr>
	      <td align="left">Name: </td>
	      <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__name" value="<% $o->name %>">  
%	         }else{
		    <b><% $o->name %></b>
%		 }
	      </td>
	    </tr>
           <tr>
             <td  align="left">Type: </td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <select name="Device__<% $id %>__type">
%		     my $lblfield = ( $gui->getlabels("DeviceType") )[0];	 
		     <option value="<% $o->type->id %>" SELECTED> <% $o->type->name %> </option>
%		     my @fo = DeviceType->retrieve_all();
%		     @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		     foreach my $fo (@fo){
%		        next if ($fo->id == $o->type->id);
  		        <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		     }
		     <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><% $o->type->name %> </b>
%		 }
	     </td> 
	   </tr>
           <tr>
             <td align="left">Component: </td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		     <select name="Device__<% $id %>__component_type" >
%		     my $lblfield = ( $gui->getlabels("ComponentType") )[0];	 
		       <option value="<% $o->component_type->id %>" SELECTED> <% $o->component_type->name %> </option>
%		       my @fo = ComponentType->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->component_type->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><% $o->component_type->name %> </b>
%		 }	        
	     </td> 
	   </tr>
           <tr>
             <td align="left">S/N: </td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__serialnumber" value="<% $o->serialnumber %>">  
%	         }else{
		    <b><% $o->serialnumber %></b>
%		 }

	     </td> 
	   </tr>
           <tr>
             <td align="left">MAC: </td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__physaddr" value="<% $o->physaddr %>">  
%	         }else{
		    <b><% $o->physaddr %> </b>
%		 }

	     </td> 
	   </tr>
           <tr>
             <td align="left">Installed on <font size="-1">(yyyy-mm-dd)</font>:</td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__dateinstalled" value="<% $o->dateinstalled %>">  
%	         }else{
		    <b><% $o->dateinstalled %> </b>
%		 }	        
	     </td> 
	   </tr>
	 </table>
      </td>
      <td valign="top" width="50%">
         <table  border="0">
           <tr>
             <td align="left">Product: </td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <select name="Device__<% $id %>__productname">
%		       my $lblfield = ( $gui->getlabels("Product") )[0];	 
		       <option value="<% $o->productname->id %>" SELECTED> <% $o->productname->name %> </option>
%		       my @fo = Product->retrieve_all();
%		       @fo = sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->productname->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><% $o->productname->name %></b> 
%		 }
	        
	     </td>
	   </tr>
           <tr>
             <td align="left">Part of: </td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <select name="Device__<% $id %>__part_of">
%		       my $lblfield = ( $gui->getlabels("Device") )[0];	 
		       <option value="<% $o->part_of->id %>" SELECTED> <% $o->part_of->name %> </option>
%		       my @fo = Device->retrieve_all();
%		       @fo = sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->part_of->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><% $o->part_of->name %></b> 
%		 }

	     </td>
	   </tr>
           <tr>
             <td align="left">Inventory: </td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__inventorynumber" value="<% $o->inventorynumber %>">  
%	         }else{
		    <b><% $o->inventorynumber %></b>
%		 }
	     </td> 
	   </tr>
           <tr>
             <td align="left">System Descr: </td>
	     <td align="left"> 
%	      	 if ($edit eq "geninfo"){	 
		    <textarea name="Device__<% $id %>__sysdescription" rows="3" cols="30"><% $o->sysdescription %></textarea>
%	         }else{
	            <font size="-1"> <% $o->sysdescription %> </font>
%		 }

		</td> 
	   </tr>
	 </table>
      </td>
  </tr>
   <tr>
     <td colspan="2" align="center">Comments:</td>
   </tr>
   <tr>
     <td colspan="2" align="left">
%	      	 if ($edit eq "geninfo"){	 
		    <textarea name="Device__<% $id %>__info" rows="3" cols="80"><% $o->info %></textarea>
%	         }else{
	            <font size="-1"><pre><% $o->info %></pre></font>
%		 }
     </td>
   </tr>
 </table>
<!-- End General Info Table -->

<br>
<!-- IPs Table -->

  <table border="0" width="100%" bgcolor="whitesmoke" cellpadding="0" cellspacing="2">
   <tr bgcolor="#CCCCCC">
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">IPs</th>
%	 if ($edit eq "ipinfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=ipinfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0">
%	my @ips;
%	foreach my $int ($o->interfaces) {
%	  my @intips;
%	  next unless (scalar(@intips = $int->ips));
%	  map { push @ips, $_} @intips;
%	}
%	if (scalar @ips){
         <tr>
	   <td align="center">IP</td>
	   <td align="center">Subnet</td>
	   <td align="center">Interface</td>
         </tr>
%	}
%	foreach my $ip (@ips){	   
%	 $ci = ($ci + 1) % 2;
	 <tr bgcolor="<% $colors{$ci} %>">
	   <td align="left">
%	      	 if ($edit eq "ipinfo"){	 
		    <input type="checkbox" name="<% "Ip__" . $ip->id . "__delete" %>" >[del]
		    <input type="text" size="15" name="<% "Ip__" . $ip->id . "__address" %>" value="<% $ip->address %>">
		    <br>
%	         }else{
		    <a href="view.html?table=Ip&id=<% $ip->id %>"><% $ip->address %></a><br>
%		 }
	   </td>
	   <td align="left">
%	      	 if ($edit eq "ipinfo"){	 
		    <select name="<% "Ip__" . $ip->id . "__subnet" %>">
%		       my $lblfield = ( $gui->getlabels("Subnet") )[0];	 
		       <option value="<% $ip->subnet->id %>" SELECTED> <% $ip->subnet->address %>/<% $ip->subnet->prefix %> </option>
%		       my @fo = Subnet->retrieve_all();
%		       @fo = sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $ip->subnet->id);
			  <option value="<% $fo->id %>"> <% $fo->address %>/<% $fo->prefix %> </option>
%		       }
		       <option value="0"> [null] </option>
		    </select>
		    <br>
%	         }elsif ( int($ip->subnet) ){
		    <a href="view.html?table=Subnet&id=<% $ip->subnet->id %>"><% $ip->subnet->address %>/<% $ip->subnet->prefix %></a><br>
%		 }
	   </td>
	   <td align="left"><font size="-1"><% $ip->interface->name %></font></td>
	  </tr>
%	}# foreach	
     </table>
    </td>
   </tr>
  </table>

<!-- End IPs Table -->

</td>
<td valign="top" align="center">

<!-- Location Table -->

  <table border="0" width="100%"  bgcolor="whitesmoke" cellpadding="0" cellspacing="2">
   <tr bgcolor="#CCCCCC">
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Group/Location</th>
%	 if ($edit eq "locinfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=locinfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0">
        <tr>
	   <td align="left">Entity: </td>
	     <td align="left"> 
%	      	 if ($edit eq "locinfo"){	 
		    <select name="Device__<% $id %>__entity">
%		       my $lblfield = ( $gui->getlabels("Entity") )[0];	 
		       <option value="<% $o->entity->id %>" SELECTED> <% $o->entity->name %> </option>
%		       my @fo = Entity->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->entity->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=Entity&id=<% $o->entity->id %>"><% $o->entity->name %></a></b> 
%		 }
	     </td>
	</tr>
        <tr>
	   <td align="left">Site: </td>
	     <td align="left"> 
%	      	 if ($edit eq "locinfo"){	 
		    <select name="Device__<% $id %>__site">
%		       my $lblfield = ( $gui->getlabels("Site") )[0];	 
		       <option value="<% $o->site->id %>" SELECTED> <% $o->site->name %> </option>
%		       my @fo = Site->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->site->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=Site&id=<% $o->site->id %>"><% $o->site->name %></a></b> 
%		 }
	     </td>
	</tr>
        <tr>
	   <td align="left">Room: </td>
	     <td align="left"> 
%	      	 if ($edit eq "locinfo"){	 
		    <input type="text" name="Device__<% $id %>__room" value="<% $o->room %>">  
%	         }else{
		    <b><% $o->room %></b>
%		 }
	     </td>
	</tr>
        <tr>
	   <td align="left">Rack: </td>
	     <td align="left"> 
%	      	 if ($edit eq "locinfo"){	 
		    <input type="text" name="Device__<% $id %>__rack" value="<% $o->rack %>">  
%	         }else{
		    <b><% $o->rack %></b>
%		 }
	     </td>
	</tr>
      </table>
     </td>
   </tr>
   </tr>
  </table>

<!-- End Location Table -->
<br>
<!-- Management Table -->

  <table border="0" width="100%" bgcolor="whitesmoke" cellpadding="0" cellspacing="2">
   <tr bgcolor="#CCCCCC">
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Management</th>
%	 if ($edit eq "mgmtinfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=mgmtinfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0">
        <tr>
	   <td align="left">Contact Group: </td>
	     <td align="left"> 
%	      	 if ($edit eq "mgmtinfo"){	 
		    <select name="Device__<% $id %>__contactlist">
%		       my $lblfield = ( $gui->getlabels("ContactList") )[0];	 
		       <option value="<% $o->contactlist->id %>" SELECTED> <% $o->contactlist->name %> </option>
%		       my @fo = ContactList->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->contactlist->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=ContactList&id=<% $o->contactlist->id %>"><% $o->contactlist->name %></a></b> 
%		 }
	     </td>
	</tr>
        <tr>
	   <td align="left">User: </td>
	     <td align="left"> 
%	         my $lbl = $gui->getobjlabel($o->user, ", ");
%	      	 if ($edit eq "mgmtinfo"){	 
		    <select name="Device__<% $id %>__user">
%		       my $lblfield = ( $gui->getlabels("Person") )[0];	 
		       <option value="<% $o->user->id %>" SELECTED> <% $lbl %> </option>
%		       my @fo = Person->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->user->id);
%			  my $folbl = $gui->getobjlabel($fo, ", ");
  		          <option value="<% $fo->id %>"> <% $folbl %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=Person&id=<% $o->user->id %>"><% $lbl %></a></b> 
%		 }
	     </td>
	</tr>
        <tr>
	   <td align="left">Out-of-band hostname: </td>
	     <td align="left"> 
%	      	 if ($edit eq "mgmtinfo"){	 
		    <input type="text" name="Device__<% $id %>__oobname" value="<% $o->oobname %>">  
%	         }else{
		    <b><% $o->oobname %></b>
%		 }
	     </td>
	</tr>
        <tr>
	   <td align="left">Out-of-band number: </td>
	     <td align="left"> 
%	      	 if ($edit eq "mgmtinfo"){	 
		    <input type="text" name="Device__<% $id %>__oobnumber" value="<% $o->oobnumber %>">  
%	         }else{
		    <b><% $o->oobnumber %></b>
%		 }
	     </td>
	</tr>
         <tr>
	   <td align="left">Managed?: </td>
	     <td align="left"> 
%		 my $value = $o->managed;	 
%	      	 if ($edit eq "mgmtinfo"){	 
%		    if ($value == 1){
		      <input type="radio" name="Device__<% $id %>__managed" value="1" checked> <b>yes</b>
		      <input type="radio" name="Device__<% $id %>__managed" value="0"> <b>no
%		    }elsif ($value eq ""){
  		       <input type="radio" name="Device__<% $id %>__managed" value="1"> <b>yes</b>
		       <input type="radio" name="Device__<% $id %>__managed" value="0"> <b>no</b>
		       <input type="radio" name="Device__<% $id %>__managed" value="" checked> <b>n/a</b>
%		    }elsif ($value == 0){
		       <input type="radio" name="Device__<% $id %>__managed" value="1"> <b>yes</b>
		       <input type="radio" name="Device__<% $id %>__managed" value="0" checked> <b>no</b>
%		    }
		 
%	         }else{
%		    if ($value == 1){
		       <b>yes</b>
%		    }elsif ($value eq ""){ 
		       <b>n/a</b>
%		    }elsif ($value == 0){
		       <b>no</b>
%		    }
%		}
	     </td>
	</tr>
        <tr>
	   <td align="left">SNMP Community: </td>
	     <td align="left"> 
%	      	 if ($edit eq "mgmtinfo"){	 
		    <input type="text" name="Device__<% $id %>__community" value="<% $o->community %>">  
%	         }else{
		    <b><% $o->community %></b>
%		 }
	     </td>
	</tr>
        <tr>
%	if ($edit eq "mgmtinfo"){	 

%	}else{
	   <td align="left"><b><a href="device.html?device=<% $name %>&action=update">[update]</a></b></td>
	     <td align="left">Fetch SNMP info from device and update database
	     </td>
%	} 
	</tr>
    </table>
     </td>
   </tr>

   </tr>
  </table>

<!-- End Management Table -->

  </td>
 </tr>
 <tr>
  <td colspan="2">

<!-- Interface Table -->

  <table border="0" width="100%" align="left" bgcolor="whitesmoke" cellpadding="0" cellspacing="2">
   <tr bgcolor="#CCCCCC">
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Interfaces</th>
%	 if ($edit eq "intinfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=intinfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0">
        <tr>
%	   if ($edit eq "intinfo"){	 
	      <td align="center">[del]</td>
%	   }
	   <td align="center">Number</td>
	   <td align="center">Name</td>
	   <td align="center">Room</td>
	   <td align="center">Jack</td>
	   <td align="center">Description</td>
	   <td align="center">Parents</td>
	   <td align="center">Managed?</td>
        </tr>

%	# Sort numerically by port number
%	foreach my $int ( map { $_->[1] }
%		          sort { $a->[0] <=> $b->[0] } 
%			  map { [$_->number, $_] } 
%			  $o->interfaces) {
%	  $ci = ($ci + 1) % 2;
	  <tr bgcolor="<% $colors{$ci} %>">
%		 if ($edit eq "intinfo"){	 
		   <td align="left">
		    <input type="checkbox" name="<% "Interface__" . $int->id . "__delete" %>" >
		   </td>	   
%	         }
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="3" name="<% "Interface__" . $int->id . "__number" %>" value="<% $int->number %>">
%	         }else{
		    <a href="view.html?table=Interface&id=<% $int->id %>"><% $int->number %></a>
%		 }
	   </td>
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="15" name="<% "Interface__" . $int->id . "__name" %>" value="<% $int->name %>">
%	         }else{
		    <% $int->name %>
%		 }
	   </td>
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="6" name="<% "Interface__" . $int->id . "__room" %>" value="<% $int->room %>">
%	         }else{
		    <% $int->room %>
%		 }
	   </td>
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="9" name="<% "Interface__" . $int->id . "__jack" %>" value="<% $int->jack %>">
%	         }else{
		    <% $int->jack %>
%		 }
	   </td>
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="40" name="<% "Interface__" . $int->id . "__description" %>" value="<% $int->description %>">
%	         }else{
		    <% $int->description %>
%		 }
	   </td>
	   <td align="left">
%	   my @parents = $int->parents;
%	   if (scalar(@parents)){
%	     foreach my $par (@parents){	   
%		 my $lbl = $gui->getobjlabel($par->parent, ", ");
%	      	 if ($edit eq "intinfo"){	 
%		 # Check for amount of objects in table before retrieving all
%		    my $count = Interface->count_all;
%		    if ( $count <= $maxselect ){			      
%		       my @allints = Interface->retrieve_all;
%		       @allints = sort { $a->number <=> $b->number } @allints; 
   		       <select name="<% "InterfaceDep__" . $par->id ."__parent" %>">
		         <option value="$par->parent->id" selected><% $lbl %> </option> 
%		          foreach my $int ( @allints ) {
		            <option value="<% $int->id %>"><% $gui->getobjlabel($int, ", ") %></option>
%			  }
		         <option></option> 
		       </select>
%		    }else{  #too many instances.  Offer a keyword search
%		       my $srchf = '_' . $int->id . 'parent_srch';  #name of the form input tag
		       <input type="text" name="<% $srchf %>" value="Keywords">
		       &nbsp;<input type="button" name="" value="List" 
		       onClick="sendquery(<% '_InterfaceDep__' . $par->id . '__parent' %>, <% $srchf . '.value' %>, 'Interface')" >
		       <br><select name="<% '_InterfaceDep__' . $par->id . '__parent' %>">
		          <option value="<% $par->parent->id %>" selected><% $lbl %></option>
			  <option value="0">[null]</option>
		       </select>
		       <input type="checkbox" name=<% "InterfaceDep__" . $par->id . "__delete" %> >[del]
%		    }
%	         }else{
		    <% $lbl %><br>
%		 }
%	     } #foreach my $par
%	   }else{ # No parents exist
%	      if ($edit eq "intinfo"){	 
%	       if (scalar($int->ips)){ #only interfaces with ip addresses (might change later)
%	        my $srchf = '_' . $int->id . 'parent_srch';  #name of the form input tag
		<input type="text" name="<% $srchf %>" value="Keywords">
	        &nbsp;<input type="button" name="" value="List" 
	        onClick="sendquery(<% "_InterfaceDep__" . $int->id ."__new" %>, <% $srchf . '.value' %>, 'Interface')" >
	        <br><select name="<% "_InterfaceDep__" . $int->id ."__new" %>">
	 	  <option value="0">[null]</option>
	        </select>	      
%	       }
%	      }
%	   }

	   </td>
	   <td align="left"> 
%		 my $value = $int->managed;	 
%	      	 if ($edit eq "intinfo"){	 
%		    if ($value == 1){
		      <input type="radio" name="<% "Interface__" . $int->id ."__managed" %>" value="1" checked> Y
		      <input type="radio" name="<% "Interface__" . $int->id ."__managed" %>" value="0"> N
%		    }elsif ($value eq ""){
  		       <input type="radio" name="<% "Interface__" . $int->id ."__managed" %>" value="1"> Y
		       <input type="radio" name="<% "Interface__" . $int->id ."__managed" %>" value="0"> N
		       <input type="radio" name="<% "Interface__" . $int->id ."__managed" %>" value="" checked> n/a
%		    }elsif ($value == 0){
		       <input type="radio" name="<% "Interface__" . $int->id ."__managed" %>" value="1"> Y
		       <input type="radio" name="<% "Interface__" . $int->id ."__managed" %>" value="0" checked> N
%		    }
		 
%	         }else{
%		    if ($value == 1){
		       yes
%		    }elsif ($value eq ""){ 
		       n/a
%		    }elsif ($value == 0){
		       no
%		    }
%		}
	   </td>
	  </tr>
%       } #foreach
% if ( $edit ){	 
    </form>
% }
     <tr>
	    <form action="device-ws.html" method="post">
	      <td colspan="7" width="100%" align="left">
	        <input type="hidden" name="id" value="<% $id %>">
	        <input type="submit" name="intadd" value="Add">
	        <input type="text" name="intaddnum" value="0" size="3"> lines
              </td>
	    </form>

     </tr>
     </table>
    </td>
   </tr>
  </table>
<!-- End Interface Table -->



 </td></tr>
</table>
<!-- End Margins Table -->
%} # if !defined search

<br>
<& footer &>

<%args>
$id     => undef
$search => undef
$edit   => undef
</%args>

<%init>
my $DEBUG = 0;
my $gui = Netdot::GUI->new();
my %colors = ( 0 => "#EEEEDD", 1 => "#E6E6DC" );
my $maxselect = 100;
my $o = undef;
my $ci = 0;
my %arg;
my $name;

if ($id){
   $o = Device->retrieve($id);
   $name = $o->name;
}
</%init>

<%doc>

Interface for viewing/updating a particular Device 
and all its relevant info in one page

</%doc>
