<%doc>
    Delete one or more objects
</%doc>

<%args>
$table   => undef
$id      => undef
$submit  => "Delete"
$sid     => undef
</%args>

<%init>
my $session;
my @objs;
my $TMP = $ui->{config}->{TMP};
my $DEBUG = 0;
my @objects;

print Dumper(%ARGS) if $DEBUG;
</%init>

<div id="sectiondetail">

<div class="container">
    <div class="containerbody">

%if ( $submit eq "Delete" ){
   <strong>Are you sure you want to delete the following objects?</strong>
   <p>
   <ul>
<%perl>
    unless($session = $ui->mksession( $TMP )){
    	$m->comp('error.mhtml', error => $ui->error);
    }
    # Accept single-delete queries with only table and id
    if ( $table && $id ){
    	my $key = $table . "__" . $id;
    	$ARGS{$key} = "1";
    }
    foreach my $arg (sort keys %ARGS){
    	next unless $arg =~ /__/;
    	my ($table, $id) = split /__/, $arg;
    	my $obj;
	unless ( $obj = $table->retrieve($id) ){
    	    $m->comp('error.mhtml', error => "Error retrieving $table id $id: $@");
    	}
    	my $lbl = $ui->getobjlabel($obj, ", ");
</%perl>
       <li><% $table %> <% $lbl %></li>
%      push @objs, [$table, $obj, $lbl];
%   }
%   $session->{objects} = \@objs;
    </ul>
    <br>
    <form method="POST" action="delete.html">
    <input type="hidden" name="sid" value="<% $session->{_session_id} %>">
    <input name="submit" value="Confirm" type="submit">
    <input type="button" name="cancel" value="Cancel" onClick="history.go(-1);">
    </form>
<%perl>

}elsif ($submit eq "Confirm"){
    unless($session = $ui->getsession( $TMP, $sid )){
	$m->comp('error.mhtml', error => $ui->error);
    }
    @objs = @{ $session->{objects} };
    foreach my $r (@objs){
	my ($table, $obj, $lbl) = @$r;
	# Delete the object
	eval {
	    $obj->delete;
	};
	if ($@){
	    $m->comp('error.mhtml', error => "$@");
	} 
    }
    $m->redirect("index.html");
    
}elsif ($submit eq "Cancel"){
    print "<p><br>";
    print "Delete cancelled";
    if ( $session ){
	$ui->rmsession( $session );
    }
}
</%perl>

</div> <!-- close containerbody -->
</div> <!-- close container -->

</div> <!-- close sectiondetail -->
