<%doc>

Cable management stuff...

</%doc>

<%args>
$id       => undef;
$edit     => undef;
$int_sort => undef;
$s2name   => "Plant";
</%args>

<%init>
my $DEBUG     = 0;
my %cssitem   = (0 => "formtablec1", 1 => "formtablec2");
my $o         = undef;
my $site      = undef;
my $editCable = 0;
my $editInt   = 0;

if ($id && $id ne "NEW") {
   $o = HorizontalCable->retrieve($id);
   $site = $o->closet->site;
}

$editCable = 1 if ($id eq "NEW" || $edit eq "cableinfo");
$editInt   = 1 if ($edit eq "intinfo");
</%init>

<& index.html, title => "Cable Plant: Horizontal", s2name => $s2name &>

<script language="JavaScript" src="select.js"></script>

<%perl>
print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

# code for inserting/updating
# -----------------------------------------------------------------------------
if (defined($ARGS{_action}) && $ARGS{_action} eq "UPDATE" || $ARGS{_action} eq "NEW") {
    my %update_info = ();
    print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
    if (!(%update_info = $ui->form_to_db(%ARGS))) {
        $m->comp("error.mhtml", $ui->error());
	}

    if ($update_info{HorizontalCable}{key}) {
        $id = $update_info{HorizontalCable}{key};
    }

    # Do this to 'flush' the values associated with the object
    # before redisplaying
    $o = undef;
    $site = undef;
    if ($id && $id ne "NEW") {
        $o = HorizontalCable->retrieve($id);
        $site = $o->closet->site;
        
        $editCable = 0;
        $editInt = 0;
    }
} elsif (defined($ARGS{_action}) && $ARGS{_action} eq "ADD_INTERFACE") {
    print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
    my @interfaces;
    if (UNIVERSAL::isa($ARGS{interfaces}, "ARRAY")) {
        @interfaces = @{$ARGS{interfaces}};
    } else {
        push(@interfaces, $ARGS{interfaces});
    }

    $m->comp("error.mhtml", $cable_manager->error()) if (!($cable_manager->insertinterfaces($o, @interfaces)));
}

# end insertion/update code
# -----------------------------------------------------------------------------
</%perl>

% if ($editCable) {

<script language="JavaScript">
<!--
var closetSearchList = new DynamicList("horizform", "HorizontalCable__<% $id %>__closet", "site", "Closet", "closet_srch");

/* Code for looking up a room. User selects a site and is presented with:
*     - a list of all floors for that site.
*     - a list of all rooms for that site.
* The user can select a floor and narrow the selection to rooms on that floor.
*/
var roomFloorLookup = new DynamicList("horizform", "HorizontalCable__<% $id %>__room", "floor", "Room", "room_floor_srch");
var siteFloorLookup = new DynamicList("horizform", "room_floor_srch", "site", "Floor", "room_site_srch", roomFloorLookup);

LIST_MANAGER.addList(closetSearchList, roomFloorLookup, siteFloorLookup);

// createJackID()
// Attempts to generate a JackID based on Site, Closet, and a user supplied
// jack number. Format for a jack id is: <building name><closet><jack number>
// ----------------------------------------------------------------------------
function createJackID()
{
    var closet_id = document.horizform.HorizontalCable__<% $id %>__closet.value;
    var jack_no = document.horizform.__jackno.value;
    if (!jack_no)
    {
        alert("You must specify a Jack Number in order to create a new Jack ID.");
        return false;
    }

    if (!closet_id || closet_id == -1)
    {
        alert("You must specify a Closet in order to create a new Jack ID.");
        return false;
    }

    var url = "suggest_jackid.html?closet=";
    url += closet_id + "&jackno=" + jack_no;
    url += "&name=HorizontalCable__<% $id %>__jackid";

    var wind = window.open(url, "tmp_<% $id %>", "width=1,height=1");
    wind.blur();
}
-->
</script>

% }

<%perl>
my @sites = Site->retrieve_all();
@sites = sort { $a->name cmp $b->name } @sites;
</%perl>

% # interface...
% # ---------------------------------------------------------------------------
% if ($site) {
<!-- Header Table -->
<table border="0" width="95%" align="center" cellpadding="3" cellspacing="0" class="tablebackground">
 <tr class="rowtitle0">
    <td align="left">
        Horizontal Cable for Site: <a href="cable_plant.html?id=<% $site->id %>&page_type=HORIZONTAL"><% $site->name %></a>&nbsp;&nbsp;&nbsp;
    </td>
 </tr>
</table>
% }
<!-- Horizontal Cable Table -->
<table border="0" width="95%" align="center"  class="tablebackground">
    <tr>
    <td valign="top" width="50%" align="center">
        <form name="horizform" action="cable_horizontal.html" method="POST">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="HorizontalCable__<% $id %>__jackid" value="<% $o ? $o->jackid : "" %>">
        <input type="hidden" name="_action" value="<% $id eq "NEW" ? "NEW" : "UPDATE" %>">
        <input type="hidden" name="s2name" value="<% $s2name %>">
        <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
        <tr class="formtabletitle">
            <td colspan="2" align="left">Horizonal Cable</td>
%           if ($editCable) {
            <td align="right"><input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);"> &nbsp;&nbsp; <input name="submit" value="save" type="submit"></td>
%           } else {
            <td align="right"><a href="cable_horizontal.html?id=NEW">[new]</a> || <a href="cable_horizontal.html?id=<% $id %>&edit=cableinfo">[edit]</a> || <a href="delete.html?table=HorizontalCable&id=<% $id %>">[delete]</a></td>
%           }
        </tr>
        <tr align="left" valign="top">
            <td width="40%">
            <table width="100%" border="0" cellspacing="2" cellpadding="0">
            <tr align="left" valign="top">
                <td align="left">Jack ID: </td>
                <td align="left" class="formtablec2">
%           if ($editCable) {
                <input type="text" name="__jackid" value="<% $o ? $o->jackid : "" %>" onChange="document.horizform.HorizontalCable__<% $id %>__jackid.value = this.value" DISABLED>
%           } else {
                <% $o->jackid %>
%           }
                </td>
            </tr>

%           if ($editCable) {
            <tr align="left" valign="top">
                <td align="left">Jack Number: </td>
                <td align="left" class="formtablec2">
                <input type="text" value="" name="__jackno">
                <input type="button" value="Create Jack ID" name="createjack" onClick="return createJackID();"> 
                </td>
            </tr>
%           }
            
            <tr align="left" valign="top">
                <td align="left">Cable Type: </td>
                <td align="left" class="formtablec2">
%               $ui->select_lookup(object=>$o, table=>"HorizontalCable", column=>"type",
%                                 lookup=>"CableType", edit=>$editCable);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Installed on <font size="-1">(yyyy-mm-dd)</font>: </td>
                <td align="left" class="formtablec2">
%               $ui->text_field(object=>$o, table=>"HorizontalCable", column=>"installdate", default=>$ui->date(),
%                              edit=>$editCable);                
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Tested on <font size="-1">(yyyy-mm-dd)</font>: </td>
                <td align="left" class="formtablec2">
%               $ui->text_field(object=>$o, table=>"HorizontalCable", column=>"datetested", 
%                              edit=>$editCable);
                </td>
            </tr>

            
            <tr align="left" valign="top">
                <td align="left">Test Passed: </td>
                <td align="left" class="formtablec2">
%               $ui->radio_group_boolean(object=>$o, table=>"HorizontalCable", 
%                                      column=>"testpassed", edit=>$editCable);
                </td>
            </tr>
            </table>
            </td>

            <td width="40%">
            <table width="100%" border="0" cellspacing="2" cellpadding="0">
            <tr align="left" valign="top">
                <td align="left">Closet: </td>
                <td align="left" class="formtablec2">
%               if ($editCable) {
%               $ui->select_lookup(object=>$o, table=>"HorizontalCable", column=>"closet", lookup=>"Closet", 
%                                 edit=>$editCable, where=>{site=>($site ? $site->id : "")});
                    &nbsp;<select name="closet_srch" onChange="closetSearchList.doIt();">
                    <option value="">Lookup by Site</option>
                    <%perl>
                    foreach my $s (@sites) {
                        printf("<option value=\"%s\">%s</option>\n", $s->id, $s->name);
                    }
                    </%perl>
                    </select>
%               } else {
                <a href="closet.html?id=<% $o->closet %>"><% $o->closet->name %></a>
%               }
                </td>
            </tr>
            
            <tr align="left" valign="top">
                <td align="left">Room: </td>
                <td align="left" class="formtablec2">
%               if ($editCable) {
%                   $ui->select_lookup(object=>$o, table=>"HorizontalCable", column=>"room", lookup=>"Room",
%                                     edit=>$editCable, where=>{id=>($o ? $o->room : "")});
                    &nbsp;<select name="room_site_srch" onChange="siteFloorLookup.doIt();">
                    <option value="">Lookup by Site</option>
                    <%perl>
                    foreach my $s (@sites) {
                        printf("<option value=\"%s\">%s</option>\n", $s->id, $s->name);
                    }
                    </%perl>
                    </select>
                    &nbsp;&nbsp;Floor:<select name="room_floor_srch" onChange="roomFloorLookup.doIt();"></select>
%               } else {
                    <a href="view.html?table=Room&id=<% $o->room %>"><% $o->room->name %></a>
%               }
                </%perl>
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Account: </td>
                <td align="left" class="formtablec2">
%               $ui->text_field(object=>$o, table=>"HorizontalCable", column=>"account", 
%                              edit=>$editCable);
                </td>
            </tr>

            <tr align="left" valign="top">
                <td align="left">Contact List: </td>
                <td align="left">
%               $ui->select_lookup(object=>$o, table=>"HorizontalCable", column=>"contactlist", 
%                                 lookup=>"ContactList", edit=>$editCable);
                </td>
            </tr>
            </table>
            </td>
            <td>&nbsp;</td>
        </tr>

        <tr><td colspan="3">&nbsp;<br></td></tr>

        <tr align="left" valign="top">
            <td colspan="2">
            <I>Comments:</I> &nbsp;&nbsp;&nbsp;
%           $ui->text_area(object=>$o, table=>"HorizontalCable", column=>"info",
%                         edit=>$editCable, htmlExtra=>"rows='3' cols='80'");
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr><td colspan="3">&nbsp;<p></td></tr>
        </table>
        </form>
    </td>
    </tr>
</table>
<!-- End Horizontal Cable Table -->

<!-- Interface Table -->
% if (defined($o)) {
<A NAME="interface"></A>
<table border="0" width="95%" align="center"  class="tablebackground">
    <tr class="formtabletitle">
    <td>Add Interfaces</td>
    </tr>

    <tr>
    <td valign="top" width="50%" align="center">

%   if (!$editCable) {
    
    <form name="netdotform" action="cable_horizontal.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="_action" value="ADD_INTERFACE">
    <input type="hidden" name="s2name" value="<% $s2name %>">

    <table border="0" width="100%" class="formtablebg" cellpadding="0" cellspacing="2">
    <tr align="left" valign="top">
    <td>
%       my $srchf = "interface_srch";  # name of the form input tag
	    <input type="text" name="<% $srchf %>" value="Keywords" onFocus="if (this.value == 'Keywords') { this.value = ''; } return true;">
	    &nbsp;<input type="button" name="" value="Interface Lookup" 
        onClick="sendquery(<% 'interfaces' %>, <% $srchf . '.value' %>, 'Interface')">
		&nbsp;&nbsp;<select name="interfaces" multiple size="3">
            <option value="0">[null]</option>
        </select> &nbsp;<input type="submit" name="add_interfaces" value="Add">
    </td>
    </tr>
    </table>
    </form>
%   }

    <%perl>
    my @ints;
    map { push (@ints, $_) } $o->interfaces;
    </%perl>
%	if (scalar(@ints)) {
    
    <form name="int_form" action="cable_horizontal.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="_action" value="UPDATE">
    <input type="hidden" name="s2name" value="<% $s2name %>">

    <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
    <tr class="formtabletitle">
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <th width="80%" align="center">Interfaces</th>
%	 if ($editInt) {	 
            <td align="right"><input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);"> &nbsp;&nbsp; <input name="submit" value="save" type="submit"></td>
%	 } else {
            <td align="right">
                <a href="cable_horizontal.html?id=<% $id %>&edit=intinfo#interface">[edit]</a>
            </td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0" width="90%">
    <tr>
        <td align="left">
            <a href="cable_horizontal.html?id=<% $id %>&int_sort=name#interface">Name</a>
        </td>
        <td align="left">
            <a href="cable_horizontal.html?id=<% $id %>&int_sort=number#interface">Number</a>
        </td>
        <td align="left">
            <a href="cable_horizontal.html?id=<% $id %>&int_sort=type#interface">Type</a>
        </td>
        <td align="left">
            <a href="cable_horizontal.html?id=<% $id %>&int_sort=device#interface">Device</a>
        </td>
    </tr>

    <%perl>
    $int_sort = "name" if (!defined($int_sort) || $int_sort eq "");
    my @sorted_ints;
    if ($int_sort eq "device") {
        @sorted_ints = sort { $a->device->name cmp $b->device->name } @ints;
    } else {
        @sorted_ints = sort { $a->$int_sort cmp $b->$int_sort } @ints;
    }
    </%perl>

%   my $i = 0;
%   foreach my $int (@sorted_ints) {
%   $i = ($i + 1) % 2;
    <tr align="left" class="<% $cssitem{$i} %>">
        <td align="left">
%       if ($editInt) {
            <input type="checkbox" name="<% "Interface__" . $int->id . "__delete" %>">[del]
%           $ui->text_field(object=>$int, table=>"Interface", column=>"name", 
%                          edit=>($edit eq "intinfo"));
%       } else {
            <a href="interface.html?id=<% $int->id %>"><% $int->name %></a>
%       }
        </td>

        <td align="left">
%           $ui->text_field(object=>$int, table=>"Interface", column=>"number", 
%                          edit=>$editInt);        
        </td>

        <td align="left">
%           $ui->text_field(object=>$int, table=>"Interface", column=>"type", 
%                          edit=>$editInt);         
        </td>

        <td align="left">
%       if ($editInt) {        
%           $ui->select_lookup(object=>$int, table=>"Interface", column=>"device", 
%                             lookup=>"Device", edit=>$editInt);
%       } else {
            <a href="device.html?id=<% $int->device %>"><% $int->device->name->name %></a>
%       }
        </td>
    </tr>
%   }
    <tr align="left" valign="top">
        <td align="left" colspan="4">

        </td>
    </tr>

    </table>
    </td>
    </tr>
    </table>
    </form>
%  }    
</td>
</tr>
</table>
% }
<!-- End Interface Table -->
