<%perl>
unless ( $ARGS{table} && $ARGS{id} ){
   print "<strong>Missing required parameters 'table' and/or 'id'</strong>";
   exit;
}
$table = $ARGS{table};
$id = $ARGS{id};
$obj = $table->retrieve($id);

unless ( $obj ){
   print "<strong>Nonexistent record: $id</strong>";
   exit;
}

%linksto = $gui->getlinksto($table);
%linksfrom = $gui->getlinksfrom($table);
%order = $gui->getcolumnorder($table);

</%perl>

%if ( !$ARGS{res} ){ # show the form
% my $labelstr = $gui->getobjlabel($obj, ", ");
<& header, title=>" Edit: $table: $labelstr" &>

<table border="0" width="95%" align="center">
<tr><td align="center">
<p><br>
<form action="update.html" method="POST">

<input type="hidden" name="table" value="<% $table %>">
<input type="hidden" name="id" value="<% $id %>">

<table cellpadding="3" cellspacing="1" border="0" bgcolor="CCCCCC" class="formtablebg">
  <tr bgcolor="#FFFFFF"> 
     <td colspan="3" align="center"><strong><% $table %></strong></td>
  </tr>
  <tr>
%   foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%     next if( $c eq 'id' );
% ################################################
%     if( ! exists( $linksto{$c} ) ) { # local field
        <tr>
          <td align="right" bgcolor="#DDDDDD" class="formtablec1"><% $c %>:</td>
	  <td colspan="2" class="formtablec2">
	  <% $gui->getinputtag($c, $obj) %>	        
	  </td>
        </tr>
% ################################################
%     } else {  # field is a foreign key
        <tr>
        <td align="right" bgcolor="#DDDDDD" class="formtablec1"><% $c %>:</td>
          <td class="formtablec2">
          <select name="<% $c %>">
%	  unless ( ref($obj->$c) ){
%	     die "$c is not a FK of Node";
%	  }
%	  my @fkobjs = $linksto{$c}->retrieve_all;
%         if( !$obj-$c || !defined( $linksto{$c}->retrieve( $obj->$c->id ) ) ) {
%	     foreach my $fkobj (@fkobjs){
%	        my $lbl = $gui->getobjlabel($fkobj, ", ");
                <option value="<% $fkobj->id %>"><% $lbl %></option>  
%	     }
	     <option value="0" selected>[null]</option>
%	  }else{
%	     foreach my $fkobj (@fkobjs){
%	        my $lbl = $gui->getobjlabel($fkobj, ", ");
%	        if( $fkobj->id == $obj->$c->id )  {
                   <option value="<% $fkobj->id %>" selected><% $lbl %></option>
%	        }else{
                   <option value="<% $fkobj->id %>"><% $lbl %></option>	     
%	        }
%	     }
%	  }
          </select>
          </td>
	  <td>
	    [<a href="create.html?table=<% $linksto{$c} %>" target="_blank">new</a>]*
	  </td>
        </td>
        </tr>
%     } # else
%   } # for
  </tr>
  <tr>
    <td colspan="3" bgcolor="#FFFFFF" align="center">
      <input name="res" value="1" type="hidden">
      <input name="submit" value="Update" type="submit">
      <input name="cancel" value="Cancel" type="submit">
    </td>
  </tr>
</table>
<p><br>

</form>
<p><font size="-1">(*) After creating the object in the other screen, close it and refresh this page.  The newly created
object will show in the drop-down manu.</font>

</td></tr>
</table>
<p><br>
<& footer &>

%} else { # parse form and update fields

%if ( $ARGS{cancel} eq 'Cancel' ){
    <& view.html, table => $table, id => $id &>
%   exit;
%}
<%perl>
# Get fields to update
$obj = $table->retrieve($id);
foreach my $j (keys %ARGS){
	next if ($j eq 'submit' || $j eq 'table' || $j eq 'id' || $j eq 'res');
	$fields{$j} = $ARGS{$j};	
}

#print Dumper (%fields) ; exit;

# Check that we have at least one column parameter
unless (scalar keys(%fields)){
   print "<strong>Missing field/value pairs to update</strong>";
   exit;
}


##########################################
## Update fields that have changed
##########################################

</%perl>

%   eval {
%      foreach my $col (keys %fields){
%         if ($fields{$col} ne $obj->$col){
%            $obj->set($col, $fields{$col});
%         }
%      }
%         $obj->update;
%   };
%   if ($@){
      <& error.html, caller => "update.html", error => $@ &>
%     exit;
%   }
  
<& view.html, table => $table, id => $id &>

%}

<%init>
use lib "/home/netdot/public_html/lib";
use Netdot::DBI;
use Netdot::GUI;
my ( %linksto, %linksfrom, %order, %inputtypes,
    $table, $id, $obj, %fields );
my $gui = Netdot::GUI->new();


</%init>

<%args>
$user => $ENV{REMOTE_USER}
</%args>
