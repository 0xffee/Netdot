<%doc>

Web interface for device discovery and updates

</%doc>
%
%
<%flags>
inherit => 'section_management.html' 
</%flags>
%
%
<%attr>
title   => 'Update Device' 
section => 'Management'
</%attr>
%
%
<%args>
$action
$host
$user
$comstr      => "public"
$id          => undef
$sid         => undef
$insert      => undef
$cancel      => undef
$entity      => undef
$site        => undef
$contactlist => undef
</%args>
%
%
<%init>
my $DEBUG = 0;
my $TMP;
my $ADDSUBNETS = 1;

my $o;
my $name;
my %argv;
my $session;
my $guessed_ent;
my $guessed_site;
my $guessed_cl;
my $webuser;

print "<pre>", Dumper(%ARGS), "</pre>" if $DEBUG;

if( $action eq "discover" && ! $sid ) {
    unless ( $session = $ui->mksession( $TMP ) ){
	$m->comp('error.mhtml', error => $ui->error);
    }
}
if( $sid ) {
    unless ( $session = $ui->getsession( $TMP, $sid ) ){
	$m->comp('error.mhtml', error => $ui->error);
    }
}
if( $cancel ) {
  $ui->rmsession( $session );
}

if( $user ) {
    $webuser = $user->getUsername();
}

if ( $action eq "discover" ){
    # See if device exists
    my ($c, $d) = $dm->find_dev($host);
    $argv{comstr} = (defined($c)) ? $c : $comstr;
    $argv{device} = (defined($d)) ? $d : "";
    
    # Fetch SNMP info
    my $dev = $dm->get_dev_info($host, $argv{comstr});
    unless ($dev){
	$m->comp('error.mhtml', error => $dm->error);
    }
    print "<pre>", Dumper($dev), "</pre>" if $DEBUG;
    
    $argv{dev} = $dev;
    $argv{host} = $host;
    $session->{argv} = \%argv;
    
    # Try to guess the Entity based on the ip address
LOOP:   foreach my $int ( keys %{ $dev->{interface} } ){
            foreach my $ip ( keys %{ $dev->{interface}->{$int}->{ips} } ){ 
		my $mask = $dev->{interface}->{$int}->{ips}->{$ip};
		if ( my $subnetaddr = $ipm->getsubnetaddr($ip, $mask) ){
		    if ( my $subnet = $ipm->searchblock($subnetaddr) ){
			if ( my $ent = $subnet->entity ){
			    $guessed_ent = $ent->id;
			    if ( my $cl = $ent->contactlist ){
				$guessed_cl = $cl->id;
			    }
			    last LOOP;  #just grab the first one
			}
		    }
		}
	    }
	}
    # Try to guess site based on SNMP location
    if ( my $loc = $dev->{syslocation} ){
	my $loc = "%" . $loc . "%";
	if ( my $site = (Site->search_like( name => $loc ))[0] ){
	    $guessed_site = $site->id;
	}
    }
    
    # Get the default contactlist from config
    my $default_contactlist;
    my $default_contactlist_id;
    if ( $default_contactlist = (ContactList->search(name=>$dm->{config}->{DEFAULT_CONTACTLIST}))[0] ){
	$default_contactlist_id = $default_contactlist->id;
    }else{
	$default_contactlist_id = 0;
    }
    
</%init>

<div id="sectiondetail">

<table align="center" valign="top" cellpadding="0" cellspacing="0" border="1" width="100%" class="tablebackground">
<tr><td>
    <form name="netdotform" action="updatedevice.html" method="POST">
    <input type="hidden" name="sid" value="<% $session->{_session_id} %>">
    <input type="hidden" name="host" value="<% $host %>">
    <input type="hidden" name="action" value="update">
    <table class="formtablebg" cellpadding="0" cellspacing="2" width="100%" border="0">
      <tr>
        <td colspan="2"><br></td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td align="left">
	  <pre><% $dm->output %></pre>
	</td>
      </tr>
      <tr><td colspan="2">&nbsp;</td></tr>
      <tr>
        <td class="formtablec1">Description:</td>
        <td class="formtablec2"><strong><% $dev->{sysdescription} %></strong></td>
      </tr>
    </table>
%     unless ($argv{device}){      
    <table class="formtablebg" cellpadding="0" cellspacing="2" width="100%" border="0">
      <tr>
        <td colspan="3" align="left"><br></td>
      </tr>
      <tr>
        <td colspan="3" align="center"><strong> Please provide the following:</strong></td>
      </tr>
      <tr>
        <td class="formtablec1">Entity/Group:</td>
        <td class="formtablec2">
           <select name="entity" id="entity">
    	   <option value="0">[null]</option>
%	   my @allents = Entity->retrieve_all; 
%          @allents = sort { $a->name cmp $b->name } @allents;
%          foreach my $ent (@allents){
%                if ( $guessed_ent && $ent->id == $guessed_ent ){
	           <option value="<% $ent->id %>" SELECTED><% $ent->name %></option>		    
%		 }else{
	           <option value="<% $ent->id %>"><% $ent->name %></option>
%		 }
%	   }	
	   </select>
	   <a href="#" onClick="openinsertwindow('Entity', 'entity')">[new]</a>
	</td>
        <td class="formtablec2">
	  * Entity where this device belongs (Department, Network Segment, etc.)
	</td>
      </tr>
      <tr>
        <td class="formtablec1">Site:</td>
        <td class="formtablec2">
           <select name="site" id="site">
   	   <option value="0">[null]</option>
%	   my @allsites = Site->retrieve_all; 
%          @allsites = sort { $a->name cmp $b->name } @allsites;
%          foreach my $site (@allsites){
%                if ( $guessed_site && $site->id == $guessed_site ){
	           <option value="<% $site->id %>" SELECTED><% $site->name %></option>
%	         }else{
	           <option value="<% $site->id %>"><% $site->name %></option>
%		 }
%	   }	
	   </select>
	   <a href="#" onClick="openinsertwindow('Site', 'site')">[new]</a>
	</td>
        <td class="formtablec2">
	  * Where this device is located.
	</td>
      </tr>
      <tr>
        <td class="formtablec1">Contact Group:</td>
        <td class="formtablec2">
           <select name="contactlist" id="contactlist">
   	   <option value="0">[null]</option>
%	   my @allcls = ContactList->retrieve_all; 
%          @allcls = sort { $a->name cmp $b->name } @allcls;
%          foreach my $cl (@allcls){
%                if ( $default_contactlist_id && $cl->id == $default_contactlist_id){
	           <option value="<% $cl->id %>" SELECTED><% $cl->name %></option>
%                }elsif ( $guessed_cl && $cl->id == $guessed_cl ){
	           <option value="<% $cl->id %>" SELECTED><% $cl->name %></option>
%		 }else{
	           <option value="<% $cl->id %>"><% $cl->name %></option>
%		 }
%	   }	
	   </select>
	   <a href="#" onClick="openinsertwindow('ContactList', 'contactlist')">[new]</a>
	</td>
        <td class="formtablec2">
	  * Who should be notified in case of problems/outages.
	</td>
      </tr>
%     }
      <tr><td colspan="3">&nbsp;</td></tr>
      <tr class="rowtitle0">
        <td colspan="3" align="center">
         <input name="insert" value="Update" type="submit">&nbsp;
         <input name="cancel" value="Cancel" type="submit">
        </td>
      </tr>
      </form>
    </table>
<%perl>
}elsif ( $action eq "update" ){
    if ( $insert ){
        %argv              = %{ $session->{argv} };
	$argv{entity}      = $entity      ||  0;
	$argv{site}        = $site        ||  0;
	$argv{contactlist} = $contactlist ||  0;
	$argv{user}        = $webuser     ||  0;

	print "<pre>",  Dumper(%argv), "</pre>" if $DEBUG;

        # Update database
        $argv{addsubnets} = $ADDSUBNETS;
        $o = $dm->update_device(%argv);
        unless ($o){
            $m->comp('error.mhtml', error => $dm->error);
        }
        unless ($o->name && ($name = $o->name->name)){
            $name = "device"
            }
</%perl>
          <p>
          <table class="formtablebg" cellpadding="0" cellspacing="0" width="100%">

%      if ($dm->output){
	    <tr>
              <td align="left">&nbsp;</td>
              <td><br></td>
	    </tr>
	    <tr>
              <td align="left">&nbsp;</td>
              <td align="left">
                <pre><% $dm->output %></pre>
              </td>
	    </tr>
%      }
            <tr><td><br></td></tr>
	    <tr>
              <td align="left">&nbsp;</td>
              <td align="left">
	        <b><a href="device.html?id=<% $o->id %>">[Go to <% $name %>]</a></b>
              </td>
	    </tr>
          </table>
%  }elsif ( $cancel ){
          <p>
          <table class="formtablebg" cellpadding="0" cellspacing="0" width="100%">
	    <tr>
              <td align="left">&nbsp;</td>
              <td align="left">Discovery of <% $host %> cancelled.</td>
	    </tr>
          </table>
%  }

<%perl>
}else{
    $m->comp('error.mhtml', error => "Unknown action: $action");
}
</%perl>

<td></tr>
</table>

</div>
