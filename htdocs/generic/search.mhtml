<%doc>
Supported arguments:

  q      - search string
  table  - list of ;-delimited names of tables in database
  page   - page to link to with results (default is view.html)
  displaybox - whether to always display search box (1 or 0)
</%doc>


<%args>

$search => undef
@tables => undef
%linksto => undef
%results => undef
$page => "view.html"
$alwaysdisplaybox => 0

</%args>

<%init>
if( exists( $ARGS{q} ) ) {
   $search = $ARGS{q};
}
if( exists( $ARGS{table} ) ) {
   @tables = split( /;/, $ARGS{table} );
} else {
   @tables = $ui->meta->get_tables();
}
if( $tables[0] =~ /^a(ny|ll)$/io ) {
   @tables = $ui->meta->get_tables();
}
if( exists( $ARGS{page} ) ) {
   $page = $ARGS{page};
}
if( exists( $ARGS{displaybox} ) ) {
   $alwaysdisplaybox = $ARGS{displaybox};
}
</%init>

<!-- begin search.mhtml -->
% if( ! $search || $alwaysdisplaybox ) {
<form>
<table cellpadding="3" cellspacing="1" border="0" class="searchbox">
  <tr>
  <td><input type="text" name="q" size="25" value="<% $ARGS{q} %>"></td>
  <td><input name="submit" value="Submit" type="submit"></td>
  </tr>
</table>
</form>
% }

<table width="100%">
   <tr><td class="delimiter"> </td></tr>
</table>

<%perl>
foreach my $tbl ( @tables ) {
   %linksto = $ui->meta->get_links_to($tbl);
   foreach my $col ( $tbl->columns() ) {
      if( $linksto{$col} ) {
         foreach my $fc ( $linksto{$col}->columns() ) {
            foreach my $q ( split( /\s+/, $ARGS{q} ) ) {
               $q = "%" . $q . "%";
               foreach my $hit ( $linksto{$col}->search_like( $fc => $q ) ) {
                  map { $results{$tbl}{$_->id} = $_ } 
                     $tbl->search_like( $col => $hit );
	       }
            }
         }
      } else {
         foreach my $q ( split( /\s+/, $ARGS{q} ) ) {
            $q = "%" . $q . "%";
            map { $results{$tbl}{$_->id} = $_ } 
               $tbl->search_like( $col => $q );
         }
      }
   }
}
</%perl>

% if( scalar( keys %results ) < 1 || ! %results ) {
  No matching records were found.
% } else {
<blockquote>
<table cellpadding="0" cellspacing="0" border="0" class="tablebackground">
%    printf "size : %i\n", scalar( keys %results );
%    foreach my $tbl ( sort { $a cmp $b } keys %results ) {
%       next if( $tbl eq "Meta" );
%       my @objs;
%       map { push @objs, $results{$tbl}{$_} } keys %{ $results{$tbl} };
<tr>
   <td colspan="2" bgcolor="#6ab1f0" class="rowtitle0">
      <strong><% $tbl %></strong>
   </td>
</tr>
<tr>
   <td>
      <& sortresults.mhtml, page => $page, table => $tbl, object => \@objs, view => "expanded", withedit => 1 &>
   </td>
</tr>
%    }
% }
</table>
</blockquote> 
