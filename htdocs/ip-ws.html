<%doc>
-- IP Worksheet --
Interface for IP blocks (both addresses and subnets)

</%doc>

<%args>
$id        => undef
$search    => undef
$_action   => undef
$delete    => undef
$allocate  => undef
$newblock  => undef
$parent    => undef
$length    => undef
$strategy  => undef
$edit      => undef
$submit    => undef
$s2name    => "Management"
$user      => $ENV{REMOTE_USER}
</%args>

<%init>
my $DEBUG = 0;
my $ui = Netdot::UI->new();
my $ipm = Netdot::IPManager->new();
my $o;
my $ci = 0;
my %arg;
my $title;
if ( $id ){
    unless ( $o = Ipblock->retrieve($id) ){
	$m->comp('error.mhtml', error => "Could not retrieve Ipblock id: $id");
    }else{
	$title = $o->address . "/" . $o->prefix;
    }
}else{
    $title = "Search";
}

my $edit_ip    = 0;
my $edit_block = 0;
$edit_ip       = 1 if ($edit eq "ipinfo");
$edit_block    = 1 if ($edit eq "blockinfo");
# By default, view object after any operation
# ( some exceptions will override )
my $view       = 1;

</%init>

<& index.html, title => "IP Worksheet: $title", s2name => $s2name  &>

<div class="margins">

<%perl>

print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

#######################################################################################
# Search
#
#######################################################################################

if ( defined($_action) && ($_action eq "SEARCH") ){
    if ($search =~ /\w+/ ){
	my ($addr, $prefix, $ipb, @list);
	if ($search =~ /\//){
	    ($addr, $prefix) = split /\//, $search;
	    if ($ipb = $ipm->searchblock($addr, $prefix)){
		push @list, $ipb;
	    }
	}else{
	    @list = $ipm->searchblock($search);
	}
	unless ( @list ){
	    # None were found, so look for substrings
	    @list = $ipm->searchblockslike($search);
	}
</%perl>      
%   my $num = scalar(@list);
    Query <b><em><% $search %></em></b> returned: <b><% $num %> matches</b>

%      if ( $num ){
        <& ipblock_list.mhtml, objects => \@list  &>
%      }elsif ( $ipm->error ){
          <p><b><% $ipm->error %></b>
%      }
%   }else{
       <p><b>No search criteria</b>   
%   }
<%perl>

#######################################################################################
# Update
# 
#######################################################################################\

}elsif( defined($_action) && ($_action eq "UPDATE")){

    if ( $ui->form_to_db(%ARGS) ){
	# Do this to 'flush' the values associated with the object
	# before redisplaying
	$o = undef;
	if ($id){
	    $o = Ipblock->retrieve($id);
	}
    }else{
	printf ("<p><b>Error: %s</b><br>", $ui->error);
    }

#######################################################################################
# Allocate
#
#######################################################################################
}elsif ( defined($_action) && ($_action eq "ALLOCATE") ){
    unless ($allocate =~ /\//){
</%perl>

     <p><b>Error: New block must have prefix length</b><br>   

<%perl>
     $m->abort;
    }
    my ($address, $prefix) = split /\//, $allocate;
    my $newblock;
    unless( $newblock = $ipm->insertblock(address     => $address, 
					  prefix      => $prefix, 
					  statusname  => "Container",
					  manual      => 1 )){
	print "<b>Error: ", $ipm->error, "</b><br>";
    }
    if ($newblock)
    {
	$o = $newblock;
	$id = $newblock->id;
    }

#######################################################################################
# Auto-Allocate
#
#######################################################################################
}elsif ( defined($_action) && ($_action eq "AUTOALLOCATE") ){
    # Strip "/" if any
    $length =~ s/\///;
    my $newblock;
    unless ( $newblock = $ipm->auto_allocate($parent, $length, $strategy) ){
	print "<b>Error: ", $ipm->error, "</b><br>";
    }else {
</%perl>
%     # Present new block and ask for confirmation
      <form action="ip-ws.html">
        <input type="hidden" name="_action" value="CONFIRM_AUTOALLOCATE">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="newblock" value="<% $newblock->id %>">
        <br>
        Use <strong><% $newblock->address %>/<% $newblock->prefix %></strong> ?
        <p>
        <input type="submit" name="submit" value="Yes" >
        <input type="submit" name="submit" value="No" >
      </form>
%      # Do not continue with object display
%      $view = 0;
%   }
<%perl>    
}elsif ( $_action eq "CONFIRM_AUTOALLOCATE" && $submit eq "Yes"){
    undef $o;
    unless ( $o = Ipblock->retrieve($newblock) ){
	$m->comp('error.mhtml', error => "Could not retrieve Ipblock id: $newblock");
    }
    # Replace current object with newblock
    $id = $o->id;

}elsif ( $_action eq "CONFIRM_AUTOALLOCATE" && $submit eq "No"){
    # Get rid of the new block
    unless ( $ipm->removeblock( id => $newblock ) ){
	$m->comp('error.mhtml', error => $ipm->error);	
    }

#######################################################################################
# Delete
#
#######################################################################################
}elsif ( defined($_action ) && ($_action eq "DELETE") ){
  
    my ($parentid, $address, $prefix, $version) = ($o->parent->id, $o->address, $o->prefix, $o->version);
    # Remove from Database
    #
    unless ($ipm->removeblock( id => $o->id )){
	$m->comp('error.mhtml', error => $ipm->error);
    }
    # 
    # Rebuild tree
    unless ( $ipm->build_tree($version) ){
	$m->comp('error.mhtml', error => $ipm->error);    
    }
    
</%perl>

    <p>Block <b><% $address %>/<% $prefix %></b> has been removed<br>

<%perl>
#    Show parent block
#    after block has been deleted
    $id = $parentid;
    if ($id != 0){
	unless ( $o = Ipblock->retrieve($id) ){
	    $m->comp('error.mhtml', error => "Can't retrieve Ipblock id $id");
	}
    }
</%perl>

%}

%#######################################################################################
%# View
%#
%#######################################################################################

%if ( $id && $view ){
% if ( $edit ){	 
    <form name="netdotform" action="ip-ws.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="s2name" value="<% $s2name %>">
    <input type="hidden" name="_action" value="UPDATE">
% }
% if ( $ipm->isaddress($o) ){  
%#######################################################################################
%# View IP address
%#######################################################################################

<!-- IP Info Table -->
   <table border="0" width="100%" cellpadding="0" cellspacing="0" class="formtablebg">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <th width="50%" align="left">Address Info</th>
%	 if ($edit eq "ipinfo"){	 
            <td width="50%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="50%" align="right">
		<a href="ip-ws.html?id=<% $id %>">[refresh]</a>
		<a href="ip-ws.html?id=<% $id %>&edit=ipinfo">[edit]</a>
		<a href="ip-ws.html?id=<% $id %>&_action=DELETE">[delete]</a>
	    </td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
      <td valign="top" width="50%">
         <table width="100%" border="0">
           <tr>
	     <td class="formtablec1">Address: </td>
	     <td class="formtablec2"><b><% $o->address %>/<% $o->prefix %></b></td>
	   </tr>
           <tr>
             <td class="formtablec1">Status: </td>
	     <td class="formtablec2"> 
%	       my @valid_block_status = qw ( Static Dynamic Reserved );
%	       if ( my $sn = $o->status->name ){
%	          if ( $edit eq "ipinfo" ){
                    <select name="Ipblock__<% $o->id %>__statusname">
%	            foreach my $st ( @valid_block_status ){
%		      if ( $st eq $sn ){
  		         <option value="<% $st %>" SELECTED><% $st %></option>
%		      }else{
  		         <option value="<% $st %>"><% $st %></option>
%		      }
%		    }
		    </select>
%                 }else{
	            <b><% $sn %></b>
%                 }
%	       }
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">Description: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"description", edit=>$edit_block, htmlExtra =>"style='width: 250px'");
	     </td>
	  </tr>
%          if (scalar($o->arecords)){	   
           <tr>
	     <td colspan="2">
	       <table width="100%" cellspacing="2">
	        <tr>
                 <td class="formtabletitle">DNS A record</td>
                 <td class="formtabletitle">Zone</td>
	        </tr>
%		 foreach my $ar ($o->arecords){
		  <tr>
	            <td class="formtablec2">
%	      	    if ($edit eq "ipinfo"){	 
                       <input type="text" name="RR__<% $ar->rr->id %>__name" value="<% $ar->rr->name %>">  
%                   }else{
		      <a href="view.html?table=RR&id=<% $ar->rr->id %>">
		      <% $ar->rr->name %></td></a>
%                   }
                    </td>
	            <td class="formtablec2">
		      <a href="view.html?table=Zone&id=<% $ar->rr->zone->id %>">
		      <% $ar->rr->zone->mname %></td></a>
                  </tr>
%		 } 
	      </table>
	    </td>
	   </tr>
%        }else{
           <tr>
             <td class="formtablec1"></td>
	     <td class="formtablec2">[Add DNS Records]</td>
	  </tr>
%	 }
%          if (scalar($o->services)){	   
           <tr>
	     <td colspan="2">
	       <table width="100%" cellspacing="2">
	        <tr>
                 <td class="formtabletitle">Service</td>
                 <td class="formtabletitle">Monitored</td>
                 <td class="formtabletitle">Contact List</td>
	        </tr>
%		 foreach my $ipservice ($o->services){
		  <tr>
	            <td class="formtablec2">
%	      	    if ($edit eq "ipinfo"){	 
%                     $ui->selectLookup(object=>$ipservice, column=>"service", lookup=>"Service", edit=>$edit_ip);
%	            }else{
		      <a href="view.html?table=Service&id=<% $ipservice->service->id %>">
		      <% $ipservice->service->name %></td></a>
%		    }
	            <td class="formtablec2">
%                     $ui->radioGroupBoolean(object=>$ipservice, column=>"monitored", edit=>$edit_ip);
		    </td>
	            <td class="formtablec2">
%	      	    if ($edit eq "ipinfo"){	 
%                     $ui->selectLookup(object=>$ipservice, column=>"contactlist", lookup=>"ContactList", edit=>$edit_ip);
%                   }elsif ($o->entity){
		      <a href="view.html?table=ContactList&id=<% $ipservice->contactlist %>">
		      <% $ipservice->contactlist->name %></td></a>
%                   }
		    </td>
                  </tr>
%		 } 
	      </table>
	    </td>
	   </tr>
%        } #enidf services
	 </table>
      </td>
      <td valign="top" width="50%">
         <table  border="0">
           <tr>
             <td class="formtablec1">Parent Block: </td>
	     <td class="formtablec2"> 
%	     if (defined($o->parent) && int($o->parent)){
		 <a href="ip-ws.html?id=<% $o->parent->id %>"><% $o->parent->address %>/<% $o->parent->prefix %></a>
%	     }else{
	         <b><font size="-1">(root block)</font></b>
%	     }
	     </td>
	   </tr>
           <tr>
             <td class="formtablec1">First seen: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"first_seen", edit=>$edit_block, htmlExtra =>"style='width: 250px'");
	     </td>
	  </tr>
           <tr>
             <td class="formtablec1">Last Seen: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"last_seen", edit=>$edit_block, htmlExtra =>"style='width: 250px'");
	     </td>
	  </tr>
           <tr>
             <td class="formtablec1">Interface: </td>
	     <td class="formtablec2"> 
%	     if ( $o->interface && $o->interface->id ){
		 <a href="view.html?table=Interface&id=<% $o->interface->id %>"><% $o->interface->name %></a> 
%	     }
	     </td>
	   </tr>
           <tr>
             <td class="formtablec1">Device: </td>
	     <td class="formtablec2"> 
%	     if ( $o->interface && $o->interface->device ){
		 <a href="device.html?id=<% $o->interface->device->id %>"><% $ui->getobjlabel($o->interface->device, ", ") %></a> 
%	     }
	     </td>
	   </tr>
           <tr>
	     <td colspan="2">
%	     if ( $o->arpentries ){
	       <table width="100%" cellspacing="2">
	        <tr>
                 <td class="formtabletitle">ARP-cached by</td>
                 <td class="formtabletitle">With MAC</td>
                 <td class="formtabletitle">On</td>
	        </tr>
%		 foreach my $arpentry ($o->arpentries){
		  <tr>
	            <td class="formtablec2">
		      <a href="view.html?table=Interface&id=<% $arpentry->arpcache->interface->id %>">
		      <% $ui->getobjlabel($arpentry->arpcache->interface, ", ") %></td></a>
	            <td class="formtablec2">
		    <a href="view.html?table=PhysAddr&id=<% $arpentry->physaddr->id %>">
		      <% $arpentry->physaddr->address %></a></td>
	            <td class="formtablec2"><% $arpentry->arpcache->tstamp %></td>
                  </tr>
%		 } 
	      </table>
%	    }
	    </td>
	   </tr>
         </table>
       </td>
     </tr>
  </table>
<!-- End IP Info Table -->

%} else {     
%#######################################################################################
%# View Block
%#######################################################################################

<!-- Block Info Table -->
   <table border="0" width="100%" cellpadding="0" cellspacing="0" class="formtablebg">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <th width="50%" align="left">Block Info</th>
%	 if ($edit eq "blockinfo"){	 
            <td width="50%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="50%" align="right">
		<a href="ip-ws.html?id=<% $id %>">[refresh]</a>
		<a href="ip-ws.html?id=<% $id %>&_action=DELETE">[delete]</a>
		<a href="ip-ws.html?id=<% $id %>&edit=blockinfo">[edit]</a>
	    </td>
%       }
      </tr>
      </table>
     <td>
  </tr>
  <tr>
     <td valign="top" width="50%">
        <table width="100%" border="0">
           <tr>
	     <td class="formtablec1">Address: </td>
	     <td class="formtablec2"><b><% $o->address %>/<% $o->prefix %></b></td>
	   </tr>
	   <tr>
             <td class="formtablec1">Status: </td>
	     <td class="formtablec2">
%	       my @valid_block_status = qw ( Container Subnet Reserved );
%	       if ( my $sn = $o->status->name ){
%	          if ( $edit eq "blockinfo" ){
                    <select name="Ipblock__<% $o->id %>__statusname">
%	            foreach my $st ( @valid_block_status ){
%		      if ( $st eq $sn ){
  		         <option value="<% $st %>" SELECTED><% $st %></option>
%		      }else{
  		         <option value="<% $st %>"><% $st %></option>
%		      }
%		    }
		    </select>
%                 }else{
	            <b><% $sn %></b>
%                 }
%	       }
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">Description: </td>
	     <td class="formtablec2"> 
%               $ui->textField(object=>$o, column=>"description", edit=>$edit_block, htmlExtra =>"style='width: 250px'");
	     </td>
	  </tr>
          <tr>
             <td class="formtablec1">Used by: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "blockinfo"){	 
%                   $ui->selectLookup(object=>$o, column=>"entity", lookup=>"Entity", edit=>$edit_block);
%                }elsif ($o->entity){
		   <a href="view.html?table=Entity&id=<% $o->entity->id %>"><% $o->entity->name %></a> 
%                }
	     </td>
	  </tr>
% if ($o->status->name eq "Subnet"){
          <tr>
             <td class="formtablec1">Utilization: </td>
<%perl>
          my $used = (scalar $o->children);
	  my $total = $ipm->subnet_num_addr($o);
	  my $avail = $total - $used;
	  my $u = sprintf("%.1f", $used / $total * 100 );
</%perl>
	     <td class="formtablec2"><% $used %> of <% $total %> (<% $u %>%), Avail: <% $avail %> </td>
	  </tr>
	  <tr>
             <td class="formtablec1">Enable DHCP: </td>
             <td class="formtablec2">
%              $ui->radioGroupBoolean(object=>$o, column=>"dhcp_enabled", edit=>$edit_block);
	     </td>
	  </tr>
	  <tr>
             <td class="formtablec1">Delegate DNS: </td>
             <td class="formtablec2">
%              $ui->radioGroupBoolean(object=>$o, column=>"dns_delegated", edit=>$edit_block);
	     </td>
	  </tr>
% }elsif ($o->status->name eq "Container"){
	  <tr>
             <td class="formtablec1">Delegate DNS: </td>
             <td class="formtablec2">
%              $ui->radioGroupBoolean(object=>$o, column=>"dns_delegated", edit=>$edit_block);
	     </td>
	  </tr>
% }
	</table>
      </td>
      <td valign="top" width="50%">
         <table width="100%" border="0">
	   <tr>
             <td class="formtablec1">Parent Block: </td>
	     <td class="formtablec2"> 
%	     if (defined($o->parent) && int($o->parent)){
		 <a href="ip-ws.html?id=<% $o->parent->id %>"><% $o->parent->address %>/<% $o->parent->prefix %></a>
%	     }else{
	         <b><font size="-1">(root block)</font></b>
%	     }
	     </td>
	   </tr>
           <tr>
             <td class="formtablec1">Created: </td>
	     <td class="formtablec2"><% $o->first_seen %></td>
	  </tr>
           <tr>
             <td class="formtablec1">Last Updated: </td>
	     <td class="formtablec2"><% $o->last_seen %></td>
	  </tr>
% if ($edit eq "blockinfo"){	 
         </table>
      </td>
    </form>
% }elsif ($o->status->name eq "Container"){
           <tr>
             <td class="formtablec1">New sub-block of length: / </td>
	     <td class="formtablec2"> 
	     <form name="netdotform" action="ip-ws.html" method="POST">
	     <input type="hidden" name="id" value="<% $id %>">
	     <input type="hidden" name="s2name" value="<% $s2name %>">
	     <input type="hidden" name="_action" value="AUTOALLOCATE">
	     <input type="hidden" name="parent" value="<% $id %>">
	     <input type="text" size = "4" name="length" value="<% $o->prefix + 1 %>">
	     <select name="strategy">
	       <option value="first">First Fit</option>
	       <option value="last">Last Fit</option>
	     </select>
	     <input name="submit" value="Get" type="submit">
	     </td>
	   </tr>
	   <tr>
             <td class="formtablec1">Choose Manually:</td>
             <td class="formtablec2">[view availability]</td>
	   </tr>
         </table>
      </td>
% }elsif ($o->status->name eq "Subnet"){
           <tr>
             <td class="formtablec1">
	     New address: </td>
	     <td class="formtablec2"> 
	     <form name="netdotform" action="ip-ws.html" method="POST">
	     <input type="hidden" name="id" value="<% $id %>">
	     <input type="hidden" name="s2name" value="<% $s2name %>">
	     <input type="hidden" name="_action" value="AUTOALLOCATE">
	     <input type="hidden" name="parent" value="<% $id %>">
%	     if ($o->version == 4){
 	        <input type="hidden" name="length" value="32">
%	     }elsif ($o->version == 6){
	        <input type="hidden" name="length" value="128">
%	     }
	     <select name="strategy">
	       <option value="first">First Fit</option>
	       <option value="last">Last Fit</option>
	     </select>
	     <input name="submit" value="Get" type="submit">
	     </td>
	   </tr>
	   <tr>
             <td class="formtablec1">Choose Manually:</td>
             <td class="formtablec2">[view availability]</td>
	   </tr>
         </table>
      </td>
% }else{
        </table>
      </td>    
% } 

<%perl>
# 
# Get children
#
my @children;  
if (scalar( @children = $ipm->getchildren($o->id) )){
</%perl>

   <tr>
     <td><br></td>
   </tr>
   <tr class="formtabletitle" >
     <th colspan="2" align="left">Children Addresses/Blocks </th>
   </tr>
   <tr>
     <td colspan="2">
      <& ipblock_list.mhtml, objects => \@children &>
      </td>
   </tr>
   </table>

% }
<!-- End Block Info Table -->
%} 
% if ($edit){	 
    </form>
% }


%}

</div>

<& footer.mhtml &>
