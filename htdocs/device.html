<& index.html, title => "Device Discovery: $host ", s2name => $s2name  &>
<%perl>
if ( $action eq "discover" ){
    if ($device = $dns->getdevbyname($host)){
	$o = $dm->discover(device => $device, host => $host, comstr => $device->community);
    }elsif($dns->getrrbyname($host)){
	$o = $dm->discover(host => $host, comstr => $comstr);
    }elsif(my $ip = $ipm->searchblock($host)){
	if ( $device = $ip->interface->device ){
	    $o = $dm->discover(device => $device, host => $host, comstr => $device->community);
	}else{
	    $o = $dm->discover(host => $host, comstr => $comstr);
	}
    }else{
	$o = $dm->discover(host => $host, comstr => $comstr);
    }
    unless ($o){
	$m->comp('error.mhtml', caller => "device.html", error => $dm->error);
    }
    for my $ver (qw (4 6)){
	unless( $ipm->build_tree($ver) ){
	    printf("Could not rebuild IPv%s space tree!: %s\n", $ver, $ipm->error);
	}
    }
    if ($dm->output){
</%perl>
       <p>
       <table class="formtablebg">
	  <tr>
	    <td>
	    <pre><% $dm->output %></pre>
	    </td>
	  </tr>
       </table>
<%perl>
    }
}else{
    $m->comp('error.mhtml', caller => "device.html", error => "Unknown action: $action");
#    $m->abort;
}
unless (defined ($name = $o->name->name)){
    $name = "device"
}
</%perl>
 <p>
 Go to <a href="device-ws.html?id=<% $o->id %>"><% $name %></a>

<& footer &>

<%args>
$action
$host
$comstr   => "public"
$id       => undef
$s2name   => "Management"
</%args>

<%init>
my $ui = Netdot::UI->new();
my $dm = Netdot::DeviceManager->new();
my $ipm = Netdot::IPManager->new();
my $dns = Netdot::DNSManager->new();
my $device;
my $DEBUG = 0;
my $o;
my $name;
print Dumper(%ARGS) if $DEBUG;
</%init>

<%doc>

Web interface for device discovery and updates

</%doc>
