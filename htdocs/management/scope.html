<%doc>

Specific page for DhcpScope objects

</%doc>

<%args>
$id
$user             => $ui->get_current_user($r)
$view             => 'all'
$edit             => undef
$submit           => undef
$bulk_import_data => undef
$import_overwrite => undef
@scope_type_box   => () #used for narrowing down types of scopes you're intrested in in contained_scopes
$scope_text_filter => undef #used to filter scope types based on a keyword.
$show_audit_record => undef
</%args>

<%attr>
title   => 'View Object' 
</%attr>

<%init>
my $table = 'DhcpScope';
my $DEBUG = 0;
my($obj, $prevobj );
my %ftables;

my %explanation_hash = ( 
    'templates' => 'When using a template, the scope will inherit all attributes of the template',
    'contained_scopes' => 'Scopes that inherit attributes from this scope.');

#@exclude is used to exclude certian fields from forms based on scope type.  
#i.e Enable fallover only needs to be displayed if this is a global scope
my @exclude = (); 

#@alias is used to specific different names for fields depending on some circumstance
#for example, we want to display "subnet" if we're a subnet scope, and "ip address" if we're a host scope
#never match anything
my @alias = ("");

#we add one entry to both of these lists because perl was complaining when passing these lists into 
#the form.mhtml component even when that entry was a "" or " "... so "nothing" should never match anything

unless ( $obj = $table->retrieve($id) ){
   $m->comp('error.mhtml', error => "Nonexistent record: $id");
}
# Check if user can view this object
my $manager = $ui->get_permission_manager($r);
unless ( $manager && $manager->can($user, "view", $obj) ){
    $m->comp('/generic/error.mhtml', error=>"You don't have permission to view this object");
}

my $labelstr  = $obj->get_label;
my $type = $obj->type->name;
my %linksfrom = $table->meta_data->get_links_from;
my %order     = $table->meta_data->get_column_order;


unless($type eq 'global'){
    push(@exclude, "enable_failover");
    push(@exclude, "failover_peer");
    push(@exclude, "export_file");
}
unless($type eq 'host'){
    push(@exclude, "physaddr");
}

#due to the implementation, aliases use the 
#short formatted names if that option is on (it is here)
if($type eq 'subnet'){
    push(@alias, "IP block:Subnet");
}
if($type eq 'host'){
    push(@alias, "IP block:IP Address");
}


if ( $DEBUG ){
    print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>';
    print '%linksfrom is  <pre>', Dumper(%linksfrom), '</pre><br>';
    print '%order is  <pre>', Dumper(%order), '</pre><br>';
    print '$type is '."$type <br>";
    print '@exclude is '."@exclude";
}

if ( $submit ){
    if ($edit eq 'bulk_import'){
	unless ( $bulk_import_data ){
	    $m->comp('/generic/error.mhtml', error=>"Empty import data");
	}
	# Do this atomically
	eval {
	    Netdot::Model->do_transaction(
		sub{
		    $obj->import_hosts(text=>$bulk_import_data, overwrite=>$import_overwrite);
		});
	};
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);
	}else{
	    $submit = 0; # So we display stuff below
	}
    }
}
</%init>

<div id="sectiondetail">

<!-- Display main object values -->
<div class="container">
    <div class="containerheadleft"><strong><% $table %></strong></div>
    <div class="containerheadright">
%       if ( ! $table->meta_data->is_history() ){
            <a href="edit.html?table=<% $table %>">[new]</a>
%	    if ( $manager && $manager->can($user, "edit", $obj) ){
		<a href="edit.html?table=<% $table %>&id=<% $obj %>">[edit]</a>
%	    }
%	}
%	if ( $manager && $manager->can($user, "delete", $obj) ){
            <a href="delete.html?table=<% $table %>&id=<% $obj %>">[delete]</a>
%       }
        <a href="#" onClick="opentextwindow(jspopoutstring,'js','');">[text]</a>
    </div>
    <div class="containerbodyoutside">
        <& "/generic/form.mhtml", table=>$table, id=>$id, edit=>0, exclude=>\@exclude, alias=>\@alias  &>
    </div>
</div>
<!-- End Display main object values -->
<!-- Display has_many possibilities-->
%  my $has_history_table = 1 if ( $table->meta_data->get_history_table_name() );
%  if ( ! $table->meta_data->is_history() && ( keys %linksfrom ) ){
  <div class="container">
	<div class="containerhead">View</div>
	   <div class="containerbody">
%	      if ( $view eq "all" ){
		  [all]
%	      }elsif ( keys %linksfrom > 1 ){
		  <a href="scope.html?id=<% $obj %>&view=all">[all]</a>
%             }
%             foreach my $i ( sort keys %linksfrom ){
%               next if($i eq 'derived_scopes' && $type ne 'template');
%               next if($i eq 'contained_scopes' && ($type eq 'host' || $type eq 'subnet' || $type eq 'template'));
%               next if($i eq 'audit_records' && $type ne 'global');
%               if ( $view eq $i ){
                   [<% $i %>]
%               }else{
                   <a href="scope.html?id=<% $obj %>&view=<% $i %>">[<% $i %>]</a>
%               }   
%             }
              <a href="scope.html?id=<% $obj %>&view=bulk_import">[bulk import]</a>
	   </div>
	</div>
  </div>
%  }
<!-- End Display has_many possibilities-->

<!-- Display has_many objects -->
<%perl>
foreach my $i ( keys %linksfrom ){
    next if ($i eq "derived_scopes" && $type ne "template");
    next if($i eq 'contained_scopes' && ($type eq 'host' || $type eq 'subnet' || $type eq 'template'));
    next if($i eq 'audit_records' && $type ne 'global');

    if ( ($view eq 'all' || $view eq $i ) ){
        
        # Table that points to us
        my $j = (keys %{ $linksfrom{$i} })[0];
        
        # Column in the other table that points to this table
        my $ffield = $linksfrom{$i}{$j};
        # Determine if the has_many method returns ordered data from the db
        my $ffattrs = $j->meta_data->get_column($ffield)->links_to_attrs();
        my $ffield_order = $ffattrs->{order_by} if ( defined $ffattrs && exists $ffattrs->{order_by} );
        
        my @robjs;
        if($i ne 'contained_scopes' || $scope_text_filter || @scope_type_box){
            @robjs = $obj->$i;
        }
        else{
           @robjs = (); #no need to preform this expensvie query if the user hasn't selected filters
        } 
            
        my $dtbl  = $j;
        my $ctbl  = $j; 
        my %args;
       

        #since the amount of returned values in contained_scopes is sometimes big, 
        #lets filter down our result list here.  Performance is better and the results
        #are more readable, but might need to figure out how to move this filtering to db
        if($i eq 'contained_scopes' && ($scope_text_filter || @scope_type_box)){
            my @tmp_row_objects;   
            foreach $r (@robjs){
                if (!@scope_type_box || grep{$_ eq $r->type->name} @scope_type_box){
                    if(!$scope_text_filter || $r->name =~ /$scope_text_filter/){
                        push(@tmp_row_objects, $r);
                    }
                }
            }
            
            @robjs = sort {$a->name cmp $b->name} @tmp_row_objects;    
        }

        my $num = scalar(@robjs);

</%perl>

%       my @all_zones = DhcpScopeType->retrieve_all();  
        <div class="container">
%       my $title = $i;
%       $title .= " ($num)" if $num;	 
%       $title .= "&nbsp;&nbsp;&nbsp;".$explanation_hash{$i};
            <div class="containerheadleft"><% $title %></div>
	    <div class="containerheadright">
%       if ( $edit eq $i ){	    
              &nbsp;
%       }
%       else{
%           if($i eq "templates"){ #we have a special edit page for templates.
%	            if ( $num ){
%                   my @temps = DhcpScopeUse->search(scope=>$obj);
%                   my $space_seperated_list = "";
%                   for my $s (@temps){
%                       $space_seperated_list.=$s." "
%                    }
%                         
                    <a href="template_edit.html?id=<% $id %>&selectall_ids=<% $space_seperated_list %>">[edit]</a>
%	            }
                <a href="template_edit.html?id=<% $obj %>">[add]</a>
%           }
%           else{ #for everything BUT templates:
%	            if ( $num ){
                  <a href="view.html?table=<% $table %>&id=<% $id %>&view=<% $view %>&edit=<% $i %>">[edit]</a>
%	            }
               <a href="edit.html?table=<% $ctbl %>&<% $ffield %>=<% $obj %>">[add]</a>
%           }
%       }
	    </div>



%       if($i eq 'contained_scopes'){
%           #present a form to the user allowing them to only display certian types of scopes           
            <form name = "scope_options" action="scope.html" method="POST" >
                <table><tr>                 
                <td>Select Scope type(s)
                 <select name = "scope_type_box">

%                    foreach my $zone (@all_zones){                   
                         <option value="<% $zone->name %>"><% $zone->name %></option>
%                    }
                       
                 </select></td></tr>
            <tr><td>keyword:  <input type="text" name="scope_text_filter"></input></td></tr>
            <tr><td><input type="submit" /></td></tr>
            <input type="hidden" name="id" value="<% $id %>" />
            <input type="hidden" name="view" value="<% $view %>">
            </form>
            </table>
%       }

%       if($i eq 'audit_records' && ! $show_audit_record){
            <form name="show_audit" action="scope.html" method="POST">
                <input type= "hidden" name = "show_audit_record" value="1" />
                <input type="hidden" name="id" value="<% $id %>" />
                <input type="hidden" name="view" value="<% $view %>">
                <input type= "submit" value= "show audit records" />
            </form>
%       }
%       else{
%           %args = ( table=>$dtbl, object=>\@robjs );
%	        if ( $edit eq $i ){
%               $args{withedit} = 1;
%	        }
%           else{
%               # If data came ordered from the db, tell sortresults not to bother sorting
%               $args{sort} = 0 if ( $ffield_order );
%           }
%	        if ($num){
%               $args{return_args} = "?id=$id&view=$view";
%               $m->comp('/generic/sortresults.mhtml', %args);
%           }
%    
    </div>
%       }
%   }
%}

<!-- End Display has_many objects -->

<!-- Display bulk import -->
% if ( $view eq 'bulk_import' ){
   <div class="container">
      <div class="containerhead">Bulk Import</div>
      <div class="containerbody">
%     if ( $obj->type->name ne 'global' && $obj->type->name ne 'group' ){
	 <p>At this time, only host scopes can be imported, which can only be contained in global or group scopes
%     }else{
      <p>
      <div align="center">
      <p>
      Create fixed-address host scopes in bulk by adding lines containing ethernet and IP address, separated by spaces.
      <br> For example:
      <p>00:23:45:67:89:AB 192.168.0.1
      <br>00:23:45:67:89:CD 192.168.0.2
      <p>
      <form action="scope.html" method="POST">
	  <input type="hidden" name="id" value="<% $id %>"
	  <input type="hidden" name="edit" value="bulk_import">
	  <textarea name="bulk_import_data" cols="80" rows="20"></textarea>
	  <p>
	  Overwrite existing records <input type="checkbox" name="import_overwrite" CHECKED>
	  <p>
	  <input type="submit" name="submit" value="Import">
      </form>
      </div>
%   }
     </div>
    </div>
% }
<!-- End Display bulk import -->


</div>
