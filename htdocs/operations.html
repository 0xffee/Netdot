<%doc>
$Id$

-- Operations Worksheet -- 

Interface (similar to device worksheet) for viewing/updating
NOC relevant information.  This includes customer contacts, 
devices, sites, circuits.

</%doc>
%
%
<%args>
$id     => undef
$search => undef
$_action => undef
$status => undef
$view   => "Basics"
$edit   => undef
$user => undef
</%args>
%
%
<%flags>
inherit => 'section_operations.html' 
</%flags>
%
%
<%attr>
title   => 'Operations' 
section => 'Operations'
</%attr>
%
%
<%init>
my $DEBUG     = 0;
my %cssitem   = ( 0 => "formtablec1", 1 => "formtablec2" );
my $maxselect = 100;
my $obj       = undef;
my $ci        = 0;
my $list;
my $name;
my $entity;
my @tables;
my %arg;
my %results;
my %stables;
my %entities;
my %caller_args = $m->caller_args(-1);


if( exists( $caller_args{page} ) ) {
    $user->setAttribute($r, "OPERATIONS_PAGE", $caller_args{page});
}
my $page = $user->getAttribute("OPERATIONS_PAGE");

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;


if( $search ) {

    @tables = qw( Connection Device Entity Person Site  );
    if( defined( $search ) && $search =~ /\w+/ ) {

        # walk through a set of tables and search each column
        foreach my $tbl ( @tables ) {
	    if( $tbl eq "Ipblock" ) {
                next;
            }
            my @columns = $tbl->_essential();
            if( $tbl eq "Device" || $tbl eq "Entity" 
                || $tbl eq "Person" || $tbl eq "Site" ) {
                push @columns, "aliases";
            }
            my %linksto = $ui->getlinksto($tbl);
            foreach my $col ( @columns ) {
                if( $col eq "id" ) {
                    next;
                }
                if( $linksto{$col} ) {
		    push @tables, $linksto{$col};
                } elsif( $col eq "origin" || $col eq "status" ) { 
                    next;
                } else {
		    $stables{$tbl}{$col} = 1;
                }
            }
        }
        foreach my $tbl ( keys %stables ) {
            foreach my $col ( keys %{ $stables{$tbl} } ) {
                my $q = "%" . $search . "%";
                map { 
                    $results{$tbl}{$_->id} = $_ 
                } $tbl->search_like( $col => $q );
            }
        }

    } elsif( defined( $search ) && $search !~ /\w+/ ) {

        print "<p><b>No search criteria</b>";
        $m->abort;

    } elsif( defined( $id ) && $page eq "INFO" ) {

        $entity = Entity->retrieve($id);
        if( ! defined( $entity) ) {
            $m->comp( 'error.mhtml', error => "Could not retrieve Entity with id $id" );
        }

    }

} elsif( $status ) {

    @tables = qw( BGPPeering Device Interface IpService );

}

if( %results ) {

    # Tables with entity column: Connection Device Person
    # Site must use EntitySite to look up the corresponding Entity
    foreach my $tbl ( keys %results ) {
        foreach my $id ( keys %{ $results{$tbl} } ) {
            my $name;
	    if( $tbl eq "Person" ) {
                $name = $results{$tbl}{$id}->lastname() . ", " 
		    . $results{$tbl}{$id}->firstname()
            } else {
	        $name = $results{$tbl}{$id}->name();
            }
            if( $tbl eq "Site" ) {
	        my $site = ( EntitySite->search( site => $id ) )[0];
		if( defined( $site ) ) {
		    my $entity = $site->entity();
                    $entities{$entity->name()}{foundby} = $tbl . " " . $name;
		    $entities{$entity->name()}{object} = $entity;
                }
            } elsif( $tbl eq "Entity" ) {
	        my $entity = $results{$tbl}{$id};
		$entities{$entity->name()}{foundby} = $tbl . " " . $name;
		$entities{$entity->name()}{object} = $entity;
            } elsif( $tbl eq "RR" ) {
                ;
            } else {
                my $entity = $results{$tbl}{$id}->entity();
		$entities{$entity->name()}{foundby} = $tbl . " " . $name;
		$entities{$entity->name()}{object} = $entity;
            }
        }
    }
    if( %entities && scalar( keys %entities ) == 1 ) {
        undef( $search );
	my $e = ( keys %entities )[0];
        $entity = $entities{$e}{object};
	$id = $entity->id();
    } else {
        foreach my $e ( keys %entities ) {
            push @{ $list }, $entities{$e}{object};
        }
    }

} elsif( $entity ) {

    ; # do nothing

} else {

    print  "<p><b>No results</b>";
    $m->abort;

}

</%init>
%
<div id="sectiondetail">
%
% if( $search ) {
%
<table border="0" align="center" class="tablebackground">
 <tr class="rowtitle0" >
    <td valign="top" align="left">
       <b><% scalar(@$list) %> results for <i><% $search %></i></b>
    </td>
 </tr>
 <tr>
   <td valign="top" width="50%" align="center">
      <& sortresults.mhtml, object => $list, view => "row", page => "operations.html", withdelete => 1 &>
  </td>
 </tr>
</table>
%
% } elsif( $entity ) {
%
<table border="0" width="100%" cellpadding="1" cellspacing="0" align="center" class="tablebackground">
    <tr class="rowtitle0" >
        <td valign="top" width="50%" align="left">
         Entity: <b><% $entity->name %></b>&nbsp;
         </td>
    </tr>
    <tr class="rowtitle0">
        <td valign="top" width="50%" align="left">
            View:
%       if( $view eq "Basics" ) {
            [Basics]
%       } else {
            <a href="operations.html?id=<% $id %>&view=Basics">[Basics]</a>
%       }
        </td>
    </tr>
</table>
%
% } elsif( $status ) {



% }
%
</div>

