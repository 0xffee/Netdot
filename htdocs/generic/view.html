<%doc>

  Generic object view
  Uses metadata to display all fields with their values
  and lists of each group of 'has_many' related objects

  Required Arguments:
    table name and either id or position

</%doc>

<%args>
$table
$id
$view    => "all"
$edit    => undef
</%args>

<%attr>
title   => 'View Object' 
</%attr>

<%init>
my $DEBUG = 0;
my($obj, $prevobj );
my %ftables;


unless ( $obj = $table->retrieve($id) ){
   $m->comp('error.mhtml', error => "Nonexistent record: $id");
}

my $labelstr  = $obj->get_label;
my %linksfrom = $table->meta_data->get_links_from;
my %order     = $table->meta_data->get_column_order;

if ( $DEBUG ){
    print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>';
    print '%linksfrom is  <pre>', Dumper(%linksfrom), '</pre><br>';
    print '%order is  <pre>', Dumper(%order), '</pre><br>';
}

# List all the has_many objects for this object
#
foreach my $i ( keys %linksfrom ){
    # Table that points to us
    my $j = (keys %{ $linksfrom{$i} })[0];

    #column in the other table that points to this table
    $ftables{$i}{ffield} = $linksfrom{$i}{$j};
    
    # Determine if the has_many method returns ordered data from the db
    my $ffattrs = $j->meta_data->get_column($ftables{$i}{ffield})->links_to_attrs();
    $ftables{$i}{ffield_order} = $ffattrs->{order_by} if ( exists $ffattrs->{order_by} );

    if ( $j->meta_data->is_join ){
	# Foreign table is a join table
	$ftables{$i}{join} = 1;
	# Get has_a entries 
	my %jlinksto = $j->meta_data->get_links_to();
	# Column in join table that points to third table
	my $col;
	map { $col = $_ if ($_ ne $linksfrom{$i}{$j}) } keys %jlinksto;
	map { push @{ $ftables{$i}{robjs} }, $_->$col } $obj->$i;
	@{$ftables{$i}{objs}} = $obj->$i;
	$ftables{$i}{dtbl} = $jlinksto{$col};  # table to display
	$ftables{$i}{ctbl} = $j;               # table to pass to create.html
    }else{  
	# table is not a join table
	$ftables{$i}{join} = 0;
	@{$ftables{$i}{robjs}} = $obj->$i;
	$ftables{$i}{dtbl} = $j;
	$ftables{$i}{ctbl} = $j; 
    }
}

print '%ftables is  <pre>', Dumper(%ftables), '</pre><br>' if $DEBUG;

</%init>

<div id="sectiondetail">

%  if ( ! $table->meta_data->is_history() ){
      <div class="container">
	<div class="containerhead">View</div>
	   <div class="containerbody">
%	      if ($view eq "all"){
		  [all]
%	      }else{
		  <a href="view.html?table=<% $table %>&id=<% $obj %>&view=all">[all]</a>
%             }
%	      if ($view eq $table){
		  [<% lc($table) %>]
%	      }else{
                  <a href="view.html?table=<% $table %>&id=<% $obj %>&view=<% $table %>">[<% lc($table) %>]</a>
%             }
%             foreach my $i (keys %ftables){
%               if ($view eq $i){
                   [<% $i %>]
%               }else{
                   <a href="view.html?table=<% $table %>&id=<% $obj %>&view=<% $i %>">[<% $i %>]</a>
%               }   
%             }
%           if ( $table->meta_data->get_history_table_name() ){
              <a href="view.html?table=<% $table %>&id=<% $obj %>&view=history">[history]</a>
%	    }
	   </div>
	</div>
      </div>
%  }

  <div class="containeroutside">

<%perl>

if ( $view eq 'all' || $view eq "$table" ){
    
</%perl>

	<div class="containerheadleftoutside"><strong><% $table %></strong></div>
	<div class="containerheadrightoutside">
%         if ( ! $table->meta_data->is_history() ){
              <a href="edit.html?table=<% $table %>">[new]</a>
              <a href="edit.html?table=<% $table %>&id=<% $obj %>">[edit]</a>
%	      }
          <a href="delete.html?table=<% $table %>&id=<% $obj %>">[delete]</a>
	</div>

	<div class="containerbodyoutside">

          <& form.mhtml, table=>$table, id=>$id, edit=>0 &>

	</div>
%}
<!-- End Display main object values -->


<!-- Display has_many objects -->

%   foreach my $i (sort keys %ftables){
%     if ( ($view eq 'all' || $view eq $i ) && $view ne "$table"){
          <div class="container">
	    <div class="containerheadleft"><% $i %></div>
	    <div class="containerheadright">
%           if ( $edit eq $i ){	    
               &nbsp;
%           }else{
%	       if ( (defined($ftables{$i}{objs})  && scalar(@{$ftables{$i}{objs}})) ||
%		    (defined($ftables{$i}{robjs}) && scalar(@{$ftables{$i}{robjs}})) ){
                   <a href="view.html?table=<% $table %>&id=<% $id %>&edit=<% $i %>">[edit]</a>
%	       }
	       <a href="edit.html?table=<% $ftables{$i}{ctbl} %>&<% $ftables{$i}{ffield} %>=<% $obj %>">[add]</a>
%           }
	    </div>
%              my %args = ( table => $ftables{$i}{dtbl}, object => $ftables{$i}{robjs} );
%	       if ( $edit eq $i ){
%                  $args{withedit} = 1;
%	       }else{
%                   # If data came ordered from the db, tell sortresults not to bother sorting
%                   $args{sort} = 0 if ( $ftables{$i}{ffield_order} );
%              }
%	       $m->comp('sortresults.mhtml', %args);
          </div>
%     }
%   } 

<!-- End Display has_many objects -->

<!-- Display history objects associated with this object-->

%  if ( $view eq 'history' && $table->meta_data->has_history() ){
%   my @ho = $obj->get_history;
    <& sortresults.mhtml, object => \@ho , view => "row", sort => 0 &>
%  } 

<!-- End Display history objects -->

   </div>
</div>
