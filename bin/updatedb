#
# Make the necessary modifications to upgrade Netdot's schema and data
#
#
# This script modifies a 0.8.* schema into current version (0.9)
#
# To developers:
# In the future we can consider:
#   1. making a temp table (in the same db) with the new table definition
#   2. copy data over
#   3. delete the old table and rename the new one over
# We can explicitly specify the names of tables that have changed.
# This method should work, and it's probably easier than current method.
#
# Also note: 0.7->0.8 updatedb uses a different approach:
# It creates a new database and copy everything over.
# See /tags/netdot-0.8.1/bin/updatedb for more info
#

use strict;
use lib "../lib";
use DBUTIL;
use Netdot;
use Netdot::Model;

my %CONFIG;
$CONFIG{debug}             = 1;
$CONFIG{keep_history}      = 1;
$CONFIG{keep_dependencies} = 0;

foreach my $var ( qw /DB_TYPE DB_HOME DB_HOST DB_PORT DB_DBA DB_DBA_PASSWORD 
		  DB_NETDOT_USER DB_NETDOT_PASS DB_DATABASE/ ){
    $CONFIG{$var} = Netdot->config->get($var);
}

my $dbh = &dbconnect($CONFIG{DB_TYPE}, $CONFIG{DB_HOST}, $CONFIG{DB_PORT}, 
			$CONFIG{DB_DBA}, $CONFIG{DB_DBA_PASSWORD}, $CONFIG{DB_DATABASE});


my @statements = (
    "ALTER TABLE `dhcpattr` DROP INDEX dhcpattr1",
    "ALTER TABLE `dhcpattr` ADD INDEX dhcpattr1 (`name`, `scope`)",
    "ALTER TABLE `dhcpscope` CHANGE `fixed_address` `ipblock` integer NOT NULL",
    "ALTER TABLE `dhcpscope` CHANGE `info` `text` blob",
    "ALTER TABLE `dhcpscope` DROP COLUMN `parent`",
    "ALTER TABLE `dhcpscope` DROP COLUMN `subnet`",
    "ALTER TABLE `dhcpscope` ADD COLUMN `container` integer NOT NULL",
    "ALTER TABLE `dhcpscope` DROP INDEX DhcpScope2",
    "ALTER TABLE `dhcpscope` ADD INDEX DhcpScope2 (`ipblock`)",
    "ALTER TABLE `ipblock` DROP COLUMN `dhcp_enabled`",
    "ALTER TABLE `person` MODIFY `email` varchar(255)",
    "ALTER TABLE `person` MODIFY `emailpager` varchar(255)",
    "ALTER TABLE `person_history` MODIFY `email` varchar(255)",
    "ALTER TABLE `person_history` MODIFY `emailpager` varchar(255)",
    "ALTER TABLE `rr` DROP INDEX RR3",
    "ALTER TABLE `rr` DROP INDEX RR4",
    "ALTER TABLE `rr` ADD INDEX RR3 (`expiration`)",
    "ALTER TABLE `rraddr` ADD INDEX RRADDR2 (`ipblock`)",
    "ALTER TABLE `rrcname` CHANGE `cname` `name` integer NOT NULL",
    "ALTER TABLE `rrcname` CHANGE `alias` `cname` varchar(128) NOT NULL",
    "ALTER TABLE `rrcname` DROP INDEX rrcname1",
    "ALTER TABLE `rrcname` ADD UNIQUE INDEX rrcname1 (`name`)",
    "ALTER TABLE `rrcname` ADD INDEX RRCNAME2 (`cname`)",
    "ALTER TABLE `rrmx` MODIFY `exchange` varchar(255) NOT NULL",
    "ALTER TABLE `rrmx` MODIFY `preference` integer NOT NULL DEFAULT '0'",
    "ALTER TABLE `rrmx` ADD INDEX RRMX2 (`exchange`)",
    "ALTER TABLE `rrns` MODIFY `nsdname` varchar(255) NOT NULL",
    "ALTER TABLE `rrns` ADD INDEX RRNS2 (`nsdname`)",
    "ALTER TABLE `rrptr` ADD COLUMN `ptrdname` varchar(255) NOT NULL",
    "ALTER TABLE `rrptr` DROP INDEX rrptr1",
    "ALTER TABLE `rrptr` ADD UNIQUE INDEX rrptr1 (`ptrdname`, `ipblock`)",
    "ALTER TABLE `rrptr` ADD INDEX RRPTR2 (`ipblock`)",
    "ALTER TABLE `rrptr` ADD INDEX RRPTR3 (`rr`)",
    "ALTER TABLE `rrsrv` CHANGE `rr` `name` integer NOT NULL",
    "ALTER TABLE `rrsrv` MODIFY `port` integer NOT NULL",
    "ALTER TABLE `rrsrv` MODIFY `priority` integer NOT NULL DEFAULT '0'",
    "ALTER TABLE `rrsrv` MODIFY `target` varchar(255) NOT NULL",
    "ALTER TABLE `rrsrv` MODIFY `weight` integer NOT NULL DEFAULT '0'",
    "ALTER TABLE `rrsrv` DROP INDEX rrsrv1",
    "ALTER TABLE `rrsrv` ADD UNIQUE INDEX rrsrv1 (`name`, `port`, `target`)",
    "ALTER TABLE `rrsrv` ADD INDEX RRSRV2 (`target`)",
    "ALTER TABLE `rrtxt` CHANGE `txt` `txtdata` varchar(128)",
    "ALTER TABLE `rrtxt` ADD INDEX RRTXT2 (`txtdata`)",
    "ALTER TABLE `zone` ADD COLUMN `default_ttl` integer NOT NULL",
    "ALTER TABLE `zone` ADD COLUMN `export_file` varchar(255) NOT NULL",
    "ALTER TABLE `zone` DROP COLUMN `masterserver`",
    "ALTER TABLE `zone` ADD COLUMN `name` varchar(128) NOT NULL",
    "ALTER TABLE `zone` DROP COLUMN `reverse`",
    "ALTER TABLE `zone` DROP INDEX zone1",
    "ALTER TABLE `zone` ADD UNIQUE INDEX zone1 (`name`)",
    "DROP TABLE `rrtype`",
    "CREATE TABLE `rrloc` (
       `altitude` integer NOT NULL,
       `horiz_pre` varchar(32),
       `id` integer NOT NULL auto_increment,
       `latitude` integer NOT NULL,
       `longitude` integer NOT NULL,
       `rr` integer NOT NULL,
       `size` varchar(32),
       `ttl` varchar(32),
       `vert_pre` varchar(32),
       UNIQUE INDEX rrloc1 (`rr`),
       PRIMARY KEY (`id`)
     ) ENGINE=InnoDB;",
    "CREATE TABLE `rrnaptr` (
       `flags` varchar(1),
       `id` integer NOT NULL auto_increment,
       `order_field` integer NOT NULL DEFAULT '0',
       `preference` integer NOT NULL DEFAULT '0',
       `regexpr` varchar(255) NOT NULL,
       `replacement` varchar(255) NOT NULL,
       `rr` integer NOT NULL,
       `services` varchar(255) NOT NULL,
       `ttl` varchar(32),
       INDEX RRNAPTR2 (`rr`),
       INDEX RRNAPTR3 (`services`),
       PRIMARY KEY (`id`)
     ) ENGINE=InnoDB;",
    "CREATE TABLE `zonealias` (
       `id` integer NOT NULL auto_increment,
       `info` blob,
       `name` varchar(128) NOT NULL,
       `zone` integer NOT NULL,
       UNIQUE INDEX zonealias1 (`name`),
       PRIMARY KEY (`id`)
     ) ENGINE=InnoDB;",
    "CREATE TABLE `dhcpscopeuse` (
       `id` integer NOT NULL auto_increment,
       `scope` integer NOT NULL,
       `template` integer NOT NULL,
       UNIQUE INDEX dhcpscopeuse1 (`scope`, `template`),
       INDEX DhcpScopeUse2 (`template`),
       PRIMARY KEY (`id`)
     ) ENGINE=InnoDB;",
    );

my @ttlchange = ("rraddr",
		 "rrcname",
		 "rrhinfo",
		 "rrmx",
		 "rrns",
		 "rrptr",
		 "rrsrv",
		 "rrtxt",
    );

my %timeStampChangeNotNull = ( "arpcache"     => "tstamp",
			       "devicemodule" => "date_installed",
			       "devicemodule" => "last_updated",
			       "fwtable"      => "tstamp",
			       "ipblock"      => "first_seen",
			       "ipblock"      => "last_seen",
			       "physaddr"     => "first_seen",
			       "physaddr"     => "last_seen",
    );

my %timeStampChangeNull = ( "device"         => "date_installed",
			    "device"         => "last_arp",
			    "device"         => "last_fwt",
			    "device"         => "last_updated",
			    "device_history" => "date_installed",
			    "device_history" => "last_arp",
			    "device_history" => "last_fwt",
			    "device_history" => "last_updated",
    );

foreach my $t (@ttlchange) {
    push (@statements, "ALTER TABLE `$t` MODIFY `ttl` varchar(32)");
}

foreach my $t (keys %timeStampChangeNotNull) {
    push (@statements, "ALTER TABLE `$t` MODIFY `$timeStampChangeNotNull{$t}` timestamp NOT NULL DEFAULT '1970-01-01 00:00:01'");
}

foreach my $t (keys %timeStampChangeNull) {
    push (@statements, "ALTER TABLE `$t` MODIFY `$timeStampChangeNull{$t}` timestamp DEFAULT '1970-01-01 00:00:01'");
}

foreach my $st (@statements) {
    my $sth = $dbh->prepare($st);
    eval {
	$dbh->do($st);
    };
    if ( $@ ) {
	print "FAILED STATEMENT: $st\n";
    }
}

&dbdisconnect($dbh);


sub debug {
    print STDERR "DEBUG: ", @_, "\n" if $CONFIG{debug};
}
