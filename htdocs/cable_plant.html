<& index.html, title => "Cable Plant: $name", s2name => $s2name  &>

<%perl>
print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

# code for inserting/updating
# -----------------------------------------------------------------------------
if(defined($ARGS{_action}))
{
    print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

    if (!$ui->form_to_db(%ARGS))
    {
        my $err = $ui->error();
        die("Error: $err\n");
	}
    
    # Do this to 'flush' the values associated with the object
    # before redisplaying
    $o = undef;
    if ($id)
    {
        $o = Site->retrieve($id);
        $name = $o->name;
    }
}  
# end insertion/update code
# -----------------------------------------------------------------------------
</%perl>     

<!-- Header Table -->
<table border="0" width="95%" align="center" cellpadding="3" cellspacing="0" class="tablebackground">
 <tr class="rowtitle0" >
    <td align="left">
    <% ucfirst(lc($page_type)) %> Cable for Site: <a href="site.html?id=<% $id %>"><% $o->name %></a>&nbsp;&nbsp; 
    <a href="cable_plant.html?id=<% $id %>&page_type=<% $page_type %>&cable_sort=<% $cable_sort %>">[refresh]</a>
    </td>
 </tr>
</table>
<!-- End Header Table -->

<!-- Margins Table -->
<table border="0" width="95%" align="center"  class="tablebackground">
 <tr>
   <td valign="top" width="50%" align="center">

% if ($edit) {
   <form name="netdotform" action="cable_plant.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="page_type" value="<% $page_type %>">
    <input type="hidden" name="_action" value="<% $id ? "UPDATE" : "NEW" %>">
    <input type="hidden" name="s2name" value="<% $s2name %>">
% }

% #############################################################################
% # BEGIN HORIZONTAL CABLE CODE
% #############################################################################
% if (uc($page_type) eq "HORIZONTAL") {
%   my (@closets, @cables);

    <%perl>
    map { push (@closets, $_) } $o->closets;

    print "closets is <pre>", Dumper(@closets), "</pre><br>" if $DEBUG;
    
    foreach my $closet (@closets)
    {
        map { push(@cables, $_) } $closet->horizontalcables;
    }
    print "cables is <pre>", Dumper(@cables), "</pre><br>" if $DEBUG;
    </%perl>

%   if (scalar(@cables) > $MAX_SELECTION) {
        <b>Over <% $MAX_SELECTION %> rows were returned. Please refine your criteria.</b>
%   } else {
        <% scalar(@cables) %> row(s) returned.

  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle" >
     <td colspan="5">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="70%" align="center">Horizontal Cable</th>
%	 if ($edit eq "cableinfo"){	 
            <td width="20%" align="right"><input name="submit" value="save" type="submit"></td>
%	 } else {
            <td width="20%" align="right">
                <a href="cable_horizontal.html?id=NEW&site_id=<% $id %>">[new]</a> &nbsp;||&nbsp; 
                <a href="cable_plant.html?id=<% $id %>&page_type=<% $page_type %>&edit=cableinfo">[edit]</a>
            </td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0" width="100%">
% }      

%	if (scalar(@cables) && scalar(@cables) < $MAX_SELECTION) {
    <tr>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=jackid&page_type=<% $page_type %>">Jack</a>
        </td>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=type&page_type=<% $page_type %>">Type</a>
        </td>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=closet&page_type=<% $page_type %>">Closet</a>
        </td>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=room&page_type=<% $page_type %>">Room</a>
        </td>
    </tr>

    <%perl>
    # sort
    # -------------------------------------------------------------------------
    $cable_sort = "jackid" if (!defined($cable_sort) || $cable_sort eq "");
    my @sorted_cables;
    if ($cable_sort eq "jackid" || $cable_sort eq "room")
    {
        @sorted_cables = sort { $a->$cable_sort cmp $b->$cable_sort } @cables;
    }
    elsif ($cable_sort eq "type")
    {
        @sorted_cables = sort { $a->type->name cmp $b->type->name } @cables;
    }
    elsif ($cable_sort eq "closet")
    {
        @sorted_cables = sort { $a->closet->name cmp $b->closet->name } @cables;
    }
    else
    {
        die("ERROR: Unknown value for cable_sort: \"$cable_sort\"\n");
    }
    # -------------------------------------------------------------------------
</%perl>
%   my $i = 0;
%   foreach my $cable (@sorted_cables) 
%   {
%   $i = ($i + 1) % 2;
    <tr align="left" class="<% $cssitem{$i} %>">
        <td align="left">
%       if ($edit eq "cableinfo") {
            <input type="checkbox" name="<% "HorizontalCable__" . $cable->id . "__delete" %>">[del]
            <input type="text" name="HorizontalCable__<% $cable->id %>__jackid" value="<% $cable->jackid %>">
%       } else {
            <a href="cable_horizontal.html?id=<% $cable->id %>"><% $cable->jackid %></a>
%       }
        </td>
        
        <td align="left">
%       if ($edit eq "cableinfo") {
%           $ui->selectLookup(object=>$cable, column=>"type", lookup=>"CableType");
%       } else {
            <% $cable->type ? $cable->type->name : "" %>
%       }
         </td>

        <td align="left">
%       if ($edit eq "cableinfo") {
%           $ui->selectLookup(object=>$cable, column=>"closet", lookup=>"Closet");
%       } else {
            <% $cable->closet ? $cable->closet->name : "" %>
%       }
         </td>
        
        <td align="left">
%       if ($edit eq "cableinfo") {
            <input type="text" name="HorizontalCable__<% $cable->id %>__room" value="<% $cable->room %>">
%       } else {
            <% $cable->room %>
%       }            
        </td>
    </tr>
%   }
%}
    </table>
    </td>
    </tr>
</table>
%} 
% #############################################################################
% # END HORIZONTAL CABLE CODE
% #############################################################################
%
%
% #############################################################################
% # BEGIN BACKBONE CABLE CODE
% #############################################################################
% elsif (uc($page_type) eq "BACKBONE") {
  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle" >
     <td colspan="5">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="70%" align="center">Backbone Cable</th>
%	 if ($edit eq "cableinfo"){	 
            <td width="20%" align="right"><input name="submit" value="save" type="submit"></td>
%	 } else {
            <td width="20%" align="right">
                <a href="cable_backbone.html?id=NEW">[new]</a> &nbsp;||&nbsp; 
                <a href="cable_plant.html?id=<% $id %>&page_type=<% $page_type %>&edit=cableinfo">[edit]</a>
            </td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0" width="100%">
    <%perl>
    my (@c1, @closets, @cables, @floors, %s);
    
    @floors = Floor->search(site=>$id); # all floors for site ...

    print "floors: <pre>", Dumper(@floors), "</pre><br>" if $DEBUG;
    
    # ... and all closets for floor
    foreach my $floor (@floors)
    {
        map { push (@c1, $_) } $floor->closets;
    }

    # Because we are storing both a floor (which has the site), and the
    # site in our Closet table we need to check both places.
    @closets = grep(!$s{$_}++, (@c1, Closet->search(site=>$id)));

    print "closets: <pre>", Dumper(@closets), "</pre><br>" if $DEBUG;

    # and finally all BackboneCables that either start or end
    # at one of these closets..
    foreach my $closet (@closets)
    {
        my $c_id = $closet->id;
        map { push (@cables, $_) } (BackboneCable->search(start_closet=>$c_id),
                                    BackboneCable->search(end_closet=>$c_id));
    }
    
    printf("cables returned: %s\n", scalar(@cables)) if $DEBUG;
    </%perl>

    <tr><td align="left" colspan="5"><% scalar(@cables) %> row(s) returned.</td></tr>

%	if (scalar(@cables)) {
    <tr>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=name&page_type=<% $page_type %>">Name</a>
        </td>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=type&page_type=<% $page_type %>">Type</a>
         </td>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=start_closet&page_type=<% $page_type %>">Start Closet</a>
        </td>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=end_closet&page_type=<% $page_type %>">End Closet</a>
        </td>
        <td align="center">
            <a href="cable_plant.html?id=<% $id %>&cable_sort=owner&page_type=<% $page_type %>">Owner</a>
        </td>
    </tr>

    <%perl>
    $cable_sort = "name" if (!defined($cable_sort) || $cable_sort eq "");
    my @sorted_cables;
    if ($cable_sort eq "name")
    {
        @sorted_cables = sort { $a->$cable_sort cmp $b->$cable_sort } @cables;
    }
    elsif ($cable_sort eq "type")
    {
        @sorted_cables = sort { $a->type->name cmp $b->type->name } @cables;
    }
    elsif ($cable_sort eq "start_closet")
    {
        @sorted_cables = sort { $a->start_closet->name cmp $b->start_closet->name } @cables;
    }
    elsif ($cable_sort eq "end_closet")
    {
        @sorted_cables = sort { $a->end_closet->name cmp $b->end_closet->name } @cables;
    }
    elsif ($cable_sort eq "owner")
    {
        @sorted_cables = sort { $a->owner->name cmp $b->owner->name } @cables;
    }
    else
    {
        die("ERROR: Unknown value for cable_sort: \"$cable_sort\"\n")
    }
    </%perl>

%   my $i = 0;
%   foreach my $cable (@sorted_cables) {
%   $i = ($i + 1) % 2;
    <tr align="left" class="<% $cssitem{$i} %>">
        <td align="left">
%       if ($edit eq "cableinfo") {
            <input type="checkbox" name="<% "BackboneCable__" . $cable->id . "__delete" %>">[del]
            <input type="text" name="BackboneCable__<% $cable->id %>__name" value="<% $cable->name %>">
%       } else {
            <a href="cable_backbone.html?id=<% $cable->id %>"><% $cable->name %></a>
%       }
        </td>
        
        <td align="left">
%       if ($edit eq "cableinfo") {
%           $ui->selectLookup(object=>$cable, column=>"type", lookup=>"CableType");
%       } else {
            <% $cable->type ? $cable->type->name : "" %>
%       }
        </td>

        <td align="left">
%       if ($edit eq "cableinfo") {
%           $ui->selectLookup(object=>$cable, column=>"start_closet", lookup=>"Closet");
%       } else {
            <% $cable->start_closet ? $cable->start_closet->name : "" %>
%       }
        </td>

        <td align="left">
%       if ($edit eq "cableinfo") {
%           $ui->selectLookup(object=>$cable, column=>"end_closet", lookup=>"Closet");
%       } else {
            <% $cable->end_closet ? $cable->end_closet->name : "" %>
%       }
        </td>

        <td align="left">
%       if ($edit eq "cableinfo") {
%           $ui->selectLookup(object=>$cable, column=>"owner", lookup=>"Entity");
%       } else {
            <% $cable->owner ? $cable->owner->name : "" %>
%       }
        </td>
    </tr>
%   }
%}
    </table>
    </td>
    </tr>
</table>

%}
% #############################################################################
% # END BACKBONE CABLE CODE
% #############################################################################
% else {
%   die("Error: Unknown type \"$page_type\"\n");
%}

% if ($edit) {	 
    </form>
% }

 </td></tr>
</table>
<!-- End Margins Table -->

<%args>
$id => undef;
$cable_sort => undef;
$edit => undef;
$page_type => undef;
$s2name => "Plant";
</%args>

<%init>
my $DEBUG = 0;
my $MAX_SELECTION = 100;
my $ui = Netdot::UI->new();
my %cssitem = (0 => "formtablec1", 1 => "formtablec2");
my $maxselect = 100;
my $o = undef;
my $name;

if ($id) 
{
   $o = Site->retrieve($id);
   $name = $o->name;
} 

else 
{
   $name = "Search"
}
</%init>

<%doc>
Cable management stuff...
</%doc>
