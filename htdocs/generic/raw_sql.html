<%doc>

 Generic Database Operations Section.

</%doc>

<%args>
$sql    => undef
$action => undef
$sid    => undef
$table  => undef
</%args>

<%attr>
title   => 'Direct SQL Commands' 
section => 'Generic'
</%attr>

<%init>
my $result;
my $sql_err;

my $session;
my %objindex;
my %orderbrief;
my @orderbrief;
my $i;

if ( $action eq "DO_SQL" ){
    eval {
	$result = Netdot::Model->raw_sql($sql);
    };
    if ( my $e = $@ ){
	$sql_err = $e;
    }
}
</%init>

<div class="container">
    <div class="containerhead">
        Direct SQL Commands
    </div>

    <div class="containerbody">

    <p><b>Be Careful!</b></p>

    <form action="<% $r->dir_config('NetdotPath') %>generic/" method="POST">
      <input type="hidden" name="action" value="DO_SQL">
      SQL query: <input type="text" size="80" name="sql" value="<% $sql | h %>">
      <input name="submit" value="Go" type="submit">
    </form>
 
    </div> <!-- close containerbody -->
</div> <!-- close container -->
% my @rows;
% if ( $action eq "DO_SQL" ){
    <div class="container">
        <div class="containerhead">Query Results:</div>
        <div class="containerbody">
<%perl>
    if ( defined $result && scalar $result->{rows} ){
        my @headers = $result->{headers};
        @rows    = $result->{rows};      
	print scalar @{$rows[0]} . " rows<br>";
	$m->comp('data_table.mhtml', field_headers=>@headers, data=>@rows);
    
    }elsif ( $sql_err ){
        print $sql_err, "<br>";
    }

my $object = @rows;
$i=0;
$session = $ui->mk_session();
map { $objindex{$i++} = $_ } @{ $object };
$table = $object->[0]->short_class unless $table;
%orderbrief = $table->meta_data->get_column_order_brief();
@orderbrief = sort { $orderbrief{$a} <=> $orderbrief{$b} } keys %orderbrief;

$session->{object}     = $object;
$session->{objindex}   = \%objindex;
$session->{table}      = $table;
$session->{orderbrief} = \@orderbrief;
$session->{total}      = scalar @$object;
</%perl>

<div class="containerheadright">
    <a href="#" onClick="opentextwindow('','csv','sid=<% $session->{_session_id} %>')">[csv]</a>
</div>
        <br>
       </div> <!-- close containerbody -->
    </div> <!-- close container -->
% }


