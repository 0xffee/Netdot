<%doc>

 Generic Database Operations Section.

</%doc>

<%args>
$sql    => undef
$action => undef
</%args>

<%attr>
title   => 'Direct SQL Commands' 
section => 'Generic'
</%attr>

<%init>
my $lines;
my $sql_err;
if ( $action eq "DO_SQL" ){
    if ( ! ($lines = $ui->raw_sql($sql) ) ){
	$sql_err = $ui->error;
    }
}
</%init>

<div class="container">
    <div class="containerhead">
        Direct SQL Commands
    </div>

    <div class="containerbody">

    <p><b>Be Careful!</b></p>

    <form action="section_generic.html" method="POST">
      <input type="hidden" name="action" value="DO_SQL">
      SQL query: <input type="text" size="80" name="sql" value="<% $sql | h %>">
      <input name="submit" value="Go" type="submit">
    </form>
 
    </div> <!-- close containerbody -->
</div> <!-- close container -->


% if ( $action eq "DO_SQL" ){
    <div class="container">
        <div class="containerhead">Query Results:</div>
        <div class="containerbody">
<%perl>
    if ( $lines ){
        if( $sql =~ /select/i ) {
            my @headers;
            my @rows;

            # return everything between SELECT and FROM in the query, and use them as the headers
            # if they do "SELECT * FROM", then we have no headers, until I can figure out how to return
            # the list of column headers from the query.
            my ($inside) = $sql =~ /^SELECT(.*)FROM/i;         # grab the headers

            # possible characters that can occur as column headers:
            #   abcxyzABCXYZ0123456789 _()-
            @headers = $inside =~ /([\w()\.\ \-]+),?/g;        # split headers on the commas

            </%perl><& data_table.mhtml, field_headers=>\@headers, data=>$lines &><%perl>
        } else {
        	foreach my $line ( @$lines ){
        	    print $line, "<br>";
        	}
        }
    }elsif ( $sql_err ){
        print $sql_err, "<br>";    
    }
</%perl>
       </div> <!-- close containerbody -->
    </div> <!-- close container -->
% }
