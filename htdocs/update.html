<%perl>
unless ( $ARGS{table} && $ARGS{id} ){
   print "<strong>Missing required parameters 'table' and/or 'id'</strong>";
   exit;
}
$table = $ARGS{table};
$id = $ARGS{id};
$obj = $table->retrieve($id);

unless ( $obj ){
   print "<strong>Nonexistent record: $id</strong>";
   exit;
}

%linksto = $gui->getlinksto($table);
%linksfrom = $gui->getlinksfrom($table);
%order = $gui->getcolumnorder($table);
##################################################
# get state back if sid defined
#   otherwise create state if necessary
if( defined( $ARGS{sid} ) ) {
  $sid = $ARGS{sid};
  $session = $gui->getsession( $TMP, $sid );
} elsif( $table ) {  
  $session = $gui->mksession( $TMP );
  $sid = $session->{_session_id};
}
</%perl>

%if ( !$ARGS{res} ){ # show the form
% my $labelstr = $gui->getobjlabel($obj, ", ");
<& header, title=>" Edit: $table: $labelstr" &>

<table border="0" width="95%" align="center">
<tr><td align="center">
<p><br>
<form action="update.html" method="POST">

<input type="hidden" name="sid" value="<% $sid %>">
<input type="hidden" name="table" value="<% $table %>">
<input type="hidden" name="id" value="<% $id %>">

<& form, table => $table, showdisabled => '0', id => $id &>

<table cellpadding="3" cellspacing="1" border="0">
<tr align="LEFT">
<td bgcolor="#FFFFFF" align="CENTER" colspan="3">
<input name="submit" value="Update" type="submit">
</td>
<td>
<input name="cancel" value="Cancel" type="submit">
</td>
</tr>
</table>

<p><br>

</form>
<p><font size="-1">(*) After creating the object in the other screen, close it and refresh this page.  The newly created
object will show in the drop-down box.</font>

</td></tr>
</table>
<p><br>
<& footer &>

%} else { # parse form and update fields

<%perl>

 unless ( $ARGS{cancel} eq 'Cancel' ){

  # Get fields to update
  $obj = $table->retrieve($id);
  foreach my $j (keys %ARGS){
     next if ($j eq 'submit' || $j eq 'table' || $j eq 'id' || $j eq 'res');
     $fields{$j} = $ARGS{$j};	
  }


  # Check that we have at least one column parameter
  unless (scalar keys(%fields)){
    print "<strong>Missing field/value pairs to update</strong>";
    exit;
  }


 ##########################################
 ## Update fields that have changed
 ##########################################

</%perl>

%   eval {
%      foreach my $col (keys %fields){
%         if ($fields{$col} ne $obj->$col){
%            $obj->set($col, $fields{$col});
%         }
%      }
%         $obj->update;
%   };
%   if ($@){
      <& error, caller => "update.html", error => $@ &>
%     exit;
%   }
  
  <& view.html, table => $table, id => $id &>

% }else{
   <& view.html, table => $table, id => $id &>

% }
%} 
<%init>
my ( %linksto, %linksfrom, %order, %inputtypes,
    $table, $id, $obj, %fields );
my $gui = Netdot::GUI->new();

</%init>

<%args>
$user => $ENV{REMOTE_USER}
</%args>
