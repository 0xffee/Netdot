# NOTE: THIS CONFIGURATION IS FOR APACHE 2 ONLY.
#
# Modify this to your liking and include it in httpd.conf.
# -----------------------------------------------------------------------------

PerlModule ModPerl::Util
#PerlModule Apache2::Request
PerlModule Apache2::RequestRec
PerlModule Apache2::RequestIO
PerlModule Apache2::RequestUtil
PerlModule Apache2::ServerUtil
PerlModule Apache2::Connection
PerlModule Apache2::Log
PerlModule Apache::Session
PerlModule APR::Table
PerlModule ModPerl::Registry
PerlModule "Apache2::Const -compile => ':common'"
PerlModule "APR::Const -compile => ':common'"

PerlModule Apache2::SiteControl
PerlModule HTML::Mason::ApacheHandler

PerlSetVar MasonArgsMethod CGI
PerlModule Apache::DBI

PerlRequire /usr/local/netdot/lib/Netdot/Mason.pm


# If you would like to put netdot somewhere other than ``/netdot''
# just change this alias and the variable NetdotPath below.


Alias /netdot "/usr/local/netdot/htdocs/"

<Directory /usr/local/netdot/htdocs/>
   Order Deny,Allow
   Allow from all

   # This is hackish but it works.  It is preferred over handling all
   # files in /netdot as this causes requests for /netdot or /netdot/
   # to fail (DirectoryIndex doesn't get handled correctly).  The
   # "proper" way to handle this is with rewrite rules or
   # fixuphandlers I think, but this works: Handle everything which
   # isn't /netdot or /netdot/, i.e. which has atleast one non / char
   # in its name relative /netdot/, with mason.
   <FilesMatch .>
       SetHandler perl-script
       PerlHandler Netdot::Mason
   </FilesMatch>

   # Prevent mason from handling css
   <FilesMatch \.css$>
       SetHandler default-handler
   </FilesMatch>

   AuthType Apache2::SiteControl
   # Choose a name for the instance of the authenticator. This name is
   # used as part of the remaining variable names.
   AuthName Netdot
   require valid-user

   # Allow access to the css and and title image so the login page
   # displays correctly.  The anonymous sub is somehow equiv to the
   # specification of the constant explicitly.  The point is that you
   # can't simply turn off authentication for particular files, you
   # must provide a new handler which allows all requests instead.    
   <FilesMatch (\.css|title\.png)$>
       PerlAuthenHandler Apache2::Const::OK #'sub { return OK }'
       PerlAuthzHandler Apache2::Const::OK #'sub { return OK }'
   </FilesMatch>

   PerlSetVar Apache2::SiteControlMethod Apache2::SiteControl::Radius

   # Turn on debugging
   PerlSetVar AccessControllerDebug 9
   PerlSetVar AuthCookieDebug 9

   # Configure the factories. See SiteControl::UserFactory and
   # SiteControl::ManagerFactory
   PerlSetVar AccessControllerManagerFactory Netdot::NetdotPermissionFactory

   # Configure the location of the session data on server disks
   # NOTE: apache should have read/write access to these locations. 
   PerlSetVar SiteControlSessions /tmp/sessions
   PerlSetVar SiteControlLocks /tmp/sessions/locks

   # Tell mod_perl that you want this module to control access:
   PerlAuthenHandler Apache2::SiteControl->authenticate
   PerlAuthzHandler Apache2::SiteControl->authorize

   # Set the path that will be protected.
   #
   # *NOTE* This variable is used to determine absolute paths where
   # needed in the netdot pages.
   PerlSetVar NetdotPath /netdot

   # Indicate the path to the login page. Be careful, HTML::Mason can 
   # interfere with proper handling...make sure you know your dependencies.
   # See samples and Apache::AuthCookie for more information.
   PerlSetVar NetdotLoginScript /netdot/login.html

   # See Apache::AuthCookie for descriptions of these.
   PerlSetVar NetdotSatisfy All
   PerlSetVar NetdotDomain myhost.mydomain.com
   PerlSetVar NetdotCache 1
   PerlSetVar NetdotExpires +2h

</Directory>

# Be careful if you put the target in your netdot root
# (e.g. /netdot/NetdotLogin) as by default the mason autohandler will
# attempt to wrap the request creating an authentication loop.
<Location /NetdotLogin>
   AuthType Apache2::SiteControl
   AuthName Netdot 
   SetHandler perl-script
   PerlHandler Apache2::SiteControl->login
   PerlSetVar SiteControlDebug 9
   PerlSetVar AuthCookieDebug 9
   PerlSetVar NetdotLoginScript /netdot/login.html
   PerlSetVar RadiusSiteControlHost "localhost"
   PerlSetVar RadiusSiteControlSecret "testing123"
   PerlSetVar SiteControlSessions /tmp/sessions
   PerlSetVar SiteControlLocks /tmp/sessions/locks
</Location>
