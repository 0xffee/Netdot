<%doc>

Add a link between two interfaces from device.html
(Creates a new InterfaceDep object)

</%doc>
%
%
<%flags>
inherit => undef
</%flags>
%
%
<%args>
$int_id  =>   undef
$role    =>   undef
$Add     =>   undef
$Cancel  =>   undef
</%args>
%
%
<%init>
my $DEBUG = 0;
my %state;
my $intobj;
my $intlbl;
# Use a hash to make sure there are no duplicates
my %subnet_devs;

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

if ( $int_id ){
    unless ( $intobj = Interface->retrieve($int_id) ){
	$m->comp("error.mhtml", error => "Can't retrieve Interface id $int_id", showplainerror=>1);	
    }
    unless ( $intlbl = $ui->getobjlabel($intobj, ", ") ){
	$intlbl = $intobj->name;
    }
#
#   Get a list of Devices in the same subnet(s)
#
    my %subnets;
    foreach my $ip ( $dm->getdevips($intobj->device) ){
	if ( my $subnet = $ip->parent ){
	    $subnets{$subnet->id} = $subnet;
	}
    }
    
    foreach my $subnet ( keys %subnets ){
	foreach my $ip ( $subnets{$subnet}->children ){
	    if ( $ip->prefix == 32 || $ip->prefix == 128 ){
		if ( $ip->interface && $ip->interface->device 
		     && $ip->interface->device->name 
		     && $ip->interface->device->name->name){
		    $subnet_devs{$ip->interface->device->name->name} = "";
		}
	    }
	}
    }
    
}
my %reserved = ( Add           => "",
		 Cancel        => "",
		 search        => "",
		 device_search => "",
		 );
my $rel_role;
if ( $role ){
    if ($role ne "parent" && $role ne "child"){
	$m->comp("error.mhtml", error => "Invalid role: $role", showplainerror=>1);
    }
    $rel_role = ($role eq "parent")? "child" : "parent";
}

my %role_tags = ( 'parent' => "Parent Interface",
		  'child'  => "Child Interface",
		  );

</%init>

% my $bodyargs;
% if ( $Add ){
%     $bodyargs = 'onUnload="opener.location.reload()"';
% } else {
%     $bodyargs = '';
% }

<html>
<head>
    <link rel=StyleSheet href="style.css" type="text/css">
</head>      
<body class="bodytag" <% $bodyargs %>>

<div class="container">
    <div class="containerhead">
        Add Link
    </div>
    <div class="containerbody">

<%perl>
if ( $Add ){
    foreach my $arg ( keys %ARGS ){
    	next if ( exists $reserved{$arg} );
    	$state{$arg} = $ARGS{$arg};
    }
    my $newdepid;
    if ( InterfaceDep->search(\%state) ){
    	print "<br>Dependency already exists!<br><br>";
        print '<a href="#" onClick="window.close()">[close]</a><br>';

    	$m->abort;
    }else{
    	unless ( $newdepid = $ui->insert(table => "InterfaceDep", state => \%state) ){
    	    $m->comp("error.mhtml", error => $ui->error, showplainerror=>1);
    	}
    }
    #
    #  Add a logical (L3) dependency automagically when adding a L2 dependency.
    #
    #  If one of the interfaces just linked does not have an ip address, try 
    #  to add a dependency between the interface in that same device that has it
    # (assuming it's only one) and another interface in the other device that 
    #  follows the same rules

    my $newdep = InterfaceDep->retrieve($newdepid);
    my $l3dep = 0;
    if ( (my $childint  = Interface->retrieve($state{child})) 
	 && (my $parentint = Interface->retrieve($state{parent})) ) {

	if ( $childint->device->id != $parentint->device->id ){
	
	    my @childips     = $dm->getdevips($childint->device);
	    my @parentips    = $dm->getdevips($parentint->device);
	    my @childintips  = $childint->ips;
	    my @parentintips = $parentint->ips; 
	    my %tmp ;
	    if ( scalar(@childintips) == 1  ){
    		$tmp{child}  = $childintips[0]->interface;
	    }elsif ( ! @childintips && (scalar(@childips) == 1) ){
    		$tmp{child}  = $childips[0]->interface;
	    }
	    if ( scalar(@parentintips) == 1 ){
    		$tmp{parent} = $parentintips[0]->interface;
	    }elsif ( ! @parentintips && (scalar(@parentips) == 1) ){
    		$tmp{parent} = $parentips[0]->interface;
	    }
	    
	    if ( my $newl3dep = (InterfaceDep->search(\%tmp))[0] ){
    		if ( $newdep->id  == $newl3dep->id ){
    		    $l3dep = "same";
    		}else{
    		    $l3dep = "existed";	    
    		}
	    }else{
    		unless ( $ui->insert(table => "InterfaceDep", state => \%tmp) ){
    		    $m->comp("error.mhtml", error => $ui->error, showplainerror=>1);
        	}else{
    		    $l3dep = "added";
    		}
	    }
	}

    }
</%perl>

	Layer 2 dependency added.<br>
%   if ( $l3dep eq "added" ){
	Layer 3 dependency added.<br>
%   }elsif ( $l3dep eq "existed" ){
	Layer 3 dependency already existed.<br>       
%   }elsif ( $l3dep eq "same" ){
	Layer 2 dependency is also Layer 3<br>       
%   }elsif ( ! $l3dep ){
	Layer 3 dependency could not be determined.  Please add manually if necessary.<br>
%   }
    
    <p><a href="#" onClick="window.close()">[done]</a>

%}elsif ( $Cancel ){
    <br>
    Cancelled
    <br>
    <a href="#" onClick="window.close()">[done]</a><br>
%}else{

<script language="javascript" src="select.js"></script>

<form name="netdotform" action="addlink.html" method="POST">
<input type="hidden" name="<% $role %>" value="<% $int_id %>">

    <%perl>
    my (@field_headers, @cell_data) = ();
    
    push( @field_headers, $role_tags{$role}.": " );
    push( @cell_data, $intlbl );

    push( @field_headers, $role_tags{$rel_role}.": ");
    push( @cell_data, 
&{sub{
    my $ac = "Select Device from list:";
    $ac .= '<select name="device_search" onChange="sendquery('.$rel_role.', device_search.value, \'Interface\')">';
    foreach my $dev ( sort keys %subnet_devs ){
        $ac .= '<option value="'.$dev.'">'.$dev.'</option>';
    }
    $ac .= '</select>';
    $ac .= '<br>Or search:';
    $ac .= '<input type="text" name="search" value="Keywords" onFocus="if(this.value==\'Keywords\') { this.value = \'\'; } return true;">';
    $ac .= '&nbsp;<input type="button" name="" value="List" onClick="sendquery('.$rel_role.', search.value, \'Interface\')">';
    $ac .= '<br>';
    $ac .= '<select name="'.$rel_role.'">';
    $ac .= '</select>';

    $ac;
}}      );
    </%perl>

<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

      <input name="Add" value="Add" type="submit">
      <input name="Cancel" value="Cancel" type="submit">

</form>

% } # close else

    </div> <!-- close containerbody -->
</div> <!-- close container -->
 
</body>
</html>
