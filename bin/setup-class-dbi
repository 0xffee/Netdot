#!/usr/bin/perl
#
#
# generate Netdot::DBI from metadata 
#


use strict;
use DBUTIL;
use lib "../lib";
use Netdot::Meta;

use vars qw( $dbh $DEBUG $DB_TYPE $DB_HOST $DB_PORT 
	     $DB_DBA $DB_DATABASE $DB_DBA_PASSWORD $DB_NETDOT_USER $DB_NETDOT_PASS);

($DB_TYPE, $DB_HOST, $DB_PORT, $DB_DBA, $DB_DATABASE, $DB_DBA_PASSWORD, $DB_NETDOT_USER, $DB_NETDOT_PASS) = @ARGV;

my $IN        = "./DBI.header";
my $OUT       = "./DBI.pm";
my $META_DIR  = '../etc';
my $META_FILE = "$META_DIR/netdot.meta";

my $meta = Netdot::Meta->new(meta_file=>$META_FILE);

open (IN, "$IN") or die "Couldn't open $IN: $!\n";
open (OUT, ">$OUT") or die "Couldn't open $OUT: $!\n";
select (OUT);  # spit it all out to the output file by default

while (<IN>){
    s/^my \$data_source;/my \$data_source = "dbi:$DB_TYPE:$DB_DATABASE";/;
    s/^my \$user;/my \$user = "$DB_NETDOT_USER";/;
    s/^my \$password;/my \$password = "$DB_NETDOT_PASS";/;
    print $_;
}
close(IN);

my $table_defs = $meta->cdbi_defs();

print $table_defs;

print "\n#Be sure to return 1\n";
print "1;\n";

close (OUT);
