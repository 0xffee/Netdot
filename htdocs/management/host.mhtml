<%doc>

    
</%doc>

<%args>
$edit      => 0
$id        => undef
$arp_limit => 10
</%args>

<%init>
my $o;
my (@headers, @rows);
</%init>

<%perl>


unless (($id) && ($o = Ipblock->retrieve($id))) {
    $m->comp('/generic/error/mhtml', error => "Could not retrieve Ipblock id: $id");
}

print '<div class="container">';
print '<div class="containerheadleft">DNS A/AAAA Records</div>';
print '<div class="containerheadright">';
print '<a href="edit.html?table=RRADDR&ipblock='.$o.'">[add]</a>';
print '</div>';

my @rrs = $o->arecords;
$m->comp('/generic/sortresults.mhtml', object=>\@rrs);

print '</div>';

print '<div class="container">';
print '<div class="containerheadleft">DNS PTR Records</div>';
print '<div class="containerheadright">';
print '<a href="edit.html?table=RRPTR&ipblock='.$o.'">[add]</a>';
print '</div>';

my @ptrs = $o->ptr_records;
$m->comp('/generic/sortresults.mhtml', object=>\@ptrs);

print '</div>';

print '<div class="container">';
print '<div class="containerheadleft">Services</div>';
print '<div class="containerheadright">';
print '<a href="edit.html?table=IpService&ip='.$o.'">[add]</a>';
print '</div>';

@headers = ("Service", "Contact List");
@rows = ();
foreach my $ipservice ($o->services){
    push( @rows,
	  [ eval {
	      if ($edit){	 
		  $ui->form_field(object=>$ipservice, column=>"service", edit=>$edit, returnValOnly=>1);
	      }else{
		  qq(<a href="view.html?table=Service&id=).$ipservice->service->id.qq(">).$ipservice->service->name."</td></a>";
	      }
	    } ,
	    eval {
		if ($edit){
		    $ui->form_field(object=>$ipservice, column=>"contactlist", edit=>$edit, returnValOnly=>1);
		}elsif ($o->used_by){
		    qq(<a href="view.html?table=ContactList&id=).$ipservice->contactlist.qq(">).$ipservice->contactlist->name."</td></a>";
		}
	    }
	  ]  );
}
$m->comp('/generic/data_table.mhtml', field_headers=>\@headers, data=>\@rows ) if ( $o->services ); 

print '</div>';

#Display ARP
print '<!-- Display ARP -->';

# Get latest arp entries
if ( my $arp = $o->get_last_n_arp($arp_limit) ){
    my @rows;
    my %tstamps;
    foreach my $row ( @$arp ){
	my ($iid, $macid, $tstamp) = @$row;
	my $lbl    = Interface->retrieve($iid)->get_label;
	my $lnk   = "<a href=\"interface.html?id=$iid\">$lbl</a>";
	push @{$tstamps{$tstamp}{$macid}}, $lnk;
    }
    foreach my $tstamp ( reverse sort keys %tstamps ){
	foreach my $macid ( keys %{$tstamps{$tstamp}} ){
	    my $maclbl   = PhysAddr->retrieve($macid)->get_label;
		my $maclnk   = "<a href=\"../management/mac.html?id=$macid\">$maclbl</a>";
		push @rows, [$tstamp, $maclnk, (join ', ', @{$tstamps{$tstamp}{$macid}})];
	    }
	}
    
    print '<div class="container">';
    print '<div class="containerheadleft"><strong>Last '.$arp_limit.' ARP entries</strong></div>';
    print '<div class="containerheadright">';
    print '<form name="netdotform" action="ip.html" method="POST">';
    print '<input type="hidden" name="id" value="'.$id.'">';
    print 'Last <input type="text" size="3" name="arp_limit" value="'.$arp_limit.'"> ARP entries <input type="submit" name="submit" value="show">';
    print '</form>';
    print '</div>';
    print '<div class="containerbodyoutside">';
    $m->comp('/generic/data_table.mhtml', field_headers=>['Time Seen', 'MAC', 'Interfaces'], data=>\@rows, style=>['', '', 'width: 60%']);
    print '</div>';
    print '</div>';

}
print '<!-- End Display ARP -->';




</%perl>

