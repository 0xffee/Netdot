<%perl>
foreach	my $j (keys %ARGS){
	next if ($ARGS{$j} !~ /\w+/ || $j eq 'submit');
	$arg{$j} = $ARGS{$j};	
}	

unless ( $arg{table} && $arg{id} ){
   print "<strong>Missing required parameters 'table' and/or 'id'</strong>";
   exit;
}
$table = $arg{table};
$obj = $table->retrieve($arg{id});

unless ( $obj ){
   print "<strong>Nonexistent record: $arg{id}</strong>";
   exit;
}

# Get some Meta info
$mi = (Meta->search( name => $arg{table} ))[0];
undef( %linksto );
map { my($j, $k) = split( /:/, $_ ); $linksto{$j} = $k }
   split( /,/, $mi->linksto );
undef( %linksfrom );
map { my($i, $j, $k) = split( /:/, $_ ); $linksfrom{$i}{$j} = $k }
   split( /,/, $mi->linksfrom );
my $i = 1;
undef( %order );
if( defined( $mi->columnorder ) ) {
   map { $order{$_} = $i++; } split( /,/, $mi->columnorder );
} else {
   $order{"id"} = $i++;
   foreach ( sort { $a cmp $b } $mi->name->columns() ) {
      next if( $_ eq "id" );
      $order{$_} = $i++;
   }
}
</%perl>


<& header, title=>" $table Details" &>

<table align="center" border="0" width="95%">
<tr><td>
<p><br>
<table align="left" cellpadding="3" cellspacing="1" border="0">
<tr> 
   <form action="expview.html" method="POST">
   <input type="hidden" name="table" value="<% $table %>">
   <td bgcolor="FFFFFF" colspan="2">
%     my (@objl, $p);
%     my $numrec =  scalar(@objl = map { $_->id } $table->retrieve_all);
%     for (my $i=0; $i < $numrec; $i++) { if ($objl[$i] == $obj->id) { $p = $i; last; }  };
      [<a href="expview.html?table=<% $table %>&id=<% $objl[0] %>">|&lt;</a>]
      &nbsp;&nbsp;[<a href="expview.html?table=<% $table %>&id=<% (($objl[$p-1]) != 0) ? ($objl[$p-1]): $numrec %>">&lt;&lt;</a>]
      &nbsp;&nbsp; [<a href="expview.html?table=<% $table %>&id=<% $objl[($p+1)%($numrec)] %>">&gt;&gt;</a>] 
      &nbsp;&nbsp;[<a href="expview.html?table=<% $table %>&id=<% $objl[$numrec-1] %>">&gt;|</a>] 
      &nbsp;&nbsp; record <input type="text" size="3" name="id" value="<% $obj->id %>"> of <% $numrec %> 
   </td>
   </form>
</tr>
</table>

<p><br><br>
<table cellpadding="3" cellspacing="1" border="0" bgcolor="CCCCCC">
<tr bgcolor="#FFFFFF"> 
<td align="center"><strong><% $table %></strong></td>
<td align="right" colspan="2" >
      [<a href="update.html?table=<% $table %>&id=<% $obj %>">edit</a>]
&nbsp;[<a href="delete.html?table=<% $table %>&id=<% $obj %>">delete</a>]
</td>
</tr>

%   foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%      next if ($c eq 'id' || $c eq 'aliases');
       <tr> 
       <td align="right" bgcolor="#DDDDDD"><% $c %>:</td>
%      if (!exists($linksto{$c}) ){
	  <td><strong><% $obj->$c %></strong></td>
%      }else{
         <td>
%	    my $fkobj;
%	    unless( defined($obj->$c) && defined($fkobj = $linksto{$c}->retrieve($obj->$c->id) )){
%	       next;
%           }
            <& sortresults.html, table => $linksto{$c}, object => [$fkobj]  &>
	 </td>
%      }
     </tr>
%   }
</tr>
<tr> 
</tr>
</table>
<%perl>
# List all the has_many objects for this object
foreach my $i (keys %linksfrom){
  my ($j, $rtbl, @tmp, @robjs, @jobjs, $col);
  map { $j = $_ } keys %{ $linksfrom{$i} };
  my $meta = ( Meta->search(name => $j) )[0];
  unless ( scalar(@tmp = $obj->$i) ){
    push @links, qq (<a href="create.html?table=$j&$linksfrom{$i}{$j}=$obj">$i</a>);
    next;
  }
  # Do some magic if table is a join table
  if ( defined($meta) && ($meta->mainobject == 0) ){
     @jobjs = @tmp;  # these are the join table objects
     my $jclass = ref($jobjs[0]);  #name of the join table class
     # Pick the fk column of the other table
     map { $col = $_  if ($_ ne $linksfrom{$i}{$j} && $_ ne 'id'); } $jclass->columns();
     map { push @robjs, $_->$col } @jobjs;
     $rtbl = ref($robjs[0]); 
  } else{
     @robjs = @tmp;
     $rtbl = $j;
  }

</%perl>
           <p>
           <table cellpadding="0" border="0"  bgcolor="#CCCCCC">
	      <tr>
                <td align="left"><strong><% $i %></strong></td>
	           <td align="right">[<a href="create.html?table=<% $rtbl %>&<% $linksfrom{$i}{$j} %>=<% $obj %>">add</a>]</td>
	      <tr>
	        <td colspan="2">
	           <& sortresults.html, table => $rtbl, object => \@robjs, view => "expanded" &>
	        </td>
	      </tr>
	   </table>

%}
%printf ( "<p><br>Add %s to this $table", (join ', ', @links) ) if ( scalar(@links) );

</td></tr>
</table>


<p><br>
<& footer &>
<%init>
use lib "/home/netdot/public_html/lib";
use Netdot::DBI;

my( %arg, %linksto, %linksfrom, $obj, $table, $mi, %order, @links);
               
</%init>

<%doc>

######################################################################
#  $Log: view.html,v $
#  Revision 1.11  2003/05/30 00:18:06  netdot
#  Added browse buttons and many other things.
#  Changing name to view.html
#
#  Revision 1.10  2003/05/23 01:10:11  netdot
#  Took out the object id from the display
#  Added a cancel button in edit option.
#  Ignores 'aliases' fields at display time
#  Hides join tables when referring to has_many objects
#
#  Revision 1.9  2003/05/21 17:59:48  netdot
#  *** empty log message ***
#
#  Revision 1.8  2003/05/14 16:28:02  netdot
#  added id arg to call to form.html
#
#  Revision 1.7  2003/05/14 16:27:34  netdot
#  initial checkin
#

</%doc>
