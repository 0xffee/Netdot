<%perl>
my %args;
foreach my $j ( keys %ARGS ) {
  next if( $ARGS{$j} !~ /\w+/ );
  $args{$j} = $ARGS{$j};
}
#if( $args{node} && ! $args{sid} ) {
#  $session = $gui->mksession( $DIR );
#}
if( $args{sid} ) {
  $session = $gui->getsession( $DIR, $args{sid} );
}
if( $args{cancel} ) {
  $gui->rmsession( $session );
}
if( exists( $args{insert} ) ) {
  my %node = %{ $session->{node} };
  if( Node->search( name => "$args{node}" ) 
      || Node->search( physaddr => $node{dot1dBaseBridgeAddress} ) ) {
    ; # do nothing
  } else {
    my %tmp;
    my @ifrsv = NvIfReserved->retrieve_all();
    $tmp{name} = $args{node};
    $tmp{sysdescription} = $node{sysDescr};
    $tmp{physaddr} = $node{dot1dBaseBridgeAddress};
    $tmp{type} = "0";   # maybe tmp; can't be null
    $tmp{device} = "0"; # same
    my $newnode = Node->create( \%tmp );
    $inserted = $newnode->id;
    foreach my $int ( keys %{ $node{interface} } ) {
      my $skip = 0;
      foreach my $rsv ( @ifrsv ) {
        $skip = 1 if( $rsv =~ /$int/ );
      }
      next if( $skip );
      undef( %tmp );
      $tmp{node} = $newnode->id;
      $tmp{ifdescr} = $int;
      $tmp{physaddr} = $node{interface}{$int}{ifPhysAddress};
      $tmp{ifIndex} = $node{interface}{$int}{instance};
      $tmp{iftype} = $node{interface}{$int}{ifType};
      $tmp{ifalias} = $node{interface}{$int}{descr} 
        unless( $node{descr} eq "-" );
      $tmp{ifspeed} = $node{interface}{$int}{ifSpeed};
      $tmp{ifadminstatus} = $node{interface}{$int}{ifAdminStatus};
      $tmp{managed} = "0";
      my $if = Interface->create( \%tmp );
      if( exists( $node{interface}{$int}{ipAdEntIfIndex} ) ) {
         foreach my $ip ( keys %{ $node{interface}{$int}{ipAdEntIfIndex} } ) {
            undef( %tmp );
	    $tmp{interface} = $if->id;
            $tmp{address} = $ip;
            $tmp{mask} = $node{interface}{$int}{ipAdEntIfIndex}{$ip};
            $tmp{subnet} = 0;
            Ip->create( \%tmp );
         }
      }
    }
    $gui->rmsession( $session );
  }
}
</%perl>
% if( $inserted ) {
  <& view.html, table => "Node", id => $inserted &>
% } else {
<& header, title => "Node" &>
<!-- node.html -->
<br>
<blockquote>
<form action="node.html" method="POST">
<input type="text" name="node" size="30" value="<% $args{node} %>">
<input name="submit" value="Discover" type="submit">
</form>
</blockquote>
%   if( exists( $args{insert} ) ) {
<hr>
%     # check to see if node already exists in Node table
%     my %node = %{ $session->{node} };
%     if( Node->search( name => "$args{node}" )
%         || Node->search( physaddr => $node{dot1dBaseBridgeAddress} ) ) {
        <p>Node <% $args{node} %> already exists in Node table.
%     }
%   } elsif( exists( $args{node} ) ) {
<hr>
<p><% $args{node} %>
%     $nv->build_config( "device", $args{node} );
%     if( my( %node ) = $nv->get_device( "device", $args{node} ) ) {
%       if( keys %node ) {
%         $session = $gui->mksession( $DIR );
%         $session->{node} = \%node;
    <form>
    <input type="hidden" name="sid" value="<% $session->{_session_id} %>">
    <input type="hidden" name="node" value="<% $args{node} %>">
    <table cellpadding="3" cellspacing="1" border="0">
    <tr align="LEFT">
    <td bgcolor="#FFFFFF" align="CENTER" colspan="3">
    <input name="insert" value="Submit" type="submit">
    </td>
    <td>
    <input name="cancel" value="Cancel" type="submit">
    </td>
    </tr>
    </table>
    </form>
%         print "<code><pre>", $nv->string_config( "device", $args{node} ), "</pre></code>\n";
%       } else {
    <p>Failed to get config.
%       }
%     } else {
    <p>Failed to build config.
%     }
%   }
% }
<& footer &>
<%args>
$DIR => "/home/netdot/public_html/tmp"
$nv => Netdot::Netviewer->new()
$gui => Netdot::GUI->new()
$session => undef
$inserted => 0
</%args>

<%init>
use lib "/home/netdot/public_html/lib";
use Netdot::DBI;
use Netdot::Netviewer;
use Netdot::GUI;
use Data::Dumper;

</%init>
<%doc>

Node discovery & updates

######################################################################
#  $Log: node.html,v $
#  Revision 1.16  2003/07/10 00:09:14  netdot
#  fixed latest bug; still need to add subnet code
#
#  Revision 1.15  2003/07/09 21:56:04  netdot
#  *** empty log message ***
#
#  Revision 1.14  2003/07/09 21:24:09  netdot
#  *** empty log message ***
#
#  Revision 1.13  2003/07/08 22:44:01  netdot
#  added code to insert ip addresses
#
#  Revision 1.12  2003/07/03 23:24:04  netdot
#  *** empty log message ***
#
#  Revision 1.11  2003/07/03 23:12:04  netdot
#  more fixes:
#    * be sure to check Reserved IFs
#    * check whether base address is already
#
#  Revision 1.10  2003/07/03 21:31:33  netdot
#  fix so that call to view.html works
#
#  Revision 1.9  2003/07/03 21:18:16  netdot
#  state and insertion stuff works; still need to fix some stuff
#  (eg. when device does not respond)
#
#  Revision 1.8  2003/07/03 00:38:39  netdot
#  blah
#
#  Revision 1.7  2003/07/01 05:27:40  netdot
#  work to introduce state for final push
#
#  Revision 1.6  2003/06/17 23:23:58  netdot
#  *** empty log message ***
#
#  Revision 1.5  2003/06/17 00:03:11  netdot
#  bugger if i know
#
#  Revision 1.4  2003/06/12 23:50:06  netdot
#  more work -- probably moving to create.html
#
#  Revision 1.3  2003/06/12 00:52:58  netdot
#  *** empty log message ***
#
#  Revision 1.2  2003/06/11 22:43:55  netdot
#  working on integrating netviewer & netdot
#
#  Revision 1.1  2003/06/11 16:19:21  netdot
#  Initial revision
#

</%doc>
