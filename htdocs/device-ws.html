
<& index.html, title => "Device Worksheet: $name ", s2name => $s2name  &>

<script language="javascript" src="select.js"></script>

<%perl>

print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

if ( defined($search) && $search =~ /\w+/ ){

 my $query = "%" . $search . "%";
 print "Query is $query " if $DEBUG;
 my @rrs = RR->search_like(name => "$query");
 print "<br>Returned names are ", join " ", map {$_->name} @rrs if $DEBUG;
 my @list = map { Device->search(name => $_ ) } @rrs;
 print "<br>Returned Device ids are ", join " ", map {$_->name} @list if $DEBUG;
 
</%perl>     
  

%  if (my $num = scalar(@list)){
 <table width="95%" border="0" cellspacing="0" cellpadding="1" class="tablebackground"> 
 <tr><td>
   <p><br>
   Query <b><em><% $search %></em></b> returned: <b><% $num %> matches</b>
   <p>
   <table border="0" width="100%" cellspacing="0" cellpadding="1" class="tablebackground">
      <tr class="rowtitle0">
      <td>Name</td>
      <td>Type</td>
      <td>Product</td>
      </tr>
  
%    foreach my $dev (@list){
      <tr>
	 <td class="column2">
	    <b><a href="device-ws.html?id=<% $dev->id %>"><% $dev->name->name %></a></b>
	 </td>   
	 <td class="column2">
	    <b><% $dev->type->name %></b>
	 </td>   
	 <td class="column2">
	    <b><% $dev->productname->name %></b>
	 </td>   
      </tr>
      <tr height="1" class="delimiter">
        <td colspan="3" height="1"></td>
      </tr>
%    }   

   </table>
% }else{
     <p><b>No results</b>
%    $m->abort;
</td></tr></table>

% }
%} elsif ( defined($search) && $search !~ /\w+/ ){
     <p><b>No search criteria</b>   
%    $m->abort;

<%perl>
}elsif( $ARGS{intadd} ){

  # Add a group of interfaces

  if (defined ($ARGS{intaddnum}) &&  $ARGS{intaddnum} > 0){
     my %tmpint;
     $tmpint{device} = $id;
     $tmpint{managed} = 0;
     $tmpint{number} = 1000;
     my $i;
     for ($i = 0; $i < $ARGS{intaddnum}; $i++){
        $tmpint{number}++;
     	if (!($ui->insert(table => "Interface", state => \%tmpint)) ){
	   my $err = $ui->error;
	   die "Error: $err"; 
	}
     }
    
  }

}elsif( defined($ARGS{submit}) ){

  # Define control field names
  my %control = ( 
                 'id'     => '',
                 'submit' => '',
                 'edit'   => '',
		 'save'   => '',
		 'show'   => '',
  );
  
  print "ARGS is  <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

  # Ignore empty and control fields
  # for saving purposes
  # / _srch/ elements are added for javascript only
  # we don't need them here

  foreach my $j (keys %ARGS){
     next if ( exists ($control{$j}) );
     next if ($j =~ /_srch/ );
     next if ($j eq "s2name" );
     # "/^_/" is added to search field names 
     # to avoid using reserved words in javascript
     # chop it off
     my $k = $j;
     $k =~ s/^_//;
     $arg{$k} = $ARGS{$j};	   
  }
  print "arg is  <pre>", Dumper(%arg), "</pre><br>" if $DEBUG;
	 
  # Check that we have at least one parameter
  unless (scalar keys(%arg)){
    die "Error: Missing name/value pairs";
  }

  # Store objects, fields and values in a hash
  my %objs;
  foreach my $item (keys %arg){
     my ($table, $id, $field) = split /__/, $item;
     $objs{$table}{$id}{$field} = $arg{$item};
  }
  print "objs is <pre>", Dumper{%objs}, "</pre><br>" if $DEBUG;
  print "Content Length: $ENV{'CONTENT_LENGTH'}" if $DEBUG; 

  # Now do the actual updating
  # First check for "action" fieldnames
  # Actions (like delete) take precedence over value updates

  foreach my $table ( keys %objs ){
    foreach my $id ( keys %{ $objs{$table} } ){
      my $act = 0;
      foreach my $field ( keys %{ $objs{$table}{$id} } ){
	   if ( $field eq "delete" && $objs{$table}{$id}{$field} eq "on" ){
	      # Remove object from DB
	      if (! ($ui->remove(table => "$table", id => "$id")) ){
	          my $err = $ui->error;
		  die "Error: $err";
	      }
	      # Set the 'action' flag
	      $act = 1;
	      last;
	   }elsif($field eq "new"){
	      my %state;
	      # This is a little hack
	      if ($table eq "InterfaceDep" && $objs{$table}{$id}{$field} ne "0"){
	         $state{child} = $id;
		 $state{parent} = $objs{$table}{$id}{$field};
	      }
	      if ( scalar(keys %state) ){
	         if (!($ui->insert(table => $table, state => \%state)) ){
      	            my $err = $ui->error;
		    die "Error: $err"; 
	         }
	      }
	      $act = 1;
	      last;
	   }
      }
      # Now update the thing
      if (!$act){ #only if no other actions were performed
         my $o;
         if (! ($o = $table->retrieve($id)) ){
            die "Couldn't retrieve id $id from table $table";
         }
         if (! ($ui->update(object => $o, state => \%{ $objs{$table}{$id} } ))){
            my $err = $ui->error;
	    die "Error: $err";
         }
      }
    }
  }  
  # Do this to 'flush' the values associated with the object
  # before redisplaying
  $o = undef;
  if ($id){
     $o = Device->retrieve($id);
     $name = $o->name;
   }
}

</%perl>

%if (!defined($search)){
<!-- Header Table -->
<table border="0" width="95%" align="center" cellpadding="3" cellspacing="0" class="tablebackground">
 <tr class="rowtitle0" >
    <td align="left">
    Device: <b><% $o->name->name %></b>&nbsp;&nbsp; 
    <a href="device-ws.html?id=<% $id %>"> [refresh]</a>
    <a href="delete.html?table=Device&id=<% $id %>"> [delete]</a>
    </td>

 </tr>
</table>
<!-- Margins Table -->
<table border="0" width="95%" align="center"  class="tablebackground">
 <tr>
   <td valign="top" width="50%" align="center">

% if ( $edit ){	 
    <form name="netdotform" action="device-ws.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="s2name" value="<% $s2name %>">
% }
<!-- General Info Table -->
   <table border="0" width="100%" cellpadding="0" cellspacing="2" class="formtablebg">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">General</th>
%	 if ($edit eq "geninfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=geninfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
      <td valign="top" width="50%">
         <table border="0">
	    <tr>
	      <td class="formtablec1">Name: </td>
	      <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="RR__<% $o->name->id %>__name" value="<% $o->name->name %>">  
%	         }else{
		    <b><% $o->name->name %></b>
%		 }
	      </td>
	    </tr>
           <tr>
             <td class="formtablec1">Type: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <select name="Device__<% $id %>__type">
%		     my $lblfield = ( $ui->getlabels("DeviceType") )[0];	 
		     <option value="<% $o->type->id %>" SELECTED> <% $o->type->name %> </option>
%		     my @fo = DeviceType->retrieve_all();
%		     @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		     foreach my $fo (@fo){
%		        next if ($fo->id == $o->type->id);
  		        <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		     }
		     <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><% $o->type->name %> </b>
%		 }
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">S/N: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__serialnumber" value="<% $o->serialnumber %>">  
%	         }else{
		    <b><% $o->serialnumber %></b>
%		 }

	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">MAC: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__physaddr" value="<% $o->physaddr %>">  
%	         }else{
		    <b><% $o->physaddr->address %> </b>
%		 }

	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">Installed on <font size="-1">(yyyy-mm-dd)</font>:</td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__dateinstalled" value="<% $o->dateinstalled %>">  
%	         }else{
		    <b><% $o->dateinstalled %> </b>
%		 }	        
	     </td> 
	   </tr>
	 </table>
      </td>
      <td valign="top" width="50%">
         <table  border="0">
           <tr>
             <td class="formtablec1">Product: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <select name="Device__<% $id %>__productname">
%		       my $lblfield = ( $ui->getlabels("Product") )[0];	 
		       <option value="<% $o->productname->id %>" SELECTED> <% $o->productname->name %> </option>
%		       my @fo = Product->retrieve_all();
%		       @fo = sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->productname->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=Product&id=<% $o->productname->id %>"><% $o->productname->name %></a></b> 
%		 }
	        
	     </td>
	   </tr>
           <tr>
             <td class="formtablec1">Part of: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <select name="Device__<% $id %>__part_of">
%		       my $lblfield = ( $ui->getlabels("Device") )[0];	 
		       <option value="<% $o->part_of->id %>" SELECTED> <% $o->part_of->name %> </option>
%		       my @fo = Device->retrieve_all();
%		       @fo = sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->part_of->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><% $o->part_of->name %></b> 
%		 }

	     </td>
	   </tr>
           <tr>
             <td class="formtablec1">Inventory #: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <input type="text" name="Device__<% $id %>__inventorynumber" value="<% $o->inventorynumber %>">  
%	         }else{
		    <b><% $o->inventorynumber %></b>
%		 }
	     </td> 
	   </tr>
           <tr>
             <td class="formtablec1">System Descr: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "geninfo"){	 
		    <textarea name="Device__<% $id %>__sysdescription" rows="3" cols="30"><% $o->sysdescription %></textarea>
%	         }else{
	            <font size="-1"> <% $o->sysdescription %> </font>
%		 }

		</td> 
	   </tr>
	 </table>
      </td>
  </tr>
   <tr>
     <td colspan="2" align="center">Comments:</td>
   </tr>
   <tr>
     <td colspan="2" align="left">
%	      	 if ($edit eq "geninfo"){	 
		    <textarea name="Device__<% $id %>__info" rows="3" cols="80"><% $o->info %></textarea>
%	         }else{
	            <font size="-1"><pre><% $o->info %></pre></font>
%		 }
     </td>
   </tr>
 </table>
% if ($edit eq "geninfo"){	 
    </form>
% }
<!-- End General Info Table -->

<br>
<!-- IPs Table -->

  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">IPs</th>
%	 if ($edit eq "ipinfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=ipinfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0">
%	my @ips;
%	foreach my $if ($o->interfaces) {
%	  my @intips;
%	  next unless (scalar(@intips = $if->ips));
%	  map { push @ips, $_} @intips;
%	}
%	if (scalar @ips){
         <tr>
	   <td align="center"><a href="device-ws.html?id=<% $id %>&ipsort=ip">IP</a></td>
	   <td align="center"><a href="device-ws.html?id=<% $id %>&ipsort=subnet">Subnet</a></td>
	   <td align="center"><a href="device-ws.html?id=<% $id %>&ipsort=interface">Interface</a></td>
         </tr>
%	}
<%perl>	
       my @sortedips;
       if ($ipsort eq "ip" || !defined($ipsort) ){
          #
          # Sort by IP address
          #
          @sortedips = map { $_->[0] }
		sort {	$a->[1] cmp $b->[1]
		        ||
			$a->[2] <=> $b->[2] 
			||	
			$a->[3]	<=> $b->[3]
			||
			$a->[4] <=> $b->[4] }
		map { [ $_, (split /\./, $_->address ) ] } @ips;
	}elsif ($ipsort eq "subnet"){
          #
          # Sort by Subnet
          #
          @sortedips = map { $_->[0] }
		sort {	$a->[1] cmp $b->[1]
		        ||
			$a->[2] <=> $b->[2] 
			||	
			$a->[3]	<=> $b->[3]
			||
			$a->[4] <=> $b->[4] }
		map { [ $_, (split /\./, $_->subnet->address ) ] } @ips;
	}elsif ($ipsort eq "interface"){
          #
          # Sort by Interface
          #
          @sortedips = map { $_->[0] }
		sort {	$a->[1] cmp $b->[1] }
		map { [ $_, $_->interface->name ] } @ips;
	}		
</%perl>	
%	foreach my $ip (@sortedips){	   
%	 $ci = ($ci + 1) % 2;
	 <tr class="<% $cssitem{$ci} %>">
	   <td align="left">
%	      	 if ($edit eq "ipinfo"){	 
		    <input type="checkbox" name="<% "Ip__" . $ip->id . "__delete" %>" >[del]
		    <input type="text" size="15" name="<% "Ip__" . $ip->id . "__address" %>" value="<% $ip->address %>">
		    <br>
%	         }else{
		    <a href="view.html?table=Ip&id=<% $ip->id %>"><% $ip->address %></a><br>
%		 }
	   </td>
	   <td align="left">
%	      	 if ($edit eq "ipinfo"){	 
		    <select name="<% "Ip__" . $ip->id . "__subnet" %>">
%		       my $lblfield = ( $ui->getlabels("Subnet") )[0];	 
		       <option value="<% $ip->subnet->id %>" SELECTED> <% $ip->subnet->address %>/<% $ip->subnet->prefix %> </option>
%		       my @fo = Subnet->retrieve_all();
%		       @fo = sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $ip->subnet->id);
			  <option value="<% $fo->id %>"> <% $fo->address %>/<% $fo->prefix %> </option>
%		       }
		       <option value="0"> [null] </option>
		    </select>
		    <br>
%	         }elsif ( int($ip->subnet) ){
		    <a href="view.html?table=Subnet&id=<% $ip->subnet->id %>"><% $ip->subnet->address %>/<% $ip->subnet->prefix %></a><br>
%		 }
	   </td>
	   <td align="left"><font size="-1"><% $ip->interface->name %></font></td>
	  </tr>
%	}# foreach	
     </table>
    </td>
   </tr>
  </table>
% if ($edit eq "ipinfo"){	 
    </form>
% }

<!-- End IPs Table -->

</td>
<td valign="top" align="center">

<!-- Location Table -->

  <table border="0" width="100%"  class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle" >
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Group/Location</th>
%	 if ($edit eq "locinfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=locinfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0">
        <tr>
	   <td class="formtablec1">Entity: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "locinfo"){	 
		    <select name="Device__<% $id %>__entity">
%		       my $lblfield = ( $ui->getlabels("Entity") )[0];	 
		       <option value="<% $o->entity->id %>" SELECTED> <% $o->entity->name %> </option>
%		       my @fo = Entity->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->entity->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=Entity&id=<% $o->entity->id %>"><% $o->entity->name %></a></b> 
%		 }
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">Site: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "locinfo"){	 
		    <select name="Device__<% $id %>__site">
%		       my $lblfield = ( $ui->getlabels("Site") )[0];	 
		       <option value="<% $o->site->id %>" SELECTED> <% $o->site->name %> </option>
%		       my @fo = Site->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->site->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=Site&id=<% $o->site->id %>"><% $o->site->name %></a></b> 
%		 }
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">Room: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "locinfo"){	 
		    <input type="text" name="Device__<% $id %>__room" value="<% $o->room %>">  
%	         }else{
		    <b><% $o->room %></b>
%		 }
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">Rack: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "locinfo"){	 
		    <input type="text" name="Device__<% $id %>__rack" value="<% $o->rack %>">  
%	         }else{
		    <b><% $o->rack %></b>
%		 }
	     </td>
	</tr>
      </table>
     </td>
   </tr>
   </tr>
  </table>
% if ($edit eq "locinfo"){	 
    </form>
% }

<!-- End Location Table -->
<br>
<!-- Management Table -->

  <table border="0" width="100%" class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle">
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Management</th>
%	 if ($edit eq "mgmtinfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=mgmtinfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0">
        <tr>
	   <td class="formtablec1">Contact Group: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "mgmtinfo"){	 
		    <select name="Device__<% $id %>__contactlist">
%		       my $lblfield = ( $ui->getlabels("ContactList") )[0];	 
		       <option value="<% $o->contactlist->id %>" SELECTED> <% $o->contactlist->name %> </option>
%		       my @fo = ContactList->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->contactlist->id);
  		          <option value="<% $fo->id %>"> <% $fo->name %> </option>          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=ContactList&id=<% $o->contactlist->id %>"><% $o->contactlist->name %></a></b> 
%		 }
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">User: </td>
	     <td class="formtablec2"> 
%	         my $lbl = $ui->getobjlabel($o->person, ", ");
%	      	 if ($edit eq "mgmtinfo"){	 
		    <select name="Device__<% $id %>__person">
%		       my $lblfield = ( $ui->getlabels("Person") )[0];	 
		       <option value="<% $o->person->id %>" SELECTED> <% $lbl %> </option>
%		       my @fo = Person->retrieve_all();
%		       @fo= sort { $a->$lblfield cmp $b->$lblfield } @fo; 
%		       foreach my $fo ( @fo ){
%		          next if ($fo->id == $o->person->id);
%			  my $folbl = $ui->getobjlabel($fo, ", ");
  		          <option value="<% $fo->id %>"> <% $folbl %> </option>		          
%		       }
		       <option value="0"> [null] </option>
		    </select>
%	         }else{
		    <b><a href="view.html?table=Person&id=<% $o->person->id %>"><% $lbl %></a></b> 
%		 }
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">Out-of-band hostname: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "mgmtinfo"){	 
		    <input type="text" name="Device__<% $id %>__oobname" value="<% $o->oobname %>">  
%	         }else{
		    <b><% $o->oobname %></b>
%		 }
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">Out-of-band number: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "mgmtinfo"){	 
		    <input type="text" name="Device__<% $id %>__oobnumber" value="<% $o->oobnumber %>">  
%	         }else{
		    <b><% $o->oobnumber %></b>
%		 }
	     </td>
	</tr>
         <tr>
	   <td class="formtablec1">Managed?: </td>
	     <td class="formtablec2"> 
%		 my $value = $o->managed;	 
%	      	 if ($edit eq "mgmtinfo"){	 
%		    if ($value == 1){
		      <input type="radio" name="Device__<% $id %>__managed" value="1" checked> <b>yes</b>
		      <input type="radio" name="Device__<% $id %>__managed" value="0"> <b>no
%		    }elsif ($value eq ""){
  		       <input type="radio" name="Device__<% $id %>__managed" value="1"> <b>yes</b>
		       <input type="radio" name="Device__<% $id %>__managed" value="0"> <b>no</b>
		       <input type="radio" name="Device__<% $id %>__managed" value="" checked> <b>n/a</b>
%		    }elsif ($value == 0){
		       <input type="radio" name="Device__<% $id %>__managed" value="1"> <b>yes</b>
		       <input type="radio" name="Device__<% $id %>__managed" value="0" checked> <b>no</b>
%		    }
		 
%	         }else{
%		    if ($value == 1){
		       <b>yes</b>
%		    }elsif ($value eq ""){ 
		       <b>n/a</b>
%		    }elsif ($value == 0){
		       <b>no</b>
%		    }
%		}
	     </td>
	</tr>
        <tr>
	   <td class="formtablec1">SNMP Community: </td>
	     <td class="formtablec2"> 
%	      	 if ($edit eq "mgmtinfo"){	 
		    <input type="text" name="Device__<% $id %>__community" value="<% $o->community %>">  
%	         }else{
		    <b><% $o->community %></b>
%		 }
	     </td>
	</tr>
%	if ($edit eq "mgmtinfo"){	 

%	}else{
        <tr>
	   <td class="formtablec1"><b><a href="device.html?device=<% $name %>&action=update">[update]</a></b></td>
	     <td class="formtablec2">Fetch SNMP info from device and update database</td>
	</tr>
        <tr>
	   <td class="formtablec1">Connect via: </td>
	   <td colspan="2" class="formtablec2" ><a href="http://<% $name %>">[HTTP]</a> <a href="ssh://<% $user %>@<% $name %>">[SSH]</a> <a href="telnet://<% $name %>">[Telnet]</a></td>
	</tr>
%	} 
    </table>
     </td>
   </tr>

   </tr>
  </table>
% if ($edit eq "mgmtinfo"){	 
    </form>
% }

<!-- End Management Table -->

  </td>
 </tr>
 <tr>
  <td colspan="2">

<!-- Interface Table -->

  <table border="0" width="100%" align="left" class="formtablebg" cellpadding="0" cellspacing="2">
   <tr class="formtabletitle"> 
     <td colspan="2">
      <table width="100%" border="0">
       <tr>
         <td width="10%" align="left">&nbsp;</td>
         <th width="80%" align="center">Interfaces</th>
%	 if ($edit eq "intinfo"){	 
            <td width="10%" align="right"><input name="submit" value="save" type="submit"></td>
%	 }else{
            <td width="10%" align="right"><a href="device-ws.html?id=<% $id %>&edit=intinfo">[edit]</a></td>
%	 }
       </tr>
      </table>
     <td>
   </tr>
   <tr>
     <td>
      <table border="0" width="100%">
        <tr>
%	   if ($edit eq "intinfo"){	 
	      <td align="center">[del]</td>
%	   }
	   <td align="center">Number</td>
	   <td align="center">Name</td>
	   <td align="center">Room</td>
	   <td align="center">Jack</td>
	   <td align="center">Description</td>
	   <td align="center">Parents</td>
	   <td align="center">Managed?</td>
        </tr>

%	#####################################
%	# Sort numerically by port number
%	#
%	# Hub ports have dots, so add a fake '.0' after numbers with no dots, and then
%	# split in two and sort first part and then second part
%	# (i.e: 1.10 goes after 1.2)
%	my @tmp;
%	foreach my $if ($o->interfaces) {
%	   my $num = $if->number;
%	   if ($num !~ /\./ ){
%	      $num .= '.0';
%	   }
%	   push @tmp, [(split /\./, $num), $if];
%	}	
%	my @ordered_ifs = sort { $a->[0] <=> $b->[0] 
%	                                  ||
%			         $a->[1] <=> $b->[1] } @tmp;
			  
%         foreach my $if (map { $_->[2] } @ordered_ifs){
%	  $ci = ($ci + 1) % 2;
	  <tr class="<% $cssitem{$ci} %>">
%		 if ($edit eq "intinfo"){	 
		   <td align="left">
		    <input type="checkbox" name="<% "Interface__" . $if->id . "__delete" %>" >
		   </td>	   
%	         }
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="3" name="<% "Interface__" . $if->id . "__number" %>" value="<% $if->number %>">
%	         }else{
		    <a href="view.html?table=Interface&id=<% $if->id %>"><% $if->number %></a>
%		 }
	   </td>
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="15" name="<% "Interface__" . $if->id . "__name" %>" value="<% $if->name %>">
%	         }else{
		    <% $if->name %>
%		 }
	   </td>
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="6" name="<% "Interface__" . $if->id . "__room" %>" value="<% $if->jack->room %>">
%	         }elsif(defined($if->jack)){
		    <% $if->jack->room %>
%		 }else{
		   -
%		 }
	   </td>
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="9" name="<% "Interface__" . $if->id . "__jackid" %>" value="<% $if->jack->jackid %>">
%	         }elsif(defined($if->jack)){
		    <% $if->jack->jackid %>
%		 }else{
		    -
%		 }
	   </td>
	   <td align="left"> 
%	      	 if ($edit eq "intinfo"){	 
		    <input type="text" size="40" name="<% "Interface__" . $if->id . "__description" %>" value="<% $if->description %>">
%	         }else{
		    <% $if->description %>
%		 }
	   </td>
	   <td align="left">
%	   my @parents = $if->parents;
%	   if (scalar(@parents)){
%	     foreach my $par (@parents){	   
%		 my $lbl = $ui->getobjlabel($par->parent, ", ");
%	      	 if ($edit eq "intinfo"){	 
%		 # Check for amount of objects in table before retrieving all
%		    my $count = Interface->count_all;
%		    if ( $count <= $maxselect ){			      
%		       my @allifs = Interface->retrieve_all;
%		       @allifs = sort { $a->number <=> $b->number } @allifs; 
   		       <select name="<% "InterfaceDep__" . $par->id ."__parent" %>">
		         <option value="$par->parent->id" selected><% $lbl %> </option> 
%		          foreach my $if ( @allifs ) {
		            <option value="<% $if->id %>"><% $ui->getobjlabel($if, ", ") %></option>
%			  }
		         <option></option> 
		       </select>
%		    }else{  #too many instances.  Offer a keyword search
%		       my $srchf = '_' . $if->id . 'parent_srch';  #name of the form input tag
		       <input type="text" name="<% $srchf %>" value="Keywords">
		       &nbsp;<input type="button" name="" value="List" 
		       onClick="sendquery(<% '_InterfaceDep__' . $par->id . '__parent' %>, <% $srchf . '.value' %>, 'Interface')" >
		       <br><select name="<% '_InterfaceDep__' . $par->id . '__parent' %>">
		          <option value="<% $par->parent->id %>" selected><% $lbl %></option>
			  <option value="0">[null]</option>
		       </select>
		       <input type="checkbox" name=<% "InterfaceDep__" . $par->id . "__delete" %> >[del]
%		    }
%	         }else{
		    <% $lbl %><br>
%		 }
%	     } #foreach my $par
%	   }else{ # No parents exist
%	      if ($edit eq "intinfo"){	 
%	       if (scalar($if->ips)){ #only interfaces with ip addresses (might change later)
%	        my $srchf = '_' . $if->id . 'parent_srch';  #name of the form input tag
		<input type="text" name="<% $srchf %>" value="Keywords">
	        &nbsp;<input type="button" name="" value="List" 
	        onClick="sendquery(<% "_InterfaceDep__" . $if->id ."__new" %>, <% $srchf . '.value' %>, 'Interface')" >
	        <br><select name="<% "_InterfaceDep__" . $if->id ."__new" %>">
	 	  <option value="0">[null]</option>
	        </select>	      
%	       }
%	      }
%	   }

	   </td>
	   <td align="left"> 
%		 my $value = $if->managed;	 
%	      	 if ($edit eq "intinfo"){	 
%		    if ($value == 1){
		      <input type="radio" name="<% "Interface__" . $if->id ."__managed" %>" value="1" checked> Y
		      <input type="radio" name="<% "Interface__" . $if->id ."__managed" %>" value="0"> N
%		    }elsif ($value eq ""){
  		       <input type="radio" name="<% "Interface__" . $if->id ."__managed" %>" value="1"> Y
		       <input type="radio" name="<% "Interface__" . $if->id ."__managed" %>" value="0"> N
		       <input type="radio" name="<% "Interface__" . $if->id ."__managed" %>" value="" checked> n/a
%		    }elsif ($value == 0){
		       <input type="radio" name="<% "Interface__" . $if->id ."__managed" %>" value="1"> Y
		       <input type="radio" name="<% "Interface__" . $if->id ."__managed" %>" value="0" checked> N
%		    }
		 
%	         }else{
%		    if ($value == 1){
		       yes
%		    }elsif ($value eq ""){ 
		       n/a
%		    }elsif ($value == 0){
		       no
%		    }
%		}
	   </td>
	  </tr>
%       } #foreach
     <tr>
%    if ($edit eq "intinfo"){	 
            <td colspan="8" width="100%" align="right">
	       <input name="submit" value="save" type="submit">
	    </td>
	    </form>
%    }else{
	    <form action="device-ws.html" method="POST">
	      <td colspan="8" width="100%" align="left">
	        Manually 
	        <input type="hidden" name="id" value="<% $id %>">
	        <input type="submit" name="intadd" value="Add">
	        <input type="text" name="intaddnum" value="0" size="3"> interfaces
              </td>
	    </form>
%    }
     </tr>
     </table>
    </td>
       </tr>
  </table>
<!-- End Interface Table -->

 </td></tr>
</table>
<!-- End Margins Table -->
%} # if !defined search


<%args>
$id     => undef
$search => undef
$edit   => undef
$ipsort => undef
$s2name  => "Management"
$user => $ENV{REMOTE_USER}
</%args>

<%init>
my $DEBUG = 0;
my $ui = Netdot::UI->new();
my %cssitem = ( 0 => "formtablec1", 1 => "formtablec2" );
my $maxselect = 100;
my $o = undef;
my $ci = 0;
my %arg;
my $name;

if ($id){
   $o = Device->retrieve($id);
   $name = $o->name->name;
}else{
   $name = "Search"
}
</%init>

<%doc>
-- Device Worksheet --
Interface for viewing/updating a particular Device 
and all its relevant info in one page

</%doc>
