<%doc>

-- Device Worksheet --

Interface for viewing/updating a particular Device 
and all its relevant info in one page

</%doc>
%
<%attr>
title        => 'Device' 
section      => 'Management'
</%attr>
%
%
%#######################################################################
%#
%# Args section
%#
%#######################################################################
<%args>
$id         => undef
$search     => undef
$edit       => undef
$editgen    => undef
$editloc    => undef
$editmgmt   => undef
$editsnmp   => undef
$editips    => undef
$addips     => undef
$editints   => undef
$editdevbgp => undef
$editbgp    => undef
$ipsort     => "address"
$ifsort     => "number"
$peersort   => "ip"
$user       => undef
$showvlan   => "all"
$intadd     => undef
$intaddnum  => undef
$overwrite_if_descr => undef
$submit     => undef
$view       => "Basics"
$deviceadd  => undef
$newhost    => undef
$newip      => undef
</%args>
%
%
%
%#######################################################################
%#
%# INIT section
%#
%#######################################################################
%
<%init>
my $DEBUG      = 0;
my %cssitem    = ( 0 => "formtablec1", 1 => "formtablec2" );
my $maxselect  = 100;
my $o          = undef;
my $ci         = 0;
my $name;
my %ifvlans;
my %vlans;
my $list;
my $fqdn;
my $whois_url = Netdot->config->get('BGP_AS_WHOIS_URL');

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

if ( $submit eq "search" ){
    if ( $search =~ /\w+:\w+/){
	# Advanced search.  User is passing
	# key/value pairs
	my @pairs = split /,/, $search;
	my %parms;
	foreach ( @pairs ){
	    my ($key, $value) = split /:/, $_;
	    if ( $key eq "ProductType" ){
		# Special case
		@$list = Device->search_by_type($value);
		last;
	    }else{
		$parms{$key} = $value;
	    }
	}
	@$list = Device->search(\%parms) if ( ! $list );
	
    }elsif( $search ){
	# Default is to search device names

	# Get rid of spaces
	$search =~ s/\s+//;

	unless ( (@$list = Device->search_like(name=>$search)) ){
print <<EOF;
	    <div class="container">
		<div class="containerhead">
		  <strong>No results</strong>   
		</div>
		<div class="containerbody">
		  <p><strong><em>$search</em> not found</strong>   
		  <form action="device.html" method="POST">
		    <p>
		    <label for="search">Device Name:</label>
		    <input type="text" name="search" class="txt" value="$search"> 
		    <input name="submit" value="search" class="btn" type="submit">
		    </p>
		  </form>
		</div>
	     </div>

EOF
	    $m->abort;
	}
	my $num = scalar(@$list);
	if ( $num == 1 ){
	    # Don't offer list.  Just display device
	    $o      = $list->[0];
	    $id     = $o->id;
	    $search = undef;
	}
	
    }else{
print <<EOF;
    <div class="container">
	<div class="containerhead">
	  <strong>No results</strong>   
	</div>
	<div class="containerbody">
	  <p><strong>No search criteria</strong>   
	</div>
    </div>
EOF
	$m->abort;
    }
 
}elsif( $intadd ){
    $o = Device->retrieve($id);
    eval { $o->add_interfaces($intaddnum) };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>$e);	
    }
    
}elsif( defined $overwrite_if_descr ){
    $o = Device->retrieve($id);
    eval { $o->set_overwrite_if_descr($overwrite_if_descr); };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>$e);	
    }

}elsif( $deviceadd && $newhost && $newip ){
    if ( Device->search(name=>$newhost) ){
	# It's already there
	print "<p><b>Device $newhost already exists in DB</b>";   
	$m->abort;
    }else{
	# Minimal info to create device manually
	eval {
	    $o = Device->discover(name=>$newhost, 
				  info=> { interface => { '1' => {'name'   => "eth0",
								  'number' => 1,
								  'ips'    => {
								      $newip => { address => $newip } } } } } );
	    $o->update({snmp_managed=>0, canautoupdate=>0});
	};
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);	
	}
    }
}elsif( $submit ){
    # insert/update
    eval {
	my %ret = $ui->form_to_db(%ARGS);
	print 'form_to_db returned: <pre>', Dumper(%ret), '</pre><br>' if $DEBUG;    
    };
    if ( my $e = $@ ){
	$m->comp('/generic/error.mhtml', error=>$e);
    }

}

if ( $id ){
    unless ($o = Device->retrieve($id)){
	$m->comp('/generic/error.mhtml', error=>"Could not retrieve Device with id $id");
    }   
}elsif ( $o ){
    unless ( $id = $o->id ){
	$m->comp('/generic/error.mhtml', error=>"Object passed was not a valid Device object");
    }   
}
if ( $o && $o->name ){
    $name = ($o->name->name) ? $o->name->name : "Name N/A!";
    $fqdn = $name . "." . $o->name->zone->mname;

}elsif ( ! $search ){
    $m->comp('/generic/error.mhtml', error=>"Device undefined or no name set");
}

if ( $view eq "Interfaces" || $view eq "All" ){
    # Build a hash of Interface Vlans
    foreach my $if ( $o->interfaces ){
	if ( my @ifv = $if->vlans ){
	    foreach my $ifv ( @ifv ){
		my $vid = $ifv->vlan->vid;
		$ifvlans{$if}{$vid} = "";
		$vlans{$vid} = $ifv->vlan->id;
	    }
	}
    }
}

my $refresh_url = "device.html?id=$id&view=$view";

</%init>

<div id="sectiondetail">

%#######################################################################
%#
%# Search results section
%#
%#######################################################################

% if ( $search ){
<div class="container">
  <div class="containerheadleft">
    <% scalar(@$list) %> results for <i><% $search %></i>
%# The non breaking space is a hack to make the table header full width
  </div><div class="containerheadright">&nbsp;</div>
  <div class="containerbody">
      <& /generic/sortresults.mhtml, object => $list, page => "device.html", withedit => 1 &>
  </div>
</div>

%#######################################################################
%#
%# Device view section
%#
%#######################################################################
% }else{  # we're not searching

<!-- Header Table -->
<div class="containeroutside">
  <div class="containerheadleftoutside">
  Device: <b><% $fqdn %></b>&nbsp;
 <a href="http://<% $fqdn %>" target="#">[HTTP]</a> <a href="ssh://<% $user->getUsername() %>@<% $fqdn %>">[SSH]</a> <a href="telnet://<% $fqdn %>">[Telnet]</a>
  </div><!-- close containerheadleftoutside -->

 <div class="containerheadrightoutside">
    <a href="<% $refresh_url %>">[refresh]</a>
%    if ( $o->snmp_managed ){
	<a href="updatedevice.html?device=<% $id %>&action=discover">[snmp-update]</a>
%    }
    <a href="delete.html?table=Device&id=<% $id %>"> [delete]</a>
 </div> <!-- close containerheadrightoutside -->

%#######################################################################
%#
%# Navigation Bar
%#
%#######################################################################

<div id="navbar">
    <ul id="navigation">
%     if( $view eq "Basics" ) {
        <li><span>Basics</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=Basics">Basics</a></li>
%     }
%     if( $view eq "Interfaces" ) {
        <li><span>Interfaces</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=Interfaces">Interfaces</a></li>
%     }
%     if( $view eq "IP" ) {
        <li><span>IP info</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=IP">IP info</a></li>
%     }
%     if ( $o->bgppeers ){
%       if( $view eq "BGP" ) {
          <li><span>BGP Peers</span></li>
%       } else {
          <li><a href="device.html?id=<% $id %>&view=BGP">BGP Peers</a></li>
%       }
%     }
%     if( $view eq "Topology" ) {
        <li><span>Topology</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=Topology">Topology</a></li>
%     }
%     if( $view eq "History" ) {
        <li><span>History</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=History">History</a></li>
%     }
%     if( $view eq "All" ) {
        <li><span>All</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=All">All</a></li>
%     }
    </ul>
</div>

 <div class="containerbodyoutside">


%#######################################################################
%#
%# Basics
%#
%#######################################################################

% if ( $view eq "Basics" || $view eq "All" ){
<!-- Two-column Division Table -->
<table border="0" width="100%" align="center">
  <tr>
    <td valign="top" width="50%" align="center">

% if ($editgen || $editloc || $editmgmt || $editsnmp) {
        <form name="netdotform" action="device.html" method="POST">
	    <input type="hidden" name="id" value="<% $id %>">
	    <input type="hidden" name="view" value="<% $view %>">
% }
    <div class="container">
	<!-- General Info Table -->
    	<div class="containerheadleft"><b>General</b></div>
    	<div class="containerheadright">
% if ($editgen) {
	    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
	    <input type="submit" name="submit" value="save" >
% }else{
            <a href="device.html?id=<% $id %>&view=<% $view %>&editgen=1">[edit]</a>
% }
        </div>
        <div class="containerbody">
<%perl>
my (@field_headers, @cell_data);

$ui->add_to_fields(o=>$o, edit=>$editgen, fields=>['name'], field_headers=>\@field_headers, 
		   cell_data=>\@cell_data, linkpages=>['view.html']);

# The type field is special because it does not belong to the Device table, but to the
# Product table
push( @field_headers, $ui->col_descr_link('Product', 'type', 'Type:') );
push( @cell_data, 
      &{sub{	
	  if (($o->product) && ($o->product->type)){	 
      '<a href="view.html?table=Product&id='.$o->product->id.'">'.$o->product->type->name."</a>";
	  }
      }}
);

my @fields = ('serialnumber','physaddr','date_installed','last_updated', 'product','inventorynumber','sysdescription', 'os', 'layers');
my @linkpages = ('', 'view.html', '', '', 'view.html', '', '' );
$ui->add_to_fields(o=>$o, edit=>$editgen, fields=>\@fields, field_headers=>\@field_headers, 
		   cell_data=>\@cell_data, linkpages=>\@linkpages);
</%perl>

<& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data, 
                          width=>"2", headercolwidth=>"15%", datacolwidth=>"35%" &>

<%perl>
my %tmp;
%tmp = $ui->form_field(object=>$o, column=>"info", edit=>$editgen, htmlExtra=>'cols="60"');
print '<div class="containerseparator">'.$tmp{label}.'</div>';
print $tmp{value};         
</%perl>

%#    </div>
      </div> <!-- containerbody -->
   </div> <!-- container -->
<!-- End General Info Table -->

<!-- Location Table -->
<div class="container">
    <div class="containerheadleft">
        Location/Contacts
    </div>
    <div class="containerheadright">
%	if ($editloc){	 
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
        <input type="submit" name="submit" value="save">
%	}else{
        <a href="device.html?id=<% $id %>&view=<% $view %>&editloc=1">[edit]</a>
%	}
    </div>
    <div class="containerbody">
<%perl>
(@field_headers, @cell_data) = ();

{
    my @fields;
    @linkpages = ("view.html","view.html","view.html");
    
    push( @fields, 'owner' );
    push( @fields, 'used_by' );
    if ( (int($o->person) != 0) || $editloc ){
	push( @fields, 'person' );
	push( @linkpages, 'view.html' );
    }
    push( @fields, 'site' );
    
    $ui->add_to_fields(o=>$o, edit=>$editloc, fields=>\@fields, field_headers=>\@field_headers, 
		       cell_data=>\@cell_data, linkpages=>\@linkpages);
}


push( @field_headers, $ui->col_descr_link('Device', 'room', 'Room:')  );
push( @cell_data, &{sub{ 
    my $s = "";
    if ($editloc) {
	$s .= '<select name="Device__'.$id.'__room" id="Device__'.$id.'__room" onChange="setNull(document.netdotform.Device__'.$id.'__closet);">';
	$s .= '<option value="0">-- Select --</option>';
	if (defined($o)) {
	    foreach my $floor ( $o->site->floors ) {
		foreach my $room ( sort { $a->name cmp $b->name } $floor->rooms ) {
		    $s .= sprintf("<option value=\"%d\" %s>%s</option>\n", 
				  $room->id, ($o->room && $room->id == $o->room->id ? "SELECTED" : ""), $room->name);
		}
	    }
	}
	$s .= '</select>';
    } else {
	if (defined($o->room)) {
	    $s .= $o->room->name; 
	}else{
	    $s .= "&nbsp;";
	}
    }
}} );
my $closetlink = $ui->col_descr_link('Device', 'closet', 'Closet:');  
push( @field_headers, " or $closetlink",  );
push( @cell_data, &{sub{
    my $closet_js = sprintf("onChange=\"setNull(document.netdotform.Device__%d__room);\"", $id);
    $ui->select_lookup(object=>$o, column=>"closet", lookup=>"Closet", 
		       edit=>$editloc, where=>{site=>($o ? $o->site : "")}, 
		       makeLink=>1, linkPage=>"cable_plant/closet.html", htmlExtra=>$closet_js, returnAsVar=>1)
    }} );

{
my @fields = ('rack');
$ui->add_to_fields(o=>$o, edit=>$editloc, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);
}

my @devcontacts = $o->contacts;
push( @field_headers, $ui->table_descr_link('DeviceContacts', 'Contacts:') );
push( @cell_data, $ui->select_multiple(object=>$o, joins=>\@devcontacts, join_table=>"DeviceContacts", 
				       this_field=>"device", other_table=>"ContactList", 
				       other_field=>"contactlist", isEditing=>$editloc, action=>"delete", 
				       makeLink=>1, returnAsVar=>1 ) );
      
</%perl>

    <& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

    </div>
</div>
<!-- End Location Table -->


  </td>
  <td valign="top"  width="50%" align="center">



<!-- Management Table -->
<div class="container">
    <div class="containerheadleft">
        Management
    </div>
    <div class="containerheadright">
%	 if ($editmgmt){	 
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
        <input type="submit" name="submit" value="save">
%	 }else{
        <a href="device.html?id=<% $id %>&view=<% $view %>&editmgmt=1">[edit]</a>
%	 }
    </div>
    <div class="containerbody">

<%perl>
(@field_headers, @cell_data) = ();

{
my @fields = ('oobname','oobnumber','monitored','customer_managed', 'monitor_config');
$ui->add_to_fields(o=>$o, edit=>$editmgmt, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);
}

</%perl>

       <& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

    </div>
</div>
<!-- End Management Table -->

<!-- SNMP Table -->
<div class="container">
    <div class="containerheadleft">
        SNMP
    </div>
    <div class="containerheadright">
%	 if ($editsnmp){	 
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
        <input type="submit" name="submit" value="save">
%	 }else{
        <a href="device.html?id=<% $id %>&view=<% $view %>&editsnmp=1">[edit]</a>
%	 }
    </div>
    <div class="containerbody">
<%perl>

(@field_headers, @cell_data) = ();
{
    my @fields = ('snmp_managed');
    $ui->add_to_fields(o=>$o, edit=>$editsnmp, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);
    @fields = ();

    if ( $o->snmp_managed ){
	push @fields, ('snmp_version', 'community', 'snmp_bulk', 'canautoupdate', 'snmp_polling',
		       'collect_arp', 'collect_fwt');
	$ui->add_to_fields(o=>$o, edit=>$editsnmp, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);

	@fields = ('last_arp', 'last_fwt');
	$ui->add_to_fields(o=>$o, edit=>0, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);
    }
    if ( $o->snmp_version eq "3" ){
	push @fields, ('snmp_authkey', 'snmp_authprotocol', 'snmp_privkey', 'snmp_privprotocol', 'snmp_securitylevel', 
		       'snmp_securityname' );
	$ui->add_to_fields(o=>$o, edit=>$editsnmp, fields=>\@fields, field_headers=>\@field_headers, cell_data=>\@cell_data);    
    }

    # Add the snmp_target IP.  We want to show only the device IPs when editing
    # Do not retrieve all the IPs unless we are indeed editing
    if ( $o->snmp_managed ){
	my %tmp;
	if ( $editsnmp ){
	    my $ips = $o->get_ips();
	    %tmp = $ui->form_field(object=>$o, column=>"snmp_target", defaults=>$ips, edit=>$editsnmp);
	}else{
	    %tmp = $ui->form_field(object=>$o, column=>"snmp_target", edit=>$editsnmp);	    
	}
	push( @field_headers, $tmp{label} );
	push( @cell_data, $tmp{value} );
    }
    

}
</%perl>

       <& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

    </div>
</div>
<!-- End SNMP Table -->


  </td>
 </tr>
</table>
<!-- End Division Table -->

%   if ( $editgen || $editloc || $editmgmt || $editsnmp ) {
      </form>
%   }


% } 
<!-- End Basics Section -->


%#######################################################################
%#
%# Interfaces section
%#
%#######################################################################
% my (@headers, @rows, @row);

%if ( $view eq "Interfaces" || $view eq "All" ){

<script language="javascript">
<!--
/* 
 * Show only interfaces belonging to selected VLAN
 * 
*/
function showVlan(){
    var name = document.showvlans.showvlan.value;
    window.location = "device.html?id=<% $id %>&view=<% $view %>&showvlan="+name;
}

var closetList = new DynamicList("netdotform", "Device__<% $id %>__closet", "site", "Closet", "Device__<% $id %>__site");
var roomList = new DynamicList("netdotform", "Device__<% $id %>__room", "floor", "Room", "Device__<% $id %>__site");
roomList.setQueryURL("room_site_query.html");
LIST_MANAGER.addList(closetList, roomList);

// Chooses the 0 valued option in a select box.  Used to enforce the
// mutual exclusivity of the room and closet options in the
// group/location form below.
function setNull(select){
    for (var i = 0; i < select.options.length || alert("No null in list.  This means nathan screwed up dynamic_list.js"); ++i){
	if (select.options[i].value == 0) {
	    select.options[i].selected = true;
	    break;
	}
    }
}

-->
</script>

<%perl>
   my $ifs = $o->interfaces_by($ifsort); 
    #
    # Store values in a hash first.  Thay way we can quicly verify if 
    # at least one of the interfaces has that field set to some value 
    # and decide whether to add that column or not
    # 
    my %intinfo;
    foreach ( @$ifs ){ 
	foreach my $field ( qw /jack room_char jack_char description neighbor/ ){
	    $intinfo{$field}{$_->id} = $_->$field if ( defined $_->$field && int($_->$field) != 0 );
	}
    } 

    ### Headers
    my @closet_jacks;
    (@headers, @rows) = ();
    
    if ( $editints ){
      push @headers, '[del]';
    }
    
    push @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=number">Number</a>';
    push @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=name">Name</a>';
    
    if ( ! $editints ){
      push @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=speed">Speed</a>';
      push @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=vlan">VLAN</a>';
    }
    push @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=monitored">Mon?</a>';
    push @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=snmp">SNMP?</a>';
    
    if ( exists $intinfo{jack} || $editints ){
      push @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=jack">Jack(cable)</a>';
      @closet_jacks = $o->closet->horizontalcables if ( int($o->closet) != 0 );
    }
    if ( exists $intinfo{room_char} || $editints ){
      push @headers, 'Room';
    }
    if ( exists $intinfo{jack_char} || $editints ){
      push @headers, 'Jack';
    }
    if ( exists $intinfo{description} || $editints ){
      push @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=descr">Descr.</a>';
    }
    if ( exists $intinfo{neighbor} || $editints ){
	push @headers, 'Neighbor';
    }
    ### Actual data
    foreach my $if ( @$ifs ){
      next if ( !exists $ifvlans{$if}{$showvlan} && $showvlan ne "all" );
      
      my (@row) = ();	
      
      if ( $editints ){	 
	    push @row, '<input type="checkbox" name="' . "Interface__" . $if->id . "__delete" . '" >';
      }
      
      push @row, $ui->form_field(object=>$if, column=>"number", edit=>$editints, htmlExtra=>"style=\"width: 2em;\"", 
				  linkPage=>"view.html", returnValOnly=>1);
      push @row, $ui->form_field(object=>$if, column=>"name", edit=>$editints, htmlExtra=>"style=\"width: 7em;\"", 
				  linkPage=>"view.html", returnValOnly=>1);
      
      if ( !$editints ){
        push @row, $if->speed_pretty;
        push @row, 
  	       &{sub{
		  my $ac = "";
		  if ( exists $ifvlans{$if} ){
		    my @links;
		    foreach my $v ( keys %{$ifvlans{$if}} ){
		      push @links, sprintf("<a href=\"view.html?table=Vlan&id=%s\">%s</a>", $vlans{$v}, $v );
		    }
		    $ac .= join ', ', @links;	# CHECK THIS (was in a print).
		  }
		  $ac;
		}};
     }
      
     push @row, $ui->form_field(object=>$if, column=>"monitored", edit=>$editints, returnValOnly=>1);
     push @row, $ui->form_field(object=>$if, column=>"snmp_managed", edit=>$editints, returnValOnly=>1);
      
      if ( exists $intinfo{jack} || $editints ){
	  if ( @closet_jacks ){
	      push @row, $ui->form_field(object=>$if, table=>"Interface", column=>"jack", defaults=>\@closet_jacks, 
					  linkPage=>"view.html", edit=>$editints, returnValOnly=>1);
	  }else{
	      push @row, $ui->form_field(object=>$if, table=>"Interface", column=>"jack", linkPage=>"cable_horizontal.html", 
					  edit=>$editints, returnValOnly=>1);
	  }
      }
      if ( exists $intinfo{room_char} || $editints ){
          push @row, $ui->form_field(object=>$if, column=>"room_char", edit=>$editints, htmlExtra =>"style=\"width: 4em;\"", 
				      returnValOnly=>1);
      }
      if ( exists $intinfo{jack_char} || $editints ){
          push @row, $ui->form_field(object=>$if, column=>"jack_char", edit=>$editints, htmlExtra =>"style=\"width: 7em;\"", 
				      returnValOnly=>1);
      }
      if ( exists $intinfo{description} || $editints ){
          push @row, $ui->form_field(object=>$if, column=>"description", edit=>$editints, returnValOnly=>1);
      }
      
      if ( exists $intinfo{neighbor}{$if->id} ){
	  push @row, $ui->form_field(object=>$if, column=>"neighbor", edit=>$editints, returnValOnly=>1);
      }

      push @rows, \@row;
      
    } #foreach
    
</%perl>

<!-- Interface Table -->
<div class="container">
    <div class="containerheadleft">
        Interfaces
    </div>
    <div class="containerheadright">

%   if ( $editints ){	 
    <form name="netdotform" action="device.html" method="POST">
	<input type="hidden" name="id" value="<% $id %>">
	<input type="hidden" name="view" value="<% $view %>">
	<input type="hidden" name="ifsort" value="<% $ifsort %>">
	<input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
	<input type="submit" name="submit" value="save">
%   }else{

        <form name="showvlans">
	VLAN view: <select name="showvlan" onChange="showVlan();">
%       if ( $showvlan eq 'all' ){
            <option value="all" SELECTED>all</option>
%       }else{
            <option value="all">all</option>
%       }
%       foreach my $vid ( sort { $a <=> $b } keys %vlans ){
%           if ( $showvlan eq $vid ){
                <option value="<% $vid %>" SELECTED><% $vid %></option>     
%           }else{
                <option value="<% $vid %>"><% $vid %></option>     
%           }
%       }
        </select>
        </form> 
        <a href="device.html?id=<% $id %>&view=<% $view %>&ifsort=<% $ifsort %>&editints=1">[edit]</a>
%  }

    </div>
    <div class="containerbody">
        <& /generic/data_table.mhtml, field_headers=>\@headers, data=>\@rows &>
    </div>
    <div class="containerheadright">
%	  if ( $editints ){	 
            <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
            <input type="submit" name="submit" value="save">
%	  }
    </div>
</div>

% if ( ! $editints && ($view eq "Interfaces" || $view eq "All") ){
<div class="container">
    <div class="containerheadleft">
        Options
    </div>
    <div class="containerheadright">&nbsp;</div>
    <div class="containerbody">
    <p>
    <form name="add_ints_form" action="device.html" method="POST">
      <input type="hidden" name="id" value="<% $id %>">
      <input type="hidden" name="view" value="<% $view %>">
      Manually 
      <input type="submit" name="intadd" value="Add">
      <input type="text" name="intaddnum" value="0" size="3"> interfaces
    </form>
    </p>
    <p>
    <form name="overwrite_form" action="device.html" method="POST">
      <input type="hidden" name="id" value="<% $id %>">
      <input type="hidden" name="view" value="<% $view %>">
      SNMP Updates Overwrite Descriptions:
      <select name="overwrite_if_descr">
          <option value="" selected>--Select--</option>
          <option value="0">No</option>
          <option value="1">Yes</option>
      </select>
      <input type="submit" name="Set" value="Set">
    </form>
    </p>
    </div>
% }
</div>

%   if ($editints){
       </form>
%   }
% } # if view eq "Interfaces"

<!-- End Interfaces Section -->



%#######################################################################
%#
%# IP info
%#
%#######################################################################

% if ( $view eq "IP" || $view eq "All" ){

%  # Get all ip address info
%  my $ips;
%  if ( $o && $ipsort ){
%    $ips = $o->get_ips(sort_by=>$ipsort);
%  }

<!-- IPs Table -->

<div class="container">
    <div class="containerheadleft">
        IPs
    </div>
    <div class="containerheadright">
%   if ( $editips || $addips ) {
      <form name="netdotform" action="device.html" method="POST">
	  <input type="hidden" name="id" value="<% $id %>">
	  <input type="hidden" name="view" value="<% $view %>">
	  <input type="hidden" name="ipsort" value="<% $ipsort %>">
	  <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
          <input type="submit" name="submit" value="save">
%   }
%   if ( !$editips && !$addips ){
          <a href="device.html?id=<% $id %>&view=<% $view %>&ipsort=<% $ipsort %>&editips=1">[edit]</a>
          <a href="device.html?id=<% $id %>&view=<% $view %>&ipsort=<% $ipsort %>&addips=1">[add]</a>
%   }
    </div>
    <div class="containerbody">

%    if (scalar @$ips){

<%perl>
    (@headers, @rows, @row) = ();

    @headers = ('<a href="device.html?id='. $id .'&view='. $view .'&ipsort=address">Address</a>',
		'Subnet',
		'<a href="device.html?id='. $id .'&view='. $view .'&ipsort=interface">Interface</a>',
		'DNS Name(s)',
		'Services',
		);

    foreach my $ip ( @$ips ){	   
	next if ( ! exists $ifvlans{$ip->interface}{$showvlan} && 
		  $showvlan ne "all" );
	my (@row) = ();
	push( @row, 
	      &{sub{
		  my $a = "";
		  if ($editips){  
		      $a .= '<input type="checkbox" name="' . "Ipblock__" . $ip->id . "__delete" . '" >[del] ';
		      $a .=  $ip->address ;
		      $a .= '<br>';
		  }else{
		      $a .= '<a href="ip.html?id=' . $ip->id . '">' . $ip->address . '</a><br>';
		  }
		  $a;
	      }} );
	push( @row, 
	      &{sub{
		  my $a = "";
		  if ( int($ip->parent) != 0  ){
		      if ($editips){  
			  $a .=  $ip->parent->address . '/' . $ip->parent->prefix ;
		      }else{
			  $a .= '<a href="ip.html?id=' . $ip->parent->id . '">' . $ip->parent->address . '/' . 
			      $ip->parent->prefix . '</a><br>';
		      }
		  }
		  $a;
	      }} );
	push( @row,
	      &{sub{
		  my @ints = $o->interfaces;
		  $ui->select_lookup(object=>$ip, table=>"Ipblock", column=>'interface', lookup=>"Interface",
				     defaults=>\@ints, edit=>$editips, returnAsVar=>1, linkPage=>1);
	      }} );
	push( @row, 
	      &{sub{
		  my $a = "";
		  if ( $ip->arecords ){
		      foreach my $ar ( $ip->arecords ){
			  # Don't let user delete the RR that the Device name points to
			  # otherwise a referential integrity error would happen
			  if ( $editips && ($ar->rr->id != $o->name->id) ){
			      $a .= '<input type="checkbox" name="' . "RR__" . $ar->rr->id . "__delete" . '" >[del] ';
			  }
			  $a .=  $ui->form_field(object=>$ar->rr, column=>"name", edit=>0, 
						 linkPage=>"view.html", returnValOnly=>1);
		      }
		  }
		  $a;
	      }} );
	push( @row, 
	      &{sub{
		  my $a = "";
		  if ( scalar ($ip->services) ){
		      foreach my $ipsrv ($ip->services){
			  if ( $editips ){
			      $a .= '<input type="checkbox" name="' . "IpService__" . $ipsrv->id . "__delete" . '" > [del] ';
			  }
			  $a .= '<a href="view.html?table=IpService&id=' . $ipsrv->id . '">' . $ipsrv->service->name . '</a>';
			  $a .= '<br>';
		      }
		  }
		  if ( !$editips ){
                      $a .= "<a class=\"hand\" onClick=\"window.open('addservice.html?ip=$ip&url=$refresh_url', 'Create IP service', 'width=400,height=200')\">[add]</a>";
		  }
		  $a;
	      }} );
	push( @rows, \@row );
	
    }# foreach
	
	$m->comp('/generic/data_table.mhtml', field_headers=>\@headers, data=>\@rows );

} # endif scalar @ips

if ( !$editips ){
    (@headers, @rows) = ();
    
    if ( $addips ){
	# Let user add a new IP           
	@headers = ( 'Interface', 'Address' );
	(@row) = ();
	push( @row, 
	      &{sub{
		  my $ac = "";
		  $ac .= '<select name="' . "Ipblock__" . "NEW" . "__interface" . '" >';
		  $ac .= '<option value="0">Select Interface</option>';
		  foreach my $int ( sort { $a->number <=> $b->number } $o->interfaces ){
		      $ac .= '<option value="' . $int->id . '">' . $int->name . '</option>';
		  }
		  $ac .= '</select>';
		  $ac;
	      }} );
	push( @row, 
	      &{sub{
		  my $ac = "";
		  $ac .= '<input type="text" name="' . "Ipblock__" . "NEW" . "__address" . '" >';
		  $ac .= '<input type="hidden" name="' . "Ipblock__" . "NEW" . "__statusname" . '" value="Static">';
		  $ac;
	      }} );
	push( @rows, \@row );
	
    }
    
    $m->comp('/generic/data_table.mhtml', field_headers=>\@headers, data=>\@rows );
    
}
</%perl>

%   if ( $editips || $addips ) {
       </form>
%   }

% }

    </div>
</div>
<!-- End IPs Section -->


%#######################################################################
%#
%# BGP Peers
%#
%#######################################################################

% if ( $view eq "BGP" || $view eq "All"){

% my (@field_headers, @cell_data);
% push( @field_headers, "BGP ID: " );
% push( @cell_data, $ui->form_field(object=>$o, column=>"bgpid", edit=>$editdevbgp, returnValOnly=>1) );
% push( @field_headers, "BGP Local AS: " );
% push( @cell_data, $ui->form_field(object=>$o, column=>"bgplocalas", edit=>$editdevbgp, returnValOnly=>1) );

<!-- Two-column Division Table -->
<table border="0" width="100%" align="center">
  <tr>
    <td valign="top" width="50%" align="center">

        <div class="container">
          <div class="containerheadleft">Device BGP Info</div>
          <div class="containerheadright">
%         if ( $editdevbgp ) {
            <form name="netdotform" action="device.html" method="POST">
	      <input type="hidden" name="id" value="<% $id %>">
	      <input type="hidden" name="view" value="<% $view %>">
	      <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
	      <input type="submit" name="submit" value="save">
%         }else{
              <a href="device.html?id=<% $id %>&view=<% $view %>&editdevbgp=1">[edit]</a>
%         }
          </div>
          <div class="containerbody">
             <& /generic/attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>
%         if ( $editdevbgp ) {
             </form>
%         }
          </div>
        </div>
    </td>
    <td></td>
  </tr>
</table>
<!-- End Two-column Division Table -->

<%perl>
    my $ipeers = $o->get_bgp_peers(type=>"internal", sort=>$peersort);
    my $epeers = $o->get_bgp_peers(type=>"external", sort=>$peersort);
</%perl>

%   if ( $ipeers || $epeers ){

<!-- BGP Peers Table -->
<div class="container">
    <div class="containerheadleft">
        BGP Peers
    </div>
    <div class="containerheadright">

%     if ( $editbgp ) {
      <form name="netdotform" action="device.html" method="POST">
	<input type="hidden" name="id" value="<% $id %>">
	<input type="hidden" name="view" value="<% $view %>">
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
	<input type="submit" name="submit" value="save">
%     }else{
        <a href="device.html?id=<% $id %>&view=<% $view %>&editbgp=1">[edit]</a>
%     }
    </div>
    <div class="containerbody">

<%perl>

(@headers, @rows) = ();

push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=ip">Remote IP</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=id">ID</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=entity">Entity</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=asname">AS Name</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=asnumber">AS Number</a>' );
push( @headers, 'Monitored?' );

if ( $epeers ){
    push @rows, ["<strong>External (eBGP)</strong>", "", "", "", "", ""];
    
    foreach my $peer ( @$epeers ){
	my (@row) = ();
	push( @row, $ui->form_field(object=>$peer, column=>"bgppeeraddr", 
				    edit=>$editbgp, linkPage=>"view.html", returnValOnly=>1) );
	push( @row, $peer->bgppeerid  );
	push( @row, '<a href="view.html?table=Entity&id=' . $peer->entity->id . '">' . $peer->entity->name . '</a>' );
	push( @row, $peer->entity->asname  );
	if ( $whois_url ){
	    my $asn = $peer->entity->asnumber;
	    my $url = $whois_url;
	    $url =~ s/<ASNUMBER>/$asn/;
	    push( @row, "<a target=\"#\" href=\"$url\">$asn</a>" );
	}else{
	    push( @row, $peer->entity->asnumber );
	}
	push( @row, $ui->radio_group_boolean(object=>$peer, column=>"monitored", edit=>$editbgp, returnAsVar=>1) );
	push( @rows, \@row );
    }
    push @rows, ["&nbsp;", "", "", "", "", ""];
}
if ( $ipeers ){
    push @rows, ["<strong>Internal (iBGP)</strong>", "", "", "", "", ""];
    
    foreach my $peer (@$ipeers){
	my (@row) = ();
	push( @row, $ui->form_field(object=>$peer, column=>"bgppeeraddr", 
				    edit=>$editbgp, linkPage=>"view.html", returnValOnly=>1) );
	push( @row, $peer->bgppeerid  );
	push( @row, '<a href="view.html?table=Entity&id=' . $peer->entity->id . '">' . $peer->entity->name . '</a>' );
	push( @row, $peer->entity->asname  );
	if ( $whois_url ){
	    my $asn = $peer->entity->asnumber;
	    my $url = $whois_url;
	    $url =~ s/<ASNUMBER>/$asn/;
	    push( @row, "<a target=\"#\" href=\"$url\">$asn</a>" );
	}else{
	    push( @row, $peer->entity->asnumber );
	}
	push( @row, $ui->radio_group_boolean(object=>$peer, column=>"monitored", edit=>$editbgp, returnAsVar=>1) );
	push( @rows, \@row );
    }
}
</%perl>
    
<& /generic/data_table.mhtml, field_headers=>\@headers, data=>\@rows &>

%   if ( $editbgp ) {
      </form>
%   }
    </div>
</div>
%    }
% }
<!-- End BGP Peers Section -->


%#######################################################################
%#
%# History
%#
%#######################################################################
%
% if ( $view eq "History" || $view eq "All" ){
%   my @h_objs = $o->get_history;
%
<!-- History Table -->
<div class="container">
    <div class="containerhead">
        History
    </div>
    <div class="containerbody">
        <& /generic/sortresults.mhtml, object => \@h_objs , view => "row" &>
    </div>
</div>
% }
%
%
<!-- End History Section -->



 </div> <!-- close containerbodyoutside --> 
</div> <!-- close containeroutside -->

%} # if !defined search

</div> <!-- close sectiondetail -->
