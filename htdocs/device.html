<%doc>

-- Device Worksheet --

Interface for viewing/updating a particular Device 
and all its relevant info in one page

</%doc>
%
%
<%flags>
inherit => 'section_management.html' 
</%flags>
%
%
<%attr>
title   => 'Device' 
section => 'Management'
</%attr>
%
%
%#######################################################################
%#
%# Args section
%#
%#######################################################################
<%args>
$id        => undef
$search    => undef
$edit      => undef
$editgen   => undef
$editloc   => undef
$editmgmt  => undef
$editsnmp  => undef
$editips   => undef
$editints  => undef
$editbgp   => undef
$ipsort    => "address"
$ifsort    => "number"
$peersort  => "ip"
$user      => undef
$showvlan  => "all"
$intadd    => undef
$submit    => undef
$view      => "Basics"
$intaddnum => undef
$deviceadd => undef
$newhost   => undef
$newip     => undef
</%args>
%
%
%#######################################################################
%#
%# INIT section
%#
%#######################################################################
%
<%init>
my $DEBUG      = 0;
my %cssitem    = ( 0 => "formtablec1", 1 => "formtablec2" );
my $maxselect  = 100;
my $o          = undef;
my $ci         = 0;
my $name;
my %ifvlans;
my %vlans;
my $list;
my $fqdn;

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

if ( $submit eq "search" ){
    if ( $search eq "unknown type" ){
	# The keyword "unknown type" is reserved and returns
	# devices with not productname set
	@$list = Device->search( productname => 0 );
	
    }elsif( $search ){
	# remove spaces
	$search =~ s/\s*//g;
	unless ( ($list = $dns->getdevbynamelike($search)) ){
print <<EOF;
	    <div class="container">
		<div class="containerhead">
		  <strong>No results</strong>   
		</div>
		<div class="containerbody">
		  <p><strong><em>$search</em> not found</strong>   
		</div>
	    </div>
EOF
	    $m->abort;
	}
	my $num = scalar(@$list);
	if ( $num == 1 ){
	    # Don't offer list.  Just display device
	    $o      = $list->[0];
	    $id     = $o->id;
	    $search = undef;
	}
	
    }else{
print <<EOF;
    <div class="container">
	<div class="containerhead">
	  <strong>No results</strong>   
	</div>
	<div class="containerbody">
	  <p><strong>No search criteria</strong>   
	</div>
    </div>
EOF
	$m->abort;
    }
 
}elsif( $intadd ){
    unless ( $dm->add_interfaces($id, $intaddnum) ){
	$m->comp('error.mhtml', error => $dm->error);	
    }
    
}elsif( $deviceadd && $newhost && $newip ){
    if ( $dns->getdevbyname($newhost) ){
	# It's already there
	print "<p><b>Device $newhost already exists in DB</b>";   
	$m->abort;
    }else{
	# Minimal info to create device manually
	my %tmp = ( host   => $newhost, 
		    dev    => { interface => { '1' => {'name'   => "eth0",
						       'number' => 1,
						       'ips'    => {$newip} } } } );
	unless ( $o = $dm->update_device(%tmp) ){
	    $m->comp('error.mhtml', error => $dm->error);	
	}
    }
}elsif( $submit ){
    # insert/update
    if ( ! $ui->form_to_db(%ARGS) ){
	$m->comp('error.mhtml', error => $ui->error);
    }
}

if ( $id ){
    unless ($o = Device->retrieve($id)){
	$m->comp('error.mhtml', error=>"Could not retrieve Device with id $id");
    }   
}elsif ( $o ){
    unless ( $id = $o->id ){
	$m->comp('error.mhtml', error=>"Object passed was not a valid Device object");
    }   
}
if ( $o && $o->name ){
    $name = ($o->name->name) ? $o->name->name : "Name N/A!";
    $fqdn = $name . "." . $o->name->zone->mname;

}elsif ( ! $search ){
    $m->comp('error.mhtml', error=>"Device undefined or no name set");
}

if ( $view eq "Interfaces" || $view eq "All" ){
    # Build a hash of Interface Vlans
    foreach my $if ( $o->interfaces ){
	if (scalar( my @ifv = $if->vlans)){
	    foreach my $ifv (@ifv){
		my $vid = $ifv->vlan->vid;
		$ifvlans{$if}{$vid} = "";
		$vlans{$vid} = $ifv->vlan->id;
	    }
	}
    }
}
</%init>

<div id="sectiondetail">


<script language="javascript">
<!--
/* 
 * Show only interfaces belonging to selected VLAN
 * 
*/
function showVlan(){
    var name = document.showvlans.showvlan.value;
    window.location = "device.html?id=<% $id %>&view=<% $view %>&showvlan="+name;
}

function addService(ip){
    var url = "addservice.html?ip="+ip;
    var wind = window.open(url, "Create IP service", "width=400,height=200");
}

function addLink(int_id, role){
    var url = "addlink.html?int_id="+int_id+"&role="+role;
    var wind = window.open(url, "Add Link", "width=600,height=200");     
}

var closetList = new DynamicList("netdotform", "Device__<% $id %>__closet", "site", "Closet", "Device__<% $id %>__site");
var roomList = new DynamicList("netdotform", "Device__<% $id %>__room", "floor", "Room", "Device__<% $id %>__site");
roomList.setQueryURL("room_site_query.html");
LIST_MANAGER.addList(closetList, roomList);

// Chooses the 0 valued option in a select box.  Used to enforce the
// mutual exclusivity of the room and closet options in the
// group/location form below.
function setNull(select){
    for (var i = 0; i < select.options.length || alert("No null in list.  This means nathan screwed up dynamic_list.js"); ++i){
	if (select.options[i].value == 0) {
	    select.options[i].selected = true;
	    break;
	}
    }
}

-->
</script>

%#######################################################################
%#
%# Search results section
%#
%#######################################################################

% if ( $search ){
<div class="container">
  <div class="containerheadleft">
    <% scalar(@$list) %> results for <i><% $search %></i>
%# The non breaking space is a hack to make the table header full width
  </div><div class="containerheadright">&nbsp;</div>
  <div class="containerbody">
      <& sortresults.mhtml, object => $list, view => "row", page => "device.html", withdelete => 1 &>
  </div>
</div>

%#######################################################################
%#
%# Device view section
%#
%#######################################################################
% }else{  # we're not searching

<!-- Header Table -->
<div class="containeroutside">
  <div class="containerheadleftoutside">
 
 Device: <b><% $name %></b>&nbsp;
 <a href="http://<% $fqdn %>" target=#>[HTTP]</a> <a href="ssh://<% $user->getUsername() %>@<% $fqdn %>">[SSH]</a> <a href="telnet://<% $fqdn %>">[Telnet]</a>

</div>

<div class="containerheadrightoutside">

    <a href="device.html?id=<% $id %>&view=<% $view %>">[refresh]</a>
%    if ( $o->snmp_managed ){
	<a href="updatedevice.html?device=<% $id %>&action=discover">[snmp-update]</a>
%    }
    <a href="deldevice.html?id=<% $id %>"> [delete]</a>

</div> <!-- close containerheadrightoutside -->

%#######################################################################
%#
%# Navigation Bar
%#
%#######################################################################

<div id="navbar">
    <ul id="navigation">
%     if( $view eq "Basics" ) {
        <li><span>Basics</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=Basics">Basics</a></li>
%     }
%     if( $view eq "Interfaces" ) {
        <li><span>Interfaces</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=Interfaces">Interfaces</a></li>
%     }
%     if( $view eq "IP" ) {
        <li><span>IP info</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=IP">IP info</a></li>
%     }
%     if ( $o->bgppeers ){
%       if( $view eq "BGP" ) {
          <li><span>BGP Peers</span></li>
%       } else {
          <li><a href="device.html?id=<% $id %>&view=BGP">BGP Peers</a></li>
%       }
%     }
%     if( $view eq "Topology" ) {
        <li><span>Topology</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=Topology">Topology</a></li>
%     }
%     if( $view eq "History" ) {
        <li><span>History</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=History">History</a></li>
%     }
%     if( $view eq "All" ) {
        <li><span>All</span></li>
%     } else {
        <li><a href="device.html?id=<% $id %>&view=All">All</a></li>
%     }
    </ul>
</div>

<div class="containerbodyoutside">

%#######################################################################
%#
%# Basics
%#
%#######################################################################

% if ( $view eq "Basics" || $view eq "All" ){

<!-- Two-column Division Table -->
<table border="0" width="100%" align="center">
  <tr>
    <td valign="top" width="50%" align="center">

% if ($editgen || $editloc || $editmgmt || $editsnmp) {
        <form name="netdotform" action="device.html" method="POST">
	    <input type="hidden" name="id" value="<% $id %>">
	    <input type="hidden" name="view" value="<% $view %>">
% }
    <div class="container">
	<!-- General Info Table -->
    	<div class="containerheadleft"><b>General</b></div>
    	<div class="containerheadright">
% if ($editgen) {
	    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
	    <input type="submit" name="submit" value="save" >
% }else{
            <a href="device.html?id=<% $id %>&view=<% $view %>&editgen=1">[edit]</a>
% }
        </div>
        <div class="containerbody">
         <table width="100%">
          <tr>
           <td valign="top" width="50%">
<%perl>
my (@field_headers, @cell_data);

# The two ways I can find to be lazy and not have to retype a temp var
# name 83 times.  Not sure which is more (or less) efficient.
push( @field_headers, "Name: " );
push( @cell_data, 
# Use eval with block.  (had trouble with eval on string (qq{})
# complaining about not knowing what `o' was.
   eval{	
       if ($o->name && $o->name->name){
	   if ($editgen){	 
	       '<input type="text" name="RR__'.$o->name->id.'__name" value="' . $o->name->name . '">';
	   }else{
	       '<b><a href="view.html?table=RR&id='.$o->name->id.'">'.$o->name->name."</a></b>";
	   }
       }else{ 
	   "Name N/A!";
       }
   }
);

push( @field_headers, "Type: ");
push( @cell_data, 
# Use anonymous subroutine with immediate call.  If perl is smart this
# will not waste mem as there are no references to the sub after this
# call.
      &{sub{	
	  if (($o->productname) && ($o->productname->type)){	 
	      '<a href="view.html?table=Product&id='.$o->productname->id.'">'.$o->productname->type->name."</a>";
	  }
      }}
);

push( @field_headers, "S/N: " );
push( @cell_data, $ui->text_field(object=>$o, column=>"serialnumber", edit=>$editgen, returnAsVar=>1) );

push( @field_headers, "MAC: " );
push( @cell_data, $ui->select_lookup(object=>$o, column=>"physaddr", 
				     lookup=>"PhysAddr", edit=>"$editgen", 
				     linkPage=>"view.html", returnAsVar=>1) );

push( @field_headers, "First Discovered: " );
push( @cell_data, $ui->text_field(object=>$o, column=>"dateinstalled", edit=>$editgen, returnAsVar=>1) );

push( @field_headers, "Last updated: " );
push( @cell_data, $ui->text_field(object=>$o, column=>"lastupdated", edit=>$editgen, returnAsVar=>1) );
</%perl>

    <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>
           </td>
           <td valign="top" width="50%">

<%perl>
(@field_headers, @cell_data) = ();

push( @field_headers, "Product: " );
push( @cell_data,                $ui->select_lookup(object=>$o, column=>"productname", lookup=>"Product", edit=>"$editgen", linkPage=>"view.html", returnAsVar=>1) );
push( @field_headers, "Inventory #:"  );
push( @cell_data,                $ui->text_field(object=>$o, column=>"inventorynumber", edit=>$editgen, returnAsVar=>1) );
push( @field_headers, "System Descr: " );
push( @cell_data,                $ui->text_field(object=>$o, column=>"sysdescription", edit=>$editgen, returnAsVar=>1) );
</%perl>

    <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>
           </td>
          </tr>
	</table>
    <div class="containerseparator">Comments</div>
       <% $ui->text_area(object=>$o, column=>"info", edit=>$editgen, htmlExtra=>"cols=60", returnAsVar=>1) %>
    </div>
   </div> <!-- containerbody -->
</div> <!-- container -->
<!-- End General Info Table -->

<!-- Location Table -->
<div class="container">
    <div class="containerheadleft">
        Group/Location
    </div>
    <div class="containerheadright">
%	if ($editloc){	 
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
        <input type="submit" name="submit" value="save">
%	}else{
        <a href="device.html?id=<% $id %>&view=<% $view %>&editloc=1">[edit]</a>
%	}
    </div>
    <div class="containerbody">
<%perl>
(@field_headers, @cell_data) = ();

push( @field_headers, "Entity: " );
push( @cell_data, $ui->select_lookup(object=>$o, column=>"entity", lookup=>"Entity", edit=>"$editloc", linkPage=>"view.html", returnAsVar=>1) );
push( @field_headers, "Site: " );
push( @cell_data,                $ui->select_lookup(object=>$o, column=>"site", lookup=>"Site", edit=>"$editloc", makeLink=>1, linkPage=>"view.html", htmlExtra=>'onChange="closetList.doIt(); roomList.doIt();"', returnAsVar=>1) );

push( @field_headers, "Room: " );
push( @cell_data, &{sub{ 
    my $s = "";
    if ($editloc) {
	$s .= '<select name="Device__'.$id.'__room" onChange="setNull(document.netdotform.Device__'.$id.'__closet);">';
	$s .= '<option value="0">-- Select --</option>';
	if (defined($o)) {
	    foreach my $floor ( $o->site->floors ) {
		foreach my $room ( sort { $a->name cmp $b->name } $floor->rooms ) {
		    $s .= sprintf("<option value=\"%d\" %s>%s</option>\n", $room->id, ($o->room && $room->id == $o->room->id ? "SELECTED" : ""), $room->name);
		}
	    }
	}
	$s .= '</select>';
    } else {
	if (defined($o->room)) {
	    $s .= $o->room->name; 
	}else{
	    $s .= "&nbsp;";
	}
    }
}} );
push( @field_headers, " or Closet: " );
push( @cell_data, &{sub{
    my $closet_js = sprintf("onChange=\"setNull(document.netdotform.Device__%d__room);\"", $id);
    $ui->select_lookup(object=>$o, column=>"closet", lookup=>"Closet", 
		       edit=>$editloc, where=>{site=>($o ? $o->site : "")}, 
		       makeLink=>1, linkPage=>"closet.html", htmlExtra=>$closet_js, returnAsVar=>1)
    }} );
push( @field_headers, "Rack: " );
push( @cell_data, $ui->text_field(object=>$o, column=>"rack", edit=>$editloc, returnAsVar=>1) );
</%perl>

    <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

    </div>
</div>
<!-- End Location Table -->


  </td>
  <td valign="top"  width="50%" align="center">



<!-- Management Table -->
<div class="container">
    <div class="containerheadleft">
        Management
    </div>
    <div class="containerheadright">
%	 if ($editmgmt){	 
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
        <input type="submit" name="submit" value="save">
%	 }else{
        <a href="device.html?id=<% $id %>&view=<% $view %>&editmgmt=1">[edit]</a>
%	 }
    </div>
    <div class="containerbody">

<%perl>
(@field_headers, @cell_data) = ();
push( @field_headers, "Contacts: " );
push( @cell_data, $ui->select_lookup(object=>$o, column=>"contactlist", lookup=>"ContactList", edit=>"$editmgmt", linkPage=>"view.html", returnAsVar=>1) );
push( @field_headers, "Secondary Contacts: " );
push( @cell_data, $ui->select_lookup(object=>$o, column=>"contactlist2", lookup=>"ContactList", edit=>"$editmgmt", linkPage=>"view.html", returnAsVar=>1) );
push( @field_headers, "User: " );
push( @cell_data, $ui->select_lookup(object=>$o, column=>"person", lookup=>"Person", edit=>"$editmgmt", linkPage=>"view.html", returnAsVar=>1) );
push( @field_headers, "Out-of-band hostname: " );
push( @cell_data, $ui->text_field(object=>$o, column=>"oobname", edit=>$editmgmt, returnAsVar=>1) );
push( @field_headers, "Out-of-band tel: " );
push( @cell_data, $ui->text_field(object=>$o, column=>"oobnumber", edit=>$editmgmt, returnAsVar=>1) );

push( @field_headers, "Monitored?: " );
push( @cell_data, $ui->radio_group_boolean(object=>$o, column=>"monitored", edit=>$editmgmt, returnAsVar=>1) );
push( @field_headers, "Customer-managed?: " );
push( @cell_data, $ui->radio_group_boolean(object=>$o, column=>"customer_managed", edit=>$editmgmt, returnAsVar=>1) );
push( @field_headers, "NATted?: " );
push( @cell_data, $ui->radio_group_boolean(object=>$o, column=>"natted", edit=>$editmgmt, returnAsVar=>1) );

</%perl>

       <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

    </div>
</div>
<!-- End Management Table -->

<!-- SNMP Table -->
<div class="container">
    <div class="containerheadleft">
        SNMP
    </div>
    <div class="containerheadright">
%	 if ($editsnmp){	 
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
        <input type="submit" name="submit" value="save">
%	 }else{
        <a href="device.html?id=<% $id %>&view=<% $view %>&editsnmp=1">[edit]</a>
%	 }
    </div>
    <div class="containerbody">
<%perl>

(@field_headers, @cell_data) = ();
push( @field_headers, "SNMP-managed?: " );
push( @cell_data, $ui->radio_group_boolean(object=>$o, column=>"snmp_managed", edit=>$editsnmp, returnAsVar=>1) );
if ( $editsnmp || $o->snmp_managed ){
    push( @field_headers, "SNMP Community: " );
    push( @cell_data, $ui->text_field(object=>$o, column=>"community", edit=>$editsnmp, returnAsVar=>1) );
    push( @field_headers, "Auto-update?: " );
    push( @cell_data, $ui->radio_group_boolean(object=>$o, column=>"canautoupdate", edit=>$editsnmp, returnAsVar=>1) );
}
</%perl>

       <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

    </div>
</div>
<!-- End SNMP Table -->


  </td>
 </tr>
</table>
<!-- End Division Table -->

%   if ( $editgen || $editloc || $editmgmt || $editsnmp ) {
      </form>
%   }
% }

<%perl>
my (@headers, @rows, @row);
</%perl>

%#######################################################################
%#
%# IP info
%#
%#######################################################################

% if ( $view eq "IP" || $view eq "All" ){

%  # Get all ip address info
%  my @ips;
%  if ( $o && $ipsort ){
%    @ips = $dm->getdevips( $o->id, $ipsort );
%  }

<!-- IPs Table -->

<div class="container">
    <div class="containerheadleft">
        IPs
    </div>
    <div class="containerheadright">
%   if ( $editips ) {
      <form name="netdotform" action="device.html" method="POST">
	  <input type="hidden" name="id" value="<% $id %>">
	  <input type="hidden" name="view" value="<% $view %>">
	  <input type="hidden" name="ipsort" value="<% $ipsort %>">
	  <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
          <input type="submit" name="submit" value="save">
%   }else{
          <a href="device.html?id=<% $id %>&view=<% $view %>&editips=1">[edit]</a>
%   }
    </div>
    <div class="containerbody">

%    if (scalar @ips){

<%perl>
(@headers, @rows, @row) = ();

@headers = (
'<a href="device.html?id='. $id .'&view='. $view .'&ipsort=address">Address</a>',
'Subnet',
'<a href="device.html?id='. $id .'&view='. $view .'&ipsort=interface">Interface</a>',
'DNS Name',
'Services',
);

</%perl>

<%perl>
foreach my $ip (@ips){	   
    next if ( ! exists $ifvlans{$ip->interface}{$showvlan} && 
	      $showvlan ne "all" );

my (@row) = ();
push( @row, 
&{sub{
    my $a = "";
    if ($editips){  
	$a .= '<input type="checkbox" name="' . "Ipblock__" . $ip->id . "__delete" . '" >[del] ';
	$a .=  $ip->address ;
	$a .= '<br>';
    }else{
	$a .= '<a href="ip-ws.html?id=' . $ip->id . '">' . $ip->address . '</a><br>';
    }
    $a;
}} );
push( @row, 
&{sub{
    my $a = "";
    if ( int($ip->parent) != 0  ){
	if ($editips){  
	    $a .=  $ip->parent->address . '/' . $ip->parent->prefix ;
	}else{
	    $a .= '<a href="ip-ws.html?id=' . $ip->parent->id . '">' . $ip->parent->address . '/' . $ip->parent->prefix . '</a><br>';
	}
    }
    $a;
}} );
push( @row, $ip->interface->name  );
push( @row, 
&{sub{
    my $a = "";
    if ( $ip->arecords ){
	foreach my $ar ($ip->arecords){
	    if ($editips){      
		$a .= '<input type="checkbox" name="' . "RR__" . $ar->rr->id . "__delete" . '" >[del] ';
	    }
	    $a .= $ui->text_field(object=> $ar->rr, column=>"name", edit=>$editips, linkPage=>"view.html", returnAsVar=>1);
	}
    }else{
    }
    $a;
}} );
push( @row, 
&{sub{
    my $a = "";
    if ( scalar ($ip->services) ){
	foreach my $ipsrv ($ip->services){
#                $a .= $ui->select_lookup(object=>$ipsrv, column=>"service", lookup=>"Service", edit=>"$editips", linkPage=>"view.html", returnAsVar=>1);       
	    $a .= '<a href="view.html?table=IpService&id=' . $ipsrv->id . '">' . $ipsrv->service->name . '</a>';
	    if ( $editips ){
		$a .= '<input type="checkbox" name="' . "IpService__" . $ipsrv->id . "__delete" . '" > [del] ';
	    }
	    $a .= '<br>';
	}
    }
    if ( $editips ){
	$a .= '<a href="#" onClick="addService(' . $ip->id . ')">[add]</a>';
    }
    $a;
}} );
push( @rows, \@row );

}# foreach	
</%perl>

<& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>

%     }else{ # No ips exist
%        if ( $editips ){
%        # Let user add a new IP           

<%perl>
(@headers, @rows) = ();

@headers = ( 
'Interface',
'Address',
'Monitored?',
);
</%perl>

<%perl>
(@row) = ();
push( @row, 
&{sub{
    my $ac = "";
    $ac .= '<select name="' . "Ipblock__" . "NEW" . "__interface" . '" >';
    $ac .= '<option value="0">Select Interface</option>';
    foreach my $int ( sort { $a->number <=> $b->number } $o->interfaces ){
	$ac .= '<option value="' . $int->id . '">' . $int->name . '</option>                        ';
    }
    $ac .= '</select>';
    $ac;
}} );
push( @row, 
&{sub{
    my $ac = "";
    $ac .= '<input type="text" name="' . "Ipblock__" . "NEW" . "__address" . '" >';
    $ac .= '<input type="hidden" name="' . "Ipblock__" . "NEW" . "__statusname" . '" value="Static">';
    $ac;
}} );
push( @row, 
&{sub{
    my $ac = "";
    $ac .= 'Y <input type="radio" name="' . "Ipblock__" . "NEW" . "__monitored" . '" value="1" CHECKED>                 ';
    $ac .= 'N <input type="radio" name="' . "Ipblock__" . "NEW" . "__monitored" . '" value="0">';
    $ac;
}} );
push( @rows, \@row );
</%perl>

<& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>

%      }else{
            Click [edit] to add a new IP
%      }  
%    }
    </div>
</div>
<!-- End IPs Table -->

%   if ( $editips ) {
       </form>
%   }
% }

%#######################################################################
%#
%# Interfaces
%#
%#######################################################################

% if ( $view eq "Interfaces" || $view eq "All" ){

<!-- Interface Table -->
<div class="container">
    <div class="containerheadleft">
        Interfaces
    </div>
    <div class="containerheadright">

%   if ($editints){	 
    <form name="netdotform" action="device.html" method="POST">
	<input type="hidden" name="id" value="<% $id %>">
	<input type="hidden" name="view" value="<% $view %>">
	<input type="hidden" name="ifsort" value="<% $ifsort %>">
	<input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
	<input type="submit" name="submit" value="save">
%   }else{

    <form name="showvlans">
	VLAN view: <select name="showvlan" onChange="showVlan();">
%     if ( $showvlan eq 'all' ){
         <option value="all" SELECTED>all</option>
%     }else{
         <option value="all">all</option>
%     }
%     foreach my $vid ( sort keys %vlans ){
%       if ( $showvlan eq $vid ){
          <option value="<% $vid %>" SELECTED><% $vid %></option>     
%       }else{
          <option value="<% $vid %>"><% $vid %></option>     
%       }
%     }
      </select>
    </form> 
    <a href="device.html?id=<% $id %>&view=<% $view %>&editints=1">[edit]</a>

%  }
    </div>
    <div class="containerbody">

<%perl>
(@headers, @rows) = ();

if ( $editints ){
push( @headers, '[del]' );
}

push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=number">No.</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=name">Name</a>' );

if ( ! $editints ){
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=speed">Speed</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=vlan">VLAN</a>' );
}

push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=jack">Jack(cable)</a>' );
push( @headers, 'Room' );
push( @headers, 'Jack' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&ifsort=descr">Descr.</a>' );
push( @headers, 'Uplink' );
push( @headers, 'Downlink' );
push( @headers, 'Mon?' );
push( @headers, 'SNMP?' );

</%perl>

<%perl>
    my @ifs;
    @ifs = $dm->get_interfaces( $o, $ifsort );
</%perl>
			  
%       foreach my $if ( @ifs ){
%         next if ( ! exists $ifvlans{$if}{$showvlan} && $showvlan ne "all");

<%perl>
my (@row) = ();	#Scope got me here.

if ( $editints ){	 
push( @row, '<input type="checkbox" name="' . "Interface__" . $if->id . "__delete" . '" >' );
}

push( @row, $ui->text_field(object=>$if, column=>"number", edit=>$editints, htmlExtra =>"style=\"width: 2em;\"", linkPage=>"view.html", returnAsVar=>1) );
push( @row, $ui->text_field(object=>$if, column=>"name", edit=>$editints, htmlExtra =>"style=\"width: 7em;\"", returnAsVar=>1) );

if ( ! $editints ){
push( @row, $dm->convert_ifspeed($if->speed)  );	# NEEDS RETURNASVAR?
push( @row, 
&{sub{
    my $ac = "";
    if (exists $ifvlans{$if}){
        my @links;
	foreach my $v ( keys %{$ifvlans{$if}} ){
	    push @links, sprintf("<a href=\"view.html?table=Vlan&id=%s\">%s</a>", $vlans{$v}, $v );
	}
	$ac .= join ', ', @links;	# CHECK THIS (was in a print).
    }
    $ac;
}} );
}

push( @row, $ui->select_lookup(object=>$if, table=>"Interface", column=>"jack", lookup=>"HorizontalCable", 
                             edit=>$editints, linkPage=>"cable_horizontal.html", returnAsVar=>1) );
push( @row, $ui->text_field(object=>$if, column=>"room_char", edit=>$editints, htmlExtra =>"style=\"width: 4em;\"", returnAsVar=>1) );
push( @row, $ui->text_field(object=>$if, column=>"jack_char", edit=>$editints, htmlExtra =>"style=\"width: 7em;\"", returnAsVar=>1) );
push( @row, $ui->text_field(object=>$if, column=>"description", edit=>$editints, returnAsVar=>1) );

#<!-- UpLink Connections Field --> <!-- ADD STUFF IN UPLINK CONNECTION FIELD SECTION -->

push( @row, 
&{sub{
    my $ac = "";
    my @parents = $if->parents;
    if (scalar(@parents)){
	foreach my $link (@parents){
	    if ( $link->parent && $link->parent->device ){
		if ( $editints ){
		    $ac .= '<input type="checkbox" name="' . "InterfaceDep__" . $link->id . "__delete" . '" > [del] ';
		}   
		my $lbl = $ui->getobjlabel($link->parent, ", ");
		$ac .= '<a href="device.html?id=' . $link->parent->device->id . '&view=Interfaces">' . $lbl . '</a><br>';
	    }
	}
    }
    if ( $editints ){  
	$ac .= '<a href="#" onClick="addLink(' . $if->id . ', \'child\')">[add]</a>';
    }
    $ac;
}} );

#<!-- DownLink Connections Field -->

push( @row, 
&{sub{
    my $ac = "";
    my @children = $if->children;
    if (scalar(@children)){
	foreach my $link (@children){
	    if ( $link->child && $link->child->device ){
		if ( $editints ){
		    $ac .= '<input type="checkbox" name="' . "InterfaceDep__" . $link->id . "__delete" . '" > [del] ';
		}   
		my $lbl = $ui->getobjlabel($link->child, ", ");
		if ( $link->child->device ){
		    $ac .= '<a href="device.html?id=' . $link->child->device->id . '&view=Interfaces">' . $lbl . '</a><br>';
		}
	    }
	}
    }
    if ( $editints ){     
	$ac .= '<a href="#" onClick="addLink(' . $if->id . ', \'parent\')">[add]</a>';
    }
    $ac;
}} );
push( @row, $ui->radio_group_boolean(object=>$if, column=>"monitored", edit=>$editints, returnAsVar=>1) );
push( @row, $ui->radio_group_boolean(object=>$if, column=>"snmp_managed", edit=>$editints, returnAsVar=>1) );

push( @rows, \@row );
</%perl>

%       } #foreach

<& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>

    </div>
    <div class="containerheadright">
%	  if ( $editints ){	 
            <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
            <input type="submit" name="submit" value="save">
%	  }
    </div>
</div>
<!-- End Interface Table -->
% } 

% if ( ! $editints && ($view eq "Interfaces" || $view eq "All") ){
    <form name="netdotform" action="device.html" method="POST">
      <input type="hidden" name="id" value="<% $id %>">
      <input type="hidden" name="view" value="<% $view %>">
      Manually 
      <input type="submit" name="intadd" value="Add">
      <input type="text" name="intaddnum" value="0" size="3"> interfaces
    </form>
% }

%   if ($editints){	 
       </form>
%   }

%#######################################################################
%#
%# BGP Peers
%#
%#######################################################################

% if ( $view eq "BGP" || $view eq "All"){

<%perl>
    my @peers;
if ( $peersort eq "ip" ){
    @peers = $dm->bgppeers_by_ip( $o );
}elsif ( $peersort eq "id"){
    @peers = $dm->bgppeers_by_id( $o );
}elsif ( $peersort eq "entity"){
    @peers = $dm->bgppeers_by_entity( $o, "name" );
}elsif ( $peersort eq "asname"){
    @peers = $dm->bgppeers_by_entity( $o, "asname" );
}elsif ( $peersort eq "asnumber"){
    @peers = $dm->bgppeers_by_entity( $o, "asnumber" );
} 
</%perl>

%   if ( scalar @peers ){
<!-- BGP Peers Table -->
<div class="container">
    <div class="containerheadleft">
        BGP Peers
    </div>
    <div class="containerheadright">

% if ( $editbgp ) {
    <form name="netdotform" action="device.html" method="POST">
	<input type="hidden" name="id" value="<% $id %>">
	<input type="hidden" name="view" value="<% $view %>">
        <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
	<input type="submit" name="submit" value="save">
% }else{
        <a href="device.html?id=<% $id %>&view=<% $view %>&editbgp=1">[edit]</a>
% }
    </div>
    <div class="containerbody">
%	if (scalar @peers){

<%perl>
(@headers, @rows) = ();

push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=ip">Remote IP</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=id">ID</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=entity">Entity</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=asname">AS Name</a>' );
push( @headers, '<a href="device.html?id=' . $id . '&view=' . $view . '&peersort=asnumber">AS Number</a>' );
push( @headers, 'Monitored?' );

foreach my $peer (@peers){

my (@row) = ();
push( @row, $peer->bgppeeraddr  );
push( @row, $peer->bgppeerid  );
push( @row, '<a href="view.html?table=Entity&id=' . $peer->entity->id . '">' . $peer->entity->name . '</a>' );
push( @row, $peer->entity->asname  );
push( @row, $peer->entity->asnumber  );
push( @row, $ui->radio_group_boolean(object=>$peer, column=>"monitored", edit=>$editbgp, returnAsVar=>1) );
push( @rows, \@row );
}
</%perl>

<& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>
	   
%      }
    </div>
</div>

%   if ( $editbgp ) {
      </form>
%   }
<!-- End BGP Peers Table -->
%   }
% }  
%
%#######################################################################
%#
%# History
%#
%#######################################################################
%
% if ( $view eq "History" || $view eq "All" ){
%   my @h_objs = $ui->gethistoryobjs($o);
%
<!-- History Table -->
<div class="container">
    <div class="containerhead">
        History
    </div>
    <div class="containerbody">
        <& sortresults.mhtml, object => \@h_objs , view => "row" &>
    </div>
</div>
<!-- End History Table -->
% }
%
%} # if !defined search
%

 </div> <!-- close containerbodyoutside --> 
</div> <!-- close containeroutside -->


</div>
