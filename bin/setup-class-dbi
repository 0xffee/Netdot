#!/usr/bin/perl
#
#
# generate Netdot::DBI from metadata 
#


use strict;
use lib "../lib";
use Netdot::Meta;

my $DB_TYPE        = $ARGV[0] || "mysql";
my $DB_DATABASE    = $ARGV[1] || "netdot";
my $DB_NETDOT_USER = $ARGV[2] || "netdot_user";
my $DB_NETDOT_PASS = $ARGV[3] || "netdot_pass";

my $IN        = "./DBI.header";
my $OUT       = "./DBI.pm";
my $META_DIR  = '../etc';
my $META_FILE = "$META_DIR/netdot.meta";

my $meta = Netdot::Meta->new(meta_file=>$META_FILE);

open (IN, "$IN") or die "Couldn't open $IN: $!\n";
open (OUT, ">$OUT") or die "Couldn't open $OUT: $!\n";
select (OUT);  # spit it all out to the output file by default

while (<IN>){
    s/^my \$data_source;/my \$data_source = "dbi:$DB_TYPE:$DB_DATABASE";/;
    s/^my \$user;/my \$user = "$DB_NETDOT_USER";/;
    s/^my \$password;/my \$password = "$DB_NETDOT_PASS";/;
    print $_;
}
close(IN);

my $table_defs = $meta->cdbi_defs();

print $table_defs;

print "\n#Be sure to return 1\n";
print "1;\n";

close (OUT);
