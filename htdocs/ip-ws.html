<%doc>
-- IP Worksheet --
Interface for IP blocks (both addresses and subnets)

</%doc>
%
%
<%flags>
inherit => 'section_management.html' 
</%flags>
%
%
<%attr>
title   => 'IP' 
section => 'Management'
</%attr>
%
%
<%args>
$id                => undef
$search            => undef
$_action           => undef
$delete            => undef
$recursivedel      => undef
$allocate          => undef
$newblock          => undef
$parent            => undef
$length            => undef
$strategy          => undef
$edit              => undef
$submit            => undef
</%args>
%
%
<%init>
my $DEBUG = 0;
my $o;
my $ci = 0;
my $title;
if ( $id ){
    unless ( $o = Ipblock->retrieve($id) ){
	$m->comp('error.mhtml', error => "Could not retrieve Ipblock id: $id");
    }else{
	$title = $o->address . "/" . $o->prefix;
    }
}else{
    $title = "Search";
}

my $edit_ip    = 0;
my $edit_block = 0;
$edit_ip       = 1 if ($edit eq "ipinfo");
$edit_block    = 1 if ($edit eq "blockinfo");

# By default, view object after any operation
# ( some exceptions will override )
my $view       = 1;

</%init>
%
<div id="sectiondetail">
%
<%perl>

print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

#######################################################################################
# Search
#
#######################################################################################

if ( defined($_action) && defined($search) ){
    my @list;
    if ( $_action eq "SEARCH_ADDR" ){
	if ($search =~ /\w+/ ){
	    my ($addr, $prefix, $ipb);
	    if ($search =~ /\//){
		($addr, $prefix) = split /\//, $search;
		if ($ipb = $ipm->searchblocks_addr($addr, $prefix)){
		    push @list, $ipb;
		}
	    }else{
		@list = $ipm->searchblocks_addr($search);
	    }
	    unless ( @list ){
		# None were found, so look for substrings
		@list = $ipm->searchblocks_addr_like($search);
	    }
	}
    }elsif ( $_action eq "SEARCH_OTHER" ){
	if ($search =~ /\w+/ ){
	    @list = $ipm->searchblocks_other($search);
	}
    }

</%perl>      


       <div class="container">
          <div class="containerhead">
%             my $num = scalar(@list);
              Query <strong><em><% $search %></em></strong> returned: <strong><% $num %> matches</strong>
          </div>
          <div class="containerbody">
%             if ( $num ){
                  <& ipblock_list.mhtml, objects => \@list  &>
%             }elsif ( $ipm->error ){
                  <p><strong><% $ipm->error %></strong>
%             }else{
                  <p><strong>No search criteria</strong>   
%             }
          </div>
       </div>

<%perl>

#######################################################################################
# Update
# 
#######################################################################################\

}elsif( defined($_action) && ($_action eq "UPDATE")){

    if ( $ui->form_to_db(%ARGS) ){
	# Do this to 'flush' the values associated with the object
	# before redisplaying
	$o = undef;
	if ($id){
	    $o = Ipblock->retrieve($id);
	}
    }else{
	printf ("<p><strong>Error: %s</strong><br>", $ui->error);
    }

#######################################################################################
# Allocate
#
#######################################################################################
}elsif ( defined($_action) && ($_action eq "ALLOCATE") ){
    unless ($allocate =~ /\//){
</%perl>

     <p><strong>Error: New block must have prefix length</strong><br>   

<%perl>
     $m->abort;
    }
    my ($address, $prefix) = split /\//, $allocate;
    my $newblock; 
    unless( $newblock = $ipm->insertblock(address     => $address, 
					  prefix      => $prefix, 
					  statusname  => "Container")){
	print "<strong>Error: ", $ipm->error, "</strong><br>";
    }
    if ($newblock)
    {
	$o = $newblock;
	$id = $newblock->id;
    }

#######################################################################################
# Auto-Allocate
#
#######################################################################################
}elsif ( defined($_action) && ($_action eq "AUTOALLOCATE") ){
    # Strip "/" if any
    $length =~ s/\///;
    my $newblock;
    unless ( $newblock = $ipm->auto_allocate($parent, $length, $strategy) ){
	print "<strong>Error: ", $ipm->error, "</strong><br>";
    }else {
</%perl>
%     # Present new block and ask for confirmation
      <form action="ip-ws.html">
        <input type="hidden" name="_action" value="CONFIRM_AUTOALLOCATE">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="newblock" value="<% $newblock->id %>">
        <br>
        <strong>Do you want to use <% $newblock->address %>/<% $newblock->prefix %></strong> ?
        <p>
        <input type="submit" name="submit" value="Yes" >
        <input type="submit" name="submit" value="No" >
      </form>
<%perl>    
   #  Do not continue with object display
      $view = 0;
   }

#######################################################################################
# Confirm Auto-Allocate
#
#######################################################################################

}elsif ( $_action eq "CONFIRM_AUTOALLOCATE" && $submit eq "Yes"){
    undef $o;
    unless ( $o = Ipblock->retrieve($newblock) ){
	$m->comp('error.mhtml', error => "Could not retrieve Ipblock id: $newblock");
    }
    # Replace current object with newblock
    $id = $o->id;

}elsif ( $_action eq "CONFIRM_AUTOALLOCATE" && $submit eq "No"){
    # Get rid of the new block
    unless ( $ipm->removeblock( id => $newblock ) ){
	$m->comp('error.mhtml', error => $ipm->error);	
    }

#######################################################################################
# Delete
#
#######################################################################################
}elsif ( defined($_action ) && ($_action eq "DELETE") ){

</%perl>

  <form action="ip-ws.html">
    <input type="hidden" name="_action" value="CONFIRM_DELETE">
    <input type="hidden" name="id" value="<% $id %>">

    <p>Are you sure you want to <strong>delete <% $o->address %>/<% $o->prefix %></strong> ?<br>

    <p>Delete recursively <input type="checkbox" name="recursivedel">

    <p>
    <input type="submit" name="submit" value="Yes" >
    <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">
  </form>


<%perl>

# Do not continue with object display
  $view = 0;

#######################################################################################
# Confirm Delete
#
#######################################################################################
}elsif ( defined($_action ) && ($_action eq "CONFIRM_DELETE") ){
  
    my ($parentid, $address, $prefix, $version) = ($o->parent->id, $o->address, $o->prefix, $o->version);
    # Remove from Database
    #
    my $rec = ($recursivedel)? 1 : 0;
    unless ( $ipm->removeblock( id => $o->id, recursive => $rec ) ){
	$m->comp('error.mhtml', error => $ipm->error);
    }
    
</%perl>
%  if ($rec){
     <p><strong>Block <% $address %>/<% $prefix %> and all its children blocks have been removed</strong> <br>
%  }else{
     <p><strong>Block <% $address %>/<% $prefix %> has been removed</strong> <br>
%  }

<%perl>
#    Show parent block
#    after block has been deleted
    $id = $parentid;
    if ($id != 0){
	unless ( $o = Ipblock->retrieve($id) ){
	    $m->comp('error.mhtml', error => "Can't retrieve Ipblock id $id");
	}
    }
</%perl>

%}

%#######################################################################################
%# View
%#
%#######################################################################################

%if ( $id && $view ){
% if ( $edit ){	 
    <form name="netdotform" action="ip-ws.html" method="POST">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="_action" value="UPDATE">
% }
% if ( $ipm->isaddress($o) ){  
%#######################################################################################
%# View IP address
%#######################################################################################

<!-- IP Info Table -->
<div class="container">

    <div class="containerheadleft">Address Info</div>
    <div class="containerheadright">
%	 if ($edit eq "ipinfo"){	 
            <input name="submit" value="save" type="submit">
%	 }else{
            <a href="ip-ws.html?id=<% $id %>">[refresh]</a>
            <a href="ip-ws.html?id=<% $id %>&_action=DELETE">[delete]</a>
            <a href="ip-ws.html?id=<% $id %>&edit=ipinfo">[edit]</a>
%	 }
    </div>

    <div class="containerbody">
      <!-- this is for the two-column layout of the body -->
      <table width="100%">
       <tr>
        <td width="50%" valign="top">

<%perl>
       my @field_headers;
       my @cell_data;

       push( @field_headers, "Address:" );
       push( @cell_data, "<strong>".$ui->text_field(object=>$o, column=>"address", edit=>$edit_ip, htmlExtra=>"style='width: 15em'", returnAsVar=>1)."/".$o->prefix."</strong>" );

       push( @field_headers, "Status:" );
            my $status;
            my @valid_block_status = qw ( Static Dynamic Reserved );
            if ( my $sn = $o->status->name ){
                if ( $edit eq "ipinfo" ){
                   $status = qq(<select name="Ipblock__).$o->id.qq(__statusname">);
                   foreach my $st ( @valid_block_status ){
                      if ( $st eq $sn ){
                         $status .= qq(<option value="$st" SELECTED>$st</option>);
                      }else{
                         $status .= qq(<option value="$st">$st</option>);
                      }
                   }
                   $status .= "</select>";
                }else{
                   $status = qq(<strong>$sn</strong>);
                }
            }
       push( @cell_data, $status );

       push( @field_headers, "Description:" );
       push( @cell_data, $ui->text_field(object=>$o, column=>"description", edit=>$edit_ip, htmlExtra=>"style='width: 25em'", returnAsVar=>1) );

       push( @field_headers, "Comments:" );
       push( @cell_data, $ui->text_area(object=>$o, column=>"info", edit=>$edit_ip, htmlExtra=>"cols=45", returnAsVar=>1) );

       if (!scalar($o->arecords)) {
           push( @field_headers, "&nbsp;" );
           push( @cell_data, "[Add DNS Records]" );
       }
</%perl>
<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>


%   if (scalar($o->arecords)) {
      <%perl>
                my @headers = ("DNS A Record", "Zone");
                my @rows;
                 foreach my $ar ($o->arecords){
                   push( @rows, 
                    [ eval {
                       if ($edit eq "ipinfo"){	 
                           qq(<input type="text" name="RR__).$ar->rr->id.qq(__name" value=").$ar->rr->name.qq(">);
                       }else{
                           qq(<a href="view.html?table=RR&id=).$ar->rr->id.qq(">).$ar->rr->name."</a>";
                       }
                      } ,
                     qq(<a href="view.html?table=Zone&id=).$ar->rr->zone->id.qq(">).$ar->rr->zone->mname."</a>"
                   ] );
                 } 
      </%perl>
      <& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>
%   } #endif arecords

%   if (scalar($o->services)){	   
      <%perl>
          my @headers = ("Service", "Contact List");
          my @rows;
          foreach my $ipservice ($o->services){
              push( @rows,
                [ eval {
                    if ($edit eq "ipinfo"){	 
                        $ui->select_lookup(object=>$ipservice, column=>"service", lookup=>"Service", edit=>$edit_ip);
	            }else{
		        qq(<a href="view.html?table=Service&id=).$ipservice->service->id.qq(">).$ipservice->service->name."</td></a>";
                    }
                  } ,
                  eval {
                    if ($edit eq "ipinfo"){
                        $ui->select_lookup(object=>$ipservice, column=>"contactlist", lookup=>"ContactList", edit=>$edit_ip);
                    }elsif ($o->entity){
                        qq(<a href="view.html?table=ContactList&id=).$ipservice->contactlist.qq(">).$ipservice->contactlist->name."</td></a>";
                    }
                  }
                ]  );
          } 
      </%perl>
      <& data_table.mhtml, field_headers=>\@headers, data=>\@rows &>
%   } #endif services


      </td>
      <td valign="top" width="50%">

<%perl>
    @field_headers = ();
    @cell_data = ();

    push( @field_headers, "Parent Block:" );
    push( @cell_data, 
        eval {
            if (defined($o->parent) && int($o->parent)){
                qq(<a href="ip-ws.html?id=).$o->parent->id.qq(">).$o->parent->address."/".$o->parent->prefix."</a>";
            }else{
                qq(<strong><font size="-1">(root block)</font></strong>);
            }
        }  );

    push( @field_headers, "First Seen:" );
    push( @cell_data, $ui->text_field(object=>$o, column=>"first_seen", edit=>$edit_ip, htmlExtra =>"style='width: 25em'", returnAsVar=>1) );

    push( @field_headers, "Last Seen:" );
    push( @cell_data, $ui->text_field(object=>$o, column=>"last_seen", edit=>$edit_ip, htmlExtra =>"style='width: 25em'", returnAsVar=>1) );

    push( @field_headers, "Interface:" );
    push( @cell_data, 
        eval {
            if ( $o->interface && $o->interface->id ){
                qq(<a href="interface.html?id=).$o->interface->id.qq(">).$o->interface->name."</a>";
            }else{
                "&nbsp;";
            }
        }  );

    push( @field_headers, "Device:" );
    push( @cell_data, 
        eval {
            if ( $o->interface && $o->interface->device ){
                qq(<a href="device.html?id=).$o->interface->device->id.qq(">).$ui->getobjlabel($o->interface->device, ", ")."</a>";
            }else{
                "&nbsp;";
            }
        }  );
</%perl>

%# actually output the table to the browser
<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

%     if ( $o->arpentries ){
        <%perl>
            @field_headers = ("ARP-cached by", "With MAC", "On");
            my @rows;
            foreach my $arpentry ($o->arpentries){
                push( @rows, 
                    [ "<a href=\"view.html?table=Interface&id=".$arpentry->arpcache->interface->id."\">".
                      $ui->getobjlabel($arpentry->arpcache->interface, ", ")."</a>"
                     ,
                      "<a href=\"view.html?table=PhysAddr&id=".$arpentry->physaddr->id."\">".$arpentry->physaddr->address."</a>"
                    ] );
            } 
        </%perl>
        <& data_table.mhtml, field_headers=>\@field_headers, data=>\@rows &>
%     }

           </td>
         </tr>
      </table>
    </div>
</div>

<!-- End IP Info Table -->

%} else {     
%#######################################################################################
%# View Block
%#######################################################################################

<!-- Block Info Table -->
<div class="container">

        <div class="containerheadleft">Block Info</div>
        <div class="containerheadright">
%	if ($edit eq "blockinfo"){	 
            <input name="submit" value="save" type="submit">
%	}else{
            <a href="ip-ws.html?id=<% $id %>">[refresh]</a>
            <a href="ip-ws.html?id=<% $id %>&_action=DELETE">[delete]</a>
            <a href="ip-ws.html?id=<% $id %>&edit=blockinfo">[edit]</a>
%       }
        </div>

    <div class="containerbody">
    <!-- this is for the two-column layout of the body -->
    <table width="100%">
     <tr>
      <td width="50%" valign="top">

<%perl>

my @field_headers = ( );
my @cell_data = ( );

    push( @field_headers, "Address:" );
    push( @cell_data, $ui->text_field(object=>$o, column=>"address", edit=>$edit_block, htmlExtra=>"style='width: 15em'", returnAsVar=>1)."/".$ui->text_field(object=>$o, column=>"prefix", edit=>$edit_block, htmlExtra =>"style='width: 2em'", returnAsVar=>1) );

    push( @field_headers, "Status:" );
    my $status;
	       my @valid_block_status = qw ( Container Subnet Reserved );
	       if ( my $sn = $o->status->name ){
	          if ( $edit eq "blockinfo" ){
                    $status .= "<select name=\"Ipblock__".$o->id."__statusname\">";
	            foreach my $st ( @valid_block_status ){
		      if ( $st eq $sn ){
  		         $status .= "<option value=\"".$st."\" SELECTED>".$st."</option>";
		      }else{
  		         $status .= "<option value=\"".$st."\">".$st."</option>";
		      }
		    }
		    $status .= "</select>";
                  }else{
	            $status .= "<strong>".$sn."</strong>";
                  }
	       }
    push( @cell_data, $status );

    push( @field_headers, "Description:" );
    push( @cell_data, $ui->text_field(object=>$o, column=>"description", edit=>$edit_block, htmlExtra =>"style='width: 25em'", returnAsVar=>1) );

    push( @field_headers, "Comments:" );
    push( @cell_data, $ui->text_area(object=>$o, column=>"info", edit=>$edit_block, htmlExtra=>"cols=45", returnAsVar=>1) );

    push( @field_headers, "Used by:" );
    my $used_by;
            if ($edit eq "blockinfo"){	 
                $used_by = $ui->select_lookup(object=>$o, column=>"entity", lookup=>"Entity", edit=>$edit_block, returnAsVar=>1);
            } elsif ($o->entity){
                $used_by = "<a href=\"view.html?table=Entity&id=".$o->entity->id."\">".$o->entity->name."</a>";
            }
    push( @cell_data, $used_by );

    my $delegate_dns = $ui->radio_group_boolean(object=>$o, column=>"dns_delegated", edit=>$edit_block, returnAsVar=>1);

# optionally, add more headers and content
if ($o->status->name eq "Subnet") {
      my $used = (scalar $o->children);
      my $total = $ipm->subnet_num_addr($o);
      my $avail = $total - $used;
      my $u = sprintf("%.1f", $used / $total * 100 );

    push( @field_headers, "Utilization:" );
    push( @cell_data, $used." of ".$total." (".$u."%), Avail: ".$avail );

    push( @field_headers, "Enable DHCP:" );
    push( @cell_data, $ui->radio_group_boolean(object=>$o, column=>"dhcp_enabled", edit=>$edit_block, returnAsVar=>1) );

    push( @field_headers, "Delegate DNS:" );
    push( @cell_data, $delegate_dns );
} elsif( $o->status->name eq "Container" ) {
    push( @field_headers, "Delegate DNS:" );
    push( @cell_data, $delegate_dns );
}

</%perl>

%# actually output the table to the browser
<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

    </td>
    <td width="50%" valign="top">

<%perl>

@field_headers = ( );
@cell_data = ( );

    push( @field_headers, "Parent Block" );
    if (defined($o->parent) && int($o->parent)){
        push( @cell_data, "<a href=\"ip-ws.html?id=".$o->parent->id."\">".$o->parent->address."/".$o->parent->prefix."</a>" );
    }else{
        push( @cell_data, "<strong><font size=\"-1\">(root block)</font></strong>" );
    }

    push( @field_headers, "Created:" );
    push( @cell_data, $o->first_seen );

    push( @field_headers, "Last Updated:" );
    push( @cell_data, $o->last_seen );

    if ($edit eq "blockinfo"){
        # don't show new subnet form

    }elsif ($o->status->name eq "Container"){
        push( @field_headers, "New subnet of length: /" );
        my $new_subnet_form = "
	     <form name=\"netdotform\" action=\"ip-ws.html\" method=\"POST\">
	     <input type=\"hidden\" name=\"id\" value=\"".$id."\">
	     <input type=\"hidden\" name=\"_action\" value=\"AUTOALLOCATE\">
	     <input type=\"hidden\" name=\"parent\" value=\"".$id."\">
	     <input type=\"text\" size = \"4\" name=\"length\" value=\"".($o->prefix + 1)."\">
	     <select name=\"strategy\">
	       <option value=\"first\">First Fit</option>
	       <option value=\"last\">Last Fit</option>
	     </select>
	     <input name=\"submit\" value=\"Allocate\" type=\"submit\">
        ";
        push( @cell_data, $new_subnet_form );

        push( @field_headers, "Choose Manually:" );
        push( @cell_data, "[view availablilty]" );

    }elsif ($o->status->name eq "Subnet"){
        push( @field_headers, "New address:" );
        my $new_address_form = "
	     <form name=\"netdotform\" action=\"ip-ws.html\" method=\"POST\">
	     <input type=\"hidden\" name=\"id\" value=\"".$id."\">
	     <input type=\"hidden\" name=\"_action\" value=\"AUTOALLOCATE\">
 	     <input type=\"hidden\" name=\"parent\" value=\"".$id."\">
             ";
	     if ($o->version == 4){
 	        $new_address_form .= "<input type=\"hidden\" name=\"length\" value=\"32\">";
	     }elsif ($o->version == 6){
	        $new_address_form .= "<input type=\"hidden\" name=\"length\" value=\"128\">";
	     }
             $new_address_form .= "
	     <select name=\"strategy\">
	       <option value=\"first\">First Fit</option>
	       <option value=\"last\">Last Fit</option>
	     </select>
	     <input name=\"submit\" value=\"Get\" type=\"submit\">
             ";
        push( @cell_data, $new_address_form );

        push( @field_headers, "Choose Manually:" );
        push( @cell_data, "[view availability]" );

   }
</%perl>

%# actually output the table to the browser
<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

      </td>
     </tr>

    </table>
    <!-- end two-column layout table -->
    </div>

</div>

<%perl>
# 
# Get children
#
my @children;  
if (scalar( @children = $ipm->getchildren($o->id) )){
</%perl>


       <div class="container">
          <div class="containerhead">
             Children Addresses/Blocks
          </div>
          <div class="containerbody">
          <& ipblock_list.mhtml, objects => \@children &>
          </div>
       </div>

% }
<!-- End Block Info Table -->
% } 
% if ($edit){	 
    </form>
% }


% }
</div>
