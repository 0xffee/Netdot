<& header, title =>'General Search' &>
<!-- begin search -->
<form action="search.html" method="POST">

<%perl>
my %arg;
foreach my $j ( keys %ARGS ) {
  next if( $ARGS{$j} !~ /\w+/ || $j eq "submit" );
# don't do this here...DEPRECATED
#  if( $j eq "q" ) {
#    $ARGS{$j} = "%" . $ARGS{$j} . "%" ; # munge for search_like
#  }
  $arg{$j} = $ARGS{$j};
}
</%perl>

<p><font size=+1>Netdot Search</font>

<form>
<table cellpadding="3" cellspacing="1" border="0" bgcolor="CCCCCC">
  <tr>
  <td><input type="text" name="q" size="25" value="<% $arg{q} %>"></td>
  <td><input name="submit" value="Submit" type="submit"></td>
  </tr>
</table>
</form>

% if( %arg ) {
    <table width="100%">
    <tr><td width="100%" bgcolor="#000099"> </td></tr>
    </table>
    <%perl>
    foreach my $meta ( Meta->retrieve_all() ) {
      my $tbl = $meta->name;
      undef( %linksto );
      map { my($j, $k) = split( /:/, $_ ); $linksto{$j} = $k } 
        split( /,/, $meta->linksto );
      foreach my $col ( $tbl->columns() ) {
        if( $linksto{$col} ) {
          foreach my $fc ( $linksto{$col}->columns() ) {
            foreach my $q ( split( /\s+/, $arg{q} ) ) {
              $q = "%" . $q . "%";
	      foreach my $hit ( $linksto{$col}->search_like( $fc => $q ) ) {
                map { $results{$tbl}{$_->id} = $_ } 
	          $tbl->search_like( $col => $hit );
	      }
            }
          }
        } else {
          foreach my $q ( split( /\s+/, $arg{q} ) ) {
            $q = "%" . $q . "%";
            map { $results{$tbl}{$_->id} = $_ } 
              $tbl->search_like( $col => $q );
          }
        }
      }
    }
    </%perl>

%   if( scalar( keys %results ) < 1 || ! %results ) {
      No matching records were found.
%   } else {
      <blockquote>
      <table cellpadding="0" cellspacing="0" border="0">
%     foreach my $tbl ( sort { $a cmp $b } keys %results ) {
%       next if( $tbl eq "Meta" );
%       my @objs;
%       map { push @objs, $results{$tbl}{$_} } keys %{ $results{$tbl} };
	<tr>
        <td colspan="2" bgcolor="#6ab1f0"><strong><% $tbl %></strong></td>
        </tr>
        <tr><td>
        <& sortresults2.html, table => $tbl, object => \@objs, view => "expanded" &>
        </td></tr>
%     } # end foreach tbl
      </table>
      </blockquote>
%   } # end else
% }
<br>
<!-- end search -->
<& footer &>

<%init>
use lib "/home/netdot/public_html/lib";
use Netdot::DBI;
use Data::Dumper;
use vars qw( %results %linksto );
undef( %results );
              
</%init>

<%doc>

######################################################################
# $Log: search.html,v $
# Revision 1.14  2003/06/03 22:16:22  netdot
# a few changes to make work with forked sortresults2.html for testing
#
# Revision 1.13  2003/06/03 20:43:25  netdot
# added blockquotes to space things out
#
# Revision 1.12  2003/05/23 16:48:38  netdot
# added html markers
#
# Revision 1.11  2003/05/14 23:48:50  netdot
# sort output of tables on display
#
# Revision 1.10  2003/05/14 23:44:07  netdot
# put value="blah" in the search box to echo back a person's search
# query.  otherwise, split the search query on whitespace and search on
# each term.
#
# Revision 1.9  2003/05/14 23:32:49  netdot
# added ability to search linksto/has_a relationships.  so, if a node is
# in the computing center (ie. Site=ComputingCenter), a search for
# 'computing center' will yield the Site and the Node.
#
# Revision 1.8  2003/05/14 16:38:49  netdot
# remove DBI stuff; now just use Meta table.
#
# Revision 1.7  2003/05/01 16:51:20  netdot
# *** empty log message ***
#
# Revision 1.6  2003/05/01 00:55:48  netdot
# more changes to make layout prettier
#
# Revision 1.5  2003/05/01 00:12:40  netdot
# supporting view argument in sortresults.html
#
# Revision 1.4  2003/04/30 23:55:42  netdot
# reflecting design in expview by carlos.  putting the name of the table
# on the page to distinguish among tables.
#
# Revision 1.3  2003/04/23 17:42:18  netdot
# now using sortresults.html module for processing presentation
#
# Revision 1.2  2003/04/23 17:16:52  netdot
# nothing for now; just putting this in rcs
#
# Revision 1.1  2003/04/23 17:13:08  netdot
# Initial revision
#
</%doc>
