<%doc>

Cable management stuff...

</%doc>


<%args>
$id          => undef;
$backbone_id => undef;
$edit        => undef;
</%args>

<%flags>
inherit => 'section_cable.html' 
</%flags>

<%attr>
title   => 'Cable Strand' 
section => 'Plant'
</%attr>

<%init>
my $DEBUG      = 0;
my $o          = undef;
my $editStrand = 0;

if ($id && $id ne "NEW")  {
    $o = CableStrand->retrieve($id);
    $backbone_id = $o->cable;
}

$editStrand = 1 if ($id eq "NEW" || $edit eq "strandinfo");

# For attribute_table.mhtml
my (@field_headers, @cell_data);
</%init>

<%perl>
print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;

# code for inserting/updating
# -----------------------------------------------------------------------------
if (defined($ARGS{_action})) {
    print "ARGS is <pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
    
    my %update_info = ();
    if (!(%update_info = $ui->form_to_db(%ARGS))) {
        $m->comp("error.mhtml", error => $ui->error());
	}

    if ($update_info{CableStrand}{id}) {
        $id = (keys %{$update_info{CableStrand}{id}})[0];
        $editStrand = 0;
    }
    
    # Do this to 'flush' the values associated with the object
    # before redisplaying
    $o = undef;
    $o = CableStrand->retrieve($id) if ($id && $id ne "NEW");

    # Special case for splices, store in many to many table...
    if (defined($ARGS{__splice1}) || defined($ARGS{__splice2})) {
        # first delete all splices for this cable strand.
        $m->comp("error.mhtml", $cable_manager->error()) if (!($cable_manager->deletesplices($o)));
        
        # and now add back any splices...
        my @splices = ("__splice1", "__splice2");
        foreach my $sp (@splices) {
            next if (!defined($ARGS{$sp}) || $ARGS{$sp} eq "");
            $m->comp("error.mhtml", $cable_manager->error()) if (!($cable_manager->insertsplice($o, CableStrand->retrieve($ARGS{$sp}))));
        }
    }
}
# end insertion/update code
# -----------------------------------------------------------------------------
</%perl>     

% # interface...
% # ---------------------------------------------------------------------------
<!-- Header Table -->
<div class="container">
<div class="containerheadleft">
        Cable Strand:
% 		if (defined($o)) {
        <% $o->name %>
%		}
</div>
<div class="containerheadright">
        <form name="netdotform" action="cable_strand.html" method="POST">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="_action" value="<% $id eq "NEW" ? "NEW" : "UPDATE" %>">
%           if ($editStrand) {
            <input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);"> &nbsp;&nbsp; <input name="submit" value="save" type="submit">
%           } else {
            <a href="cable_strand.html?id=NEW">[new]</a> &nbsp;&nbsp; <a href="cable_strand.html?id=<% $id %>&edit=strandinfo">[edit]</a> &nbsp;&nbsp;<a href="delete.html?table=CableStrand&id=<% $id %>">[delete]</a>
%           }
</div>
<!-- End Header Table -->
<div class="containerbody">
        <table> <!-- Two column layout table -->
        <tr>
            <td width="50%">

	      <%perl>
	      (@field_headers, @cell_data) = ();
	      push( @field_headers, "Name: " );
	      push( @cell_data, $ui->text_field(object=>$o, table=>"CableStrand", column=>"name", edit=>$editStrand, returnAsVar=>1) );
	      push( @field_headers, "Number: " );
	      push( @cell_data, $o ? $o->number : "" );
	      push( @field_headers, "Backbone: " );

	      if (!$editStrand) {
		  push( @cell_data, '<a href="cable_backbone.html?id='.$o->cable.'">'.$o->cable->name.'</a>' );
	      } else {
		  push( @cell_data, $ui->select_lookup(object=>$o, table=>"CableStrand", column=>"cable", lookup=>"BackboneCable", edit=>$editStrand, returnAsVar=>1) );
	      }

	      push( @field_headers, "Status: " );
	      push( @cell_data, $ui->select_lookup(object=>$o, table=>"CableStrand", column=>"status", lookup=>"StrandStatus", edit=>$editStrand, returnAsVar=>1) );
	      push( @field_headers, "Spliced with: " );
	      </%perl>

	      <&| "HERE.mhtml" &>
%               if (!$editStrand) {
%                   my @splices = $o->splices;
%                   if (scalar(@splices)) {
                        <a href="cable_stranif (!$editStrand) {d.html?id=<% $splices[0]->strand2->id %>"><% $splices[0]->strand2->name %></a>
%                   }
%                   if (scalar(@splices) == 2) {
                        , <a href="cable_strand.html?id=<% $splices[1]->strand2->id %>"><% $splices[1]->strand2->name %></a> 
%                   }
%               } elsif ($editStrand && defined($o)) {
                <%perl>
                # first we need to grab all backbones for start and end sites of this strand.
                my ($start_site, $end_site) = ($o->cable->start_closet->floor->site, $o->cable->end_closet->floor->site);
                my @backbones = ();
                foreach my $closet (($start_site->closets, $end_site->closets))
                {
                    map { push (@backbones, $_) } (BackboneCable->search(start_closet=>$closet),
                                                   BackboneCable->search(end_closet=>$closet));
                }
                </%perl>
                <script language="JavaScript">
                <!--
                function lookupStrands(bb_id, field_name, form_name)
                {
                    if (!bb_id)
                    {
                        alert("You must select a backbone.");
                    }
                    var url = "strand_backbone_list_query.html?bb_id=";
                    url += bb_id + "&field_name=" + field_name;
                    url += "&form_name=" + form_name;
                    var wind = window.open(url, "tmp", "width=1,height=1");
                    wind.blur();
                }
                -->
                </script>
                <SELECT NAME="backbone_list_srch1" onChange="lookupStrands(this.value, '__splice1', 'netdotform');">
                <OPTION VALUE="">Lookup by Backbone</OPTION>
                <%perl>
                my @splices = $o->splices;
                my %stored = ();
                foreach my $bb (sort { $a->name cmp $b->name } @backbones)
                {
                    next if ($bb->id == int($o->cable) || exists($stored{$bb}));
                    $stored{$bb} = 1;
                    printf("<OPTION VALUE=\"%s\">%s</OPTION>\n", $bb->id, $bb->name);
                }
                </%perl>
                </SELECT> &nbsp; 
                <select name="__splice1">
                <option value="">-- Make your selection --</option>
%               if (scalar(@splices)) {
                <option value="<% $splices[0]->strand2->id %>" SELECTED><% $splices[0]->strand2->name %></option>
%               }
                <option value="">[null]</option>
                </select>
                <br>
                <SELECT NAME="backbone_list_srch2" onChange="lookupStrands(this.value, '__splice2', 'netdotform');">
                <OPTION VALUE="">Lookup by Backbone</OPTION>
                <%perl>
                %stored = ();
                foreach my $bb (sort { $a->name cmp $b->name } @backbones)
                {
                    next if ($bb->id == int($o->cable) || exists($stored{$bb}));
                    $stored{$bb} = 1;
                    printf("<OPTION VALUE=\"%s\">%s</OPTION>\n", $bb->id, $bb->name);
                }
                </%perl>
                </SELECT> &nbsp; 
                <select name="__splice2">
                <option value="">-- Make your selection --</option>
%               if (scalar(@splices) == 2) {
                <option value="<% $splices[1]->strand2->id %>" SELECTED><% $splices[1]->strand2->name %></option>
%               }
                <option value="">[null]</option>
                </select>
%               } 
              </&>
	      <%perl>
	      push( @cell_data, $_ );

	      if (defined($o) && !$editStrand) {    
		  push( @field_headers, "Part of Sequence:" );
		  my @strands = ($o);
		  push( @cell_data, $m->scomp( "display_sequence.mhtml", strands=>\@strands ) );
	      }

	      push( @field_headers, "Circuit: " );
              push( @cell_data, $ui->select_lookup(object=>$o, table=>"CableStrand", column=>"circuit_id", lookup=>"Circuit", 
						   edit=>$editStrand, returnAsVar=>1, linkPage => "circuit.html") );

	      </%perl>

	      <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

            </td>
            <td width="50%">
           
	      <%perl>
	      (@field_headers, @cell_data) = ();
	      push( @field_headers, 'Tested on: <font size="-1">(yyyy-mm-dd)</font>: ' );
	      push( @cell_data, $ui->text_field(object=>$o, table=>"CableStrand", column=>"datetested", edit=>$editStrand, returnAsVar=>1) );
	      push( @field_headers, "Fiber Type: " );
	      push( @cell_data, $ui->select_lookup(object=>$o, table=>"CableStrand", column=>"fiber_type", lookup=>"FiberType", edit=>$editStrand, returnAsVar=>1) );
	      push( @field_headers, "Loss: " );
	      push( @cell_data, $ui->text_field(object=>$o, table=>"CableStrand", column=>"loss", edit=>$editStrand, returnAsVar=>1) );
	      push( @field_headers, "Direction: " );
	      </%perl>

	      <&| "HERE.mhtml" &>
%               if ($editStrand) {
%                   my $dir_name = "CableStrand__" . $id . "__direction";
	            <input type="radio" name="<% $dir_name %>" value="0" <% ($o && int($o->direction) == 0 ? "CHECKED" : "") %>>TX &nbsp;&nbsp;&nbsp; 
	            <input type="radio" name="<% $dir_name %>" value="1" <% ($o && int($o->direction) == 1 ? "CHECKED" : "") %>>RX
%               } elsif (defined($o)) {
	            <% (int($o->direction) == 1 ? "RX" : "TX") %>
%               }
	      </&>
	      <%perl>
	      push( @cell_data, $_ );
	      push( @field_headers, "Description: " );
	      push( @cell_data, $ui->text_field(object=>$o, table=>"CableStrand", column=>"description", edit=>$editStrand, returnAsVar=>1) );
	      </%perl>

	      <& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

	    </td>
	  </tr>
	</table>
	<div class="containerseparator">Comments:</div>
%           $ui->text_area(object=>$o, table=>"CableStrand", column=>"info",
%                         edit=>$editStrand, htmlExtra=>"rows='3' cols='80'");
        </form>
</div>
</div>

<!-- End Cable Strand Table -->
