<%perl>
foreach	my $arg (keys %ARGS){
	next if ($ARGS{$arg} !~ /\w+/ || $arg eq 'submit');
	$args{$arg} = $ARGS{$arg};	
}	

$table = $args{table};
$obj = $table->retrieve($args{id});

# Get some Meta info
$mi = (Meta->search( name => $args{table} ))[0];
undef( %linksto );
map { my($j, $k) = split( /:/, $_ ); $j = lc($j); $linksto{$j} = $k }
   split( /,/, $mi->linksTo );
undef( %linksfrom );
map { my($i, $j, $k) = split( /:/, $_ ); $linksfrom{$i}{$j} = $k }
   split( /,/, $mi->linksFrom );
</%perl>
<p>
<& header, title=>" $table Details" &>

%#  Display-only option
%if( !$args{edit} ) {

% # First show values that are not foreign keys
<p> 
<table cellpadding="3" cellspacing="1" border="0" bgcolor="CCCCCC">
<tr> 
<td>id:</td><td><strong><% $obj->id %></strong></td>
</tr>
%   foreach my $c ($table->columns()){
%      next if ($c eq 'id');
%      if (!exists($linksto{$c}) ){
          <tr> 
	  <td><% $c %>:</td><td><strong><% $obj->$c %></strong></td>
	  </tr>
%      }
%   }
</table>

%foreach my $fk (keys %linksto){
   <p>
   <table cellpadding="3" cellspacing="1" border="0" bgcolor="CCCCCC">
   <tr><td>
   <strong><% $fk %>:</strong>
%  my $fkobj;
%  unless( defined($fkobj = $linksto{$fk}->retrieve($obj->$fk->id) )){
     n/a</td></tr></table> 
%    next;
%  }
   <& sortresults.html, table => $linksto{$fk}, object => [$fkobj]  &>
   </td></tr>
   </table>
%}

%}elsif( $args{edit} ) {

   <form action="update.html" method="POST">
   <table cellpadding="3" cellspacing="1" border="0" bgcolor="CCCCCC">
   <tr>
   <td bgcolor="#DDDDDD"><strong>id</strong></td><td><input type="hidden" name="id"><% $obj->id %></input></td>
   </tr>
%  foreach my $c ($table->columns()){
%     next if ($c eq 'id');
%     if (!exists($linksto{$c}) ){  # The column is 'local'
         <tr> 
         <td bgcolor="#DDDDDD"><strong><% $c %>:</strong></td><td><input type="text" size="40" value="<% $obj->$c %>"</td>
	 </tr>
%     } else {  # The column is a foreign key. Provide a list to select.
         <tr>
	 <td bgcolor="#DDDDDD"><strong><% $c %>:</strong></td>
	 <td>
%         my $t = (Meta->search( name => $linksto{$c} ))[0];
%         if( ! defined( $t ) ) {
            No <% $linksto{$c} %> in Meta table
%         } elsif( $obj->$c->id == 0 ) {
	    -
%         } else {
%           my $lbl = $t->label;
            <select name="$c">
	    <option value="<% $obj->$c->id %>" selected><% $obj->$c->$lbl %></option>
%	    my @fkobjs = $linksto{$c}->retrieve_all; 
%	    foreach my $fkobj (@fkobjs){
%	      next if ($fkobj->id == $obj->$c->id);  # exclude current val from list
              <option value="<% $fkobj->id %>"><% $fkobj->$lbl %></option>
%           }
            </select>
	    </td></tr>        
%        } 

%    }
%  }
   </tr>
   <tr><td bgcolor="#FFFFFF"align=center colspan=2>
   <input name="submit" value="Update" type="submit">
   </tr></td>
   </form>
   </table>

%} #endif ($args{edit})
<p><br>
<& footer &>

<%init>
use lib "/home/netdot/public_html/lib";
use Netdot::DBI;
use Data::Dumper;
my( %args, %linksto, %linksfrom, $obj, $table, $mi );
               
</%init>
