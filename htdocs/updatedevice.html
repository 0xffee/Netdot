<& index.html, title => "Device Discovery: $host ", s2name => $s2name  &>
<table align="center" valign="top" cellpadding="0" cellspacing="0" border="0" width="95%" class="tablebackground">
<tr><td>
<%perl>
    if ( $action eq "discover" ){

    # See if device exists
    my ($c, $d) = $dm->find_dev($host);
    $argv{comstr} = (defined($c)) ? $c : $comstr;
    $argv{device} = (defined($d)) ? $d : "";
    
    # Fetch SNMP info
    my $dev = $dm->get_dev_info($host, $comstr);
    unless ($dev){
	$m->comp('error.mhtml', error => $dm->error);
    }
    $argv{dev} = $dev;
    $argv{host} = $host;
    $session->{argv} = \%argv;
</%perl>
    <form action="updatedevice.html" method="POST">
    <input type="hidden" name="sid" value="<% $session->{_session_id} %>">
    <input type="hidden" name="host" value="<% $host %>">
    <input type="hidden" name="action" value="update">
    <table class="formtablebg" cellpadding="0" cellspacing="2" width="100%">
      <tr>
        <td>&nbsp;</td>
        <td align="left">
	  <pre><% $dm->output %></pre>
	</td>
      </tr>
      <tr><td colspan="2">&nbsp;</td></tr>
      <tr>
        <td class="formtablec1">Description:</td>
        <td class="formtablec2"><strong><% $dev->{sysdescription} %></strong></td>
      </tr>
%     unless ($argv{device}){      
      <tr>
        <td colspan="2" align="left"><br></td>
      </tr>
      <tr>
        <td colspan="2" align="center"><strong> Please provide the following:</strong></td>
      </tr>
      <tr>
        <td class="formtablec1">Entity:</td>
        <td class="formtablec2">
           <select name="entity">
%	   my @allents = Entity->retrieve_all; 
%          @allents = sort { $a->name cmp $b->name } @allents;
%          foreach my $ent (@allents){
	         <option value="<% $ent->id %>"><% $ent->name %></option>
%	   }	
   	   <option value="0">[null]</option>
	   </select>
	</td>
      </tr>
      <tr>
        <td class="formtablec1">Site:</td>
        <td class="formtablec2">
           <select name="site">
%	   my @allsites = Site->retrieve_all; 
%          @allsites = sort { $a->name cmp $b->name } @allsites;
%          foreach my $site (@allsites){
	         <option value="<% $site->id %>"><% $site->name %></option>
%	   }	
   	   <option value="0">[null]</option>
	   </select>
	</td>
      </tr>
      <tr>
        <td class="formtablec1">Contact Group:</td>
        <td class="formtablec2">
           <select name="contactlist">
%	   my @allcls = ContactList->retrieve_all; 
%          @allcls = sort { $a->name cmp $b->name } @allcls;
%          foreach my $cl (@allcls){
	         <option value="<% $cl->id %>"><% $cl->name %></option>
%	   }	
   	   <option value="0">[null]</option>
	   </select>
	</td>
%     }
      <tr><td colspan="2">&nbsp;</td></tr>
      <tr class="rowtitle0">
        <td colspan="2" align="center">
         <input name="insert" value="Update" type="submit">&nbsp;
         <input name="cancel" value="Cancel" type="submit">
        </td>
      </tr>
      </form>
    </table>
<%perl>
}elsif ( $action eq "update" ){
    if ( $insert ){
        %argv = %{ $session->{argv} };
	$argv{entity}      = $entity      ||  0;
	$argv{site}        = $site        ||  0;
	$argv{contactlist} = $contactlist ||  0;

        # Update database
        $argv{addsubnets} = $ADDSUBNETS;
        $o = $dm->update(%argv);
        unless ($o){
            $m->comp('error.mhtml', error => $dm->error);
        }
        for my $ver (qw (4 6)){
            unless( $ipm->build_tree($ver) ){
                printf("Could not rebuild IPv%s space tree!: %s\n", $ver, $ipm->error);
            }
        }
        unless ($o->name && ($name = $o->name->name)){
            $name = "device"
            }
</%perl>
          <p>
          <table class="formtablebg" cellpadding="0" cellspacing="0" width="100%">

%      if ($dm->output){
	  <tr>
          <td>
          <pre><% $dm->output %></pre>
          </td>
	  </tr>
%      }
	  <tr>
          <td>
	    Go to <a href="device.html?id=<% $o->id %>"><% $name %></a>
          </td>
	  </tr>
          </table>
%  }elsif ( $cancel ){
          <p>
          <table class="formtablebg" cellpadding="0" cellspacing="0" width="100%">
	  <tr>
          <td>Discovery of <% $host %> cancelled.
          </td>
	  </tr>
          </table>
%  }

<%perl>
}else{
    $m->comp('error.mhtml', error => "Unknown action: $action");
}
</%perl>

<td></tr>
</table>
<& footer.mhtml &>

<%args>
$action
$host
$comstr      => "public"
$id          => undef
$s2name      => "Management"
$sid         => undef
$insert      => undef
$cancel      => undef
$entity      => undef
$site        => undef
$contactlist => undef
</%args>

<%init>
my $DEBUG = 0;
my $TMP;
my $ADDSUBNETS = 1;

my $ui = Netdot::UI->new();
my $dm = Netdot::DeviceManager->new();
my $ipm = Netdot::IPManager->new();
my $dns = Netdot::DNSManager->new();
my $o;
my $name;
my %argv;
my $session;

print Dumper(%ARGS) if $DEBUG;

if( $action eq "discover" && ! $sid ) {
  $session = $ui->mksession( $TMP );
}
if( $sid ) {
  $session = $ui->getsession( $TMP, $sid );
}
if( $cancel ) {
  $ui->rmsession( $session );
}

</%init>

<%doc>

Web interface for device discovery and updates

</%doc>
