<%doc>

User Interface for Hosts
    
</%doc>

<%args>
$id             => undef
$user           => $ui->get_current_user($r)
$rr             => undef
$ipblock        => undef
$action         => undef
$zone           => undef
$submit         => undef
$delete_ip      => undef
$add_ptr        => undef
</%args>

<%init>
my $DEBUG = 0;
print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;
my @rraddrs;
my %rrs;
my $edit;
my $deleted_label;

my $manager = $ui->get_permission_manager($r);

if ($id) {
    $rr = RR->retrieve($id);
}elsif ($rr && !ref $rr) {
    $rr = RR->retrieve($rr);
    $id = $rr->id;
}

# Check if user can view this object 
if ( $rr ){
    unless ( $manager && $manager->can($user, "view", $rr) ){
	$m->comp('/generic/error.mhtml', error=>"You don't have permission to view this object");
    }
}
if ($ipblock && !ref $ipblock) {
    $ipblock = Ipblock->retrieve($ipblock);
    unless ( $manager && $manager->can($user, "view", $ipblock) ){
	$m->comp('/generic/error.mhtml', error=>"You don't have permission to view this object");
    }
}

if ( $submit ){
    if ( $rr && $action eq 'delete_confirm' ){

	# Check if user can delete this object 
	unless ( $manager && $manager->can($user, "delete", $rr) ){
	    $m->comp('/generic/error.mhtml', error=>"You don't have permission to delete this object");
	}
	my @ips = map { $_->ipblock } $rr->arecords();
	$deleted_label = $rr->get_label();
	$rr->delete();
	if ( @ips && $delete_ip ){
	    foreach my $ip ( @ips ){
		$ip->delete();
	    }
	}
	undef $rr;
	$action = 'deleted';

    }elsif ($rr || $id || $ipblock || $action eq 'new') {
	# insert/update
	eval {
	    
	    my $user_type = $user->getAttribute('USER_TYPE');
	    # For unprivileged users, we apply restrictions
	    # on RR names
	    if ( $user_type eq 'user' ){
		foreach my $key ( %ARGS ){
		    if ( $key =~ /RR__(?:NEW|\d+)__(.*)$/ ){
			my $name = $1;
			RR->validate_name($name);
		    }
		}
	    }
	    
	    my %ret = $ui->form_to_db(%ARGS);
	    print 'form_to_db returned: <pre>', Dumper(%ret), '</pre><br>' if $DEBUG;    
	    
	    if (exists $ret{RR}) {
		my $newid = (keys %{$ret{RR}{id}})[0];
		if ($ret{RR}{id}{$newid}{action} eq 'INSERTED') {
		    $id = $newid;
		    $rr = $newid;
		    if (defined $ipblock) {
			RRADDR->insert({rr=>$newid, ipblock=>$ipblock});
		    }
		}
	    }
	};
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);
	} else {
	    $submit = 0;
	    $action = "";
	}
    }
}else{
    $rrs{$rr->id} = $rr if $rr;

    if ( $ipblock ){
        if (my @arecords = $ipblock->arecords()) {
	    foreach my $arecord (@arecords) {
		$rrs{$arecord->rr->id} = $arecord->rr;
	    }
	}
    }
}

</%init>

<%perl>
print '<form name="netdotform" action="host.html" method="POST">';
print '<script language="javascript" src="../java_script/datechooser.js"></script>';

if ( $rr && $action eq 'delete' ){
    print '<div class="container">';
    print '<div class="containerhead"><b>Delete Records</b></div>';
    print '<div class="containerbody">';
   
    print '<p>';
    print '<strong>Are you sure you want to delete the records below?</strong>';
    print '<p>';
    if ( $rr->arecords ){
	print '<p>';
	print 'Delete associated IP(s) too <input type="checkbox" name="delete_ip" CHECKED>';
    }
    print '<p>';
    print '<input type="hidden" name="id" value="'.$rr.'">';
    print '<input type="hidden" name="action" value="delete_confirm" >';
    print '<input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);"> ';
    print '<input type="submit" name="submit" value="yes" >';
    print '</div>';
    print '</div>';
    print '<p>';
}
print '<div class="container">';

my (@field_headers, @cell_data);

print '<div class="containerheadleft"><b>Host</b></div>';
print '<div class="containerheadright">';
if ($action eq 'new') {
    if ($ipblock) {
	print '<input type="hidden" name="ipblock" value="'.$ipblock.'">';
    }
    print '<input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">';
    print '<input type="submit" name="submit" value="save" >';
    print '<input type="hidden" name="action" value="new" >';
} elsif ($ipblock) {
	print '<a href="host.html?ipblock='.$ipblock.'&action=new">[new]</a>';
} elsif (!($id || $rr || $ipblock)) {
	print '<a href="host.html?action=new">[add]</a>';
}else{
    print '&nbsp;'
}

print '</div>'; #close containderheadright
print '<div class="containerbody"><br>';


my %comphash = (field_headers=>\@field_headers, data=>\@cell_data, 
		width=>"1", headercolwidth=>"15%", datacolwidth=>"85%");

if ($action eq 'new') {
    print '<div class="container" style="width:80%;margin-left:20px">';
    print '<div class="containerhead"><b>New Record</b></div>';
    print '<div class="containerbody">';

    $ui->add_to_fields(edit=>1, table=>'RR', fields=>['name'],
		       field_headers=>\@field_headers, cell_data=>\@cell_data);

    if ( defined $zone ){
	unless ( ref($zone) ){
	    $zone = Zone->retrieve($zone);
	}
    }elsif ( $ipblock ){
	unless ( ref($ipblock) ){
	    $ipblock = Ipblock->retrieve($ipblock);
	}
	$zone = $ipblock->forward_zone();
    }
    
    if ( $zone ){
	print '<input type="hidden" name="RR__NEW__zone" value="'.$zone.'">';
	push @field_headers, 'Zone:';
	push @cell_data, $zone->get_label;

    }else{
	my %args = (edit=>1, table=>'RR', fields=>['zone'],
		    field_headers=>\@field_headers, cell_data=>\@cell_data,
		    linkpages=>['zone.html']);
	
	$ui->add_to_fields(%args);
    }

    $m->comp('/generic/attribute_table.mhtml', %comphash);
    (@field_headers, @cell_data) = ((),());

    print '</div>'; #close containerbody of 'new'
    print '</div>'; #close container of 'new'

}elsif ( $action eq 'deleted' ){
    print '<p>';
    print 'Record '.$deleted_label.' has been deleted';
    print '</div>';
    print '</div>';
    print '<p>';
}

</%perl>

<script type="text/javascript" language="javascript">
var uricomponents = new Array();
function dynamicAdd(table, id, toAdd, rrFieldName) {
    if (toAdd == 1) {
	document.getElementById(table+"_div_"+id).innerHTML=decodeURIComponent(uricomponents[table+"_"+id.toString()+"_content"]);
	document.getElementById(table+"_"+id).innerHTML="<input type='button' name='cancel_button' value='cancel' onClick='dynamicAdd(\""+table+"\", \""+id+"\", 0)'><input type='submit' name='submit' value='save'>";
	if (rrFieldName != "") {
	    document.getElementById(table+"_"+id).innerHTML+="<input type='hidden' name='"+table.toUpperCase()+"__NEW__"+rrFieldName+"' value='"+id+"'>";
	}
    } else {
	document.getElementById(table+"_div_"+id).innerHTML="";
	document.getElementById(table+"_"+id).innerHTML="<a href='#' onClick='dynamicAdd(\""+table+"\", \""+id+"\", 1)'>[add]</a>";
    }
}
</script>


<%perl>

foreach my $o ( values %rrs ) {
    if ($action eq 'edit' && $rr->id == $o->id) {
	$edit = 1;
    } else {
	$edit = 0;
    }

    print '<input type="hidden" name="rr" value="'.$o.'">';
    
    print '<div class="container" style="width:80%;margin-left:20px">';
    print '<div class="containerheadleft"><b>'.$o->get_label.'</b></div>';
    print '<div class="containerheadright">';
    if ( $edit ) {
	print '<input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">';
	print '<input type="submit" name="submit" value="save" >';
    } else {
	print '<a href="host.html?rr='.$o.'">[refresh]</a>&nbsp;';
	if ( $manager && $manager->can($user, "edit", $o) ){
	    print '<a href="host.html?rr='.$o.'&action=edit">[edit]</a>&nbsp;';
	}
	if ( $manager && $manager->can($user, "delete", $o) ){
	    print '<a href="host.html?id='.$o.'&action=delete">[delete]</a>';
	}
    }
    print '</div>';

    $ui->add_to_fields(edit=>$edit, o=>$o, fields=>['name', 'zone', 'expiration'],
		       field_headers=>\@field_headers, cell_data=>\@cell_data,
		       linkpages=>['', 'zone.html', '']);
    $m->comp('/generic/attribute_table.mhtml', %comphash);
    (@field_headers, @cell_data) = ((),());

    
    my @arecs = $o->arecords();

    #####################################################################################################
    #RRADDR
    if ( !$o->cnames ){
	print '<div class="container" style="margin-left:10px">';
	print '<div class="containerheadleft"><b>Address(es)</b></div>';
	print '<div class="containerheadright">';

	#new rraddr
	if (!RRCNAME->search(name=>$o->id)) {
	    push( @field_headers, ("IP", "TTL") );
	    push( @cell_data, "<input name='RRADDR__NEW__ipblock' value='' type='text'>" );
	    push( @cell_data, "<input name='RRADDR__NEW__ttl' value='' type='text'>" );
	    my $newrraddr = $m->scomp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
	    $newrraddr =~ s/\n//g;
	    $newrraddr =~ s/<script.*?<\/script>//g;
	    $newrraddr =~ s/'/\\'/g;
	    print '<script type="text/javascript" language="javascript">uricomponents[\'rraddr_'.$o.'_content\']=encodeURIComponent(\''.$newrraddr.'\');</script>';
	    print '<div id="rraddr_'.$o.'"><a href="#" onClick="dynamicAdd(\'rraddr\', \''.$o.'\', 1, \'rr\')">[add]</a></div>';
	} else {
	    print "&nbsp;";
	}
	print '</div>';  #close containerheadright

	#display/edit rraddr
	print '<div class="containerbody">';
	foreach my $arecord (@arecs) {
	    my $ipblock = $arecord->ipblock;
	    if ( $ipblock == 0 ){
		# This record should not exist then
		$arecord->delete;
		next;
	    }

	    push( @field_headers, "IP");
	    if ($edit) {
		push( @cell_data, "<input name='RRADDR__".$arecord."__ipblock' value='".$ipblock->address."' type='text'>" );
	    } else {
		push( @cell_data, "<a href='ip.html?id=".$ipblock."'>".$ipblock->address."</a>");
	    }
	    $ui->add_to_fields(o=>$arecord, edit=>$edit, fields=>['ttl'],
			       field_headers=>\@field_headers, cell_data=>\@cell_data,
			       linkpages=>['']);

	    if ( $edit ){
		push @field_headers, 'Delete';
		push @cell_data, '<input type="checkbox" name="RRADDR__'.$arecord.'__DELETE">';
	    }
	    
	    ################################################################
	    # DHCP host scope
	    # Do not show ethernet field unless the subnet has DHCP enabled
	    if ( ($ipblock->parent != 0) && $ipblock->parent->dhcp_scopes ) {
		my $gscope = $ipblock->parent->dhcp_scopes->first->container;
		
		push @field_headers, 'Ethernet: ';
		if ( my $scope  = $ipblock->dhcp_scopes->first ){
		    my $phys = $scope->physaddr();
		    if ( $phys == 0 ){
			# This scope should not exist then
			$scope->delete();
		    }else{
			if ( $edit ){
			    push( @cell_data, '<input name="DhcpScope__'.$scope.'__physaddr" value="'.$phys->address.'" type="text">' );
			}else{
			    push( @cell_data, '<a href="mac.html?id='.$phys.'">'.$phys->address.'</a>' );
			}
		    }
		}else{
		    if ( $edit ){
			print '<input name="DhcpScope__NEW__container" value="'.$gscope.'" type="hidden">';
			print '<input name="DhcpScope__NEW__type" value="host" type="hidden">';
			print '<input name="DhcpScope__NEW__name" value="'.$ipblock->address.'" type="hidden">';
			print '<input name="DhcpScope__NEW__ipblock" value="'.$ipblock.'" type="hidden">';
			push( @cell_data, '<input name="DhcpScope__NEW__physaddr" value="" type="text">' );
		    }else{
			push( @cell_data, '&nbsp;' );
		    }
		}
		
	    }
	    $m->comp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
		
	}

	print '<div id="rraddr_div_'.$o.'"></div>';
	print '</div></div>';


	#####################################################################################################
	#RRHINFO
	print '<div class="container" style="margin-left:10px">';
	print '<div class="containerheadleft"><b>Hardware Information (HINFO)</b></div>';
	print '<div class="containerheadright">';

	my $defaults = [ {'PC-INTEL'=>'PC-Intel' , 'MAC-INTEL'=>'Mac-Intel', 
			  'MAC-PPC'=>'Mac-PowerPC', 'OTHER'=>'Other'}, 
			 {'WINDOWS'=>'Windows', 'MACOS'=>'Mac OS', 
			  'LINUX'=>'Linux', 'OTHER'=>'Other'} ];
	
	if ( !$o->hinfo_records ){
	    #new rrhinfo
	    $ui->add_to_fields(table=>'RRHINFO', edit=>1, fields=>['cpu', 'os', 'ttl'],
			       field_headers=>\@field_headers, cell_data=>\@cell_data,
			       defaults =>$defaults,
			       linkpages=>['view.html','view.html','']);
	    
	    my $newhinfo = $m->scomp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
	    
	    $newhinfo =~ s/\n//g;
	    $newhinfo =~ s/<script.*?<\/script>//g;
	    $newhinfo =~ s/'/\\'/g;
	    print '<script type="text/javascript" language="javascript">uricomponents[\'rrhinfo_'.$o.'_content\']=encodeURIComponent(\''.$newhinfo.'\');</script>';
	    print '<div id="rrhinfo_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrhinfo\', \''.$o.'\', 1, \'rr\')">[add]</a></div>';
	}else{
	    print '&nbsp;';
	}
	print '</div>';  #close containerheadright

	#display/edit
	print '<div class="containerbody">';
	if (my @hinfos = $o->hinfo_records()) {
	    foreach my $hinfo (@hinfos) {
		$ui->add_to_fields(o=>$hinfo, edit=>$edit, fields=>['cpu', 'os', 'ttl'],
				   field_headers=>\@field_headers, cell_data=>\@cell_data,
				   defaults =>$defaults,
				   linkpages=>['view.html','view.html',''], with_delete=>1		
		    );
		$m->comp('/generic/attribute_table.mhtml', %comphash);
		(@field_headers, @cell_data) = ((),());
	    }
	}

	print '<div id="rrhinfo_div_'.$o.'"></div>';
	print '</div></div>';

	#####################################################################################################
	#RRTXT
	print '<div class="container" style="margin-left:10px">';
	print '<div class="containerheadleft"><b>Text Records (TXT)</b></div>';
	print '<div class="containerheadright">';
	
	#new rrtxt
	$ui->add_to_fields(table=>'RRTXT', edit=>1, fields=>['txtdata', 'ttl'],
			   field_headers=>\@field_headers, cell_data=>\@cell_data,
			   linkpages=>['view.html','']);
	my $newtxt = $m->scomp('/generic/attribute_table.mhtml', %comphash);
	(@field_headers, @cell_data) = ((),());
	$newtxt =~ s/\n//g;
	$newtxt =~ s/<script.*?<\/script>//g;
	$newtxt =~ s/'/\\'/g;
	print '<script type="text/javascript" language="javascript">uricomponents[\'rrtxt_'.$o.'_content\']=encodeURIComponent(\''.$newtxt.'\');</script>';
	print '<div id="rrtxt_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrtxt\', \''.$o.'\', 1, \'rr\')">[add]</a></div>';
	print '</div>';  #close containerheadright

	#display/edit
	print '<div class="containerbody">';
	if (my @txts = $o->txt_records()) {
	    foreach my $txt (@txts) {
		$ui->add_to_fields(o=>$txt, edit=>$edit, fields=>['txtdata', 'ttl'],
				   field_headers=>\@field_headers, cell_data=>\@cell_data,
				   linkpages=>['view.html',''], with_delete=>1);
		$m->comp('/generic/attribute_table.mhtml', %comphash);
		(@field_headers, @cell_data) = ((),());
	    }
	}

	print '<div id="rrtxt_div_'.$o.'"></div>';
	print '</div></div>';

	#####################################################################################################
	#RRCNAME for somewhere pointing to $o
	print '<p>';
	print '<div class="container" style="margin-left:10px">';
	print '<div class="containerheadleft"><b>Aliases of '.$o->get_label.' (CNAME)</b></div>';
	print '<div class="containerheadright">';

	#new rrcname
	$ui->add_to_fields(table=>'RRCNAME', edit=>1, fields=>['name', 'ttl'],
			   field_headers=>\@field_headers, cell_data=>\@cell_data,
			   linkpages=>['host.html','']);
	my $newcname = $m->scomp('/generic/attribute_table.mhtml', %comphash);
	(@field_headers, @cell_data) = ((),());
	$newcname =~ s/\n//g;
	$newcname =~ s/<script.*?<\/script>//g;
	$newcname =~ s/'/\\'/g;
	print '<script type="text/javascript" language="javascript">uricomponents[\'rrcname_'.$o.'_content\']=encodeURIComponent(\''.$newcname.'\');</script>';
	print '<div id="rrcname_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrcname\', \''.$o.'\', 1, \'cname\');netdotform.RRCNAME__NEW__cname.value=\''.$o->get_label.'\'">[add]</a></div>';
	print '</div>';  #close containerheadright

	#display/edit
	print '<div class="containerbody">';
	if (my @cnames = RRCNAME->search(cname=>$o->get_label)) {
	    foreach my $cname (@cnames) {
		$ui->add_to_fields(o=>$cname, edit=>$edit, fields=>['name', 'ttl'],
				   field_headers=>\@field_headers, cell_data=>\@cell_data,
				   linkpages=>['host.html',''], with_delete=>1);
		$m->comp('/generic/attribute_table.mhtml', %comphash);
		(@field_headers, @cell_data) = ((),());
	    }
	}

	print '<div id="rrcname_div_'.$o.'"></div>';
	print '</div></div>';

    }

    #####################################################################################################
    #RRCNAME for aliases of $o ($o pointing to somewhere)
    # cannot have an A/AAAA record at the same time
    # the $o is unique in the cname table
    
    #new rrcname
    if ( !$o->arecords() ) {
	print '<div class="container" style="margin-left:10px">';
	print '<div class="containerheadleft"><b>'.$o->get_label.' is an alias of (CNAME)</b></div>';
	print '<div class="containerheadright">';
	
	$ui->add_to_fields(table=>'RRCNAME', edit=>1, fields=>['cname', 'ttl'],
			   field_headers=>\@field_headers, cell_data=>\@cell_data,
			   linkpages=>['view.html','']);
	my $newcname = $m->scomp('/generic/attribute_table.mhtml', %comphash);
	(@field_headers, @cell_data) = ((),());
	$newcname =~ s/\n//g;
	$newcname =~ s/<script.*?<\/script>//g;
	$newcname =~ s/'/\\'/g;
	print '<script type="text/javascript" language="javascript">uricomponents[\'rrcname_'.$o.'_content\']=encodeURIComponent(\''.$newcname.'\');</script>';
	print '<div id="rrcname_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrcname\', \''.$o.'\', 1, \'name\')">[add]</a></div>';

	print '</div>';  #close containerheadright
	
	#display/edit
	print '<div class="containerbody">';
	if (my @cnames = $o->cnames()) {
	    foreach my $cname (@cnames) {
		if ( my $cnamerr = RR->search(name=>$cname->cname)->first ){
		    push @field_headers, "Name:";
		    push @cell_data, "<a href=\"host.html?id=$cnamerr\">".$cnamerr->get_label."</a>";
		    $m->comp('/generic/attribute_table.mhtml', %comphash);
		    (@field_headers, @cell_data) = ((),());
		}
	    }
	}
	
	if (!$o->arecords()) {
	    print '<div id="rrcname_div_'.$o.'"></div>';
	}
	print '</div></div>';
    }
    

    #####################################################################################################
    # Restrict access to the following records
    #####################################################################################################

    if ( !$o->cnames && ($manager && $manager->can($user, "access_section", 'host.html:extra_records')) ){
    
    #####################################################################################################
    #RRPTR
    foreach my $arecord ( @arecs ) {
	next if $arecord->ipblock == 0;
	my $ipblock = $arecord->ipblock;

	# We can assume there is only one per IP
	my $ptr = $ipblock->ptr_records->first;

	print '<div class="container" style="margin-left:10px">';
	print '<div class="containerheadleft"><b>Reverse for '.$ipblock->get_label.' (PTR)</b></div>';
	print '<div class="containerheadright">';
	if ( !$ptr ){
	    print '<a href="host.html?id='.$id.'&add_ptr='.$ipblock.'">[add]</a>';
	}else{
	    print '&nbsp;';
	}
	print '</div>';  #close containerheadright
	print '<div class="containerbody">';

	if ( $add_ptr == $ipblock->id ){
	    # new rrptr
	    my $rzone;
	    if ( ($ipblock->parent != 0) && $ipblock->parent->reverse_zone ){
		$rzone = $ipblock->parent->reverse_zone;
	    }
	    push( @field_headers, ("Name", "Zone", "Domain Name", "TTL") );
	    print '<input name="RR__NEW__type" value="PTR" type="hidden">';
	    print '<input name="RR__NEW__ipblock" value="'.$ipblock.'" type="hidden">';
	    if ( $rzone ){
		my $name = RRPTR->get_name(ipblock=>$ipblock, zone=>$rzone);
		push( @cell_data, '<input name="RR__NEW__name" value="'.$name.'" type="text">' );
	    }else{
		push( @cell_data, '<input name="RR__NEW__name" value="" type="text">' );
	    }
	    my $zone_select = '<select name="RR__NEW__zone">';
	    foreach my $z ( sort { $a->name cmp $b->name } Zone->retrieve_all ){
		if ( $rzone && $rzone->id == $z->id ){
		    $zone_select .= '<option value="'.$z.'" SELECTED>'.$z->get_label.'</option>';
		}else{
		    $zone_select .= '<option value="'.$z.'">'.$z->get_label.'</option>';
		}
	    }
	    $zone_select .= "</select>";
	    push( @cell_data, $zone_select );
	    push( @cell_data, '<input name="RR__NEW__ptrdname" value="'.$rr->get_label.'" type="text">' );
	    push( @cell_data, '<input name="RR__NEW__ttl" value="" type="text">' );
	    $m->comp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());

	    print '<input type="button" name="cancel_button" value="cancel" onClick="history.go(-1);">';
	    print '<input type="submit" name="submit" value="save" >';
	}

	# display/edit
	if ( $ptr ) {
	    $ui->add_to_fields(o=>$ptr, edit=>0, fields=>['rr', 'ptrdname', 'ttl'],
			       field_headers=>\@field_headers, cell_data=>\@cell_data,
			       linkpages=>['host.html', '', ''], with_delete=>1);
	    
	    $m->comp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
	    
	}
	print '</div></div>';
    }

    #####################################################################################################
    #RRMX
    print '<div class="container" style="margin-left:10px">';
    print '<div class="containerheadleft"><b>Mail Exchangers (MX)</b></div>';
    print '<div class="containerheadright">';

    #new rrmx
    $ui->add_to_fields(table=>'RRMX', edit=>1, fields=>['exchange', 'preference', 'ttl'],
		       field_headers=>\@field_headers, cell_data=>\@cell_data,
		       linkpages=>['view.html','view.html','']);
    my $newmx = $m->scomp('/generic/attribute_table.mhtml', %comphash);
    (@field_headers, @cell_data) = ((),());
    $newmx =~ s/\n//g;
    $newmx =~ s/<script.*?<\/script>//g;
    $newmx =~ s/'/\\'/g;
    print '<script type="text/javascript" language="javascript">uricomponents[\'rrmx_'.$o.'_content\']=encodeURIComponent(\''.$newmx.'\');</script>';
    print '<div id="rrmx_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrmx\', \''.$o.'\', 1, \'rr\')">[add]</a></div>';
    print '</div>';  #close containerheadright

    #display/edit
    print '<div class="containerbody">';
    if (my @mxs = $o->mx_records()) {
	foreach my $mx (@mxs) {
	    $ui->add_to_fields(o=>$mx, edit=>$edit, fields=>['exchange', 'preference', 'ttl'],
			       field_headers=>\@field_headers, cell_data=>\@cell_data,
			       linkpages=>['view.html','view.html','']);
	    $m->comp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
	}
    }

    print '<div id="rrmx_div_'.$o.'"></div>';
    print '</div></div>';

    
    #####################################################################################################
    #RRNS
    print '<div class="container" style="margin-left:10px">';
    print '<div class="containerheadleft"><b>Name Servers (NS)</b></div>';
    print '<div class="containerheadright">';

    #new rrns
    $ui->add_to_fields(table=>'RRNS', edit=>1, fields=>['nsdname', 'ttl'],
		       field_headers=>\@field_headers, cell_data=>\@cell_data,
		       linkpages=>['view.html','']);
    my $newns = $m->scomp('/generic/attribute_table.mhtml', %comphash);
    (@field_headers, @cell_data) = ((),());
    $newns =~ s/\n//g;
    $newns =~ s/<script.*?<\/script>//g;
    $newns =~ s/'/\\'/g;
    print '<script type="text/javascript" language="javascript">uricomponents[\'rrns_'.$o.'_content\']=encodeURIComponent(\''.$newns.'\');</script>';
    print '<div id="rrns_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrns\', \''.$o.'\', 1, \'rr\')">[add]</a></div>';
    print '</div>';  #close containerheadright

    #display/edit
    print '<div class="containerbody">';
    if (my @nss = $o->ns_records()) {
	foreach my $ns (@nss) {
	    $ui->add_to_fields(o=>$ns, edit=>$edit, fields=>['nsdname', 'ttl'],
			       field_headers=>\@field_headers, cell_data=>\@cell_data,
			       linkpages=>['view.html',''], with_delete=>1);
	    $m->comp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
	}
    }

    print '<div id="rrns_div_'.$o.'"></div>';
    print '</div></div>';

    
    #####################################################################################################
    #RRNAPTR
    print '<div class="container" style="margin-left:10px">';
    print '<div class="containerheadleft"><b>Name Authority Pointer (NAPTR)</b></div>';
    print '<div class="containerheadright">';

    #new rrnaptr
    $ui->add_to_fields(table=>'RRNAPTR', edit=>1, 
		       fields=>['order_field', 'preference', 'flags', 
				'services', 'regexpr', 'replacement', 'ttl'],
		       field_headers=>\@field_headers, cell_data=>\@cell_data,
		       linkpages=>['view.html','']);
    my $newnaptr = $m->scomp('/generic/attribute_table.mhtml', %comphash);
    (@field_headers, @cell_data) = ((),());
    $newnaptr =~ s/\n//g;
    $newnaptr =~ s/<script.*?<\/script>//g;
    $newnaptr =~ s/'/\\'/g;
    print '<script type="text/javascript" language="javascript">uricomponents[\'rrnaptr_'.$o.'_content\']=encodeURIComponent(\''.$newnaptr.'\');</script>';
    print '<div id="rrnaptr_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrnaptr\', \''.$o.'\', 1, \'rr\')">[add]</a></div>';
    print '</div>';  #close containerheadright

    #display/edit
    print '<div class="containerbody">';
    if (my @naptrs = $o->naptr_records()) {
	foreach my $naptr (@naptrs) {
	    $ui->add_to_fields(o=>$naptr, edit=>$edit, 
			       fields=>['order_field', 'preference', 'flags', 
					'services', 'regexpr', 'replacement', 'ttl'],
			       field_headers=>\@field_headers, cell_data=>\@cell_data,
			       linkpages=>['view.html','view.html',''], with_delete=>1);
	    $m->comp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
	}
    }

    print '<div id="rrnaptr_div_'.$o.'"></div>';
    print '</div></div>';

    
    #####################################################################################################
    #RRPTR (when the name is the PTR record's name)
    if ( !$o->arecords ){
    
	print '<div class="container" style="margin-left:10px">';
	print '<div class="containerheadleft"><b>PTR</b></div>';
	print '<div class="containerheadright">';

	#new rrptr
	push( @field_headers, "IP");
	push( @cell_data, "<input name='RRPTR__NEW__ipblock' value='' type='text'>");
	$ui->add_to_fields(table=>'RRPTR', edit=>1, fields=>['ttl'],
			   field_headers=>\@field_headers, cell_data=>\@cell_data,
			   linkpages=>['']);
	my $newptr = $m->scomp('/generic/attribute_table.mhtml', %comphash);
	(@field_headers, @cell_data) = ((),());
	$newptr =~ s/\n//g;
	$newptr =~ s/<script.*?<\/script>//g;
	$newptr =~ s/'/\\'/g;
	print '<script type="text/javascript" language="javascript">uricomponents[\'rrptr_'.$o.'_content\']=encodeURIComponent(\''.$newptr.'\');</script>';
	print '<div id="rrptr_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrptr\', \''.$o.'\', 1, \'rr\')">[add]</a></div>';
	print '</div>';  #close containerheadright

	#display/edit
	print '<div class="containerbody">';
	if (my @ptrs = $o->ptr_records()) {
	    foreach my $ptr (@ptrs) {
		push( @field_headers, "IP");
		if ($edit) {
		    push( @cell_data, "<input name='RRPTR__".$ptr."__ipblock' value='".$ptr->ipblock->address."' type='text'>" );
		} else {
		    push( @cell_data, "<a href='ip.html?id=".$ptr->ipblock->id."'>".$ptr->ipblock->address."</a>");
		}
		$ui->add_to_fields(o=>$ptr, edit=>$edit, fields=>['ptrdname', 'ttl'],
				   field_headers=>\@field_headers, cell_data=>\@cell_data,
				   linkpages=>['', ''], with_delete=>1);
		$m->comp('/generic/attribute_table.mhtml', %comphash);
		(@field_headers, @cell_data) = ((),());
	    }
	}

	print '<div id="rrptr_div_'.$o.'"></div>';
	print '</div></div>';

    }    

    #####################################################################################################
    #RRLOC
    print '<div class="container" style="margin-left:10px">';
    print '<div class="containerheadleft"><b>Location Records (LOC)</b></div>';
    print '<div class="containerheadright">';

    #new
    $ui->add_to_fields(table=>'RRLOC', edit=>1, 
		       fields=>['latitude', 'longitude', 'altitude', 'size', 
				'horiz_pre', 'vert_pre', 'ttl'],
		       field_headers=>\@field_headers, cell_data=>\@cell_data,
		       linkpages=>['view.html', 'view.html', 'view.html', 'view.html', 'view.html', 'view.html', ''], 
	);
    my $newloc = $m->scomp('/generic/attribute_table.mhtml', %comphash);
    (@field_headers, @cell_data) = ((),());
    $newloc =~ s/\n//g;
    $newloc =~ s/<script.*?<\/script>//g;
    $newloc =~ s/'/\\'/g;
    print '<script type="text/javascript" language="javascript">uricomponents[\'rrloc_'.$o.'_content\']=encodeURIComponent(\''.$newloc.'\');</script>';
    print '<div id="rrloc_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrloc\', \''.$o.'\', 1, \'rr\')">[add]</a></div>';
    print '</div>';  #close containerheadright

    #display/edit
    print '<div class="containerbody">';
    if (my @locs = $o->loc_records()) {
	foreach my $loc (@locs) {
	    $ui->add_to_fields(o=>$loc, edit=>$edit, 
			       fields=>['latitude', 'longitude', 'altitude', 
					'size', 'horiz_pre', 'vert_pre', 'ttl'],
			       field_headers=>\@field_headers, cell_data=>\@cell_data,
			       linkpages=>['view.html', 'view.html', 'view.html', 'view.html', 'view.html', 'view.html', ''], 
			       with_delete=>1
		);
	    $m->comp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
	}
    }

    print '<div id="rrloc_div_'.$o.'"></div>';
    print '</div></div>';

    
    #####################################################################################################
    #RRSRV
    print '<div class="container" style="margin-left:10px">';
    print '<div class="containerheadleft"><b>Service Records (SRV)</b></div>';
    print '<div class="containerheadright">';

    #new rrsrv
    $ui->add_to_fields(table=>'RRSRV', edit=>1, fields=>['priority', 'weight', 'port', 'target', 'ttl'],
		       field_headers=>\@field_headers, cell_data=>\@cell_data,
		       linkpages=>['view.html','view.html','view.html','view.html','']);
    my $newsrv = $m->scomp('/generic/attribute_table.mhtml', %comphash);
    (@field_headers, @cell_data) = ((),());
    $newsrv =~ s/\n//g;
    $newsrv =~ s/<script.*?<\/script>//g;
    $newsrv =~ s/'/\\'/g;
    print '<script type="text/javascript" language="javascript">uricomponents[\'rrsrv_'.$o.'_content\']=encodeURIComponent(\''.$newsrv.'\');</script>';
    print '<div id="rrsrv_'.$o.'"><a href="#" onClick="dynamicAdd(\'rrsrv\', \''.$o.'\', 1, \'name\')">[add]</a></div>';
    print '</div>';  #close containerheadright

    #display/edit
    print '<div class="containerbody">';
    if (my @srvs = $o->srv_records()) {
	foreach my $srv (@srvs) {
	    $ui->add_to_fields(o=>$srv, edit=>$edit, fields=>['priority', 'weight', 'port', 'target', 'ttl'],
			       field_headers=>\@field_headers, cell_data=>\@cell_data,
			       linkpages=>['view.html','view.html','view.html','view.html',''], with_delete=>1);
	    $m->comp('/generic/attribute_table.mhtml', %comphash);
	    (@field_headers, @cell_data) = ((),());
	}
    }

    print '<div id="rrsrv_div_'.$o.'"></div>';
    print '</div></div>';

    } # close restrict if
    print '</div>'; #close container
}

print '</div>'; #close outer containerbody
print '</form>';
print '</div>'; #close outer container


</%perl>

