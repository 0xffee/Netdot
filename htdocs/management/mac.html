<%doc>
Interface for MAC addresses
</%doc>
%
%
<%attr>
title   => 'MAC' 
section => 'Management'
</%attr>
%
%
<%args>
$id     => undef
$search => undef
$delete => undef
$limit  => 10
</%args>
%
%
<%init>
my $DEBUG = 0;
my $o;
my @list;
my (@interfaces, @devices);
my $edge_port;
my ($fwt, $arp);
print "<pre>", Dumper(%ARGS), "</pre><br>" if $DEBUG;
</%init>

<%doc>
#######################################################################################
# Search
#
#######################################################################################
</%doc>

% if ( defined($search) ){
%        # Remove trailing and leading spaces
%        $search =~ s/^\s*(.*)\s*$/$1/g;
%        @list = PhysAddr->search_like(address=>$search);

	<div class="container">
          <div class="containerhead">
              Query <em><% $search %></em> returned: <% scalar(@list) %> matches
          </div>
          <div class="containerbody">
%         if ( scalar(@list) > 1 ){
              <& /generic/sortresults.mhtml, object => \@list  &>
%         }elsif ( @list ){
%             $o = $list[0];
%         }else{
	      <form action="mac.html" method="POST">
                <p>
                <label for="search">MAC:</label>
                <input type="text" name="search" class="txt" value="<% $search %>"> 
                <input name="submit" value="search" class="btn" type="submit">
                </p>
              </form> 
%         }
          </div>
       </div>
% }

<%perl>

if ( $id && !$o ){
    unless ( $o = PhysAddr->retrieve($id) ){
	$m->comp('/generic/error.mhtml', error => "Could not retrieve PhysAddr id: $id");
    }
}

if ( $o ){
    # Get latest forwarding table entries
    $fwt = $o->get_last_n_fte($limit);
    # Get latest arp entries
    $arp        = $o->get_last_n_arp($limit);
    # Devices whose base_mac address is this one
    @devices    = $o->devices;
    # Interfaces with this address
    @interfaces = $o->interfaces;

    # Get edge port unless MAC belongs to an Interface with a neighbor
    unless ( scalar(@interfaces) == 1 && ($interfaces[0])->neighbor ){
	$edge_port  = $o->find_edge_port;
    }
    
    my (@headers, @data) = ();
    
    my @fields = ('address');
    $ui->add_to_fields(o=>$o, edit=>0, fields=>\@fields, 
		       field_headers=>\@headers, cell_data=>\@data);
    
 # Add Vendor
    push(@headers, 'Vendor');
    my $vendor = $o->vendor;
    my $oui    = $o->oui;
    my $srch   = "$oui*";
    my $slink  = "<a href=\"../generic/search_obj.html?table=PhysAddr&address=$srch&res=1\">$vendor ($oui)</a>";
    push(@data, $slink);
    
    @fields = ('static', 'first_seen', 'last_seen');
    $ui->add_to_fields(o=>$o, edit=>0, fields=>\@fields,
		       field_headers=>\@headers, cell_data=>\@data);

</%perl>
<!-- Display main object values -->
<div class="container">
    <div class="containerhead"><strong>MAC Address</strong></div>
    <div class="containerbodyoutside">
        <& /generic/attribute_table.mhtml, field_headers=>\@headers, data=>\@data, 
           width=>"1", headercolwidth=>"25%", datacolwidth=>"75%" &>
    </div>
</div>
<!-- End Display main object values -->

%if ( @devices ){
<!-- Display Device -->
<div class="container">
    <div class="containerhead"><strong>Devices using this address</strong></div>
    <div class="containerbodyoutside">
        <& /generic/sortresults.mhtml, object=>\@devices &>
    </div>
</div>

<!-- EndDisplay Device -->
%}

%if ( @interfaces ){
<!-- Display Interfaces -->
<div class="container">
    <div class="containerhead"><strong>Interfaces using this address</strong></div>
    <div class="containerbodyoutside">
        <& /generic/sortresults.mhtml, object=>\@interfaces &>
    </div>
</div>

<!-- EndDisplay Interfaces -->
%}

<%perl>
    if ( $edge_port ){
	my $iface = Interface->retrieve($edge_port);
	my ($jack, $room);
	if ( $iface->jack ){
	    $jack = $iface->jack->jackid;
	    $room = $iface->jack->room->name if $iface->jack->room;
	}else{
	    $jack = $iface->jack_char;
	    $room = $iface->room_char;
	}
	$jack ||=  'n/a';
	$room ||=  'n/a';
	my $lbl = $iface->get_label;
	my $lnk = "<a href=\"../generic/view.html?table=Interface&id=$edge_port\">$lbl</a>";
</%perl>
<!-- Display Location -->
<div class="container">
    <div class="containerhead"><strong>Edge Port</strong></div>
    <div class="containerbodyoutside">
        <& /generic/data_table.mhtml, field_headers=>['Interface', 'Room', 'Jack', 'Description'], 
           data=>[[$lnk, $room, $jack, $iface->description]] &>
    </div>
</div>
<!-- End Display Location -->
%    }

<%perl>
    if ( scalar @$fwt ){
        my @rows;
        foreach my $row ( @$fwt ){
            my ($iid, $tstamp) = @$row;
            my $iface = Interface->retrieve($iid);
            my $lbl   = $iface->get_label;
            my $lnk   = "<a href=\"../generic/view.html?table=Interface&id=$iid\">$lbl</a>";
            push @rows, [$tstamp, $lnk];
        }
</%perl>
<!-- Display FWT -->
<div class="container">
    <div class="containerhead"><strong>Last <% $limit %> forwarding table entries</strong></div>
    <div class="containerbodyoutside">
        <& /generic/data_table.mhtml, field_headers=>['Time Seen', 'Interface'], data=>\@rows &>
    </div>
</div>
<!-- End Display FWT -->
%     }

<%perl>
    if ( scalar @$arp ){
        my @rows;
        foreach my $row ( @$arp ){
            my ($iid, $ipid, $tstamp) = @$row;
            my $iface   = Interface->retrieve($iid);
            my $ipblock = Ipblock->retrieve($ipid);
            my $ilbl    = $iface->get_label;
            my $iplbl   = $ipblock->get_label;
            my $ilnk    = "<a href=\"../generic/view.html?table=Interface&id=$iid\">$ilbl</a>";
            my $iplnk   = "<a href=\"../generic/view.html?table=Ipblock&id=$ipid\">$iplbl</a>";
            push @rows, [$tstamp, $iplnk, $ilnk ];
        }
       
</%perl>
<!-- Display ARP -->
<div class="container">
    <div class="containerhead"><strong>Last <% $limit %> ARP entries</strong></div>
    <div class="containerbodyoutside">
        <& /generic/data_table.mhtml, field_headers=>['Time Seen', 'IP', 'Interface'], data=>\@rows &>
    </div>
</div>
<!-- End Display ARP -->

%     }

% }
