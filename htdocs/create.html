<%perl>
##################################################
# clean out old state files
$gui->rmsessions( $TMP, $AGE );
##################################################
# grab arguments to this script
my %rev = reverse %ARGS;
foreach my $j ( keys %ARGS ) {
  if( $ARGS{$j} eq "New" ) {
    $TBL = $j;
    next;
  }
  next if( $ARGS{$j} !~ /\w+/ || $j !~ /\w+/ );
  $args{$j} = $ARGS{$j};
}
##################################################
# define TBL (if not already) and set previous table for reference
if( $TBL && $args{table} ) {
  $PREV = $args{table}
} elsif( ! defined( $TBL ) ) {
  $TBL = $args{table};
}
unless( defined( $PREV ) ) {
  $PREV = $TBL;
}
##################################################
# get state back if sid defined
#   otherwise create state if necessary
if( defined( $args{sid} ) ) {
  $sid = $args{sid};
  $session = $gui->getsession( $TMP, $sid );
} elsif( $args{table} ) {  
  $session = $gui->mksession( $TMP );
  $sid = $session->{_session_id};
}
if( $DEBUG ) {
  print "ARGS: ";
  printf "<pre>%s</pre>\n", Dumper( \%ARGS );
  print "SESSION: ";
  printf "<pre>%s</pre>\n", Dumper( $session );
}
##################################################
# if Cancel, delete state
if( $args{cancel} eq "Cancel" ) {
  undef( $TBL );
  undef( $PREV );
  if( defined( $session ) ) {
    $gui->rmsession( $session );
  }
  delete( $args{sid} );
  delete( $args{table} );
  delete( $args{submit} );
  delete( $ARGS{ $rev{New} } );
  delete( $rev{New} );
}
##################################################
# fill in the rest of state details -- for Submit or New
if( exists( $args{submit} ) 
    || exists( $rev{New} ) || exists( $args{discover} ) ) {
  foreach my $arg ( keys %args ) {
    next if( $arg eq "submit" || $arg eq "sid" 
             || $arg eq "table" || $arg eq "commit" );
    next if( length( $arg ) < 1 || ! defined( $args{$arg} ) );
    $session->{tables}{$PREV}{$arg} = $args{$arg};
  }
  if( ! defined( $args{submit} ) ) {
    defined( $session->{path} ) ?
      ( $session->{path} .= ";$args{table}" ) 
      : ( $session->{path} = "$args{table}" );
  }
}
##################################################
# get back some history of where user has clicked
if( exists( $args{submit} ) || exists( $args{confirm} ) ) {
  ################################################
  # if user hits reload after a 'Confirm' (and we're displaying a table
  #   form submit page), we need to be sure we go back to the proper
  #   table/object page and do not create empty objects in the DB.
  if( $args{confirm} && ! exists( $session->{tables}{ $args{create} } ) ) {
    delete( $args{confirm} );
    my ( $x, %z );
    map { $z{$_} = 1 } split( /;/, $session->{path} );
    foreach my $y ( keys %{ $session->{tables} } ) {
      if( ! exists( $z{$y} ) ) {
        $x = $y;
      }
    }
    ( length( $session->{path} ) > 1 ) ?
      ( $session->{path} .= ";$x" ) : ( $session->{path} = "$x" );
  }
  my @tbls = split( /;/, $session->{path} );
  if( scalar( @tbls ) > 0 ) {
    if( ! exists( $args{submit} ) ) {
      my $tmp = pop @tbls;
      $TBL = $tmp;
    }
  }
  $session->{path} = join( ';', @tbls );
}

##################################################
# if confirm, handle here
if( $args{confirm} eq "Confirm" ) {
  my( $T, $c );
  $T = $args{create};
  eval { $c = $T->create( \%{ $session->{tables}{$T} } ); }
    or die "Unable to create $T: $@\n";
  delete( $session->{tables}{ $args{create} } );
  if( length( $session->{path} ) < 1 && ! defined( $TBL ) ) {
    if( defined( $session ) ) {
      $gui->rmsession( $session );
    }
  }
  $id = $c->id;
  $session->{created}{$T} = $id;
}
##################################################
# create %state to pass to form
if( defined( $TBL ) ) {
  my $meta = $gui->getmeta( $TBL );
  my %lt = $gui->getlinksto( $TBL );
  foreach my $c ( split( /,/, $meta->columnorder ) ) {
    if( $args{$c} ) {
      $state{$c} = $args{$c};
    }
  }
  if( exists( $session->{tables}{$TBL} ) ) {
    foreach my $c ( keys %{ $session->{tables}{$TBL} } ) {
      if( $lt{$c} && $session->{created}{$lt{$c}} ) {
        $state{$c} = $session->{created}{$lt{$c}};
      } else {
        $state{$c} = $session->{tables}{$TBL}{$c};
      }
    }
  }
}
</%perl>
% ####################################################################
% if( $DEBUG ) {
    tables : TBL <% $TBL %> : table <% $args{table} %><br>
    PREV : <% $PREV %> <br>
    ARGS :
%   printf "<pre>%s</pre>\n", Dumper( \%ARGS );
    <br> session: 
%   printf "<pre>%s</pre>\n", Dumper( $session );
    <hr>
% }
% ####################################################################
% if( $args{confirm} eq "Confirm" && ( ! $TBL || $args{cancel} ) ) {
    <& view.html, table => $args{create}, id => $id &>
% } else {
    <& header, title =>"$TBL Create" &>
    <!-- begin create.html -->
    <p>
% ####################################################################
%   if( $args{"submit"} eq "Submit" ) {
      <p>Please confirm the following:
%     my $obj = $gui->getmeta( $TBL );
%     my %linksto = $gui->getlinksto( $TBL );
      <p><blockquote><strong><% $TBL %></strong><ul>
%     foreach my $C ( split( /,/, $obj->columnorder() ) ) {
        <li>
        <% $C %> :
%       if( ! exists( $session->{tables}{$TBL}{$C} ) ) {
          -
%       } else {
%         if( $linksto{$C} ) {
%           my $ft = $gui->getmeta( $linksto{$C} );
%           if( ! defined( $ft ) ) {
              No such object <% $linksto{$C} %>
%           } elsif( $session->{tables}{$TBL}{$C} == 0 ) {
              -
%           } elsif( ! defined( $linksto{$C}->
%                    retrieve( int( $session->{tables}{$TBL}{$C} ) ) ) ) {
              -
%           } else {
%             my $o = $linksto{$C}->retrieve( $session->{tables}{$TBL}{$C} );
%             my $lbl = $gui->getobjlabel( $o, ", " );
              <% $lbl %>
%           }
%         } else {
            <% $session->{tables}{$TBL}{$C} %>
%         }
%       }
%     }
      </ul></blockquote>
      <form action="create.html" method="POST">
      <input type="hidden" name="sid" value="<% $sid %>">
      <input type="hidden" name="create" value="<% $TBL %>">
      <input name="confirm" value="Confirm" type="submit">
      <input name="cancel" value="Cancel" type="submit">
      </form>
%   } elsif( ! $TBL || $args{cancel} ) {
      <p>
      <blockquote>
      <& table, width => $WIDTH, link => "create.html", title => "Please select an object to create:" &>
      </blockquote>
%   } else {
      <br>
      <blockquote>
      <form action="create.html" method="POST">
      <input type="hidden" name="sid" value="<% $sid %>">
%     ############################################
%     # special clause for node
%     if( $TBL eq "Node" ) {
        <a href="node.html">Auto Discover Node</a><br>
        <p>
%     }
      <& form, table => $TBL, showdisabled => '0', session => \%state &>
      <table cellpadding="3" cellspacing="1" border="0">
      <tr align="LEFT">
      <td bgcolor="#FFFFFF" align="CENTER" colspan="3">
      <input name="submit" value="Submit" type="submit">
      </td>
      <td>
      <input name="cancel" value="Cancel" type="submit">
      </td>
      </tr>
      </table>
      </form>
      </blockquote>
%   } # if/else table
    <p>
    <!-- end create.html -->
    <& footer &>
% }
% ####################################################################
<%args>

$DEBUG => 0
$TBL => undef
$PREV => undef
$id => undef
$sid => undef
$nv => undef
$TMP => "/home/netdot/public_html/tmp"
$AGE => 86400
$WIDTH => 2
$session => undef
$gui => Netdot::GUI->new()
%args => undef
%order => undef
%linksto => undef

</%args>
<%init>
my %state;
undef( %state );

</%init>

<%doc>
create.html

  Arguments:

    table -- name of table to create
    sid   -- session id (used for keeping state while creating objects)
    cancel - cancels all existing state and returns to null state
    submit - 
    (column names from any/all tables)

  Possible states:

    - null 
    new page to create any table
    - table is set
    present page to create that table
    - user clicked New on a table page
    present page to create object for New; keep state for previous 
    table page
    - cancel
    user clicks on cancel; should clear all state
    - submit
    if this is the last table, goto confirm page; otherwise, go to 
    last edited table
    

######################################################################
#  $Log: create.html,v $
#  Revision 1.26  2003/07/14 17:06:26  netdot
#  removing print statement
#
#  Revision 1.25  2003/07/11 16:11:36  netdot
#  fixed bug where state could be loss; call view.html after last object
#  is created; changed debug code a little
#
#  Revision 1.24  2003/07/08 21:27:40  netdot
#  state seems to be working along with other updates to calls to GUI.pm
#
#  Revision 1.23  2003/07/08 00:44:44  netdot
#  *** empty log message ***
#
#  Revision 1.22  2003/07/03 22:39:31  netdot
#  still cleaning up from state/session changes
#
#  Revision 1.21  2003/07/02 23:51:15  netdot
#  more work to convert to new GUI and state code; still untested
#
#  Revision 1.20  2003/07/02 00:06:29  netdot
#  *** empty log message ***
#
#  Revision 1.19  2003/07/01 19:04:23  netdot
#  *** empty log message ***
#
#  Revision 1.18  2003/07/01 05:07:53  netdot
#  *** empty log message ***
#
#  Revision 1.17  2003/07/01 05:03:00  netdot
#  migrating state functionality to GUI.pm
#
#  Revision 1.16  2003/06/27 21:07:57  netdot
#  removed most infrastructure for autodiscovery
#
#  Revision 1.15  2003/06/17 00:03:20  netdot
#  *** empty log message ***
#
#  Revision 1.14  2003/06/13 20:49:13  netdot
#  status pending while I deliberate node discovery in create.html
#
#  Revision 1.13  2003/06/12 23:49:47  netdot
#  integrating node discovery into create; moved variable declarations to
#  <%args>
#
#  Revision 1.12  2003/05/30 22:58:12  netdot
#  set table width to 2 (for table)
#
#  Revision 1.11  2003/05/30 21:43:04  netdot
#  opening page now using table to display initial list of tables to
#  create
#
#  Revision 1.10  2003/05/29 00:04:41  netdot
#  forgot to note: fixed the bug where a reload after a confirm will go
#  to the wrong page and insert empty data.
#
#  Revision 1.9  2003/05/29 00:03:33  netdot
#  added columnorder when displaying confirmation page
#
#  Revision 1.8  2003/05/27 23:13:05  netdot
#  added catch for %state such that args passed from other scripts
#  (ie. GET create?table=x&name=foo) will work
#
#  Revision 1.7  2003/05/23 23:45:38  netdot
#  lots of changes.  in a nutshell, create stuff now works -- actually
#  creates data.  it also passes state to form to fill in some
#  details where necessary.  there is a problem if a user does:
#
#    - user hits confirm on one page
#    - we pop the last element out of path (and table is not set)
#    - user hits reload
#
#  create then goes back to first page, not back to that table page.
#
#  Revision 1.6  2003/05/22 23:23:48  netdot
#  have most of the driving functionality in place -- so links take you
#  where you're supposed to go with the requisite state.  also displaying
#  the linksto stuff instead of the integer.  still need to pass state
#  (if it exists) to form.  after that, it is a matter of doing the
#  actual inserts! -sf
#
#  Revision 1.5  2003/05/13 23:36:15  netdot
#  more changes.  still need to remap the confirm stuff to confirm after
#  every click on submit; then go back to previous table or null state
#
#  Revision 1.4  2003/05/12 23:23:58  netdot
#  trying to clean up some of the logic and cover the cases of 'submit',
#  'new', and 'cancel'.  also better document some of the chunks of code.
#
#  Revision 1.3  2003/05/12 16:21:12  netdot
#  *** empty log message ***
#
#  Revision 1.2  2003/05/09 00:01:58  netdot
#  lots of changes, so not sure where to start.  can generally drive
#  through the interface (click on links and they take you places);
#  keeping some state; have a cancel button to kill some state; need to
#  add history links (links to the previous table you were editing if
#  creating a chain of tables; need confirm screen
#
#  Revision 1.1  2003/05/02 17:11:30  netdot
#  Initial revision
#


</%doc>
