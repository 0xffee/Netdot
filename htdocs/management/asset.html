<%doc>
Asset form
</%doc>

<%attr>
title => 'Assets'
section => "Management"
</%attr>
%
%
<%args>
$user       => $ui->get_current_user($r)
$id         => undef
$submit => undef
$purchase_date => undef
$maint_contract_num => undef
$product_type => undef
$serial_numbers => undef
</%args>


<%init>
my $DEBUG = 0;
print '%ARGS is  <pre>', Dumper(%ARGS), $m->dhandler_arg,'</pre><br>' if $DEBUG;
my @products = Product->retrieve_all();
my @assets = Asset->retrieve_all();
my @a_serial;
for (@assets){
	push(@a_serial, $_->serial_number);
}

if($submit){
    my @s_numbers = split(' ',$serial_numbers);
    my %tmp_hash = {};
    
    for my $s ((@s_numbers, @a_serial)){
        if($tmp_hash{$s}){
            #Not perfect, but this should ensure no duplicated serial numbers are entered into the database assuming the user doesn't modify them
            #after they are entered.  If this happens, the database rules will still prevent duplicates, but the error won't be so pretty
            $m->comp('/generic/error.mhtml', error=>"Duplicate serial numbers detected, either you have entered duplicate serial numbers, \nor one or more of the serial numbers you have entereded already exists in the database");
        }
        else{
            $tmp_hash{$s} = 1;
        }
    }
    for my $s (@s_numbers){
        Asset->insert({date_purchased=>$purchase_date, maint_contract=>$maint_contract_num, product_id=>$product_type, serial_number=>$s});
    }
}


</%init>

<div id="sectiontools">
  <div class="container">
    <div class="containerheadleft">
      Assets
    </div>
    <div class="containerheadright">&nbsp; </div>
    <div class="containerbody">
    <form name="asset_entry" method='POST'>
    <table>  
    <tr><td width=30%>Purchase Date:</td><td><input type='text' name='purchase_date' /></td></tr>
    <tr><td>Maintenance Contract Number (optional):</td><td><input type='text' name='maint_contract_num' /></td></tr>
    <tr><td>Product:</td><td><select name="product_type">
    <option name='0'>Select a product type</option>
%   foreach my $type ( sort { $a->name cmp $b->name } @products ){
      <option name='<% $type->id %>'><% ProductType->search({id=>$type->type})->first->name.": ".$type->name %></option>	
%   }
    </select></td></tr>
    </table>
    <br/>
    Serial Numbers:<br/> <textarea name = 'serial_numbers' rows='7' cols='60'></textarea><br/>
    <input type='submit' name='submit' value='Submit'/>
    </form>     



    </div>

  </div>
</div>
