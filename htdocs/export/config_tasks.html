<%doc>

-- Config tasks --

</%doc>
%
<%attr>
title => 'Config Tasks' 
</%attr>
%
%
%#######################################################################
%#
%# Args section
%#
%#######################################################################
<%args>
@config_types   => undef
$user           => undef
$submit         => undef
$showheader     => 1
$hideheader     => undef
</%args>
%
%
%
%#######################################################################
%#
%# INIT section
%#
%#######################################################################
%
<%init>
use Netdot::Exporter;
my $DEBUG = 0;
print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;
my @types = qw /Nagios Sysmon Rancid/;
my $logstr;

</%init>

<div id="sectiontools" <% $hideheader %>>
<div class="container">
    <div class="containerhead">
        Export third party configurations from Netdot
    </div>
    <div class="containerbody" id="tasks">
        <p><br>
        <table><tr><td>
        <fieldset class="medium">
            <legend>Export Options</legend>
            <form action="config_tasks.html" method="POST">
                Select one or more of:
                <select name="config_types" MULTIPLE>
%               foreach my $type ( @types ){
        	    <option value="<% $type %>"><% $type %></option> 
%               } 
                </select>
                <input type="submit" name="submit" class="btn" value="submit" >
            </form>
        </fieldset>
        </td></tr></table>

<%perl>
if ( $submit ){

    $m->comp('/generic/error.mhtml', error=>"Please select an Export type")
	unless ( $ARGS{config_types} );

    my $logger = Netdot->log->get_logger('Netdot::Exporter');
    if ( $logstr = Log::Log4perl::appender_by_name('config_tasks.html') ){
	Log::Log4perl->eradicate_appender('config_tasks.html');
    }
    $logstr = Netdot::Util::Log->new_appender('String', name=>'config_tasks.html');
    $logger->add_appender($logstr);

    foreach my $type ( @config_types ){
	eval {
	    my $exporter = Netdot::Exporter->new(type=>$type);
	    $exporter->generate_configs();
	};
	if ( my $e = $@ ){
	    $m->comp('/generic/error.mhtml', error=>$e);
	}
    }

    my $log = $logstr->string() ;
    if ( $log ){
	print "<strong>Exporter Output:</strong> <br>";
	print "<p><pre>";
	print "$log";
	print "</pre> <br />";
    }
}
</%perl>
 
    </div> <!-- close containerbody -->
</div> <!-- close container -->
</div> <!-- close sectiontools -->


<%cleanup>
    if ( defined $logstr ){
        Log::Log4perl->eradicate_appender('config_tasks.html')
    }
</%cleanup>
