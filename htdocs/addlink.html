<%doc>

Add a link between two interfaces from device.html
(Creates a new InterfaceDep object)

</%doc>
%
%
<%flags>
inherit => undef
</%flags>
%
%
<%args>
$int_id  =>   undef
$role    =>   undef
$Add     =>   undef
$Cancel  =>   undef
</%args>
%
%
<%init>
my $DEBUG = 0;
my %state;
my $intobj;
my $intlbl;
# Use a hash to make sure there are no duplicates
my %subnet_devs;

print '%ARGS is  <pre>', Dumper(%ARGS), '</pre><br>' if $DEBUG;

if ( $int_id ){
    unless ( $intobj = Interface->retrieve($int_id) ){
	$m->comp("error.mhtml", error => "Can't retrieve Interface id $int_id", showplainerror=>1);	
    }
    unless ( $intlbl = $ui->getobjlabel($intobj, ", ") ){
	$intlbl = $intobj->name;
    }
#
#   Get a list of Devices in the same subnet(s)
#
    my %subnets = $dm->getdevsubnets($intobj->device);
    
    foreach my $subnet ( keys %subnets ){
	foreach my $ip ( $subnets{$subnet}->children ){
	    if ( $ip->prefix == 32 || $ip->prefix == 128 ){
		if ( $ip->interface && $ip->interface->device 
		     && $ip->interface->device->name 
		     && $ip->interface->device->name->name){
		    $subnet_devs{$ip->interface->device->name->name} = "";
		}
	    }
	}
    }
    
}
my $rel_role;
if ( $role ){
    if ($role ne "parent" && $role ne "child"){
	   $m->comp("error.mhtml", error => "Invalid role: $role", showplainerror=>1);
    }
    $rel_role = ($role eq "parent")? "child" : "parent";
}

my %role_tags = ( 'parent' => "Parent Interface",
		  'child'  => "Child Interface",
		  );

my $bodyargs;
if ( $Add ){
    $bodyargs = 'onUnload="opener.location.reload()"';
} else {
    $bodyargs = '';
}

</%init>

<html>
<head>
    <link rel="stylesheet" href="<% $r->dir_config('NetdotPath') %>css/style.css" type="text/css">
</head>      
<body class="bodytag" <% $bodyargs %>>

<div class="container">
    <div class="containerhead">
        Add Link
    </div>
    <div class="containerbody">

<%perl>

if ( $Add ){
    $state{parent} = $ARGS{parent};
    $state{child} = $ARGS{child};

    if ( $state{parent} && $state{child} ){
	my $newdepid;
	if ( InterfaceDep->search(\%state) ){
	    print "<br>Dependency already exists!<br><br>";
	    print '<a href="#" onClick="window.close()">[close]</a><br>';
	    $m->abort;
	}else{
	    unless ( $newdepid = $ui->insert(table => "InterfaceDep", state => \%state) ){
		$m->comp("error.mhtml", error => $ui->error, showplainerror=>1);
	    }
	}
	print "Layer 2 dependency added.<br>";

	#
	#  Add L3 dependencies if possible.
	#
	
	if ( (my $childint  = Interface->retrieve($state{child})) 
	     && (my $parentint = Interface->retrieve($state{parent})) ) {
	    if ( $childint->device->id != $parentint->device->id ){
		my $childdev  = $childint->device;
		my $parentdev = $parentint->device;
		my @childips  = $dm->getdevips($childdev);
		my @parentips = $dm->getdevips($parentdev);
		
		my @newlinks;
		foreach my $chip ( @childips ){
		    foreach my $parip ( @parentips ){
			if ( int($chip->parent) && int($parip->parent) &&
			     int($chip->parent) == int($parip->parent) ){
			    
			    push @newlinks, { child  => $chip->interface, 
					      parent => $parip->interface };
			    last;
			}
		    }
		}
		my @l3deps;
		foreach my $state ( @newlinks ){
		    if (! InterfaceDep->search($state) ){
			unless ( $ui->insert(table => "InterfaceDep", state => $state) ){
			    $m->comp("error.mhtml", error => $ui->error, showplainerror=>1);
			}
			push @l3deps, sprintf( "%s:%s <=> %s:%s", 
					       $state->{parent}->device->name->name, $state->{parent}->name , 
					       $state->{child}->device->name->name, $state->{child}->name );

		    }
		}
		if ( @l3deps ){
		    print "<br>Also added the following Layer 3 dependencies:<br>";
		    foreach  ( @l3deps ){
			print "$_<br>";
		    }
		}
		
	    }else{
		# parent and child devices are the same
	    }
	}else{
	    # Could not retrieve childint or parentint
	}
	
	print "<p><a href=\"#\" onClick=\"window.close()\">[done]</a>";
	$m->abort;

    }else{
	print "<br><strong>Invalid parent and/or child!</strong><br><br>";
    }
    
</%perl>


%}elsif ( $Cancel ){
    <br>
    Cancelled
    <br>
    <a href="#" onClick="window.close()">[done]</a><br>
%   $m->abort;

%}

<script language="javascript" src="select.js"></script>
<script language="javascript" src="jsrsClient.js"></script>
<script language="javascript">
<!--
    function performSearch(field) {
        dvs = document.getElementById('device_search');
        txs = document.getElementById('text_search');

        if( dvs.value == 0 ) { 
            search_criteria='';
        } else {
            search_criteria = dvs.value + ' ';
        }
        if( txs.value != 'Keywords' ) { 
            search_criteria += txs.value; 
        }

        jsrsSendquery(field, search_criteria, 'Interface');
    }
//-->
</script>

<form name="netdotform" action="addlink.html" method="POST">

     <input type="hidden" name="role" value="<% $role %>">
     <input type="hidden" name="int_id" value="<% $int_id %>">

     <input type="hidden" name="<% $role %>" value="<% $int_id %>">

    <%perl>
    my (@field_headers, @cell_data) = ();
    
    push( @field_headers, $role_tags{$role}.": " );
    push( @cell_data, $intlbl );

    push( @field_headers, $role_tags{$rel_role}.": ");
    push( @cell_data, 
&{sub{
    my $ac = "Select Device from list:";
    $ac .= '<select name="device_search" id="device_search" onChange="performSearch('.$rel_role.');">';
    $ac .= '<option value="0">-- Select --</option>';
    foreach my $dev ( sort keys %subnet_devs ){
        $ac .= '<option value="'.$dev.'">'.$dev.'</option>';
    }
    $ac .= '</select>';
    $ac .= '<br>Or search:';
    $ac .= '<input type="text" name="text_search" id="text_search" value="Keywords" onFocus="if(this.value==\'Keywords\') { this.value = \'\'; } return true;">';
    $ac .= '&nbsp;<input type="button" name="" value="List" onClick="performSearch('.$rel_role.')">';
    $ac .= '<br>';
    $ac .= '<select name="'.$rel_role.'" id="'.$rel_role.'">';
    $ac .= '</select>';

    $ac;
}}      );
    </%perl>

<& attribute_table.mhtml, field_headers=>\@field_headers, data=>\@cell_data &>

      <input name="Add" value="Add" type="submit">
      <input name="Cancel" value="Cancel" type="submit">

</form>


    </div> <!-- close containerbody -->
</div> <!-- close container -->
 
</body>
</html>
