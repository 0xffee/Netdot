<%perl>
# expect name of Table & objects that require sorting
undef( %args );
foreach my $j ( keys %ARGS ) {
  next if( $ARGS{$j} !~ /\w+/ || $j eq "submit" );
  $args{$j} = $ARGS{$j};
}
if( exists( $args{session} ) ) {
  %session = %{ $args{session} };
}
unless( defined( $args{showdisabled} ) ) {
  $args{showdisabled} = 0;
}
undef $obj;
if( $args{table} ) {
  if( defined( $args{id} ) ) {
    $obj = $args{table}->retrieve($args{id}) ;
  }
  my $M = (Meta->search( name => $args{table} ))[0];
  if( defined( $M ) ) {
    my $i = 1;
    undef( %order );
    if( defined( $M->columnorder ) ) {
      map { $order{$_} = $i++; } split( /,/, $M->columnorder );
    } else {
      $order{"id"} = $i++;
      foreach ( sort { $a cmp $b } $M->name->columns() ) {
        next if( $_ eq "id" );
        $order{$_} = $i++;
      }
    }
    undef( %linksto );
    map { my($j, $k) = split( /:/, $_ ); $linksto{$j} = $k } 
        split( /,/, $M->linksto );
  }
}
</%perl>

% ####################################################################

% if( defined( $args{table} ) ) {
    <table cellpadding="3" cellspacing="1" border="0" bgcolor="#CCCCCC">
    <tr>
    <input type="hidden" name="table" value="<% $args{table} %>">
%   if( $args{id} ) {
    <input type="hidden" name="id" value="<% $args{id} %>">
%   }
%   foreach my $c ( sort { $order{$a} <=> $order{$b} } keys %order ) {
%     next if( $c eq 'id' );
%     next if( $c eq 'disabled' && ! $args{showdisabled} );
% ################################################
%     if( ! exists( $linksto{$c} ) ) { 
        <tr>
        <td bgcolor="#FFFFFF"><strong><% $c %>:</strong></td>
%       if( defined( $args{id} ) ) {
          <td colspan="2"><input type="text" size="40" name="<% $c %>" value="<% $obj->$c %>"></td>
%       } elsif( exists( $session{$c} ) ) {
          <td colspan="2"><input type="text" size="40" name="<% $c %>" value="<% $session{$c} %>"></td>
%       } else {
          <td colspan="2"><input type="text" size="40" name="<% $c %>"></td>
%       }
        </tr>
% ################################################
%     } else {
        <tr>
        <td bgcolor="#FFFFFF"><strong><% $c %>:</strong></td>
%       my $ft = (Meta->search( name => $linksto{$c} ))[0];
%       if( ! defined( $ft ) ) {
          No <% linksto{$c} %> in Meta table
%       } elsif( defined( $obj ) && $obj->$c == 0 ) {
          -
%       } else {
%         my $lbl = $ft->label;
          <td>
          <select name="<% $c %>">
%         foreach my $fkobj ( $linksto{$c}->retrieve_all ) {
%           if( ( defined( $obj ) && $fkobj->id == $obj->$c->id ) 
%               || ( $fkobj->id == $session{$c} ) ) {
              <option value="<% $fkobj->id %>" selected><% $fkobj->$lbl %></option>
%           } else {
              <option value="<% $fkobj->id %>"><% $fkobj->$lbl %></option>
%           }
%         } # for
          </select>
          </td>
	  <td>
	  <input name="<% $linksto{$c} %>" value="New" type="submit">
	  </td>
%       } # else
        </td>
        </tr>
%     } # else
%   } # for
    </tr>
    </table>
% } # if

% ####################################################################


<%init>
use lib "/home/netdot/public_html/lib";
use Netdot::DBI;
use Data::Dumper;
my( %args, %order, %orderbrief, %linksto, %linksfrom, $obj, %session );
undef( %session );

</%init>
<%doc>

Arguments:  
  table         -  name of table (REQUIRED)
  id            -  id (row) from the above table  (OPTIONAL)
  showdisabled  -  1|0  whether to show disabled columns
  session       -  ref to a hash with values to insert (if object ! exist)

######################################################################
#  $Log: form.html,v $
#  Revision 1.8  2003/05/15 21:49:44  netdot
#  removed same bug that afflicted sortresults.html:
#   ( $obj->$c->id  =>  $obj->$c ) around line 70
#
#  Revision 1.7  2003/05/15 21:34:47  netdot
#  added hidden input field for id (if it is defined)
#
#  Revision 1.6  2003/05/14 17:52:19  netdot
#  changes to support session -- ability to put values in boxes when the
#  object doesn't exist
#
#  Revision 1.5  2003/05/14 16:26:52  netdot
#  added some markers
#
#  Revision 1.4  2003/05/09 00:02:28  netdot
#  removed submit button from this component; probably should be in
#  calling component
#
#  Revision 1.3  2003/05/08 22:17:44  netdot
#  removed some unnecessary code; working towards stabilizing this
#  component
#
#  Revision 1.2  2003/05/07 19:13:49  netdot
#  bugger if i know.  do a diff.
#
#  Revision 1.1  2003/05/05 17:59:33  netdot
#  Initial revision
#

</%doc>
